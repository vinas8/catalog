<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêç Terrarium Shelves</title>
  <script src="../src/utils/debug-loader.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .shelf-info {
      color: rgba(255,255,255,0.9);
      font-size: 16px;
      margin-top: 10px;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      background: white;
      color: #667eea;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    /* Shelf Container */
    .shelf-container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
    }
    
    .shelf-wrapper {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .shelf-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      color: white;
    }
    
    .shelf-title {
      font-size: 24px;
      font-weight: bold;
    }
    
    .shelf-actions {
      display: flex;
      gap: 10px;
    }
    
    .action-btn {
      padding: 8px 16px;
      background: rgba(255,255,255,0.9);
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      color: #667eea;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .action-btn:hover {
      background: white;
      transform: scale(1.05);
    }
    
    /* Terrarium Grid - 10 tanks per shelf */
    .terrarium-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .terrarium {
      background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
      border: 3px solid #1976d2;
      border-radius: 15px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
      min-height: 180px;
      display: flex;
      flex-direction: column;
    }
    
    .terrarium:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      border-color: #0d47a1;
    }
    
    /* Water effect */
    .terrarium::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, 
        rgba(255,255,255,0.4) 0%, 
        rgba(255,255,255,0.2) 30%, 
        rgba(255,255,255,0) 60%, 
        rgba(0,0,0,0.1) 100%);
      pointer-events: none;
    }
    
    .terrarium-number {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(255,255,255,0.95);
      color: #1976d2;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: bold;
      z-index: 1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .terrarium-count {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255,255,255,0.95);
      color: #1976d2;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      z-index: 1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .snakes-container {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 30px 10px 10px;
      z-index: 1;
    }
    
    .snake-in-tank {
      font-size: 32px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      animation: swim 3s ease-in-out infinite;
      transition: transform 0.2s;
    }
    
    .snake-in-tank:hover {
      transform: scale(1.2);
    }
    
    @keyframes swim {
      0%, 100% { transform: translateY(0) rotate(-5deg); }
      50% { transform: translateY(-5px) rotate(5deg); }
    }
    
    .terrarium-empty {
      opacity: 0.6;
      background: linear-gradient(180deg, #f5f5f5 0%, #e0e0e0 100%);
      border-color: #bdbdbd;
      justify-content: center;
      align-items: center;
    }
    
    .terrarium-empty .snakes-container {
      padding: 10px;
    }
    
    .empty-text {
      color: #9e9e9e;
      font-size: 14px;
      font-weight: 600;
      z-index: 1;
    }
    
    /* Shelf Navigation */
    .shelf-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
    }
    
    .nav-btn {
      width: 50px;
      height: 50px;
      background: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: all 0.3s;
      color: #667eea;
      font-weight: bold;
    }
    
    .nav-btn:hover:not(:disabled) {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .shelf-indicator {
      color: white;
      font-size: 18px;
      font-weight: bold;
      min-width: 150px;
      text-align: center;
    }
    
    @media (max-width: 1024px) {
      .terrarium-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 640px) {
      .terrarium-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .snake-in-tank {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üêç Terrarium Shelves</h1>
    <div class="shelf-info" id="shelf-info">Loading...</div>
  </div>
  
  <div class="controls">
    <button class="btn" onclick="loadScenario(5)">5 Snakes</button>
    <button class="btn" onclick="loadScenario(15)">15 Snakes</button>
    <button class="btn" onclick="loadScenario(30)">30 Snakes (3 Shelves)</button>
    <button class="btn" onclick="loadMixedStates()">Mixed States</button>
    <button class="btn" onclick="distributeEvenly()">Distribute Evenly</button>
    <a href="../calculator.html" class="btn" style="text-decoration: none;">üß¨ Breeding Calculator</a>
  </div>
  
  <div class="shelf-container">
    <div class="shelf-wrapper">
      <div class="shelf-header">
        <div class="shelf-title" id="shelf-title">Shelf 1</div>
        <div class="shelf-actions">
          <button class="action-btn" onclick="cleanAll()">üßπ Clean All</button>
          <button class="action-btn" onclick="feedAll()">üçñ Feed All</button>
        </div>
      </div>
      
      <div class="terrarium-grid" id="terrarium-grid"></div>
      
      <div class="shelf-nav">
        <button class="nav-btn" id="prev-btn" onclick="prevShelf()">‚Äπ</button>
        <div class="shelf-indicator" id="shelf-indicator">Shelf 1 of 1</div>
        <button class="nav-btn" id="next-btn" onclick="nextShelf()">‚Ä∫</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { SnakeDetailView } from '../src/modules/game/snake-detail-view.js?v=5';
    
    console.log('üöÄ Initializing Terrarium Shelves with multi-snake tanks...');
    
    window.gameState = { 
      snakes: [],
      terrariums: [], // Each shelf has 10 terrariums, each can hold multiple snakes
      currency: { gold: 5000 }
    };
    
    window.currentShelfIndex = 0;
    const TERRARIUMS_PER_SHELF = 10;
    
    function getTotalShelves() {
      return Math.max(1, Math.ceil(window.gameState.terrariums.length / TERRARIUMS_PER_SHELF));
    }
    
    function getCurrentShelfTerrariums() {
      const start = window.currentShelfIndex * TERRARIUMS_PER_SHELF;
      const end = start + TERRARIUMS_PER_SHELF;
      return window.gameState.terrariums.slice(start, end);
    }
    
    function renderShelves() {
      const currentTerrariums = getCurrentShelfTerrariums();
      const grid = document.getElementById('terrarium-grid');
      
      // Ensure we always show 10 terrarium slots per shelf
      const slots = Array(10).fill(null).map((_, i) => currentTerrariums[i] || { snakes: [] });
      
      grid.innerHTML = slots.map((terrarium, index) => {
        const globalIndex = (window.currentShelfIndex * TERRARIUMS_PER_SHELF) + index;
        const snakes = terrarium.snakes || [];
        
        if (snakes.length === 0) {
          return `
            <div class="terrarium terrarium-empty" onclick="showTerrariumDetails(${globalIndex})">
              <div class="terrarium-number">${index + 1}</div>
              <div class="snakes-container">
                <div style="font-size: 48px; opacity: 0.3;">üè†</div>
              </div>
              <div class="empty-text">Empty Tank</div>
            </div>
          `;
        }
        
        return `
          <div class="terrarium" onclick="showTerrariumDetails(${globalIndex})">
            <div class="terrarium-number">${index + 1}</div>
            <div class="terrarium-count">${snakes.length} üêç</div>
            <div class="snakes-container">
              ${snakes.map(snake => {
                const state = getSnakeState(snake);
                return `<div class="snake-in-tank" title="${snake.nickname}">${state.emoji}</div>`;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
      
      // Update shelf info
      const currentShelf = window.currentShelfIndex + 1;
      const totalShelves = getTotalShelves();
      const totalSnakes = window.gameState.snakes.length;
      const totalTerrariums = window.gameState.terrariums.length;
      
      document.getElementById('shelf-title').textContent = `Shelf ${currentShelf}`;
      document.getElementById('shelf-indicator').textContent = `Shelf ${currentShelf} of ${totalShelves}`;
      document.getElementById('shelf-info').textContent = 
        `${totalSnakes} snakes in ${totalTerrariums} terrariums across ${totalShelves} shelf${totalShelves !== 1 ? 'es' : ''}`;
      
      // Update nav buttons
      document.getElementById('prev-btn').disabled = currentShelf === 1;
      document.getElementById('next-btn').disabled = currentShelf === totalShelves;
      
      console.log(`‚úÖ Rendered shelf ${currentShelf}/${totalShelves} with ${totalTerrariums} terrariums`);
    }
    
    function getSnakeState(snake) {
      if (snake.stats.health < 30) return { emoji: 'ü§¢', state: 'sick' };
      if (snake.shed_cycle?.stage === 'blue') return { emoji: 'üîµ', state: 'shedding' };
      if (snake.stats.hunger < 30) return { emoji: 'üòã', state: 'hungry' };
      if (snake.stats.happiness > 80) return { emoji: 'üòä', state: 'happy' };
      if (snake.stats.stress > 70) return { emoji: 'üò∞', state: 'stressed' };
      return { emoji: 'üêç', state: 'normal' };
    }
    
    window.showTerrariumDetails = function(terrariumIndex) {
      const terrarium = window.gameState.terrariums[terrariumIndex];
      if (!terrarium || terrarium.snakes.length === 0) {
        console.log(`Empty terrarium #${terrariumIndex + 1}`);
        alert(`Terrarium #${terrariumIndex + 1} is empty!\n\nYou can add snakes here in the future.`);
        return;
      }
      
      console.log(`üè† Terrarium #${terrariumIndex + 1} has ${terrarium.snakes.length} snake${terrarium.snakes.length !== 1 ? 's' : ''}`);
      
      // Create modal to show all snakes in this terrarium
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
      `;
      
      const snakesHtml = terrarium.snakes.map((snake, index) => {
        const detailView = new SnakeDetailView(snake);
        return `
          <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 15px 0; color: #667eea;">üêç Snake ${index + 1} of ${terrarium.snakes.length}</h3>
            ${detailView.renderContent()}
          </div>
        `;
      }).join('');
      
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 20px;
          max-width: 800px;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        ">
          <div style="
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1;
          ">
            <h2 style="margin: 0; font-size: 24px;">üè† Terrarium #${terrariumIndex + 1}</h2>
            <button id="close-modal" style="
              background: rgba(255, 255, 255, 0.2);
              border: 2px solid white;
              color: white;
              width: 36px;
              height: 36px;
              border-radius: 50%;
              font-size: 20px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
            ">‚úï</button>
          </div>
          
          <div style="padding: 20px;">
            <div style="
              background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
              padding: 15px;
              border-radius: 12px;
              margin-bottom: 20px;
              text-align: center;
            ">
              <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 5px;">
                ${terrarium.snakes.length} Snake${terrarium.snakes.length !== 1 ? 's' : ''} Living Together
              </div>
              <div style="font-size: 14px; color: #666;">
                Click actions below to care for each snake individually
              </div>
            </div>
            
            ${snakesHtml}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close modal handlers
      const closeBtn = modal.querySelector('#close-modal');
      closeBtn.addEventListener('click', () => modal.remove());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    };
    
    window.nextShelf = function() {
      const maxShelf = getTotalShelves() - 1;
      if (window.currentShelfIndex < maxShelf) {
        window.currentShelfIndex++;
        renderShelves();
        console.log('‚û°Ô∏è Next shelf');
      }
    };
    
    window.prevShelf = function() {
      if (window.currentShelfIndex > 0) {
        window.currentShelfIndex--;
        renderShelves();
        console.log('‚¨ÖÔ∏è Previous shelf');
      }
    };
    
    window.cleanAll = function() {
      const terrariums = getCurrentShelfTerrariums();
      let count = 0;
      terrariums.forEach(aq => {
        aq.snakes.forEach(snake => {
          snake.stats.cleanliness = 100;
          snake.last_cleaned = new Date().toISOString();
          count++;
        });
      });
      renderShelves();
      console.log(`‚úÖ Cleaned ${count} snakes!`);
    };
    
    window.feedAll = function() {
      const terrariums = getCurrentShelfTerrariums();
      let count = 0;
      terrariums.forEach(aq => {
        aq.snakes.forEach(snake => {
          snake.stats.hunger = 100;
          count++;
        });
      });
      renderShelves();
      console.log(`‚úÖ Fed ${count} snakes!`);
    };
    
    function createTestSnake(index, overrides = {}) {
      return {
        id: `snake-${index}`,
        nickname: `${['Slinky', 'Noodle', 'Monty', 'Luna', 'Pixel', 'Shadow', 'Basil', 'Olive', 'Pepper', 'Sage'][index % 10]} #${index}`,
        type: 'real',
        species: 'ball_python',
        morph: ['Banana', 'Piebald', 'Pastel', 'Albino', 'Mojave', 'Cinnamon'][index % 6],
        sex: index % 2 === 0 ? 'male' : 'female',
        weight_grams: 100 + (index * 10),
        length_cm: 30 + (index * 2),
        stats: {
          hunger: Math.max(20, 80 - (index * 2)),
          water: 100,
          temperature: 80,
          humidity: 60,
          health: Math.max(30, 100 - (index * 1.5)),
          stress: Math.min(80, 10 + (index * 2)),
          cleanliness: Math.max(30, 100 - (index * 3)),
          happiness: Math.max(40, 85 - (index * 1.5)),
          ...overrides.stats
        },
        equipment: { enclosure_tier: Math.min(5, Math.floor(index / 5) + 1) },
        shed_cycle: { stage: 'normal', days_since_last: 5 },
        last_fed: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
        last_cleaned: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()
      };
    }
    
    window.loadScenario = function(count) {
      console.log(`üîÑ Loading ${count} snakes...`);
      
      // Create snakes
      window.gameState.snakes = [];
      for (let i = 1; i <= count; i++) {
        window.gameState.snakes.push(createTestSnake(i));
      }
      
      // Distribute randomly into terrariums (1-4 snakes per tank)
      window.gameState.terrariums = [];
      let snakeIndex = 0;
      
      while (snakeIndex < count) {
        const snakesInThisTank = Math.min(
          Math.floor(Math.random() * 3) + 1, // 1-3 snakes per tank
          count - snakeIndex
        );
        
        const tankSnakes = [];
        for (let i = 0; i < snakesInThisTank; i++) {
          tankSnakes.push(window.gameState.snakes[snakeIndex++]);
        }
        
        window.gameState.terrariums.push({ snakes: tankSnakes });
      }
      
      window.currentShelfIndex = 0;
      renderShelves();
      console.log(`‚úÖ Loaded ${count} snakes into ${window.gameState.terrariums.length} terrariums`);
    };
    
    window.distributeEvenly = function() {
      if (window.gameState.snakes.length === 0) {
        console.log('‚ö†Ô∏è No snakes to distribute');
        return;
      }
      
      // Put 3 snakes per terrarium
      window.gameState.terrariums = [];
      const snakesPerTank = 3;
      
      for (let i = 0; i < window.gameState.snakes.length; i += snakesPerTank) {
        const tankSnakes = window.gameState.snakes.slice(i, i + snakesPerTank);
        window.gameState.terrariums.push({ snakes: tankSnakes });
      }
      
      window.currentShelfIndex = 0;
      renderShelves();
      console.log(`‚úÖ Distributed into ${window.gameState.terrariums.length} terrariums (3 per tank)`);
    };
    
    window.loadMixedStates = function() {
      console.log('üîÑ Loading mixed states...');
      window.gameState.snakes = [
        createTestSnake(1, { stats: { hunger: 25 } }),
        createTestSnake(2, { stats: { health: 20 } }),
        createTestSnake(3, { stats: { happiness: 95 } }),
        createTestSnake(4, { stats: { stress: 85 } }),
        createTestSnake(5, { shed_cycle: { stage: 'blue' } }),
        createTestSnake(6),
        createTestSnake(7),
        createTestSnake(8),
      ];
      
      // Put multiple snakes in some tanks
      window.gameState.terrariums = [
        { snakes: [window.gameState.snakes[0], window.gameState.snakes[1]] }, // 2 snakes
        { snakes: [window.gameState.snakes[2]] }, // 1 snake
        { snakes: [window.gameState.snakes[3], window.gameState.snakes[4], window.gameState.snakes[5]] }, // 3 snakes
        { snakes: [window.gameState.snakes[6], window.gameState.snakes[7]] }, // 2 snakes
      ];
      
      window.currentShelfIndex = 0;
      renderShelves();
      console.log('‚úÖ Mixed states loaded with varied tank populations');
    };
    
    // Initialize
    console.log('‚úÖ Multi-snake terrarium system initialized');
    loadScenario(15);
  </script>
</body>
</html>
