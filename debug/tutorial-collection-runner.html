<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêç Tutorial Collection Runner - Snake Muffin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 { color: #58a6ff; margin-bottom: 10px; font-size: 24px; }
    
    .subtitle {
      color: #8b949e;
      margin-bottom: 20px;
      font-size: 13px;
    }
    
    .btn {
      background: #238636;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    
    .btn:hover { background: #2ea043; }
    .btn:disabled { background: #21262d; cursor: not-allowed; opacity: 0.5; }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .test-card {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
      transition: border-color 0.3s;
    }
    
    .test-card.running { border-color: #d29922; }
    .test-card.passed { border-color: #3fb950; }
    .test-card.failed { border-color: #f85149; }
    
    .test-header {
      padding: 14px 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      user-select: none;
    }
    
    .test-header:hover { background: #1c2128; }
    
    .test-number {
      background: #21262d;
      color: #8b949e;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      min-width: 50px;
      text-align: center;
    }
    
    .test-title { 
      flex: 1; 
      font-weight: 500;
      font-size: 14px;
    }
    
    .test-duration {
      background: #21262d;
      color: #8b949e;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
    }
    
    .test-status {
      font-size: 20px;
      min-width: 30px;
      text-align: center;
    }
    
    .test-body {
      display: none;
      padding: 16px;
      border-top: 1px solid #30363d;
      background: #0d1117;
    }
    
    .test-body.show { display: block; }
    
    .code-block {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      line-height: 1.5;
      color: #c9d1d9;
    }
    
    .progress-bar {
      background: #161b22;
      border-radius: 10px;
      height: 28px;
      overflow: hidden;
      margin: 15px 0;
      border: 2px solid #30363d;
      display: none;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #238636, #2ea043);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease-out;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 13px;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    
    .progress-text {
      color: #58a6ff;
      font-size: 13px;
      font-weight: bold;
      margin-top: 10px;
      display: none;
    }
    
    .run-btn-container {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }

    .summary-box {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 12px;
    }

    .summary-item {
      text-align: center;
    }

    .summary-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .summary-label {
      color: #8b949e;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
  </style>
</head>
<body>
  <h1>üêç Tutorial Collection Runner (S2-7.x)</h1>
  <p class="subtitle">
    <strong>Collection ID:</strong> COL-S2-7-tutorial | 
    <strong>Module:</strong> S2 (Game) | 
    <strong>Scenarios:</strong> 6 | 
    <strong>Duration:</strong> ~5-6 minutes<br>
    <span style="display: inline-flex; align-items: center; gap: 8px; margin-top: 5px;">
      <strong style="color: #8b949e;">Tests:</strong>
      <span style="background: #f77f00; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Care Mechanics</span>
      <span style="background: #1f6feb; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Event System</span>
      <span style="background: #8957e5; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">LocalStorage</span>
    </span><br>
    <a href="index.html" style="color: #58a6ff; text-decoration: none; font-size: 12px;">‚Üê Back to Debug Hub</a>
  </p>
  
  <div class="summary-box">
    <h2 style="color: #c9d1d9; font-size: 16px; margin-bottom: 10px;">Collection Summary</h2>
    <div class="summary-grid">
      <div class="summary-item">
        <div class="summary-value" style="color: #58a6ff;" id="total-count">6</div>
        <div class="summary-label">Total</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" style="color: #3fb950;" id="passed-count">0</div>
        <div class="summary-label">Passed</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" style="color: #f85149;" id="failed-count">0</div>
        <div class="summary-label">Failed</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" style="color: #8b949e;" id="pending-count">6</div>
        <div class="summary-label">Pending</div>
      </div>
    </div>
  </div>

  <div class="run-btn-container">
    <button id="run-all-btn" class="btn">‚ñ∂ Run All Scenarios</button>
    <button id="collapse-btn" class="btn btn-small">Collapse All</button>
    <button id="expand-btn" class="btn btn-small">Expand All</button>
    <button id="reset-btn" class="btn btn-small" style="background: #d29922;">‚Üª Reset</button>
  </div>
  
  <div class="progress-bar" id="progress-container">
    <div class="progress-fill" id="progress-bar">0%</div>
  </div>
  <div class="progress-text" id="progress-text">Ready to run</div>
  
  <div id="scenario-list"></div>

  <script type="module">
    import { TestRunner } from './modules/test-runner.js';
    import { createGameStorage } from '../src/modules/game/storage-client.js';

    // Initialize storage client for tutorial tracking
    const storage = createGameStorage({
      backend: 'localStorage',
      namespace: 'tutorial_runner',
      autoSave: true,
      saveInterval: 10000
    });

    // Listen to storage events
    storage.on('set', ({ key, value }) => {
      console.log('üìù Storage updated:', key);
    });

    // Tutorial scenarios as test groups
    const testGroups = [
      {
        name: 'Tutorial System (S2-7.x)',
        icon: 'üêç',
        module: 'S2-7',
        tests: [
          {
            id: 'S2-7-01',
            number: 'S2-7.x.01',
            method: 'DEMO',
            name: 'Happy Path (Daily Check-in)',
            endpoint: 'tutorial-happy-path.html',
            description: 'Tests daily care routine, positive reinforcement, and basic mechanics',
            expected: 'Feed action, Water action, Stat display, Event timers',
            run: async () => {
              await storage.setTutorialProgress({ current: 'S2-7.x.01', started_at: Date.now() });
              const response = await fetch('tutorial-happy-path.html', { method: 'HEAD' });
              if (!response.ok) throw new Error(`Status ${response.status}`);
              await storage.markTutorialComplete('S2-7.x.01');
              const contentLength = response.headers.get('content-length');
              return { 
                status: 'passed', 
                url: 'tutorial-happy-path.html',
                fileSize: contentLength ? contentLength + ' bytes' : 'unknown',
                message: 'Tutorial page accessible'
              };
            }
          },
          {
            id: 'S2-7-02',
            number: 'S2-7.x.02',
            method: 'DEMO',
            name: 'Missed Care (2-3 days)',
            endpoint: 'tutorial-missed-care.html',
            description: 'Tests stat decay over time, recovery mechanics, re-engagement flow',
            expected: 'Decay rates, Critical warnings, Recovery actions, Stat persistence',
            run: async () => {
              await storage.setTutorialProgress({ current: 'S2-7.x.02', started_at: Date.now() });
              const response = await fetch('tutorial-missed-care.html', { method: 'HEAD' });
              if (!response.ok) throw new Error(`Status ${response.status}`);
              await storage.markTutorialComplete('S2-7.x.02');
              return { 
                status: 'passed', 
                url: 'tutorial-missed-care.html',
                message: 'Tutorial page accessible'
              };
            }
          },
          {
            id: 'S2-7-03',
            number: 'S2-7.x.03',
            method: 'DEMO',
            name: 'Education-First Commerce',
            endpoint: 'tutorial-education-commerce.html',
            description: 'Browse catalog without purchase pressure, learn before buying',
            expected: 'Catalog access, No forced purchase, Educational content, Trust building',
            run: async () => {
              await storage.setTutorialProgress({ current: 'S2-7.x.03', started_at: Date.now() });
              const response = await fetch('tutorial-education-commerce.html', { method: 'HEAD' });
              if (!response.ok) throw new Error(`Status ${response.status}`);
              await storage.markTutorialComplete('S2-7.x.03');
              return { 
                status: 'passed', 
                url: 'tutorial-education-commerce.html',
                message: 'Tutorial page accessible'
              };
            }
          },
          {
            id: 'S2-7-04',
            number: 'S2-7.x.04',
            method: 'DEMO',
            name: 'Trust Protection',
            endpoint: 'tutorial-trust-protection.html',
            description: 'Transparent care requirements, no dark patterns, honest expectations',
            expected: 'Clear requirements, No manipulation, Transparent costs, Exit options',
            run: async () => {
              await storage.setTutorialProgress({ current: 'S2-7.x.04', started_at: Date.now() });
              const response = await fetch('tutorial-trust-protection.html', { method: 'HEAD' });
              if (!response.ok) throw new Error(`Status ${response.status}`);
              await storage.markTutorialComplete('S2-7.x.04');
              return { 
                status: 'passed', 
                url: 'tutorial-trust-protection.html',
                message: 'Tutorial page accessible'
              };
            }
          },
          {
            id: 'S2-7-05',
            number: 'S2-7.x.05',
            method: 'DEMO',
            name: 'Email-Driven Re-entry',
            endpoint: 'tutorial-email-reentry.html',
            description: 'Email notification triggers, multi-day gap handling, return flow',
            expected: 'Email triggers, State recovery, Gap handling, Re-engagement',
            run: async () => {
              await storage.setTutorialProgress({ current: 'S2-7.x.05', started_at: Date.now() });
              const response = await fetch('tutorial-email-reentry.html', { method: 'HEAD' });
              if (!response.ok) throw new Error(`Status ${response.status}`);
              await storage.markTutorialComplete('S2-7.x.05');
              return { 
                status: 'passed', 
                url: 'tutorial-email-reentry.html',
                message: 'Tutorial page accessible'
              };
            }
          },
          {
            id: 'S2-7-06',
            number: 'S2-7.x.06',
            method: 'DEMO',
            name: 'Failure Case (Educational)',
            endpoint: 'tutorial-failure-educational.html',
            description: 'Death scenario, educational failure messages, learning opportunity',
            expected: 'Death trigger, Educational message, Restart option, Lesson learned',
            run: async () => {
              await storage.setTutorialProgress({ current: 'S2-7.x.06', started_at: Date.now() });
              const response = await fetch('tutorial-failure-educational.html', { method: 'HEAD' });
              if (!response.ok) throw new Error(`Status ${response.status}`);
              await storage.markTutorialComplete('S2-7.x.06');
              return { 
                status: 'passed', 
                url: 'tutorial-failure-educational.html',
                message: 'Tutorial page accessible'
              };
            }
          }
        ]
      }
    ];

    // Initialize TestRunner
    const runner = new TestRunner({
      containerId: 'scenario-list',
      progressBarId: 'progress-bar',
      progressTextId: 'progress-text',
      progressContainerId: 'progress-container',
      autoRun: false,
      testDelay: 500,
      testGroups: testGroups
    });

    // Render tests
    runner.renderTests();

    // Attach button handlers
    document.getElementById('run-all-btn').addEventListener('click', async () => {
      const results = await runner.runAllTests();
      
      // Update summary
      document.getElementById('total-count').textContent = results.total;
      document.getElementById('passed-count').textContent = results.passed;
      document.getElementById('failed-count').textContent = results.failed;
      document.getElementById('pending-count').textContent = results.total - results.passed - results.failed;
    });

    document.getElementById('collapse-btn').addEventListener('click', () => {
      document.querySelectorAll('.test-body').forEach(body => body.classList.remove('show'));
    });

    document.getElementById('expand-btn').addEventListener('click', () => {
      document.querySelectorAll('.test-body').forEach(body => body.classList.add('show'));
    });

    document.getElementById('reset-btn').addEventListener('click', async () => {
      // Reset UI
      document.querySelectorAll('.test-status').forEach(el => {
        el.textContent = '‚è≥';
        el.className = 'test-status';
      });
      document.querySelectorAll('[id^="response-"]').forEach(el => {
        el.textContent = 'Not run yet';
      });
      
      // Reset progress
      document.getElementById('progress-bar').style.width = '0%';
      document.getElementById('progress-bar').textContent = '0%';
      document.getElementById('progress-text').textContent = 'Ready to run';
      document.getElementById('progress-container').style.display = 'none';
      document.getElementById('progress-text').style.display = 'none';
      
      // Reset summary
      document.getElementById('passed-count').textContent = '0';
      document.getElementById('failed-count').textContent = '0';
      document.getElementById('pending-count').textContent = '6';
      
      // Clear tutorial progress
      await storage.setTutorialProgress({
        completed: [],
        current: null,
        started_at: null
      });
      
      console.log('üîÑ Tutorial progress reset');
    });

    // Load initial progress
    (async () => {
      const progress = await storage.getTutorialProgress();
      console.log('üìä Tutorial progress loaded:', progress);
      document.getElementById('pending-count').textContent = 6 - (progress.completed?.length || 0);
    })();
  </script>
</body>
</html>
