<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõí Catalog Demo v1.0 - SMRI S1.x</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: linear-gradient(135deg, #1f6feb 0%, #0969da 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .header h1 { color: white; font-size: 32px; margin-bottom: 10px; }
    .header p { color: rgba(255,255,255,0.9); font-size: 14px; }
    
    .breadcrumb {
      color: rgba(255,255,255,0.7);
      font-size: 13px;
      margin-bottom: 15px;
    }
    
    .breadcrumb a { color: rgba(255,255,255,0.9); text-decoration: none; }
    
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .btn {
      background: #238636;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .btn:hover { background: #2ea043; transform: translateY(-1px); }
    .btn.secondary { background: #1f6feb; }
    .btn.secondary:hover { background: #0969da; }
    
    .info-panel {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }
    
    .info-panel h3 { color: #58a6ff; margin-bottom: 15px; font-size: 18px; }
    
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-card {
      background: #0d1117;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #30363d;
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #58a6ff;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 12px;
      color: #8b949e;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .product-card {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
      position: relative;
    }
    
    .product-card:hover {
      border-color: #58a6ff;
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(88, 166, 255, 0.2);
    }
    
    .product-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .badge-real { background: #238636; color: white; }
    .badge-virtual { background: #8957e5; color: white; }
    .badge-sold { background: #da3633; color: white; }
    
    .product-title {
      font-size: 18px;
      font-weight: 600;
      color: #c9d1d9;
      margin-bottom: 10px;
    }
    
    .product-meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 15px 0;
      font-size: 13px;
    }
    
    .meta-row {
      display: flex;
      justify-content: space-between;
      color: #8b949e;
    }
    
    .meta-label { color: #8b949e; }
    .meta-value { color: #c9d1d9; font-weight: 600; }
    
    .product-price {
      font-size: 24px;
      font-weight: bold;
      color: #238636;
      margin: 15px 0;
    }
    
    .product-id {
      font-family: monospace;
      font-size: 11px;
      color: #6e7681;
      margin-top: 10px;
      padding: 8px;
      background: #0d1117;
      border-radius: 4px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #8b949e;
    }
    
    .spinner {
      border: 3px solid #30363d;
      border-top: 3px solid #58a6ff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }
    
    .alert.success {
      background: rgba(35, 134, 54, 0.1);
      border-left-color: #238636;
      color: #3fb950;
    }
    
    .alert.error {
      background: rgba(218, 54, 51, 0.1);
      border-left-color: #da3633;
      color: #f85149;
    }
    
    .alert.info {
      background: rgba(88, 166, 255, 0.1);
      border-left-color: #58a6ff;
      color: #58a6ff;
    }
    
    .filter-bar {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-bar label {
      color: #8b949e;
      font-size: 13px;
      margin-right: 8px;
    }
    
    .filter-bar select {
      background: #0d1117;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="breadcrumb">
      <a href="index.html">Debug Hub</a> ‚Üí Catalog Demo
    </div>
    <h1>üõí Catalog Demo - Product Listing</h1>
    <p>SMRI S1.5-11.1.01 - Shop module with KV product catalog</p>
    <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Testing catalog display and KV integration</p>
  </div>

  <div class="controls">
    <button class="btn" onclick="loadProducts()">üîÑ Refresh Products</button>
    <button class="btn secondary" onclick="testProductAPI()">üß™ Test API</button>
    <button class="btn secondary" onclick="window.location.href='../catalog.html'">
      üéØ Go to Live Catalog
    </button>
  </div>

  <div id="alertContainer"></div>

  <div class="info-panel">
    <h3>üìä Catalog Statistics</h3>
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalCount">-</div>
        <div class="stat-label">Total Products</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="realCount">-</div>
        <div class="stat-label">Real Snakes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="virtualCount">-</div>
        <div class="stat-label">Virtual Snakes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="speciesCount">-</div>
        <div class="stat-label">Species</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgPrice">-</div>
        <div class="stat-label">Avg Price</div>
      </div>
    </div>
  </div>

  <div class="filter-bar">
    <label>Filter by:</label>
    <select id="typeFilter" onchange="filterProducts()">
      <option value="all">All Types</option>
      <option value="real">Real Only</option>
      <option value="virtual">Virtual Only</option>
    </select>
    
    <label>Species:</label>
    <select id="speciesFilter" onchange="filterProducts()">
      <option value="all">All Species</option>
    </select>
    
    <label>Status:</label>
    <select id="statusFilter" onchange="filterProducts()">
      <option value="available">Available</option>
      <option value="sold">Sold</option>
      <option value="all">All</option>
    </select>
    
    <label>Sort by:</label>
    <select id="sortBy" onchange="filterProducts()">
      <option value="name">Name</option>
      <option value="price-low">Price: Low to High</option>
      <option value="price-high">Price: High to Low</option>
    </select>
  </div>

  <div class="info-panel">
    <h3>üêç Product Catalog</h3>
    <div id="productsContainer">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading products from KV...</p>
      </div>
    </div>
  </div>

  <div class="info-panel">
    <h3>üìñ API Reference</h3>
    <div style="color: #8b949e; line-height: 1.8; font-size: 13px;">
      <strong style="color: #58a6ff;">Endpoint:</strong> <code style="background: #0d1117; padding: 4px 8px; border-radius: 4px;">GET /products</code><br>
      <strong style="color: #58a6ff;">Worker URL:</strong> <code style="background: #0d1117; padding: 4px 8px; border-radius: 4px;" id="workerUrl">Loading...</code><br>
      <strong style="color: #58a6ff;">Returns:</strong> Array of product objects from KV<br>
      <strong style="color: #58a6ff;">KV Namespace:</strong> PRODUCTS<br>
      <strong style="color: #58a6ff;">Used by:</strong> catalog.html, Shop module (S1.x)
    </div>
  </div>

  <script>
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    let allProducts = [];
    let filteredProducts = [];
    
    document.getElementById('workerUrl').textContent = WORKER_URL;

    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert ${type}`;
      alert.textContent = message;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    }

    async function loadProducts() {
      const container = document.getElementById('productsContainer');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading products from KV...</p></div>';
      
      try {
        const response = await fetch(`${WORKER_URL}/products`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!Array.isArray(data)) {
          throw new Error('Response is not an array');
        }
        
        if (data.length === 0) {
          container.innerHTML = '<div class="loading"><p style="color: #d29922;">‚ö†Ô∏è No products found in KV</p></div>';
          showAlert('No products found in KV storage', 'error');
          return;
        }
        
        allProducts = data;
        filteredProducts = [...allProducts];
        
        updateStatistics();
        populateFilters();
        renderProducts();
        
        showAlert(`‚úÖ Loaded ${data.length} products from KV`, 'success');
        
      } catch (error) {
        container.innerHTML = `<div class="loading"><p style="color: #f85149;">‚ùå Error: ${error.message}</p></div>`;
        showAlert(`Error loading products: ${error.message}`, 'error');
        console.error('Load error:', error);
      }
    }

    function updateStatistics() {
      const real = allProducts.filter(p => p.type === 'real').length;
      const virtual = allProducts.filter(p => p.type === 'virtual').length;
      const species = new Set(allProducts.map(p => p.species)).size;
      const avgPrice = Math.round(allProducts.reduce((sum, p) => sum + (p.price || 0), 0) / allProducts.length);
      
      document.getElementById('totalCount').textContent = allProducts.length;
      document.getElementById('realCount').textContent = real;
      document.getElementById('virtualCount').textContent = virtual;
      document.getElementById('speciesCount').textContent = species;
      document.getElementById('avgPrice').textContent = avgPrice > 0 ? `‚Ç¨${avgPrice}` : '-';
    }

    function populateFilters() {
      const speciesSet = new Set(allProducts.map(p => p.species));
      const speciesFilter = document.getElementById('speciesFilter');
      
      speciesFilter.innerHTML = '<option value="all">All Species</option>';
      speciesSet.forEach(species => {
        const option = document.createElement('option');
        option.value = species;
        option.textContent = species.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        speciesFilter.appendChild(option);
      });
    }

    function filterProducts() {
      const typeFilter = document.getElementById('typeFilter').value;
      const speciesFilter = document.getElementById('speciesFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      const sortBy = document.getElementById('sortBy').value;
      
      filteredProducts = allProducts.filter(p => {
        if (typeFilter !== 'all' && p.type !== typeFilter) return false;
        if (speciesFilter !== 'all' && p.species !== speciesFilter) return false;
        if (statusFilter !== 'all' && p.status !== statusFilter) return false;
        return true;
      });
      
      // Sort
      if (sortBy === 'price-low') {
        filteredProducts.sort((a, b) => (a.price || 0) - (b.price || 0));
      } else if (sortBy === 'price-high') {
        filteredProducts.sort((a, b) => (b.price || 0) - (a.price || 0));
      } else {
        filteredProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      }
      
      renderProducts();
      showAlert(`Showing ${filteredProducts.length} of ${allProducts.length} products`, 'info');
    }

    function renderProducts() {
      const container = document.getElementById('productsContainer');
      
      if (filteredProducts.length === 0) {
        container.innerHTML = '<div class="loading"><p style="color: #8b949e;">No products match the current filters</p></div>';
        return;
      }
      
      container.innerHTML = `<div class="products-grid">${filteredProducts.map(renderProductCard).join('')}</div>`;
    }

    function renderProductCard(product) {
      const badgeClass = product.type === 'real' ? 'badge-real' : 'badge-virtual';
      const badgeText = product.type === 'real' ? 'REAL' : 'VIRTUAL';
      const price = product.price ? `‚Ç¨${product.price}` : 'N/A';
      
      return `
        <div class="product-card">
          <div class="product-badge ${badgeClass}">${badgeText}</div>
          <div class="product-title">${product.name || 'Unnamed'}</div>
          
          <div class="product-meta">
            <div class="meta-row">
              <span class="meta-label">Species:</span>
              <span class="meta-value">${(product.species || '').replace('_', ' ')}</span>
            </div>
            <div class="meta-row">
              <span class="meta-label">Morph:</span>
              <span class="meta-value">${(product.morph || 'N/A').replace('_', ' ')}</span>
            </div>
            <div class="meta-row">
              <span class="meta-label">Status:</span>
              <span class="meta-value" style="color: ${product.status === 'available' ? '#3fb950' : '#f85149'}">${product.status || 'unknown'}</span>
            </div>
          </div>
          
          <div class="product-price">${price}</div>
          
          <div class="product-id">ID: ${product.id || 'unknown'}</div>
        </div>
      `;
    }

    async function testProductAPI() {
      showAlert('Running API tests...', 'info');
      
      const tests = [
        {
          name: 'API Response',
          test: async () => {
            const res = await fetch(`${WORKER_URL}/products`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return `‚úÖ HTTP ${res.status}`;
          }
        },
        {
          name: 'Response Format',
          test: async () => {
            const res = await fetch(`${WORKER_URL}/products`);
            const data = await res.json();
            if (!Array.isArray(data)) throw new Error('Not an array');
            return `‚úÖ Array with ${data.length} items`;
          }
        },
        {
          name: 'Product Schema',
          test: async () => {
            const res = await fetch(`${WORKER_URL}/products`);
            const data = await res.json();
            const required = ['id', 'name', 'species', 'price', 'type'];
            const first = data[0];
            const missing = required.filter(f => !(f in first));
            if (missing.length > 0) throw new Error(`Missing: ${missing.join(', ')}`);
            return `‚úÖ All required fields present`;
          }
        }
      ];
      
      for (const test of tests) {
        try {
          const result = await test.test();
          console.log(`${test.name}: ${result}`);
        } catch (error) {
          console.error(`${test.name}: ‚ùå ${error.message}`);
          showAlert(`‚ùå ${test.name} failed: ${error.message}`, 'error');
          return;
        }
      }
      
      showAlert('‚úÖ All API tests passed!', 'success');
    }

    // Load products on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadProducts();
    });
  </script>
</body>
</html>
