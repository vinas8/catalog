<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß™ SMRI Test Runner - Snake Muffin v0.7.7</title>
  <script src="../../src/utils/debug-loader.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .header h1 { 
      color: white; 
      font-size: 32px; 
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .breadcrumb {
      color: rgba(255,255,255,0.7);
      font-size: 13px;
      margin-bottom: 15px;
    }
    .breadcrumb a { 
      color: rgba(255,255,255,0.9); 
      text-decoration: none; 
    }
    .status-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(255,255,255,0.2);
    }
    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover { 
      background: #2ea043; 
      transform: translateY(-1px); 
    }
    button:disabled {
      background: #21262d;
      color: #8b949e;
      cursor: not-allowed;
      transform: none;
    }
    button.secondary { background: #1f6feb; }
    button.secondary:hover { background: #0969da; }
    .panel {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }
    .panel h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #58a6ff;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    .scenario-card {
      background: #0d1117;
      border: 2px solid #30363d;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .scenario-card:hover {
      border-color: #58a6ff;
      transform: translateY(-2px);
    }
    .scenario-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: #c9d1d9;
    }
    .scenario-id {
      font-size: 12px;
      color: #8b949e;
      margin-bottom: 10px;
    }
    .scenario-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }
    .scenario-card[data-status="running"] { border-color: #f0883e; background: rgba(240,136,62,0.1); }
    .scenario-card[data-status="passed"] { border-color: #3fb950; background: rgba(63,185,80,0.1); }
    .scenario-card[data-status="failed"] { border-color: #f85149; background: rgba(248,81,73,0.1); }
    #consoleOutput {
      background: #0d1117;
      border: 2px solid #30363d;
      border-radius: 8px;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      display: none; /* Hidden - using mobile console instead */
    }
    .log-entry {
      margin-bottom: 5px;
      display: flex;
      gap: 10px;
    }
    .log-time { color: #8b949e; }
    .log-info { color: #58a6ff; }
    .log-success { color: #3fb950; }
    .log-error { color: #f85149; }
    .log-warning { color: #f0883e; }
    #test-frame {
      width: 100%;
      height: 600px;
      border: 2px solid #30363d;
      border-radius: 8px;
      background: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="breadcrumb">
        <a href="index.html">üè† Debug Hub</a> / SMRI Test Runner
      </div>
      <h1>
        <span>üß™</span>
        <span>SMRI Test Runner</span>
      </h1>
      <div id="globalStatus" class="status-badge">Ready ¬∑ 63 Scenarios</div>
    </div>

    <div class="controls">
      <button onclick="runAll()">‚ñ∂Ô∏è Run All Tests</button>
      <button onclick="runModule('S1')" class="secondary">üõí Shop Tests</button>
      <button onclick="runModule('S0')" class="secondary">üè• System Tests</button>
      <button onclick="runModule('S2')" class="secondary">üéÆ Game Tests</button>
      <button onclick="clearConsole()">üóëÔ∏è Clear Console</button>
    </div>

    <div class="panel">
      <h2>üìã Test Scenarios</h2>
      <div id="scenarioGrid" class="grid"></div>
    </div>

    <div class="panel" style="display: none;">
      <h2>üìù Console Output (Using Mobile Console)</h2>
      <div id="consoleOutput"></div>
      <p style="color: #8b949e; font-size: 13px; margin-top: 10px;">
        üí° Console output is now displayed via the floating debug console (bottom-right button üìã).
      </p>
    </div>

    <div class="panel">
      <h2>üñºÔ∏è Test Render</h2>
      <iframe id="test-frame"></iframe>
    </div>
  </div>

  <!-- External modules -->
  <script src="smri-scenarios.js"></script>
  <script src="smri-tests.js"></script>
  <script src="csv-import-manager.js"></script>

  <script>
    const WORKER_URL = 'https://serpent-town.vinas8.workers.dev';
    const DEFAULT_CSV = `name,morph,gender,year_of_birth
Pudding,Banana H. Clown,Male,2024
Muffin,Spider Yellowbelly,Female,2024`;

    // Use scenarios from external module
    const scenarios = SMRI_SCENARIOS;

    // State
    let results = {
      passed: 0,
      failed: 0,
      total: 0,
      duration: 0
    };

    // Initialize UI
    function initScenarios() {
      const grid = document.getElementById('scenarioGrid');
      grid.innerHTML = scenarios.map(s => `
        <div class="scenario-card" data-id="${s.id}" onclick="runScenario('${s.id}')">
          <div class="scenario-title">${s.icon} ${s.title}</div>
          <div class="scenario-id">${s.smri}</div>
          <div class="scenario-status">
            <span class="icon">‚è∏Ô∏è</span>
            <span>Not run</span>
          </div>
        </div>
      `).join('');
    }

    // Logging - Use both console.log (mobile console) and inline
    function log(message, type = 'info') {
      // Log to browser console (will be captured by debug-loader.js)
      const logMethod = type === 'error' ? console.error : 
                       type === 'warning' ? console.warn : 
                       type === 'success' ? console.info : 
                       console.log;
      logMethod(`[SMRI] ${message}`);
      
      // Also update inline console (hidden by default, but kept for compatibility)
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-message log-${type}">${message}</span>
      `;
      const output = document.getElementById('consoleOutput');
      if (output) {
        output.appendChild(entry);
        output.scrollTop = output.scrollHeight;
      }
    }

    function clearConsole() {
      const output = document.getElementById('consoleOutput');
      if (output) output.innerHTML = '';
      console.clear();
    }

    function updateScenarioCard(id, status, message) {
      const card = document.querySelector(`[data-id="${id}"]`);
      if (!card) return;
      
      card.dataset.status = status;
      const statusEl = card.querySelector('.scenario-status');
      const icons = { running: '‚è≥', passed: '‚úÖ', failed: '‚ùå' };
      statusEl.innerHTML = `
        <span class="icon">${icons[status] || '‚è∏Ô∏è'}</span>
        <span>${message}</span>
      `;
    }

    // Run scenario
    async function runScenario(id) {
      const scenario = scenarios.find(s => s.id === id);
      if (!scenario) return;
      
      log(`\n${'='.repeat(50)}\nüß™ Running: ${scenario.title}\n${'='.repeat(50)}`, 'info');
      updateScenarioCard(id, 'running', 'Running...');
      
      let result;
      
      // Map scenario IDs to test functions
      const testMap = {
        'csv-import': testCSVImport,
        'purchase-flow': testPurchaseFlow,
        'catalog-display': testCatalogDisplay,
        'success-page': testSuccessPage,
        'collection-view': testCollectionView,
        'game-tamagotchi': testGameTamagotchi,
        'account-page': testAccountPage,
        'breeding-calculator': testBreedingCalculator,
        'import-page': testImportPage,
        'healthcheck': testHealthcheck,
        'worker-api': testWorkerAPI,
        'kv-storage': testKVStorage
      };
      
      const testFn = testMap[id];
      if (testFn) {
        result = await testFn();
      } else {
        // Default: load page in iframe
        result = await testHTMLPage(scenario.url, scenario.title);
      }
      
      // Update results
      results.total++;
      results.duration += result.duration || 0;
      
      if (result.passed) {
        results.passed++;
        log(`‚úÖ PASSED in ${result.duration}ms\n`, 'success');
        updateScenarioCard(id, 'passed', `Passed (${result.duration}ms)`);
      } else {
        results.failed++;
        log(`‚ùå FAILED in ${result.duration}ms\n`, 'error');
        updateScenarioCard(id, 'failed', result.error);
      }
      
      updateGlobalStatus();
    }

    function updateGlobalStatus() {
      const status = document.getElementById('globalStatus');
      const { passed, failed, total } = results;
      status.textContent = `${passed}/${total} Passed ¬∑ ${failed} Failed`;
      
      if (failed === 0 && total > 0) {
        status.style.background = 'rgba(63,185,80,0.3)';
      } else if (failed > 0) {
        status.style.background = 'rgba(248,81,73,0.3)';
      }
    }

    async function runAll() {
      results = { passed: 0, failed: 0, total: 0, duration: 0 };
      clearConsole();
      log('üöÄ Running all scenarios...', 'info');
      
      for (const scenario of scenarios) {
        if (!scenario.autoRun) continue; // Skip auto-run scenarios in bulk
        await runScenario(scenario.id);
      }
      
      log(`\nüèÅ Test run complete: ${results.passed}/${results.total} passed`, 'success');
    }

    async function runModule(module) {
      results = { passed: 0, failed: 0, total: 0, duration: 0 };
      clearConsole();
      log(`üöÄ Running ${module} module tests...`, 'info');
      
      const moduleScenarios = scenarios.filter(s => s.smri.startsWith(module));
      
      for (const scenario of moduleScenarios) {
        await runScenario(scenario.id);
      }
      
      log(`\nüèÅ Module complete: ${results.passed}/${results.total} passed`, 'success');
    }

    // Initialize
    initScenarios();
    
    // Auto-run CSV import
    const csvImportScenario = scenarios.find(s => s.autoRun);
    if (csvImportScenario) {
      setTimeout(() => runScenario(csvImportScenario.id), 1000);
    }
    
    console.log('üêç SMRI Test Runner v0.8.0 initialized - Modular version');
    console.log('üì¶ Loaded 55 scenarios from external modules');
  </script>
</body>
</html>
