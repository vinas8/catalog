<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üóÑÔ∏è KV Data Manager - Serpent Town</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }
    h1 { color: #58a6ff; margin-bottom: 10px; }
    .subtitle { color: #8b949e; margin-bottom: 20px; }
    .nav { margin-bottom: 20px; }
    .nav a { color: #58a6ff; text-decoration: none; margin-right: 15px; }
    
    .namespace-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 768px) {
      body { padding: 10px; }
      .namespace-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      .stats-bar {
        flex-direction: column;
        gap: 15px;
      }
      h1 { font-size: 24px; }
    }
    
    .namespace-card {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 20px;
    }
    
    .namespace-card h2 {
      color: #58a6ff;
      font-size: 18px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .namespace-card .count {
      background: #238636;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: bold;
    }
    
    .namespace-card .description {
      color: #8b949e;
      font-size: 13px;
      margin-bottom: 15px;
    }
    
    .btn {
      background: #238636;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    .btn:hover { background: #2ea043; }
    .btn:disabled { background: #30363d; cursor: not-allowed; opacity: 0.5; }
    
    .btn-danger { background: #da3633; }
    .btn-danger:hover { background: #f85149; }
    
    .btn-secondary { background: #21262d; }
    .btn-secondary:hover { background: #30363d; }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .data-container {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 15px;
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .key-item {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }
    
    .key-item:hover {
      border-color: #58a6ff;
      background: #1c2128;
    }
    
    .key-name {
      color: #58a6ff;
      font-family: 'Monaco', monospace;
      font-size: 13px;
      flex: 1;
      word-break: break-all;
      transition: color 0.2s;
    }
    
    .key-name:hover {
      color: #79c0ff;
      text-decoration: underline;
    }
    
    .key-actions {
      display: flex;
      gap: 5px;
      margin-left: 10px;
    }
    
    .key-value {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 4px;
      padding: 10px;
      margin-top: 8px;
      font-family: 'Monaco', monospace;
      font-size: 12px;
      color: #c9d1d9;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .empty-state {
      text-align: center;
      color: #8b949e;
      padding: 40px;
    }
    
    .loading {
      text-align: center;
      color: #58a6ff;
      padding: 20px;
    }
    
    .stats-bar {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .stats-bar .stat {
      text-align: center;
    }
    
    .stats-bar .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #58a6ff;
    }
    
    .stats-bar .stat-label {
      color: #8b949e;
      font-size: 13px;
      margin-top: 5px;
    }
    
    .debug-log {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 15px;
      max-width: 400px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 999;
      display: none;
    }
    
    .debug-log.visible {
      display: block;
    }
    
    .debug-log h3 {
      color: #58a6ff;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .debug-log .log-entry {
      font-family: Monaco, monospace;
      font-size: 11px;
      padding: 5px;
      border-bottom: 1px solid #30363d;
      color: #8b949e;
    }
    
    .debug-log .log-entry.error {
      color: #f85149;
    }
    
    .debug-log .log-entry.success {
      color: #3fb950;
    }
    
    .debug-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #238636;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1000;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    
    .wizard-container {
      max-width: 700px;
      margin: 0 auto;
    }
    
    .wizard-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 0 20px;
    }
    
    .wizard-step {
      flex: 1;
      text-align: center;
      position: relative;
    }
    
    .wizard-step::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #30363d;
      z-index: -1;
    }
    
    .wizard-step:last-child::after {
      display: none;
    }
    
    .step-number {
      display: inline-block;
      width: 40px;
      height: 40px;
      line-height: 40px;
      border-radius: 50%;
      background: #30363d;
      color: #8b949e;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .wizard-step.active .step-number {
      background: #238636;
      color: white;
    }
    
    .wizard-step.completed .step-number {
      background: #58a6ff;
      color: white;
    }
    
    .step-label {
      color: #8b949e;
      font-size: 13px;
    }
    
    .wizard-step.active .step-label {
      color: #58a6ff;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="nav">
    <a href="../index.html">‚Üê Back to Debug Hub</a>
  </div>

  <h1>üóÑÔ∏è KV Data Manager</h1>
  <p class="subtitle">View and manage all KV namespaces</p>

  <div class="stats-bar">
    <div class="stat">
      <div class="stat-number" id="totalKeys">0</div>
      <div class="stat-label">Total Keys</div>
    </div>
    <div class="stat">
      <div class="stat-number" id="totalNamespaces">6</div>
      <div class="stat-label">Namespaces</div>
    </div>
    <div>
      <button class="btn" onclick="loadAllNamespaces()">üîÑ Refresh All</button>
      <button class="btn" onclick="generateRandomSnake()">üé≤ Random Snake</button>
      <button class="btn" onclick="startWizard()">üßô Step-by-Step Wizard</button>
      <button class="btn" onclick="selectExistingUser()">üë§ Use Existing User</button>
      <button class="btn btn-danger" onclick="clearAllKV()">üóëÔ∏è Clear All KV</button>
    </div>
  </div>

  <div class="namespace-grid" id="namespaceGrid">
    <!-- Dynamically populated -->
  </div>

  <button class="debug-toggle" onclick="toggleDebug()">üêõ</button>
  <div class="debug-log" id="debugLog">
    <h3>üêõ Debug Log</h3>
    <div id="debugEntries"></div>
  </div>

  <script>
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    
    // Debug logging
    function debugLog(message, type = 'info') {
      console.log(`[KV Manager] ${message}`);
      const entries = document.getElementById('debugEntries');
      if (entries) {
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
        entries.insertBefore(entry, entries.firstChild);
        
        // Keep only last 20 entries
        while (entries.children.length > 20) {
          entries.removeChild(entries.lastChild);
        }
      }
    }
    
    function formatUserTag(tag) {
      const tagMap = {
        'b2c_beginner': 'B2C - Beginner',
        'b2c_collector': 'B2C - Collector',
        'b2b_breeder': 'B2B - Breeder',
        'b2b_shop': 'B2B - Shop',
        'b2b_importer': 'B2B - Importer',
        // Legacy tags
        'beginner': 'B2C - Beginner (Legacy)',
        'enthusiast': 'B2C - Collector (Legacy)',
        'breeder': 'B2B - Breeder (Legacy)',
        'collector': 'B2C - Collector (Legacy)'
      };
      return tagMap[tag] || tag;
    }
    
    function toggleDebug() {
      const log = document.getElementById('debugLog');
      log.classList.toggle('visible');
    }
    
    const NAMESPACES = [
      {
        binding: 'PRODUCTS',
        name: 'Products Catalog',
        description: 'Main product catalog (legacy)',
        id: 'ecbcb79f3df64379863872965f993991'
      },
      {
        binding: 'PRODUCTS_REAL',
        name: 'Real Snakes',
        description: 'Live snakes for sale (Farm context)',
        id: 'a618c6b71cc249e1accadd95d7ce4545'
      },
      {
        binding: 'PRODUCTS_VIRTUAL',
        name: 'Virtual Snakes',
        description: 'Practice snakes (Learn context)',
        id: '6f7cf9f61f694021be0ecf65a35bbd31'
      },
      {
        binding: 'USER_PRODUCTS',
        name: 'User Purchases',
        description: 'Customer owned products',
        id: '3b88d32c0a0540a8b557c5fb698ff61a'
      },
      {
        binding: 'PRODUCT_STATUS',
        name: 'Product Status',
        description: 'Track sold/available status',
        id: '57da5a83146147c8939e4070d4b4d4c1'
      },
      {
        binding: 'USERS',
        name: 'Users',
        description: 'Customer profiles and tags',
        id: 'e2c1dcb3559246cfb670b76658a27d43'
      }
    ];

    let nsData = {};
    let selectedNs = null;
    let selectedKey = null;

    async function loadAllNamespaces() {
      debugLog('Starting loadAllNamespaces()');
      document.getElementById('namespaceGrid').innerHTML = '<div class="loading">‚è≥ Loading all namespaces...</div>';
      
      try {
        debugLog(`Fetching: ${WORKER_URL}/kv/list-all`);
        const res = await fetch(`${WORKER_URL}/kv/list-all`);
        debugLog(`Response status: ${res.status}`);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        debugLog(`Received data keys: ${Object.keys(data).join(', ')}`);
        
        // Parse the data structure
        let totalKeys = 0;
        
        NAMESPACES.forEach(ns => {
          const keys = data[ns.binding] || [];
          nsData[ns.binding] = Array.isArray(keys) ? keys : [];
          totalKeys += nsData[ns.binding].length;
          debugLog(`${ns.binding}: ${nsData[ns.binding].length} keys`);
        });
        
        document.getElementById('totalKeys').textContent = totalKeys;
        debugLog(`Total keys: ${totalKeys}`, 'success');
        renderNamespaces();
      } catch (err) {
        debugLog(`Error: ${err.message}`, 'error');
        console.error('Load error:', err);
        document.getElementById('namespaceGrid').innerHTML = `
          <div class="loading">
            ‚ùå Error: ${err.message}<br>
            <small>Check debug log (üêõ) for details</small>
          </div>
        `;
      }
    }

    function renderNamespaces() {
      const grid = document.getElementById('namespaceGrid');
      grid.innerHTML = '';

      NAMESPACES.forEach(ns => {
        const keys = nsData[ns.binding] || [];
        
        const card = document.createElement('div');
        card.className = 'namespace-card';
        
        // Use snake generator for REAL/VIRTUAL products
        const addBtn = (ns.binding === 'PRODUCTS_REAL' || ns.binding === 'PRODUCTS_VIRTUAL') 
          ? `<button class="btn btn-small" onclick="showAddSnakeModal({ type: '${ns.binding === 'PRODUCTS_VIRTUAL' ? 'virtual' : 'real'}' })">‚ûï Add Snake</button>`
          : `<button class="btn btn-small" onclick="showAddKeyForm('${ns.binding}')">‚ûï Add</button>`;
        
        card.innerHTML = `
          <h2>
            ${ns.name}
            <span class="count">${keys.length || 0}</span>
          </h2>
          <div class="description">${ns.description}</div>
          <div style="margin-bottom: 10px;">
            <button class="btn btn-small" onclick="loadAllNamespaces()">üîÑ Refresh</button>
            <button class="btn btn-small btn-secondary" onclick="toggleData('${ns.binding}')">üëÅÔ∏è View All</button>
            ${addBtn}
            <button class="btn btn-small btn-danger" onclick="clearNamespace('${ns.binding}')">üóëÔ∏è Clear</button>
          </div>
          <div id="data-${ns.binding}" class="data-container" style="display: none;"></div>
        `;
        
        grid.appendChild(card);
      });
    }

    async function toggleData(binding) {
      const container = document.getElementById(`data-${binding}`);
      const isVisible = container.style.display !== 'none';
      
      if (isVisible) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      const keys = nsData[binding] || [];
      
      if (keys.length === 0) {
        container.innerHTML = '<div class="empty-state">üì≠ No keys found</div>';
        return;
      }

      container.innerHTML = keys.map(item => {
        const keyName = item.name || item;
        return `
        <div class="key-item">
          <div class="key-name" onclick="viewAndEditKey('${binding}', '${keyName}')" style="cursor: pointer; flex: 1;">${keyName}</div>
          <div class="key-actions">
            <button class="btn btn-small btn-danger" onclick="deleteKey('${binding}', '${keyName}')">üóëÔ∏è</button>
          </div>
        </div>
      `}).join('');
    }

    async function viewAndEditKey(binding, keyName) {
      debugLog(`Loading key: ${keyName} from ${binding}`);
      
      // Special handling for USERS namespace
      if (binding === 'USERS' && keyName.startsWith('user:')) {
        await viewUserWithProducts(keyName);
        return;
      }
      
      try {
        // Fetch the key value
        const res = await fetch(`${WORKER_URL}/kv/get?ns=${binding}&key=${encodeURIComponent(keyName)}`);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${await res.text()}`);
        }
        
        const data = await res.json();
        const formatted = JSON.stringify(data, null, 2);
        
        const modal = `
          <div id="viewEditModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto;" onclick="event.stopPropagation()">
              <h2 style="color: #58a6ff; margin-bottom: 5px;">üìÑ ${keyName}</h2>
              <p style="color: #8b949e; font-size: 13px; margin-bottom: 20px;">Namespace: ${binding}</p>
              
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <label style="color: #8b949e; font-size: 13px;">Edit JSON:</label>
                  <button class="btn btn-small btn-secondary" onclick="formatJSON()">üîß Format</button>
                </div>
                <textarea id="jsonEditor" rows="20" style="width: 100%; padding: 15px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-family: Monaco, monospace; font-size: 12px; resize: vertical;">${formatted}</textarea>
              </div>
              
              <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="saveEditedKey('${binding}', '${keyName}')">üíæ Save Changes</button>
                <button class="btn btn-secondary" onclick="document.getElementById('viewEditModal').remove()">Cancel</button>
                <button class="btn btn-danger" onclick="if(confirm('Delete this key?')) { deleteKey('${binding}', '${keyName}'); document.getElementById('viewEditModal').remove(); }" style="margin-left: auto;">üóëÔ∏è Delete</button>
              </div>
            </div>
          </div>
        `;
        
        const existing = document.getElementById('viewEditModal');
        if (existing) existing.remove();
        
        document.body.insertAdjacentHTML('beforeend', modal);
        
      } catch (err) {
        debugLog(`Error loading key: ${err.message}`, 'error');
        alert(`‚ùå Error: ${err.message}`);
      }
    }
    
    async function viewUserWithProducts(keyName) {
      debugLog(`Loading user with products: ${keyName}`);
      
      try {
        // Fetch user data
        const userRes = await fetch(`${WORKER_URL}/kv/get?ns=USERS&key=${encodeURIComponent(keyName)}`);
        if (!userRes.ok) throw new Error('Failed to fetch user');
        const user = await userRes.json();
        
        // Fetch user's products
        const userId = keyName.replace('user:', '');
        const productsRes = await fetch(`${WORKER_URL}/kv/get?ns=USER_PRODUCTS&key=user:${userId}`);
        let userProducts = { products: [] };
        if (productsRes.ok) {
          userProducts = await productsRes.json();
        }
        
        // Fetch product details
        let productDetails = [];
        if (userProducts.products && userProducts.products.length > 0) {
          for (const prodId of userProducts.products) {
            try {
              const prodRes = await fetch(`${WORKER_URL}/kv/get?ns=PRODUCTS_REAL&key=product:${prodId}`);
              if (prodRes.ok) {
                const prod = await prodRes.json();
                productDetails.push(prod);
              }
            } catch (err) {
              console.error(`Failed to fetch product ${prodId}:`, err);
            }
          }
        }
        
        // Build impersonation URL
        const impersonateUrl = `${window.location.origin}/index.html?user=${userId}`;
        
        const productsHtml = productDetails.length > 0 
          ? productDetails.map(p => `
              <div style="background: #161b22; padding: 12px; border-radius: 6px; border: 1px solid #30363d; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="color: #58a6ff; font-weight: 600; margin-bottom: 5px;">${p.name || 'Unknown'}</div>
                    <div style="color: #8b949e; font-size: 12px;">${p.species || ''} ${p.morph ? `- ${p.morph}` : ''}</div>
                    <div style="color: #8b949e; font-size: 11px; font-family: Monaco;">ID: ${p.id || 'N/A'}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #3fb950; font-weight: 600;">$${p.price ? p.price.toFixed(2) : '0.00'}</div>
                    <div style="color: #8b949e; font-size: 11px;">${p.status || 'unknown'}</div>
                  </div>
                </div>
              </div>
            `).join('')
          : '<div style="color: #8b949e; text-align: center; padding: 20px;">No products owned</div>';
        
        const modal = `
          <div id="viewEditModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto;" onclick="event.stopPropagation()">
              <h2 style="color: #58a6ff; margin-bottom: 5px;">üë§ ${user.name || 'User'}</h2>
              <p style="color: #8b949e; font-size: 13px; margin-bottom: 20px;">${user.email || ''}</p>
              
              <!-- User Info -->
              <div style="background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                  <div>
                    <div style="color: #8b949e; font-size: 12px; margin-bottom: 5px;">Tag</div>
                    <div style="color: #c9d1d9; font-weight: 600;">${formatUserTag(user.tag || '')}</div>
                  </div>
                  <div>
                    <div style="color: #8b949e; font-size: 12px; margin-bottom: 5px;">Products Owned</div>
                    <div style="color: #c9d1d9; font-weight: 600;">${productDetails.length}</div>
                  </div>
                  <div style="grid-column: 1 / -1;">
                    <div style="color: #8b949e; font-size: 12px; margin-bottom: 5px;">User ID</div>
                    <div style="color: #c9d1d9; font-family: Monaco; font-size: 11px; word-break: break-all;">${userId}</div>
                  </div>
                </div>
                
                <!-- Impersonate Button -->
                <a href="${impersonateUrl}" target="_blank" style="display: block; background: #238636; color: white; text-align: center; padding: 12px; border-radius: 6px; text-decoration: none; font-weight: 600; transition: background 0.2s;">
                  üé≠ Impersonate User (Open in New Tab)
                </a>
              </div>
              
              <!-- Products List -->
              <div style="background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 20px;">
                <h3 style="color: #58a6ff; margin-bottom: 15px; font-size: 16px;">üêç Owned Snakes (${productDetails.length})</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                  ${productsHtml}
                </div>
              </div>
              
              <!-- Actions -->
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="editUserJSON('${keyName}')">‚úèÔ∏è Edit JSON</button>
                <button class="btn btn-secondary" onclick="document.getElementById('viewEditModal').remove()">Close</button>
                <button class="btn btn-danger" onclick="if(confirm('Delete this user?')) { deleteKey('USERS', '${keyName}'); document.getElementById('viewEditModal').remove(); }" style="margin-left: auto;">üóëÔ∏è Delete User</button>
              </div>
            </div>
          </div>
        `;
        
        const existing = document.getElementById('viewEditModal');
        if (existing) existing.remove();
        
        document.body.insertAdjacentHTML('beforeend', modal);
        
      } catch (err) {
        debugLog(`Error loading user: ${err.message}`, 'error');
        alert(`‚ùå Error: ${err.message}`);
      }
    }
    
    async function editUserJSON(keyName) {
      document.getElementById('viewEditModal').remove();
      viewAndEditKeyRaw('USERS', keyName);
    }
    
    async function viewAndEditKeyRaw(binding, keyName) {
      debugLog(`Loading key for editing: ${keyName} from ${binding}`);
      
      try {
        const res = await fetch(`${WORKER_URL}/kv/get?ns=${binding}&key=${encodeURIComponent(keyName)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
        
        const data = await res.json();
        const formatted = JSON.stringify(data, null, 2);
        
        const modal = `
          <div id="viewEditModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto;" onclick="event.stopPropagation()">
              <h2 style="color: #58a6ff; margin-bottom: 5px;">üìÑ ${keyName}</h2>
              <p style="color: #8b949e; font-size: 13px; margin-bottom: 20px;">Namespace: ${binding}</p>
              
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <label style="color: #8b949e; font-size: 13px;">Edit JSON:</label>
                  <button class="btn btn-small btn-secondary" onclick="formatJSON()">üîß Format</button>
                </div>
                <textarea id="jsonEditor" rows="20" style="width: 100%; padding: 15px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-family: Monaco, monospace; font-size: 12px; resize: vertical;">${formatted}</textarea>
              </div>
              
              <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="saveEditedKey('${binding}', '${keyName}')">üíæ Save Changes</button>
                <button class="btn btn-secondary" onclick="document.getElementById('viewEditModal').remove()">Cancel</button>
              </div>
            </div>
          </div>
        `;
        
        const existing = document.getElementById('viewEditModal');
        if (existing) existing.remove();
        
        document.body.insertAdjacentHTML('beforeend', modal);
        
      } catch (err) {
        debugLog(`Error loading key: ${err.message}`, 'error');
        alert(`‚ùå Error: ${err.message}`);
      }
    }
    
    function formatJSON() {
      try {
        const editor = document.getElementById('jsonEditor');
        const json = JSON.parse(editor.value);
        editor.value = JSON.stringify(json, null, 2);
      } catch (err) {
        alert('Invalid JSON: ' + err.message);
      }
    }
    
    async function saveEditedKey(binding, keyName) {
      const editor = document.getElementById('jsonEditor');
      
      try {
        const value = JSON.parse(editor.value);
        
        debugLog(`Saving changes to ${keyName}`);
        
        const res = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: binding,
            key: keyName,
            value: value
          })
        });
        
        if (res.ok) {
          debugLog(`‚úÖ Saved: ${keyName}`, 'success');
          alert('‚úÖ Changes saved successfully!');
          document.getElementById('viewEditModal').remove();
          loadAllNamespaces();
        } else {
          const error = await res.text();
          throw new Error(error);
        }
      } catch (err) {
        debugLog(`‚ùå Error: ${err.message}`, 'error');
        alert(`‚ùå Error: ${err.message}`);
      }
    }

    async function viewKey(binding, keyName) {
      // Just call the combined function
      viewAndEditKey(binding, keyName);
    }

    function showAddKeyForm(binding) {
      const modal = `
        <div id="addKeyModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
          <div style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%;" onclick="event.stopPropagation()">
            <h2 style="color: #58a6ff; margin-bottom: 20px;">‚ûï Add Key to ${binding}</h2>
            <div style="margin-bottom: 15px;">
              <label style="display: block; color: #8b949e; margin-bottom: 5px;">Key Name:</label>
              <input type="text" id="newKeyName" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-family: Monaco, monospace;">
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; color: #8b949e; margin-bottom: 5px;">Value (JSON):</label>
              <textarea id="newKeyValue" rows="10" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-family: Monaco, monospace; font-size: 12px;"></textarea>
            </div>
            <button class="btn" onclick="saveNewKey('${binding}')">üíæ Save</button>
            <button class="btn btn-secondary" onclick="document.getElementById('addKeyModal').remove()">Cancel</button>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modal);
    }

    async function saveNewKey(binding) {
      const keyName = document.getElementById('newKeyName').value;
      const keyValue = document.getElementById('newKeyValue').value;
      
      if (!keyName) {
        alert('Key name is required');
        return;
      }
      
      try {
        const value = keyValue ? JSON.parse(keyValue) : {};
        
        const res = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: binding,
            key: keyName,
            value: value
          })
        });
        
        if (res.ok) {
          alert('‚úÖ Key saved successfully');
          document.getElementById('addKeyModal').remove();
          loadAllNamespaces();
        } else {
          const error = await res.text();
          alert(`‚ùå Failed: ${error}`);
        }
      } catch (err) {
        alert(`‚ùå Error: ${err.message}`);
      }
    }

    function editKey(binding, keyName) {
      // Redirect to combined view/edit function
      viewAndEditKey(binding, keyName);
    }

    async function deleteKey(binding, keyName) {
      if (!confirm(`Delete key "${keyName}" from ${binding}?`)) return;

      try {
        const res = await fetch(`${WORKER_URL}/kv/delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: binding,
            key: keyName
          })
        });
        
        if (res.ok) {
          alert('‚úÖ Key deleted');
          loadAllNamespaces();
        } else {
          alert('‚ùå Failed to delete');
        }
      } catch (err) {
        alert(`‚ùå Error: ${err.message}`);
      }
    }

    async function clearNamespace(binding) {
      if (!confirm(`‚ö†Ô∏è Clear ALL keys from ${binding}?`)) return;

      try {
        statusDiv.textContent = `üîÑ Clearing ${binding}...`;
        statusDiv.className = 'status info';

        const response = await fetch(`${API_URL}/clear-namespace`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ namespace: binding })
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.textContent = `‚úÖ Cleared ${result.keysDeleted} keys from ${binding}`;
          statusDiv.className = 'status success';
          loadKVData(); // Refresh
        } else {
          statusDiv.textContent = `‚ùå Error: ${result.error}`;
          statusDiv.className = 'status error';
        }
      } catch (error) {
        statusDiv.textContent = `‚ùå Failed to clear namespace: ${error.message}`;
        statusDiv.className = 'status error';
      }
    }

    async function clearAllKV() {
      if (!confirm('‚ö†Ô∏è Delete ALL data from ALL KV namespaces?')) return;
      
      try {
        const res = await fetch(`${WORKER_URL}/clear-kv-all`, {
          method: 'POST'
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert(`‚úÖ Deleted ${data.totalKeysDeleted} keys across all namespaces`);
          loadAllNamespaces();
        } else {
          alert(`‚ùå Failed: ${data.error}`);
        }
      } catch (err) {
        alert(`‚ùå Error: ${err.message}`);
      }
    }

    function updateTotalKeys() {
      let total = 0;
      NAMESPACES.forEach(ns => {
        const data = nsData[ns.binding] || [];
        if (!data.error) {
          total += data.length || 0;
        }
      });
      document.getElementById('totalKeys').textContent = total;
    }

    // Random snake generator
    function generateRandomSnake() {
      const snakeData = createRandomSnakeData();
      showAddSnakeModal(snakeData);
    }
    
    function createRandomSnakeData() {
      const species = ['Ball Python', 'Corn Snake', 'Boa Constrictor', 'King Snake'];
      const morphs = ['Normal', 'Albino', 'Piebald', 'Banana', 'Pastel', 'Spider', 'Clown', 'Mojave', 'Lesser', 'Butter'];
      const genders = ['Male', 'Female', 'Unknown'];
      const names = ['Pudding', 'Noodle', 'Pretzel', 'Slinky', 'Ziggy', 'Apollo', 'Luna', 'Pepper', 'Mango', 'Kiwi', 'Basil', 'Sage'];
      
      const randomSpecies = species[Math.floor(Math.random() * species.length)];
      const randomMorph = morphs[Math.floor(Math.random() * morphs.length)];
      const randomGender = genders[Math.floor(Math.random() * genders.length)];
      const randomName = names[Math.floor(Math.random() * names.length)] + ' ' + Math.floor(Math.random() * 999);
      const randomYear = 2020 + Math.floor(Math.random() * 5);
      const randomWeight = (Math.random() * 2000 + 100).toFixed(0);
      const randomPrice = (Math.random() * 500 + 50).toFixed(2);
      
      return {
        id: `prod_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        name: randomName,
        species: randomSpecies,
        morph: randomMorph,
        gender: randomGender,
        year: randomYear,
        weight: randomWeight,
        price: parseFloat(randomPrice),
        currency: 'usd',
        status: 'available',
        createdAt: new Date().toISOString(),
        type: 'real'
      };
    }
    
    function createRandomUserData() {
      const firstNames = ['Alex', 'Sam', 'Jordan', 'Taylor', 'Morgan', 'Casey', 'Riley', 'Jamie', 'Avery', 'Quinn'];
      const lastNames = ['Smith', 'Johnson', 'Brown', 'Davis', 'Wilson', 'Garcia', 'Martinez', 'Lee', 'Kim', 'Chen'];
      const tags = ['b2c_beginner', 'b2c_collector', 'b2b_breeder', 'b2b_shop', 'b2b_importer'];
      
      const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
      const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
      const randomTag = tags[Math.floor(Math.random() * tags.length)];
      const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      return {
        id: userId,
        hash: userId, // Use same as hash for simplicity
        name: `${firstName} ${lastName}`,
        email: `${firstName.toLowerCase()}.${lastName.toLowerCase()}@example.com`,
        tag: randomTag,
        createdAt: new Date().toISOString(),
        purchaseCount: 0
      };
    }
    
    function generateUserWithSnake() {
      const user = createRandomUserData();
      const snake = createRandomSnakeData();
      snake.type = 'real'; // Ensure it's a real snake
      
      showUserSnakeModal(user, snake);
    }
    
    function showUserSnakeModal(user, snake) {
      const modal = `
        <div id="userSnakeModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
          <div style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; max-width: 800px; width: 90%; margin: 20px;" onclick="event.stopPropagation()">
            <h2 style="color: #58a6ff; margin-bottom: 20px;">üë§ Create User + Assign Snake</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <!-- User Section -->
              <div style="background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d;">
                <h3 style="color: #58a6ff; margin-bottom: 15px; font-size: 16px;">üë§ User</h3>
                
                <div style="margin-bottom: 10px;">
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 12px;">Name:</label>
                  <input type="text" id="userName" value="${user.name}" style="width: 100%; padding: 8px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 13px;">
                </div>
                
                <div style="margin-bottom: 10px;">
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 12px;">Email:</label>
                  <input type="email" id="userEmail" value="${user.email}" style="width: 100%; padding: 8px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 13px;">
                </div>
                
                <div style="margin-bottom: 10px;">
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 12px;">Tag:</label>
                  <select id="userTag" style="width: 100%; padding: 8px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 13px;">
                    <option value="b2c_beginner" ${user.tag === 'b2c_beginner' ? 'selected' : ''}>B2C - Beginner</option>
                    <option value="b2c_collector" ${user.tag === 'b2c_collector' ? 'selected' : ''}>B2C - Collector</option>
                    <option value="b2b_breeder" ${user.tag === 'b2b_breeder' ? 'selected' : ''}>B2B - Breeder</option>
                    <option value="b2b_shop" ${user.tag === 'b2b_shop' ? 'selected' : ''}>B2B - Shop</option>
                    <option value="b2b_importer" ${user.tag === 'b2b_importer' ? 'selected' : ''}>B2B - Importer</option>
                  </select>
                </div>
                
                <div style="margin-bottom: 10px;">
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 12px;">User ID:</label>
                  <input type="text" id="userId" value="${user.id}" style="width: 100%; padding: 8px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-family: Monaco, monospace; font-size: 11px;">
                </div>
              </div>
              
              <!-- Snake Section -->
              <div style="background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d;">
                <h3 style="color: #58a6ff; margin-bottom: 15px; font-size: 16px;">üêç Snake</h3>
                
                <div style="margin-bottom: 10px;">
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 12px;">Name:</label>
                  <input type="text" id="snakeName2" value="${snake.name}" style="width: 100%; padding: 8px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 13px;">
                </div>
                
                <div style="margin-bottom: 10px;">
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 12px;">Species:</label>
                  <input type="text" id="snakeSpecies2" value="${snake.species}" style="width: 100%; padding: 8px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 13px;">
                </div>
                
                <div style="margin-bottom: 10px;">
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 12px;">Morph:</label>
                  <input type="text" id="snakeMorph2" value="${snake.morph}" style="width: 100%; padding: 8px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 13px;">
                </div>
                
                <div style="margin-bottom: 10px;">
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 12px;">Price:</label>
                  <input type="number" step="0.01" id="snakePrice2" value="${snake.price}" style="width: 100%; padding: 8px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 13px;">
                </div>
                
                <div style="margin-bottom: 10px;">
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 12px;">Product ID:</label>
                  <input type="text" id="snakeId2" value="${snake.id}" style="width: 100%; padding: 8px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-family: Monaco, monospace; font-size: 11px;">
                </div>
              </div>
            </div>
            
            <div style="margin-top: 20px;">
              <button class="btn" onclick="saveUserAndSnake()">üíæ Create User + Assign Snake</button>
              <button class="btn" onclick="generateUserWithSnake()">üé≤ Randomize Both</button>
              <button class="btn btn-secondary" onclick="document.getElementById('userSnakeModal').remove()">Cancel</button>
            </div>
          </div>
        </div>
      `;
      
      const existing = document.getElementById('userSnakeModal');
      if (existing) existing.remove();
      
      document.body.insertAdjacentHTML('beforeend', modal);
    }
    
    // Step-by-Step Wizard
    let wizardData = { step: 1, user: null, snake: null };
    
    function startWizard() {
      wizardData = { step: 1, user: createRandomUserData(), snake: null };
      showWizardStep1();
    }
    
    function showWizardStep1() {
      const user = wizardData.user;
      
      const modal = `
        <div id="wizardModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
          <div class="wizard-container" style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; width: 90%; margin: 20px;" onclick="event.stopPropagation()">
            <h2 style="color: #58a6ff; margin-bottom: 20px;">üßô Assignment Wizard</h2>
            
            <div class="wizard-steps">
              <div class="wizard-step active">
                <div class="step-number">1</div>
                <div class="step-label">Create User</div>
              </div>
              <div class="wizard-step">
                <div class="step-number">2</div>
                <div class="step-label">Create Snake</div>
              </div>
              <div class="wizard-step">
                <div class="step-number">3</div>
                <div class="step-label">Assign</div>
              </div>
            </div>
            
            <div style="background: #0d1117; padding: 25px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 25px;">
              <h3 style="color: #58a6ff; margin-bottom: 20px; font-size: 18px;">üë§ Step 1: Create User</h3>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Name:</label>
                  <input type="text" id="wiz_userName" value="${user.name}" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                </div>
                
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Email:</label>
                  <input type="email" id="wiz_userEmail" value="${user.email}" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                </div>
                
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Tag:</label>
                  <select id="wiz_userTag" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                    <option value="b2c_beginner" ${user.tag === 'b2c_beginner' ? 'selected' : ''}>B2C - Beginner</option>
                    <option value="b2c_collector" ${user.tag === 'b2c_collector' ? 'selected' : ''}>B2C - Collector</option>
                    <option value="b2b_breeder" ${user.tag === 'b2b_breeder' ? 'selected' : ''}>B2B - Breeder</option>
                    <option value="b2b_shop" ${user.tag === 'b2b_shop' ? 'selected' : ''}>B2B - Shop</option>
                    <option value="b2b_importer" ${user.tag === 'b2b_importer' ? 'selected' : ''}>B2B - Importer</option>
                  </select>
                </div>
                
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">User ID:</label>
                  <input type="text" id="wiz_userId" value="${user.id}" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-family: Monaco, monospace; font-size: 12px;">
                </div>
              </div>
            </div>
            
            <div style="display: flex; justify-content: space-between;">
              <button class="btn btn-secondary" onclick="document.getElementById('wizardModal').remove()">Cancel</button>
              <div>
                <button class="btn btn-secondary" onclick="wizardData.user = createRandomUserData(); showWizardStep1();">üé≤ Randomize</button>
                <button class="btn" onclick="saveWizardStep1()">Next: Create Snake ‚Üí</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      const existing = document.getElementById('wizardModal');
      if (existing) existing.remove();
      
      document.body.insertAdjacentHTML('beforeend', modal);
    }
    
    function saveWizardStep1() {
      wizardData.user = {
        id: document.getElementById('wiz_userId').value,
        hash: document.getElementById('wiz_userId').value,
        name: document.getElementById('wiz_userName').value,
        email: document.getElementById('wiz_userEmail').value,
        tag: document.getElementById('wiz_userTag').value,
        createdAt: new Date().toISOString(),
        purchaseCount: 0
      };
      
      if (!wizardData.user.name || !wizardData.user.email) {
        alert('Name and email are required');
        return;
      }
      
      wizardData.step = 2;
      wizardData.snake = createRandomSnakeData();
      showWizardStep2();
    }
    
    function showWizardStep2() {
      const snake = wizardData.snake;
      
      const modal = `
        <div id="wizardModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
          <div class="wizard-container" style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; width: 90%; margin: 20px;" onclick="event.stopPropagation()">
            <h2 style="color: #58a6ff; margin-bottom: 20px;">üßô Assignment Wizard</h2>
            
            <div class="wizard-steps">
              <div class="wizard-step completed">
                <div class="step-number">‚úì</div>
                <div class="step-label">User Created</div>
              </div>
              <div class="wizard-step active">
                <div class="step-number">2</div>
                <div class="step-label">Create Snake</div>
              </div>
              <div class="wizard-step">
                <div class="step-number">3</div>
                <div class="step-label">Assign</div>
              </div>
            </div>
            
            <div style="background: #0d1117; padding: 25px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 25px;">
              <h3 style="color: #58a6ff; margin-bottom: 20px; font-size: 18px;">üêç Step 2: Create Snake</h3>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Name:</label>
                  <input type="text" id="wiz_snakeName" value="${snake.name}" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                </div>
                
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Species:</label>
                  <select id="wiz_snakeSpecies" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                    <option value="Ball Python" ${snake.species === 'Ball Python' ? 'selected' : ''}>Ball Python</option>
                    <option value="Corn Snake" ${snake.species === 'Corn Snake' ? 'selected' : ''}>Corn Snake</option>
                    <option value="Boa Constrictor" ${snake.species === 'Boa Constrictor' ? 'selected' : ''}>Boa Constrictor</option>
                    <option value="King Snake" ${snake.species === 'King Snake' ? 'selected' : ''}>King Snake</option>
                  </select>
                </div>
                
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Morph:</label>
                  <input type="text" id="wiz_snakeMorph" value="${snake.morph}" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                </div>
                
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Price ($):</label>
                  <input type="number" step="0.01" id="wiz_snakePrice" value="${snake.price}" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                </div>
                
                <div style="grid-column: 1 / -1;">
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Product ID:</label>
                  <input type="text" id="wiz_snakeId" value="${snake.id}" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-family: Monaco, monospace; font-size: 12px;">
                </div>
              </div>
            </div>
            
            <div style="display: flex; justify-content: space-between;">
              <button class="btn btn-secondary" onclick="showWizardStep1()">‚Üê Back</button>
              <div>
                <button class="btn btn-secondary" onclick="wizardData.snake = createRandomSnakeData(); showWizardStep2();">üé≤ Randomize</button>
                <button class="btn" onclick="saveWizardStep2()">Next: Review & Assign ‚Üí</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      const existing = document.getElementById('wizardModal');
      if (existing) existing.remove();
      
      document.body.insertAdjacentHTML('beforeend', modal);
    }
    
    function saveWizardStep2() {
      wizardData.snake = {
        id: document.getElementById('wiz_snakeId').value,
        name: document.getElementById('wiz_snakeName').value,
        species: document.getElementById('wiz_snakeSpecies').value,
        morph: document.getElementById('wiz_snakeMorph').value,
        price: parseFloat(document.getElementById('wiz_snakePrice').value),
        currency: 'usd',
        status: 'sold',
        createdAt: new Date().toISOString()
      };
      
      if (!wizardData.snake.name || !wizardData.snake.id) {
        alert('Snake name and ID are required');
        return;
      }
      
      wizardData.step = 3;
      showWizardStep3();
    }
    
    function showWizardStep3() {
      const user = wizardData.user;
      const snake = wizardData.snake;
      
      const modal = `
        <div id="wizardModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
          <div class="wizard-container" style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; width: 90%; margin: 20px;" onclick="event.stopPropagation()">
            <h2 style="color: #58a6ff; margin-bottom: 20px;">üßô Assignment Wizard</h2>
            
            <div class="wizard-steps">
              <div class="wizard-step completed">
                <div class="step-number">‚úì</div>
                <div class="step-label">User Created</div>
              </div>
              <div class="wizard-step completed">
                <div class="step-number">‚úì</div>
                <div class="step-label">Snake Created</div>
              </div>
              <div class="wizard-step active">
                <div class="step-number">3</div>
                <div class="step-label">Assign</div>
              </div>
            </div>
            
            <div style="background: #0d1117; padding: 25px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 25px;">
              <h3 style="color: #58a6ff; margin-bottom: 20px; font-size: 18px;">‚úÖ Step 3: Review & Assign</h3>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="background: #161b22; padding: 15px; border-radius: 6px; border: 1px solid #30363d;">
                  <h4 style="color: #58a6ff; margin-bottom: 10px; font-size: 14px;">üë§ User</h4>
                  <div style="color: #c9d1d9; font-size: 13px; line-height: 1.8;">
                    <strong>Name:</strong> ${user.name}<br>
                    <strong>Email:</strong> ${user.email}<br>
                    <strong>Tag:</strong> ${user.tag}<br>
                    <strong>ID:</strong> <span style="font-family: Monaco; font-size: 11px;">${user.id}</span>
                  </div>
                </div>
                
                <div style="background: #161b22; padding: 15px; border-radius: 6px; border: 1px solid #30363d;">
                  <h4 style="color: #58a6ff; margin-bottom: 10px; font-size: 14px;">üêç Snake</h4>
                  <div style="color: #c9d1d9; font-size: 13px; line-height: 1.8;">
                    <strong>Name:</strong> ${snake.name}<br>
                    <strong>Species:</strong> ${snake.species}<br>
                    <strong>Morph:</strong> ${snake.morph}<br>
                    <strong>Price:</strong> $${snake.price.toFixed(2)}<br>
                    <strong>ID:</strong> <span style="font-family: Monaco; font-size: 11px;">${snake.id}</span>
                  </div>
                </div>
              </div>
              
              <div style="background: #238636; padding: 15px; border-radius: 6px; margin-top: 20px; text-align: center;">
                <p style="color: white; font-size: 14px; margin: 0;">
                  This will create the user, add the snake to inventory, and assign ownership
                </p>
              </div>
            </div>
            
            <div style="display: flex; justify-content: space-between;">
              <button class="btn btn-secondary" onclick="showWizardStep2()">‚Üê Back</button>
              <button class="btn" onclick="executeWizardAssignment()" style="background: #238636;">‚úÖ Create & Assign</button>
            </div>
          </div>
        </div>
      `;
      
      const existing = document.getElementById('wizardModal');
      if (existing) existing.remove();
      
      document.body.insertAdjacentHTML('beforeend', modal);
    }
    
    async function executeWizardAssignment() {
      const user = wizardData.user;
      const snake = wizardData.snake;
      
      debugLog('üßô Starting wizard assignment...');
      
      try {
        // Step 1: Save snake
        debugLog('1/4: Creating snake in PRODUCTS_REAL');
        const snakeRes = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: 'PRODUCTS_REAL',
            key: `product:${snake.id}`,
            value: snake
          })
        });
        if (!snakeRes.ok) throw new Error('Failed to create snake');
        
        // Step 2: Save user
        debugLog('2/4: Creating user in USERS');
        user.purchaseCount = 1;
        const userRes = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: 'USERS',
            key: `user:${user.hash}`,
            value: user
          })
        });
        if (!userRes.ok) throw new Error('Failed to create user');
        
        // Step 3: Assign snake to user
        debugLog('3/4: Assigning snake to user in USER_PRODUCTS');
        const assignRes = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: 'USER_PRODUCTS',
            key: `user:${user.hash}`,
            value: {
              userId: user.hash,
              products: [snake.id],
              lastUpdated: new Date().toISOString()
            }
          })
        });
        if (!assignRes.ok) throw new Error('Failed to assign snake');
        
        // Step 4: Mark as sold
        debugLog('4/4: Marking snake as sold in PRODUCT_STATUS');
        const statusRes = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: 'PRODUCT_STATUS',
            key: `status:${snake.id}`,
            value: {
              productId: snake.id,
              status: 'sold',
              soldTo: user.hash,
              soldAt: new Date().toISOString()
            }
          })
        });
        if (!statusRes.ok) throw new Error('Failed to update status');
        
        debugLog('‚úÖ Wizard completed successfully!', 'success');
        
        alert(`‚úÖ Success!\n\nüë§ User: ${user.name}\nüêç Snake: ${snake.name}\n\n‚ú® Assignment complete!`);
        
        document.getElementById('wizardModal').remove();
        loadAllNamespaces();
        
      } catch (err) {
        debugLog(`‚ùå Wizard error: ${err.message}`, 'error');
        alert(`‚ùå Error: ${err.message}`);
      }
    }

    async function saveUserAndSnake() {
      const user = {
        id: document.getElementById('userId').value,
        hash: document.getElementById('userId').value,
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        tag: document.getElementById('userTag').value,
        createdAt: new Date().toISOString(),
        purchaseCount: 1
      };
      
      const snake = {
        id: document.getElementById('snakeId2').value,
        name: document.getElementById('snakeName2').value,
        species: document.getElementById('snakeSpecies2').value,
        morph: document.getElementById('snakeMorph2').value,
        price: parseFloat(document.getElementById('snakePrice2').value),
        currency: 'usd',
        status: 'sold',
        createdAt: new Date().toISOString()
      };
      
      if (!user.name || !user.id || !snake.name || !snake.id) {
        alert('All required fields must be filled');
        return;
      }
      
      debugLog(`Creating user ${user.name} and assigning snake ${snake.name}`);
      
      try {
        // 1. Save snake to PRODUCTS_REAL
        debugLog('1/4: Saving snake to PRODUCTS_REAL');
        const snakeRes = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: 'PRODUCTS_REAL',
            key: `product:${snake.id}`,
            value: snake
          })
        });
        if (!snakeRes.ok) throw new Error('Failed to save snake');
        
        // 2. Save user to USERS
        debugLog('2/4: Saving user to USERS');
        const userRes = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: 'USERS',
            key: `user:${user.hash}`,
            value: user
          })
        });
        if (!userRes.ok) throw new Error('Failed to save user');
        
        // 3. Assign snake to user in USER_PRODUCTS
        debugLog('3/4: Assigning snake to user');
        const assignRes = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: 'USER_PRODUCTS',
            key: `user:${user.hash}`,
            value: {
              userId: user.hash,
              products: [snake.id],
              lastUpdated: new Date().toISOString()
            }
          })
        });
        if (!assignRes.ok) throw new Error('Failed to assign snake to user');
        
        // 4. Mark snake as sold in PRODUCT_STATUS
        debugLog('4/4: Marking snake as sold');
        const statusRes = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: 'PRODUCT_STATUS',
            key: `status:${snake.id}`,
            value: {
              productId: snake.id,
              status: 'sold',
              soldTo: user.hash,
              soldAt: new Date().toISOString()
            }
          })
        });
        if (!statusRes.ok) throw new Error('Failed to update product status');
        
        debugLog(`‚úÖ Success! User ${user.name} now owns ${snake.name}`, 'success');
        alert(`‚úÖ Success!\n\nUser: ${user.name}\nSnake: ${snake.name}\n\nAll data saved to KV storage.`);
        document.getElementById('userSnakeModal').remove();
        loadAllNamespaces();
        
      } catch (err) {
        debugLog(`‚ùå Error: ${err.message}`, 'error');
        alert(`‚ùå Error: ${err.message}`);
      }
    }

    function showAddSnakeModal(prefillData = null) {
      const data = prefillData || {};
      
      const modal = `
        <div id="addSnakeModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
          <div style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; margin: 20px;" onclick="event.stopPropagation()">
            <h2 style="color: #58a6ff; margin-bottom: 20px;">üêç Add Snake</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div style="grid-column: 1 / -1;">
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">Name:</label>
                <input type="text" id="snakeName" value="${data.name || ''}" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
              </div>
              
              <div>
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">Species:</label>
                <select id="snakeSpecies" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                  <option value="Ball Python" ${data.species === 'Ball Python' ? 'selected' : ''}>Ball Python</option>
                  <option value="Corn Snake" ${data.species === 'Corn Snake' ? 'selected' : ''}>Corn Snake</option>
                  <option value="Boa Constrictor" ${data.species === 'Boa Constrictor' ? 'selected' : ''}>Boa Constrictor</option>
                  <option value="King Snake" ${data.species === 'King Snake' ? 'selected' : ''}>King Snake</option>
                </select>
              </div>
              
              <div>
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">Morph:</label>
                <input type="text" id="snakeMorph" value="${data.morph || ''}" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
              </div>
              
              <div>
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">Gender:</label>
                <select id="snakeGender" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                  <option value="Male" ${data.gender === 'Male' ? 'selected' : ''}>Male</option>
                  <option value="Female" ${data.gender === 'Female' ? 'selected' : ''}>Female</option>
                  <option value="Unknown" ${data.gender === 'Unknown' ? 'selected' : ''}>Unknown</option>
                </select>
              </div>
              
              <div>
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">Year Born:</label>
                <input type="number" id="snakeYear" value="${data.year || new Date().getFullYear()}" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
              </div>
              
              <div>
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">Weight (g):</label>
                <input type="number" id="snakeWeight" value="${data.weight || ''}" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
              </div>
              
              <div>
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">Price ($):</label>
                <input type="number" step="0.01" id="snakePrice" value="${data.price || ''}" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
              </div>
              
              <div>
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">Type:</label>
                <select id="snakeType" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                  <option value="real" ${data.type === 'real' ? 'selected' : ''}>Real (PRODUCTS_REAL)</option>
                  <option value="virtual" ${data.type === 'virtual' ? 'selected' : ''}>Virtual (PRODUCTS_VIRTUAL)</option>
                </select>
              </div>
              
              <div style="grid-column: 1 / -1;">
                <label style="display: block; color: #8b949e; margin-bottom: 5px;">Product ID:</label>
                <input type="text" id="snakeId" value="${data.id || `prod_${Date.now()}`}" style="width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-family: Monaco, monospace; font-size: 12px;">
              </div>
            </div>
            
            <div style="margin-top: 20px;">
              <button class="btn" onclick="saveSnake()">üíæ Save Snake</button>
              <button class="btn" onclick="generateRandomSnake()">üé≤ Randomize</button>
              <button class="btn btn-secondary" onclick="document.getElementById('addSnakeModal').remove()">Cancel</button>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existing = document.getElementById('addSnakeModal');
      if (existing) existing.remove();
      
      document.body.insertAdjacentHTML('beforeend', modal);
    }

    async function saveSnake() {
      const snake = {
        id: document.getElementById('snakeId').value,
        name: document.getElementById('snakeName').value,
        species: document.getElementById('snakeSpecies').value,
        morph: document.getElementById('snakeMorph').value,
        gender: document.getElementById('snakeGender').value,
        year: parseInt(document.getElementById('snakeYear').value),
        weight: parseInt(document.getElementById('snakeWeight').value),
        price: parseFloat(document.getElementById('snakePrice').value),
        currency: 'usd',
        status: 'available',
        createdAt: new Date().toISOString(),
        type: document.getElementById('snakeType').value
      };
      
      if (!snake.name || !snake.id) {
        alert('Name and ID are required');
        return;
      }
      
      const namespace = snake.type === 'virtual' ? 'PRODUCTS_VIRTUAL' : 'PRODUCTS_REAL';
      const key = `product:${snake.id}`;
      
      debugLog(`Saving snake: ${snake.name} to ${namespace}`);
      
      try {
        const res = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: namespace,
            key: key,
            value: snake
          })
        });
        
        if (res.ok) {
          debugLog(`‚úÖ Saved: ${snake.name}`, 'success');
          alert(`‚úÖ Snake "${snake.name}" saved successfully!`);
          document.getElementById('addSnakeModal').remove();
          loadAllNamespaces();
        } else {
          const error = await res.text();
          debugLog(`‚ùå Failed: ${error}`, 'error');
          alert(`‚ùå Failed: ${error}`);
        }
      } catch (err) {
        debugLog(`‚ùå Error: ${err.message}`, 'error');
        alert(`‚ùå Error: ${err.message}`);
      }
    }
    
    // Select Existing User
    async function selectExistingUser() {
      debugLog('Loading existing users...');
      
      try {
        const res = await fetch(`${WORKER_URL}/kv/users/list`);
        if (!res.ok) throw new Error('Failed to fetch users');
        
        const keys = await res.json();
        
        if (keys.length === 0) {
          alert('No users found. Create a user first using the wizard.');
          return;
        }
        
        // Fetch all user data
        const users = [];
        for (const key of keys) {
          try {
            const userRes = await fetch(`${WORKER_URL}/kv/get?ns=USERS&key=${encodeURIComponent(key.name)}`);
            if (userRes.ok) {
              const userData = await userRes.json();
              users.push({ key: key.name, ...userData });
            }
          } catch (err) {
            console.error(`Failed to fetch user ${key.name}:`, err);
          }
        }
        
        const usersHtml = users.map(u => `
          <div class="user-card" onclick="selectUserForActions('${u.key}')" style="background: #161b22; border: 2px solid #30363d; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="color: #58a6ff; font-weight: 600; font-size: 16px; margin-bottom: 5px;">${u.name || 'Unknown'}</div>
                <div style="color: #8b949e; font-size: 13px; margin-bottom: 3px;">${u.email || ''}</div>
                <div style="color: #8b949e; font-size: 12px;">
                  <span style="background: #30363d; padding: 2px 8px; border-radius: 12px; margin-right: 5px;">${formatUserTag(u.tag || '')}</span>
                  <span style="font-family: Monaco; font-size: 11px;">${u.id || u.key}</span>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="color: #58a6ff; font-size: 24px;">‚Üí</div>
              </div>
            </div>
          </div>
        `).join('');
        
        const modal = `
          <div id="selectUserModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
              <h2 style="color: #58a6ff; margin-bottom: 10px;">üë§ Select Existing User</h2>
              <p style="color: #8b949e; margin-bottom: 20px; font-size: 14px;">Click on a user to assign snakes or perform actions</p>
              
              <div style="margin-bottom: 20px;">
                ${usersHtml}
              </div>
              
              <button class="btn btn-secondary" onclick="document.getElementById('selectUserModal').remove()">Cancel</button>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
        
        // Add hover effect
        document.querySelectorAll('.user-card').forEach(card => {
          card.addEventListener('mouseenter', () => {
            card.style.borderColor = '#58a6ff';
            card.style.background = '#1c2128';
          });
          card.addEventListener('mouseleave', () => {
            card.style.borderColor = '#30363d';
            card.style.background = '#161b22';
          });
        });
        
      } catch (err) {
        debugLog(`Error loading users: ${err.message}`, 'error');
        alert(`‚ùå Error: ${err.message}`);
      }
    }
    
    async function selectUserForActions(userKey) {
      document.getElementById('selectUserModal').remove();
      
      debugLog(`Loading user actions for: ${userKey}`);
      
      try {
        // Fetch user data
        const userRes = await fetch(`${WORKER_URL}/kv/get?ns=USERS&key=${encodeURIComponent(userKey)}`);
        if (!userRes.ok) throw new Error('Failed to fetch user');
        const user = await userRes.json();
        
        // Fetch user's products
        const userId = userKey.replace('user:', '');
        const productsRes = await fetch(`${WORKER_URL}/kv/get?ns=USER_PRODUCTS&key=user:${userId}`);
        let userProducts = { products: [] };
        if (productsRes.ok) {
          userProducts = await productsRes.json();
        }
        
        const modal = `
          <div id="userActionsModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%;" onclick="event.stopPropagation()">
              <h2 style="color: #58a6ff; margin-bottom: 5px;">üë§ ${user.name || 'User'}</h2>
              <p style="color: #8b949e; font-size: 13px; margin-bottom: 20px;">${user.email || ''}</p>
              
              <div style="background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                  <div>
                    <div style="color: #8b949e; font-size: 12px; margin-bottom: 5px;">Tag</div>
                    <div style="color: #c9d1d9; font-weight: 600;">${formatUserTag(user.tag || '')}</div>
                  </div>
                  <div>
                    <div style="color: #8b949e; font-size: 12px; margin-bottom: 5px;">Products Owned</div>
                    <div style="color: #c9d1d9; font-weight: 600;">${userProducts.products.length}</div>
                  </div>
                </div>
              </div>
              
              <h3 style="color: #58a6ff; margin-bottom: 15px; font-size: 16px;">Actions</h3>
              
              <div style="display: grid; gap: 10px; margin-bottom: 20px;">
                <button class="btn" onclick="assignSnakeToUser('${userKey}', '${user.name}')">
                  üêç Assign New Snake
                </button>
                <button class="btn btn-secondary" onclick="viewUserFullDetails('${userKey}')">
                  üëÅÔ∏è View Full Details
                </button>
                <button class="btn btn-secondary" onclick="window.open('${window.location.origin}/index.html?user=${userId}', '_blank')">
                  üé≠ Impersonate User
                </button>
                <button class="btn btn-secondary" onclick="editUserJSON('${userKey}')">
                  ‚úèÔ∏è Edit User Data
                </button>
              </div>
              
              <button class="btn btn-secondary" onclick="document.getElementById('userActionsModal').remove()">Close</button>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
        
      } catch (err) {
        debugLog(`Error: ${err.message}`, 'error');
        alert(`‚ùå Error: ${err.message}`);
      }
    }
    
    async function assignSnakeToUser(userKey, userName) {
      document.getElementById('userActionsModal').remove();
      
      const snake = createRandomSnakeData();
      const userId = userKey.replace('user:', '');
      
      const modal = `
        <div id="assignSnakeModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
          <div style="background: #161b22; border: 2px solid #30363d; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; margin: 20px;" onclick="event.stopPropagation()">
            <h2 style="color: #58a6ff; margin-bottom: 10px;">üêç Assign Snake to ${userName}</h2>
            <p style="color: #8b949e; font-size: 13px; margin-bottom: 20px;">Create a new snake and assign it to this user</p>
            
            <div style="background: #0d1117; padding: 20px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 20px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Name:</label>
                  <input type="text" id="assign_snakeName" value="${snake.name}" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                </div>
                
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Species:</label>
                  <select id="assign_snakeSpecies" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                    <option value="Ball Python" ${snake.species === 'Ball Python' ? 'selected' : ''}>Ball Python</option>
                    <option value="Corn Snake" ${snake.species === 'Corn Snake' ? 'selected' : ''}>Corn Snake</option>
                    <option value="Boa Constrictor" ${snake.species === 'Boa Constrictor' ? 'selected' : ''}>Boa Constrictor</option>
                    <option value="King Snake" ${snake.species === 'King Snake' ? 'selected' : ''}>King Snake</option>
                  </select>
                </div>
                
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Morph:</label>
                  <input type="text" id="assign_snakeMorph" value="${snake.morph}" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                </div>
                
                <div>
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Price ($):</label>
                  <input type="number" step="0.01" id="assign_snakePrice" value="${snake.price}" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                </div>
                
                <div style="grid-column: 1 / -1;">
                  <label style="display: block; color: #8b949e; margin-bottom: 5px; font-size: 13px;">Product ID:</label>
                  <input type="text" id="assign_snakeId" value="${snake.id}" style="width: 100%; padding: 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-family: Monaco, monospace; font-size: 12px;">
                </div>
              </div>
            </div>
            
            <div style="display: flex; justify-content: space-between;">
              <button class="btn btn-secondary" onclick="document.getElementById('assignSnakeModal').remove()">Cancel</button>
              <div>
                <button class="btn btn-secondary" onclick="randomizeAssignSnake()">üé≤ Randomize</button>
                <button class="btn" onclick="saveAssignedSnake('${userId}')">üíæ Assign Snake</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modal);
    }
    
    function randomizeAssignSnake() {
      const snake = createRandomSnakeData();
      document.getElementById('assign_snakeName').value = snake.name;
      document.getElementById('assign_snakeSpecies').value = snake.species;
      document.getElementById('assign_snakeMorph').value = snake.morph;
      document.getElementById('assign_snakePrice').value = snake.price;
      document.getElementById('assign_snakeId').value = snake.id;
    }
    
    async function saveAssignedSnake(userId) {
      const snake = {
        id: document.getElementById('assign_snakeId').value,
        name: document.getElementById('assign_snakeName').value,
        species: document.getElementById('assign_snakeSpecies').value,
        morph: document.getElementById('assign_snakeMorph').value,
        price: parseFloat(document.getElementById('assign_snakePrice').value),
        currency: 'usd',
        status: 'sold',
        createdAt: new Date().toISOString()
      };
      
      if (!snake.name || !snake.id) {
        alert('Name and ID are required');
        return;
      }
      
      debugLog(`Assigning snake ${snake.name} to user ${userId}`);
      
      try {
        // 1. Save snake
        debugLog('1/3: Creating snake');
        const snakeRes = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: 'PRODUCTS_REAL',
            key: `product:${snake.id}`,
            value: snake
          })
        });
        if (!snakeRes.ok) throw new Error('Failed to create snake');
        
        // 2. Get existing products for user
        debugLog('2/3: Fetching user products');
        const productsRes = await fetch(`${WORKER_URL}/kv/get?ns=USER_PRODUCTS&key=user:${userId}`);
        let userProducts = { products: [] };
        if (productsRes.ok) {
          userProducts = await productsRes.json();
        }
        
        // Add new product
        userProducts.products.push(snake.id);
        userProducts.userId = userId;
        userProducts.lastUpdated = new Date().toISOString();
        
        debugLog('3/3: Updating user products');
        const updateRes = await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: 'USER_PRODUCTS',
            key: `user:${userId}`,
            value: userProducts
          })
        });
        if (!updateRes.ok) throw new Error('Failed to update user products');
        
        // Update status
        await fetch(`${WORKER_URL}/kv/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            namespace: 'PRODUCT_STATUS',
            key: `status:${snake.id}`,
            value: {
              productId: snake.id,
              status: 'sold',
              soldTo: userId,
              soldAt: new Date().toISOString()
            }
          })
        });
        
        debugLog('‚úÖ Snake assigned successfully!', 'success');
        alert(`‚úÖ Snake "${snake.name}" assigned successfully!`);
        document.getElementById('assignSnakeModal').remove();
        loadAllNamespaces();
        
      } catch (err) {
        debugLog(`‚ùå Error: ${err.message}`, 'error');
        alert(`‚ùå Error: ${err.message}`);
      }
    }
    
    function viewUserFullDetails(userKey) {
      document.getElementById('userActionsModal').remove();
      viewAndEditKey('USERS', userKey);
    }

    // Load on page load
    loadAllNamespaces();
  </script>
</body>
</html>
