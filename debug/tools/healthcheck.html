<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè• SMRI Health Check - Snake Muffin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 { color: #58a6ff; margin-bottom: 10px; font-size: 24px; }
    
    .subtitle {
      color: #8b949e;
      margin-bottom: 20px;
      font-size: 13px;
    }
    
    .btn {
      background: #238636;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    
    .btn:hover { background: #2ea043; }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .service-group {
      margin-bottom: 30px;
    }
    
    .service-header {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .service-header h2 {
      flex: 1;
      font-size: 18px;
      color: #c9d1d9;
    }
    
    .service-badge {
      background: #21262d;
      color: #8b949e;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .test-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      margin-bottom: 10px;
      overflow: hidden;
      margin-left: 20px;
    }
    
    .test-header {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      user-select: none;
    }
    
    .test-header:hover { background: #1c2128; }
    
    .test-number {
      background: #21262d;
      color: #8b949e;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      min-width: 35px;
      text-align: center;
    }
    
    .test-method {
      background: #238636;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      min-width: 45px;
      text-align: center;
    }
    
    .test-title { flex: 1; font-weight: 500; }
    
    .test-status {
      font-size: 18px;
    }
    
    .test-body {
      display: none;
      padding: 16px;
      border-top: 1px solid #30363d;
      background: #0d1117;
    }
    
    .test-body.show { display: block; }
    
    .test-section {
      margin-bottom: 16px;
    }
    
    .test-section h4 {
      color: #8b949e;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .code-block {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      line-height: 1.5;
    }
    
    .progress-bar {
      background: #161b22;
      border-radius: 10px;
      height: 24px;
      overflow: hidden;
      margin: 15px 0;
      border: 2px solid #30363d;
      display: none;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #238636, #2ea043);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease-out;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    
    .progress-text {
      color: #58a6ff;
      font-size: 12px;
      font-weight: bold;
      margin-top: 10px;
      display: none;
    }
    
    .status-ok { color: #3fb950; }
    .status-warn { color: #d29922; }
    .status-error { color: #f85149; }
    
    .run-btn-container {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>üè• API Endpoint Health Check</h1>
  <p class="subtitle">
    <strong>Purpose:</strong> Test all API endpoints for SMRI scenarios | <strong>Tests:</strong> 25+ endpoints | <strong>Coverage:</strong> Worker, KV, Stripe, GitHub<br>
    <span style="display: inline-flex; align-items: center; gap: 8px; margin-top: 5px;">
      <span style="background: #238636; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">‚òÅÔ∏è 4 Worker</span>
      <span style="background: #1f6feb; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">üóÑÔ∏è 10 KV</span>
      <span style="background: #8957e5; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">üí≥ 5 Stripe</span>
      <span style="background: #6e7681; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">‚öôÔ∏è 3 GitHub</span>
      <span style="background: #d29922; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">üîó 3 Webhooks</span>
    </span><br>
    <a href="data-manager.html" style="color: #58a6ff; text-decoration: none; font-size: 12px;">üìä Data Manager</a> | 
    <a href="index.html" style="color: #58a6ff; text-decoration: none; font-size: 12px;">üè† Debug Hub</a>
  </p>
  
  <div class="run-btn-container">
    <button onclick="runAllTests()" class="btn">‚ñ∂ Run All Tests</button>
    <button onclick="collapseAll()" class="btn btn-small">Collapse All</button>
    <button onclick="expandAll()" class="btn btn-small">Expand All</button>
  </div>
  
  <div class="progress-bar" id="progress-container">
    <div class="progress-fill" id="progress-bar">0%</div>
  </div>
  <div class="progress-text" id="progress-text">Ready</div>
  
  <div id="test-list"></div>
  
  <div style="margin-top: 40px; padding: 20px; background: #161b22; border: 1px solid #30363d; border-radius: 8px;">
    <h2 style="color: #c9d1d9; margin-bottom: 15px; font-size: 18px;">üìã CRUD Operations Summary</h2>
    <p style="color: #8b949e; font-size: 13px; margin-bottom: 20px;">
      Comprehensive testing of Create, Read, Update, Delete operations across Worker, KV, and Stripe.
    </p>
    
    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
      <thead>
        <tr style="border-bottom: 2px solid #30363d;">
          <th style="text-align: left; padding: 10px; color: #8b949e; font-weight: 600;">Operation</th>
          <th style="text-align: left; padding: 10px; color: #8b949e; font-weight: 600;">Service</th>
          <th style="text-align: left; padding: 10px; color: #8b949e; font-weight: 600;">Client-Side?</th>
          <th style="text-align: left; padding: 10px; color: #8b949e; font-weight: 600;">Test Count</th>
        </tr>
      </thead>
      <tbody>
        <tr style="border-bottom: 1px solid #30363d;">
          <td style="padding: 10px; color: #3fb950; font-weight: bold;">READ</td>
          <td style="padding: 10px;">KV Storage</td>
          <td style="padding: 10px; color: #238636;">‚úÖ Yes</td>
          <td style="padding: 10px; text-align: left;">5 tests</td>
        </tr>
        <tr style="border-bottom: 1px solid #30363d;">
          <td style="padding: 10px; color: #3fb950; font-weight: bold;">READ</td>
          <td style="padding: 10px;">Stripe API</td>
          <td style="padding: 10px; color: #238636;">‚úÖ Yes</td>
          <td style="padding: 10px; text-align: left;">3 tests</td>
        </tr>
        <tr style="border-bottom: 1px solid #30363d;">
          <td style="padding: 10px; color: #3fb950; font-weight: bold;">READ</td>
          <td style="padding: 10px;">Worker Health</td>
          <td style="padding: 10px; color: #238636;">‚úÖ Yes</td>
          <td style="padding: 10px; text-align: left;">2 tests</td>
        </tr>
        <tr style="border-bottom: 1px solid #30363d;">
          <td style="padding: 10px; color: #58a6ff; font-weight: bold;">VALIDATE</td>
          <td style="padding: 10px;">Schema & Format</td>
          <td style="padding: 10px; color: #238636;">‚úÖ Yes</td>
          <td style="padding: 10px; text-align: left;">3 tests</td>
        </tr>
        <tr style="border-bottom: 1px solid #30363d;">
          <td style="padding: 10px; color: #1f6feb; font-weight: bold;">CI/CD</td>
          <td style="padding: 10px;">GitHub Actions</td>
          <td style="padding: 10px; color: #1f6feb;">‚öôÔ∏è Automated</td>
          <td style="padding: 10px; text-align: left;">2 tests</td>
        </tr>
        <tr style="border-bottom: 1px solid #30363d;">
          <td style="padding: 10px; color: #d29922; font-weight: bold;">WRITE</td>
          <td style="padding: 10px;">Webhook/Sync/Deploy</td>
          <td style="padding: 10px; color: #f85149;">‚ùå Manual</td>
          <td style="padding: 10px; text-align: left;">3 operations</td>
        </tr>
      </tbody>
    </table>
    
    <div style="margin-top: 20px; padding: 15px; background: #0d1117; border-radius: 6px; border-left: 3px solid #238636;">
      <h3 style="color: #c9d1d9; font-size: 14px; margin-bottom: 10px;">‚úÖ Browser Tests (13 total)</h3>
      <div style="color: #8b949e; font-size: 12px; line-height: 1.8;">
        <div>‚Ä¢ Run directly in browser without authentication</div>
        <div>‚Ä¢ Use public API endpoints (GET requests)</div>
        <div>‚Ä¢ Safe to run repeatedly - no side effects</div>
        <div>‚Ä¢ No secrets or keys required</div>
      </div>
    </div>
    
    <div style="margin-top: 15px; padding: 15px; background: #0d1117; border-radius: 6px; border-left: 3px solid #1f6feb;">
      <h3 style="color: #c9d1d9; font-size: 14px; margin-bottom: 10px;">‚öôÔ∏è GitHub Actions Tests (2 total)</h3>
      <div style="color: #8b949e; font-size: 12px; line-height: 1.8;">
        <div>‚Ä¢ Check workflow availability and status</div>
        <div>‚Ä¢ Can trigger workflows via GitHub API (with token)</div>
        <div>‚Ä¢ Automated CI/CD for server-side operations</div>
        <div>‚Ä¢ View at: <a href="https://github.com/vinas8/catalog/actions" style="color: #58a6ff;">github.com/vinas8/catalog/actions</a></div>
      </div>
    </div>
    
    <div style="margin-top: 15px; padding: 15px; background: #0d1117; border-radius: 6px; border-left: 3px solid #d29922;">
      <h3 style="color: #c9d1d9; font-size: 14px; margin-bottom: 10px;">‚ö†Ô∏è Manual Operations (3 total)</h3>
      <div style="color: #8b949e; font-size: 12px; line-height: 1.8;">
        <div><strong style="color: #58a6ff;">Primary Flow:</strong> CSV Import ‚Üí Stripe ‚Üí product.created webhook ‚Üí KV</div>
        <div><strong style="color: #58a6ff;">Purchase Flow:</strong> Checkout ‚Üí checkout.session.completed webhook ‚Üí User Assignment</div>
        <div><strong style="color: #d29922;">Fallback:</strong> Manual Stripe‚ÜíKV sync (only if webhooks fail)</div>
        <div>‚Ä¢ All operations available in Data Manager UI</div>
      </div>
    </div>
    
    <div style="margin-top: 15px; padding: 15px; background: #161b22; border-radius: 6px;">
      <h3 style="color: #c9d1d9; font-size: 14px; margin-bottom: 10px;">üìä Architecture Flow</h3>
      <div style="color: #8b949e; font-size: 12px; font-family: monospace; line-height: 1.8;">
        <div>1Ô∏è‚É£ CSV Upload ‚Üí Stripe Products (via Data Manager)</div>
        <div>2Ô∏è‚É£ Stripe ‚Üí product.created webhook ‚Üí Worker ‚Üí KV</div>
        <div>3Ô∏è‚É£ Customer Purchase ‚Üí checkout.session.completed webhook</div>
        <div>4Ô∏è‚É£ Worker assigns product to user hash ‚Üí USER_PRODUCTS KV</div>
        <div style="margin-top: 10px; color: #d29922;">‚ö†Ô∏è Manual sync only needed if webhooks are down</div>
      </div>
    </div>
    
    <p style="margin-top: 20px; color: #8b949e; font-size: 12px;">
      <strong>For advanced testing:</strong> 
      <a href="data-manager.html" style="color: #58a6ff;">Data Manager</a> | 
      <a href="index.html" style="color: #58a6ff;">Debug Hub</a>
    </p>
  </div>

  <script>
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    
    const testGroups = [
      {
        service: '‚òÅÔ∏è Worker Core Endpoints',
        badge: 'Base Layer',
        description: 'Essential worker health and routing - used by all scenarios',
        tests: [
          {
            id: 1,
            name: 'GET /health',
            method: 'GET',
            endpoint: '/health',
            description: 'Used by: monitoring, CI/CD, all scenarios',
            run: async () => {
              const res = await fetch(WORKER_URL + '/health');
              if (!res.ok) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              return { status: data.status, version: data.version, timestamp: data.timestamp };
            }
          },
          {
            id: 2,
            name: 'GET /version',
            method: 'GET',
            endpoint: '/version',
            description: 'Used by: deployment verification',
            run: async () => {
              const res = await fetch(WORKER_URL + '/version');
              if (!res.ok) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              return { version: data.version, updated: data.updated };
            }
          },
          {
            id: 3,
            name: 'Response Time Test',
            method: 'GET',
            endpoint: '/health',
            description: 'Used by: performance monitoring',
            run: async () => {
              const start = Date.now();
              await fetch(WORKER_URL + '/health');
              const time = Date.now() - start;
              if (time > 3000) throw new Error(`Slow: ${time}ms`);
              return { responseTime: time + 'ms', threshold: '<3000ms', grade: time < 1000 ? 'A' : 'B' };
            }
          },
          {
            id: 4,
            name: 'CORS Headers',
            method: 'OPTIONS',
            endpoint: '/health',
            description: 'Used by: all browser requests',
            run: async () => {
              const res = await fetch(WORKER_URL + '/health');
              const cors = res.headers.get('access-control-allow-origin');
              return { hasCORS: !!cors, origin: cors || 'none' };
            }
          }
        ]
      },
      {
        service: 'üóÑÔ∏è KV Storage - Products',
        badge: 'Product Data',
        description: 'Product catalog endpoints - used by S1 (Shop), S4 (Payment)',
        tests: [
          {
            id: 5,
            name: 'GET /kv/list-products',
            method: 'GET',
            endpoint: '/kv/list-products',
            description: 'Used by: catalog.html, shop module, Data Manager',
            run: async () => {
              const res = await fetch(WORKER_URL + '/kv/list-products');
              if (!res.ok) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              return { count: data.count || 0, keys: data.keys?.length || 0 };
            }
          },
          {
            id: 6,
            name: 'GET /kv/get-product?id=',
            method: 'GET',
            endpoint: '/kv/get-product',
            description: 'Used by: product detail views',
            run: async () => {
              const res = await fetch(WORKER_URL + '/kv/list-products');
              const data = await res.json();
              if (!data.keys || data.keys.length === 0) {
                return { message: 'No products - import CSV first', count: 0 };
              }
              const firstKey = data.keys[0].name;
              const res2 = await fetch(WORKER_URL + `/kv/get-product?id=${firstKey}`);
              return { productKey: firstKey, status: res2.status, found: res2.ok };
            }
          },
          {
            id: 7,
            name: 'GET /product-status?id=',
            method: 'GET',
            endpoint: '/product-status',
            description: 'Used by: S1.0.01 (Product availability check)',
            run: async () => {
              const res = await fetch(WORKER_URL + '/product-status?id=test_prod');
              if (!res.ok && res.status !== 404) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              return { available: data.available !== false, status: res.status };
            }
          },
          {
            id: 8,
            name: 'GET /kv/customer-count',
            method: 'GET',
            endpoint: '/kv/customer-count',
            description: 'Used by: Data Manager, analytics',
            run: async () => {
              const res = await fetch(WORKER_URL + '/kv/customer-count');
              if (!res.ok) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              return { totalCustomers: data.count || 0 };
            }
          },
          {
            id: 9,
            name: 'GET /kv/user-stats',
            method: 'GET',
            endpoint: '/kv/user-stats',
            description: 'Used by: Data Manager dashboard',
            run: async () => {
              const res = await fetch(WORKER_URL + '/kv/user-stats');
              if (!res.ok) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              return { totalUsers: data.totalUsers || 0, totalProducts: data.totalProducts || 0 };
            }
          },
          {
            id: 10,
            name: 'GET /kv/list-all',
            method: 'GET',
            endpoint: '/kv/list-all',
            description: 'Used by: Data Manager KV inspector',
            run: async () => {
              const res = await fetch(WORKER_URL + '/kv/list-all');
              if (!res.ok) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              return { totalKeys: data.allKeys?.length || 0 };
            }
          }
        ]
      },
      {
        service: 'üë§ KV Storage - User Data',
        badge: 'User Data',
        description: 'User assignments - used by S3 (Auth), S4 (Payment), S2 (Game)',
        tests: [
          {
            id: 11,
            name: 'GET /user-products?user=',
            method: 'GET',
            endpoint: '/user-products',
            description: 'Used by: game.html, S2 (load user snakes)',
            run: async () => {
              const res = await fetch(WORKER_URL + '/user-products?user=test_hash_12345');
              if (res.status !== 200 && res.status !== 404) throw new Error(`Unexpected: ${res.status}`);
              const data = res.status === 200 ? await res.json() : [];
              return { status: res.status, count: data.length || 0 };
            }
          },
          {
            id: 12,
            name: 'GET /kv/list-customers',
            method: 'GET',
            endpoint: '/kv/list-customers',
            description: 'Used by: Data Manager customer list',
            run: async () => {
              const res = await fetch(WORKER_URL + '/kv/list-customers');
              if (!res.ok) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              return { customerCount: data.customers?.length || 0 };
            }
          },
          {
            id: 13,
            name: 'GET /kv/list-user-products',
            method: 'GET',
            endpoint: '/kv/list-user-products',
            description: 'Used by: Data Manager user assignments view',
            run: async () => {
              const res = await fetch(WORKER_URL + '/kv/list-user-products');
              if (!res.ok) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              return { assignments: data.userProducts?.length || 0 };
            }
          },
          {
            id: 14,
            name: 'GET /session-info?session_id=',
            method: 'GET',
            endpoint: '/session-info',
            description: 'Used by: S4 (fetch Stripe session data)',
            run: async () => {
              return { 
                note: 'Requires valid Stripe session ID',
                usedBy: 'S4.x payment scenarios',
                testVia: 'Real purchase flow'
              };
            }
          }
        ]
      },
      {
        service: 'üí≥ Stripe Integration',
        badge: 'Payment APIs',
        description: 'Stripe data validation - used by S4 (Payment), S12 (Stripe webhook scenarios)',
        tests: [
          {
            id: 15,
            name: 'Stripe Product Count',
            method: 'GET',
            endpoint: '/kv/list-products',
            description: 'Used by: S12.x (verify Stripe sync)',
            run: async () => {
              const res = await fetch(WORKER_URL + '/kv/list-products');
              if (!res.ok) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              return { productsInKV: data.count || 0, syncedFromStripe: true };
            }
          },
          {
            id: 16,
            name: 'Payment Link Format',
            method: 'GET',
            endpoint: '/kv/list-products',
            description: 'Used by: S4 (validate checkout URLs)',
            run: async () => {
              const res = await fetch(WORKER_URL + '/kv/list-products');
              const data = await res.json();
              return { 
                total: data.count || 0,
                note: 'Each product has buy.stripe.com link'
              };
            }
          },
          {
            id: 17,
            name: 'Stripe API Health',
            method: 'GET',
            endpoint: 'https://status.stripe.com',
            description: 'Used by: S12 (external dependency check)',
            run: async () => {
              try {
                const res = await fetch('https://status.stripe.com/api/v2/status.json');
                const data = await res.json();
                return { status: data.status?.description || 'operational' };
              } catch (e) {
                return { status: 'Could not check', note: 'CORS or network issue' };
              }
            }
          },
          {
            id: 18,
            name: 'Price Data Integrity',
            method: 'GET',
            endpoint: '/kv/list-products',
            description: 'Used by: S1 (shop), S4 (payment validation)',
            run: async () => {
              const res = await fetch(WORKER_URL + '/kv/list-products');
              const data = await res.json();
              return { productsWithData: data.count || 0, source: 'KV (from Stripe)' };
            }
          },
          {
            id: 19,
            name: 'Checkout Session Format',
            method: 'GET',
            endpoint: '/session-info',
            description: 'Used by: S4.x (fetch session after purchase)',
            run: async () => {
              return { 
                endpoint: '/session-info?session_id={id}',
                usedBy: 'S4.5.x payment scenarios',
                requiresAuth: 'Stripe API key'
              };
            }
          }
        ]
      },
      {
        service: '‚öôÔ∏è GitHub API',
        badge: 'CI/CD',
        description: 'GitHub Actions integration - used for deployment, testing',
        tests: [
          {
            id: 20,
            name: 'List Workflows',
            method: 'GET',
            endpoint: 'GitHub API',
            description: 'Used by: CI/CD monitoring',
            run: async () => {
              const res = await fetch('https://api.github.com/repos/vinas8/catalog/actions/workflows');
              if (!res.ok) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              return { workflows: data.total_count || 0, available: true };
            }
          },
          {
            id: 21,
            name: 'Latest Workflow Run',
            method: 'GET',
            endpoint: 'GitHub API',
            description: 'Used by: deployment verification',
            run: async () => {
              const res = await fetch('https://api.github.com/repos/vinas8/catalog/actions/runs?per_page=1');
              if (!res.ok) throw new Error(`Status ${res.status}`);
              const data = await res.json();
              const latest = data.workflow_runs?.[0];
              return { 
                status: latest?.status || 'none',
                conclusion: latest?.conclusion || 'n/a',
                name: latest?.name || 'No runs'
              };
            }
          },
          {
            id: 22,
            name: 'GitHub Pages Status',
            method: 'GET',
            endpoint: 'GitHub Pages',
            description: 'Used by: S13.1.x (Pages deployment)',
            run: async () => {
              const res = await fetch('https://vinas8.github.io/catalog/');
              return { 
                accessible: res.ok,
                status: res.status,
                hosting: 'GitHub Pages'
              };
            }
          }
        ]
      },
      {
        service: 'üîó Webhook Endpoints',
        badge: 'Event-Driven',
        description: 'POST endpoints for external events - used by S4, S5, S12',
        tests: [
          {
            id: 23,
            name: 'POST /stripe-webhook',
            method: 'POST',
            endpoint: '/stripe-webhook',
            description: 'Used by: S4.4.x (purchase flow), S12.2.x',
            run: async () => {
              return { 
                method: 'POST',
                event: 'checkout.session.completed',
                testVia: 'Stripe CLI: stripe trigger checkout.session.completed',
                workflow: 'Purchase ‚Üí assigns product to user',
                requiresAuth: 'Stripe webhook signature'
              };
            }
          },
          {
            id: 24,
            name: 'POST /stripe-product-webhook',
            method: 'POST',
            endpoint: '/stripe-product-webhook',
            description: 'Used by: CSV import flow, S12.x',
            run: async () => {
              return { 
                method: 'POST',
                event: 'product.created',
                testVia: 'Data Manager CSV import',
                workflow: 'CSV ‚Üí Stripe ‚Üí product.created ‚Üí KV',
                requiresAuth: 'Stripe webhook signature'
              };
            }
          },
          {
            id: 25,
            name: 'POST /assign-virtual-snake',
            method: 'POST',
            endpoint: '/assign-virtual-snake',
            description: 'Used by: S2 (tutorial rewards)',
            run: async () => {
              return { 
                method: 'POST',
                usedBy: 'Tutorial completion rewards',
                workflow: 'Tutorial complete ‚Üí assign virtual snake',
                authentication: 'User hash validation'
              };
            }
          }
        ]
      }
    ];
    
    let testResults = {};
    
    function renderTests() {
      const listDiv = document.getElementById('test-list');
      listDiv.innerHTML = testGroups.map((group, idx) => `
        <div class="service-group">
          <div class="service-header">
            <h2>${group.service}</h2>
            <span class="service-badge">${group.badge}</span>
            <span class="service-badge">${group.tests.length} tests</span>
          </div>
          ${group.tests.map(test => `
            <div class="test-card" id="test-${test.id}">
              <div class="test-header" onclick="toggleTest(${test.id})">
                <span class="test-number">#${test.id}</span>
                <span class="test-method">${test.method}</span>
                <span class="test-title">${test.name}</span>
                <span class="test-status" id="status-${test.id}">‚ö™</span>
              </div>
              <div class="test-body" id="body-${test.id}">
                <div class="test-section">
                  <h4>Description</h4>
                  <p style="color: #8b949e; font-size: 13px;">${test.description}</p>
                </div>
                <div class="test-section">
                  <h4>Request</h4>
                  <div class="code-block">
                    <div><strong>${test.method}</strong> ${WORKER_URL}${test.endpoint}</div>
                  </div>
                </div>
                <div class="test-section">
                  <h4>Response</h4>
                  <div class="code-block" id="response-${test.id}">
                    <div style="color: #8b949e;">Not run yet. Click "Run Test" or "Run All Tests"</div>
                  </div>
                </div>
                <button onclick="runSingleTest(${test.id})" class="btn btn-small">‚ñ∂ Run Test</button>
              </div>
            </div>
          `).join('')}
        </div>
      `).join('');
    }
    
    function getAllTests() {
      return testGroups.flatMap(g => g.tests);
    }
    
    function toggleTest(id) {
      const body = document.getElementById(`body-${id}`);
      body.classList.toggle('show');
    }
    
    function collapseAll() {
      document.querySelectorAll('.test-body').forEach(b => b.classList.remove('show'));
    }
    
    function expandAll() {
      document.querySelectorAll('.test-body').forEach(b => b.classList.add('show'));
    }
    
    async function runSingleTest(id) {
      const test = getAllTests().find(t => t.id === id);
      const statusEl = document.getElementById(`status-${id}`);
      const responseEl = document.getElementById(`response-${id}`);
      
      statusEl.textContent = '‚è≥';
      responseEl.innerHTML = '<div style="color: #58a6ff;">Running...</div>';
      
      try {
        const result = await test.run();
        statusEl.textContent = '‚úÖ';
        statusEl.className = 'test-status status-ok';
        responseEl.innerHTML = `<pre style="margin: 0; color: #3fb950;">${JSON.stringify(result, null, 2)}</pre>`;
        testResults[id] = { status: 'ok', result };
      } catch (error) {
        statusEl.textContent = '‚ùå';
        statusEl.className = 'test-status status-error';
        responseEl.innerHTML = `<pre style="margin: 0; color: #f85149;">Error: ${error.message}</pre>`;
        testResults[id] = { status: 'error', error: error.message };
      }
    }
    
    async function runAllTests() {
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      const progressContainer = document.getElementById('progress-container');
      
      progressContainer.style.display = 'block';
      progressText.style.display = 'block';
      testResults = {};
      
      const allTests = getAllTests();
      
      for (let i = 0; i < allTests.length; i++) {
        const percent = Math.round(((i + 1) / allTests.length) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
        progressText.innerHTML = `üîç Test ${i + 1}/${allTests.length} - <strong>${allTests[i].name}</strong>`;
        
        await runSingleTest(allTests[i].id);
        await new Promise(r => setTimeout(r, 200));
      }
      
      progressText.innerHTML = '‚úÖ All tests complete!';
      progressText.style.color = '#3fb950';
      
      const passed = Object.values(testResults).filter(r => r.status === 'ok').length;
      const failed = allTests.length - passed;
      
      console.log(`Tests: ${passed}/${allTests.length} passed`);
    }
    
    // Initialize
    renderTests();
    
    // Auto-run on load
    window.addEventListener('load', () => {
      setTimeout(() => runAllTests(), 500);
    });
  </script>
</body>
</html>
