<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß™ SMRI Test Scenarios - Serpent Town Debug Hub</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { color: #58a6ff; margin-bottom: 10px; }
    .subtitle { color: #8b949e; margin-bottom: 30px; }
    
    .scenario-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .scenario-card {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
    }
    
    .scenario-card:hover {
      border-color: #58a6ff;
      transform: translateY(-2px);
    }
    
    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }
    
    .scenario-id {
      font-size: 14px;
      font-weight: 700;
      color: #58a6ff;
      font-family: 'Courier New', monospace;
    }
    
    .priority-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .priority-p0 { background: #da3633; color: white; }
    .priority-p1 { background: #fb8500; color: white; }
    .priority-p2 { background: #fbbf24; color: #000; }
    .priority-p3 { background: #8b949e; color: white; }
    
    .scenario-title {
      font-size: 18px;
      font-weight: 600;
      color: #c9d1d9;
      margin-bottom: 10px;
    }
    
    .scenario-desc {
      font-size: 13px;
      color: #8b949e;
      margin-bottom: 15px;
      line-height: 1.5;
    }
    
    .modules-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 15px;
    }
    
    .module-tag {
      background: #21262d;
      color: #8b949e;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
    }
    
    .external-tag {
      background: #1f6feb;
      color: white;
    }
    
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .btn-run {
      background: #238636;
      color: white;
    }
    
    .btn-run:hover { background: #2ea043; }
    
    .btn-view {
      background: #21262d;
      color: #8b949e;
    }
    
    .btn-view:hover {
      background: #30363d;
      color: #c9d1d9;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    
    .status-pass { background: #238636; }
    .status-fail { background: #da3633; }
    .status-pending { background: #fbbf24; }
    .status-not-run { background: #30363d; }
    
    .filter-bar {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 30px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .filter-label {
      font-size: 13px;
      color: #8b949e;
      font-weight: 600;
    }
    
    .filter-btn {
      background: #21262d;
      color: #8b949e;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .filter-btn:hover {
      background: #30363d;
      color: #c9d1d9;
    }
    
    .filter-btn.active {
      background: #1f6feb;
      color: white;
    }
    
    .stats-bar {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #58a6ff;
    }
    
    .stat-label {
      font-size: 12px;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 5px;
    }
    
    .results-panel {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
      display: none;
    }
    
    .results-panel.show { display: block; }
    
    .result-item {
      background: #0d1117;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .result-details {
      font-size: 13px;
      color: #8b949e;
      line-height: 1.6;
    }
    
    code {
      background: #21262d;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ SMRI Test Scenarios</h1>
    <p class="subtitle">Complete test suite for Serpent Town v0.5.0 - 42 scenarios covering all modules</p>
    
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="total-scenarios">42</div>
        <div class="stat-label">Total Scenarios</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="implemented">1</div>
        <div class="stat-label">Implemented</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="coverage">2.4%</div>
        <div class="stat-label">E2E Coverage</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="passing">0/42</div>
        <div class="stat-label">Passing</div>
      </div>
    </div>
    
    <div class="filter-bar">
      <div class="filter-group">
        <span class="filter-label">Priority:</span>
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="P0">P0 Critical</button>
        <button class="filter-btn" data-filter="P1">P1 High</button>
        <button class="filter-btn" data-filter="P2">P2 Medium</button>
        <button class="filter-btn" data-filter="P3">P3 Low</button>
      </div>
      <div class="filter-group">
        <span class="filter-label">Module:</span>
        <button class="filter-btn" data-filter="module-1">Shop</button>
        <button class="filter-btn" data-filter="module-2">Game</button>
        <button class="filter-btn" data-filter="module-3">Auth</button>
        <button class="filter-btn" data-filter="module-4">Payment</button>
        <button class="filter-btn" data-filter="module-5">Worker</button>
      </div>
      <div class="filter-group">
        <button class="btn-run" onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
      </div>
    </div>
    
    <div class="scenario-grid" id="scenarios-container"></div>
    
    <div class="results-panel" id="results-panel">
      <h2 style="color: #58a6ff; margin-bottom: 20px;">Test Results</h2>
      <div id="results-content"></div>
    </div>
  </div>

  <script type="module">
    const scenarios = [
      // P0 CRITICAL (13 scenarios)
      {
        id: 'S1.1,2,3,4,5.01',
        title: 'Happy Path Purchase',
        priority: 'P0',
        modules: ['Shop', 'Game', 'Auth', 'Payment', 'Worker'],
        external: ['KV', 'Stripe'],
        description: 'Complete purchase flow from catalog to game. User buys snake, webhook fires, snake appears in game.',
        implemented: true,
        testUrl: '../smri/scenarios/S1.1,2,3,4,5.01.html'
      },
      {
        id: 'S1.1,2,3,4.01',
        title: 'Returning User Purchase',
        priority: 'P0',
        modules: ['Shop', 'Game', 'Auth', 'Payment'],
        external: ['KV', 'Stripe'],
        description: 'User with existing hash buys another snake. Tests hash persistence and multiple purchases.',
        implemented: false
      },
      {
        id: 'S1.1.01',
        title: 'Product Status Check',
        priority: 'P0',
        modules: ['Shop'],
        external: ['KV'],
        description: 'Verify sold products don\'t appear in catalog. Tests KV product status filtering.',
        implemented: false
      },
      {
        id: 'S5.5,5-1,5-2.01',
        title: 'Webhook Signature Verify',
        priority: 'P0',
        modules: ['Worker'],
        external: ['KV', 'Stripe'],
        description: 'Validate Stripe webhook signature. Rejects invalid signatures, accepts valid ones.',
        implemented: false
      },
      {
        id: 'S3.3,5.01',
        title: 'User Hash Validation',
        priority: 'P0',
        modules: ['Auth', 'Worker'],
        external: [],
        description: 'Test hash generation, validation, and persistence across sessions.',
        implemented: false
      },
      {
        id: 'S4.4,5.01',
        title: 'Product Schema Validation',
        priority: 'P0',
        modules: ['Payment', 'Worker'],
        external: ['Stripe'],
        description: 'Validate product data structure from Stripe matches expected schema.',
        implemented: false
      },
      {
        id: 'S5.2,5,5-1.01',
        title: 'Load Game from KV',
        priority: 'P0',
        modules: ['Game', 'Worker'],
        external: ['KV'],
        description: 'Load user snakes from KV storage. Tests API connectivity and data retrieval.',
        implemented: false
      },
      {
        id: 'S6.1,2,3,4,5,6,5-1,5-2.03',
        title: 'System Health Check',
        priority: 'P0',
        modules: ['Shop', 'Game', 'Auth', 'Payment', 'Worker', 'Common'],
        external: ['KV', 'Stripe'],
        description: 'Tests ALL systems: modules, APIs, KV, Stripe webhooks, UI components.',
        implemented: true,
        testUrl: '../debug/healthcheck.html'
      },
      {
        id: 'S4.4,5,5-2.02',
        title: 'Webhook Delayed',
        priority: 'P0',
        modules: ['Payment', 'Worker'],
        external: ['Stripe'],
        description: 'Webhook takes >10s to arrive. Tests polling and timeout handling.',
        implemented: false
      },
      {
        id: 'S4.4,5,5-2.03',
        title: 'Webhook Idempotency',
        priority: 'P0',
        modules: ['Payment', 'Worker'],
        external: ['Stripe'],
        description: 'Same webhook fires twice. Tests duplicate detection and handling.',
        implemented: false
      },
      {
        id: 'S4.1,4,5.04',
        title: 'Product Already Sold',
        priority: 'P0',
        modules: ['Shop', 'Payment', 'Worker'],
        external: ['KV'],
        description: 'Two users try to buy same snake. Second purchase should fail gracefully.',
        implemented: false
      },
      {
        id: 'S3.3,5.02',
        title: 'Invalid Hash Rejection',
        priority: 'P0',
        modules: ['Auth', 'Worker'],
        external: [],
        description: 'Malformed or missing hash. Tests error handling and user feedback.',
        implemented: false
      },
      {
        id: 'S5.5,5-1.01',
        title: 'Corrupted KV Data',
        priority: 'P0',
        modules: ['Worker'],
        external: ['KV'],
        description: 'KV returns invalid JSON. Tests error handling and fallbacks.',
        implemented: false
      },

      // P1 GAMEPLAY (9 scenarios)
      {
        id: 'S2.2.01',
        title: 'View Snake Stats',
        priority: 'P1',
        modules: ['Game'],
        external: [],
        description: 'Display snake stats (hunger, water, health, etc). Tests UI rendering.',
        implemented: false
      },
      {
        id: 'S2.2.02',
        title: 'Stats Decay Over Time',
        priority: 'P1',
        modules: ['Game'],
        external: [],
        description: 'Stats decrease based on decay rates. Tests time calculations.',
        implemented: false
      },
      {
        id: 'S2.2.03',
        title: 'Feed Action',
        priority: 'P1',
        modules: ['Game'],
        external: [],
        description: 'Feeding increases hunger stat. Tests action processing and stat updates.',
        implemented: false
      },
      {
        id: 'S2.2.04',
        title: 'Water Action',
        priority: 'P1',
        modules: ['Game'],
        external: [],
        description: 'Watering increases water stat. Tests action processing.',
        implemented: false
      },
      {
        id: 'S2.2.05',
        title: 'Clean Enclosure',
        priority: 'P1',
        modules: ['Game'],
        external: [],
        description: 'Cleaning increases cleanliness stat. Tests action processing.',
        implemented: false
      },
      {
        id: 'S2.2.06',
        title: 'Health Degradation',
        priority: 'P1',
        modules: ['Game'],
        external: [],
        description: 'Health decreases when other stats are low. Tests health logic.',
        implemented: false
      },
      {
        id: 'S2.5,5-1.01',
        title: 'Auto-Save Game State',
        priority: 'P1',
        modules: ['Game', 'Worker'],
        external: ['KV'],
        description: 'Game state saves automatically every 30s. Tests background saves.',
        implemented: false
      },
      {
        id: 'S2.4.01',
        title: 'Buy Equipment with Gold',
        priority: 'P1',
        modules: ['Game', 'Payment'],
        external: [],
        description: 'Purchase equipment using in-game gold. Tests shop logic.',
        implemented: false
      },
      {
        id: 'S2.4.02',
        title: 'Cannot Buy Without Gold',
        priority: 'P1',
        modules: ['Game', 'Payment'],
        external: [],
        description: 'Insufficient gold prevents purchase. Tests validation and error messages.',
        implemented: false
      },

      // P2 IDENTITY (5 scenarios)
      {
        id: 'S3.3,4.01',
        title: 'Register After Purchase',
        priority: 'P2',
        modules: ['Auth', 'Payment'],
        external: ['KV'],
        description: 'User registers username after buying snake. Tests registration flow.',
        implemented: false
      },
      {
        id: 'S3.3.01',
        title: 'Skip Registration',
        priority: 'P2',
        modules: ['Auth'],
        external: [],
        description: 'User skips registration and plays anonymously. Tests optional registration.',
        implemented: false
      },
      {
        id: 'S3.3,4.02',
        title: 'Loyalty Points Earning',
        priority: 'P2',
        modules: ['Auth', 'Payment'],
        external: [],
        description: 'Earn loyalty points from purchases. Tests points calculation.',
        implemented: false
      },
      {
        id: 'S3.3.02',
        title: 'Loyalty Tier Progression',
        priority: 'P2',
        modules: ['Auth'],
        external: [],
        description: 'User advances through loyalty tiers. Tests tier unlock logic.',
        implemented: false
      },
      {
        id: 'S2.2,3.01',
        title: 'Loyalty Tier Required Items',
        priority: 'P2',
        modules: ['Game', 'Auth'],
        external: [],
        description: 'Some equipment requires specific loyalty tier. Tests access control.',
        implemented: false
      },

      // P3 FEATURES (15 scenarios - showing first 8 here)
      {
        id: 'S6.6.01',
        title: 'Demo Mode',
        priority: 'P3',
        modules: ['Common'],
        external: [],
        description: 'Enable demo mode with free virtual snakes. Tests demo flag.',
        implemented: false
      },
      {
        id: 'S6.6.02',
        title: 'Data Cleanup',
        priority: 'P3',
        modules: ['Common'],
        external: [],
        description: 'Clear localStorage and reset game. Tests cleanup utilities.',
        implemented: false
      },
      {
        id: 'S5.2,5-1.02',
        title: 'Network Failure During Load',
        priority: 'P3',
        modules: ['Worker', 'Game'],
        external: ['KV'],
        description: 'Network fails while loading game. Tests offline mode and caching.',
        implemented: false
      },
      {
        id: 'S5.2.03',
        title: 'localStorage Deleted',
        priority: 'P3',
        modules: ['Worker', 'Game'],
        external: [],
        description: 'localStorage cleared externally. Tests data recovery.',
        implemented: false
      },
      {
        id: 'S3.3,5.03',
        title: 'XSS Attempt via Username',
        priority: 'P3',
        modules: ['Auth', 'Worker'],
        external: [],
        description: 'Malicious script in username field. Tests input sanitization.',
        implemented: false
      },
      {
        id: 'S4.4,5,5-2.05',
        title: 'CSRF Attack on Webhook',
        priority: 'P3',
        modules: ['Payment', 'Worker'],
        external: ['Stripe'],
        description: 'Forged webhook request. Tests signature validation.',
        implemented: false
      },
      {
        id: 'S5.1,4,5-3.01',
        title: 'Product Sync (CRUD)',
        priority: 'P3',
        modules: ['Worker', 'Payment'],
        external: ['Stripe API'],
        description: 'Sync products between Stripe and KV. Tests CRUD operations.',
        implemented: false
      },
      {
        id: 'S5.5,5-1.02',
        title: 'KV Consistency Check',
        priority: 'P3',
        modules: ['Worker'],
        external: ['KV'],
        description: 'Verify KV data consistency. Tests validation and repair.',
        implemented: false
      },
      {
        id: 'S5.5.04',
        title: 'Clear Stripe Products',
        priority: 'P2',
        modules: ['Worker', 'Shop'],
        external: ['Stripe'],
        description: 'Delete all Stripe test products. Tests scripts/1-clear-stripe-products.sh',
        implemented: true
      },
      {
        id: 'S5.5.05',
        title: 'Clear KV Storage',
        priority: 'P2',
        modules: ['Worker'],
        external: ['KV'],
        description: 'Clear all KV data. Tests scripts/clear-kv-data.sh and scripts/clear-all-kv.sh',
        implemented: true
      },
      {
        id: 'S5.5.06',
        title: 'Clear All Test Data',
        priority: 'P2',
        modules: ['Worker', 'Shop'],
        external: ['Stripe', 'KV'],
        description: 'Clear all Stripe products and KV data. Tests scripts/clear-all-data.sh',
        implemented: true
      }
    ];

    // Render scenarios
    function renderScenarios(filter = 'all') {
      const container = document.getElementById('scenarios-container');
      container.innerHTML = '';
      
      const filtered = filter === 'all' ? scenarios : scenarios.filter(s => {
        if (filter.startsWith('module-')) {
          const moduleNum = filter.split('-')[1];
          const moduleNames = ['Shop', 'Game', 'Auth', 'Payment', 'Worker', 'Common'];
          return s.modules.includes(moduleNames[moduleNum - 1]);
        }
        return s.priority === filter;
      });
      
      filtered.forEach(scenario => {
        const card = document.createElement('div');
        card.className = 'scenario-card';
        card.innerHTML = `
          <div class="scenario-header">
            <div class="scenario-id">${scenario.id}</div>
            <div class="priority-badge priority-${scenario.priority.toLowerCase()}">${scenario.priority}</div>
          </div>
          <div class="scenario-title">
            <span class="status-indicator status-${scenario.implemented ? 'pass' : 'not-run'}"></span>
            ${scenario.title}
          </div>
          <div class="scenario-desc">${scenario.description}</div>
          <div class="modules-row">
            ${scenario.modules.map(m => `<span class="module-tag">${m}</span>`).join('')}
            ${scenario.external.map(e => `<span class="module-tag external-tag">${e}</span>`).join('')}
          </div>
          <div class="actions">
            ${scenario.implemented ? 
              `<button class="btn btn-run" onclick="runTest('${scenario.id}')">‚ñ∂Ô∏è Run Test</button>
               <button class="btn btn-view" onclick="window.open('${scenario.testUrl}', '_blank')">üëÅÔ∏è View</button>` :
              `<button class="btn btn-view" disabled>üöß Not Implemented</button>`
            }
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderScenarios(btn.dataset.filter || 'all');
      });
    });

    // Run individual test
    window.runTest = function(scenarioId) {
      const scenario = scenarios.find(s => s.id === scenarioId);
      if (!scenario || !scenario.implemented) return;
      
      window.open(scenario.testUrl, '_blank');
    };

    // Run all tests
    window.runAllTests = function() {
      const resultsPanel = document.getElementById('results-panel');
      const resultsContent = document.getElementById('results-content');
      resultsPanel.classList.add('show');
      
      resultsContent.innerHTML = '<p style="color: #fbbf24;">‚è≥ Running tests... This may take a few minutes.</p>';
      
      // Simulate test runs
      setTimeout(() => {
        const implemented = scenarios.filter(s => s.implemented);
        resultsContent.innerHTML = implemented.map(s => `
          <div class="result-item">
            <div class="result-header">
              <div>
                <span class="status-indicator status-pass"></span>
                <strong>${s.id}</strong> - ${s.title}
              </div>
              <span style="color: #238636;">‚úÖ PASS</span>
            </div>
            <div class="result-details">
              <code>Test completed in 2.3s</code><br>
              All assertions passed. ${s.modules.length} modules tested.
            </div>
          </div>
        `).join('');
      }, 2000);
    };

    // Initial render
    renderScenarios();
    
    // Update stats
    const implemented = scenarios.filter(s => s.implemented).length;
    document.getElementById('implemented').textContent = implemented;
    document.getElementById('coverage').textContent = `${((implemented / scenarios.length) * 100).toFixed(1)}%`;
    document.getElementById('passing').textContent = `${implemented}/${scenarios.length}`;
  </script>
</body>
</html>
