<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä Data Manager - SMRI Debug</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 { color: #58a6ff; margin-bottom: 10px; }
    .subtitle { color: #8b949e; margin-bottom: 30px; }
    .nav { margin-bottom: 20px; }
    .nav a { color: #58a6ff; text-decoration: none; }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 20px;
    }
    
    .stat-card h2 {
      color: #c9d1d9;
      font-size: 16px;
      margin-bottom: 15px;
    }
    
    .stat-number {
      font-size: 48px;
      font-weight: bold;
      color: #58a6ff;
      margin: 10px 0;
    }
    
    .stat-label {
      color: #8b949e;
      font-size: 14px;
    }
    
    .btn {
      background: #238636;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    .btn:hover { background: #2ea043; }
    .btn:disabled { background: #30363d; cursor: not-allowed; opacity: 0.5; }
    
    .btn-danger { background: #da3633; }
    .btn-danger:hover { background: #f85149; }
    
    .btn-secondary { background: #21262d; }
    .btn-secondary:hover { background: #30363d; }
    
    .test-section {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }
    
    .test-section h2 {
      color: #58a6ff;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .output {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
    }
    
    .output div { margin-bottom: 3px; }
    .success { color: #3fb950; }
    .error { color: #f85149; }
    .warning { color: #d29922; }
    .info { color: #58a6ff; }
    
    textarea {
      width: 100%;
      min-height: 180px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 12px;
      color: #c9d1d9;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    th, td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid #30363d;
    }
    
    th {
      color: #58a6ff;
      font-weight: 600;
      background: #0d1117;
      position: sticky;
      top: 0;
    }
    
    .preview-container {
      max-height: 350px;
      overflow-y: auto;
      border-radius: 6px;
      border: 1px solid #30363d;
    }
  </style>
</head>
<body>
  <div class="nav">
    <a href="index.html">‚Üê Back to Debug Hub</a>
  </div>
  
  <h1>üìä Data Manager</h1>
  <p class="subtitle">Manage Stripe products, KV storage, and bulk CSV imports</p>

  <!-- Stats Cards -->
  <div class="grid">
    <div class="stat-card">
      <h2>üí≥ Stripe Products</h2>
      <div class="stat-number" id="stripeCount">-</div>
      <div class="stat-label">Active products</div>
      <button class="btn btn-secondary" onclick="refreshStripeCount()" style="margin-top: 10px;">Refresh</button>
    </div>
    
    <div class="stat-card">
      <h2>üóÑÔ∏è KV Storage</h2>
      <div class="stat-number" id="kvCount">-</div>
      <div class="stat-label">Total keys</div>
      <button class="btn btn-secondary" onclick="refreshKVCount()" style="margin-top: 10px;">Refresh</button>
    </div>
    
    <div class="stat-card">
      <h2>üë• Customers</h2>
      <div class="stat-number" id="customerCount">-</div>
      <div class="stat-label">Registered users</div>
      <button class="btn btn-secondary" onclick="refreshCustomerCount()" style="margin-top: 10px;">Refresh</button>
    </div>
  </div>

  <!-- Stripe Data Inspector -->
  <div class="test-section">
    <h2>üí≥ Stripe Data Inspector</h2>
    <button class="btn" onclick="fetchAllStripeProducts()">Fetch All Products</button>
    <button class="btn" onclick="fetchStripePrices()">Fetch Prices</button>
    <button class="btn btn-danger" onclick="clearStripeProducts()">Clear</button>
    <div id="stripeOutput" class="output"></div>
  </div>

  <!-- KV Storage Inspector -->
  <div class="test-section">
    <h2>üóÑÔ∏è KV Storage Inspector</h2>
    <button class="btn" onclick="listKVProducts()">List Product Keys</button>
    <button class="btn" onclick="listKVCustomers()">List Customer Keys</button>
    <button class="btn" onclick="listAllKVKeys()">List All Keys</button>
    <button class="btn btn-danger" onclick="clearAllKV()">üóëÔ∏è Clear All KV</button>
    <button class="btn btn-danger" onclick="clearKVOutput()">Clear Log</button>
    <div id="kvOutput" class="output"></div>
  </div>

  <!-- Worker API Inspector -->
  <div class="test-section">
    <h2>‚öôÔ∏è Worker API Inspector</h2>
    <button class="btn" onclick="testWorkerProducts()">GET /products</button>
    <button class="btn" onclick="testWorkerHealth()">GET /health</button>
    <button class="btn" onclick="testWorkerCustomer()">GET /customer?hash=test</button>
    <button class="btn btn-danger" onclick="clearWorkerOutput()">Clear</button>
    <div id="workerOutput" class="output"></div>
  </div>

  <!-- Data Sync Verification -->
  <div class="test-section">
    <h2>üîÑ Data Sync Verification</h2>
    <p style="color: #8b949e; margin-bottom: 15px;">
      Verify that data is synchronized between Stripe, KV, and Worker API
    </p>
    <button class="btn" onclick="runFullVerification()">Run Full Verification</button>
    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
    <div id="syncOutput" class="output"></div>
  </div>

  <!-- CSV Import Section -->
  <div class="test-section">
    <h2>üì§ Import Products from CSV</h2>
    <p style="color: #8b949e; margin-bottom: 15px;">
      Upload snake collection CSV or paste CSV text (Name, Morph, Gender, YOB, Weight)
    </p>
    
    <div style="margin-bottom: 15px;">
      <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
      <button class="btn" onclick="document.getElementById('csvFileInput').click()">
        üìÅ Choose CSV File
      </button>
      <button class="btn btn-secondary" onclick="togglePasteArea()">
        üìã Paste CSV Text
      </button>
      <span id="csvFileName" style="margin-left: 15px; color: #8b949e;"></span>
    </div>
    
    <div id="pasteArea" style="display: none; margin-bottom: 15px;">
      <textarea id="csvTextInput" 
        placeholder="Paste CSV here (include headers)&#10;Example:&#10;Name,Morph,Gender,YOB,Weight&#10;Pudding,Banana H. Clown,Male,2024,"></textarea>
      <button class="btn" onclick="parseCSVFromText()" style="margin-top: 10px;">Parse CSV</button>
      <button class="btn btn-secondary" onclick="clearPasteArea()">Clear</button>
    </div>
    
    <button class="btn" onclick="uploadToStripe()" id="uploadStripeBtn" style="display: none;">‚¨ÜÔ∏è Upload to Stripe</button>
    <button class="btn" onclick="syncToKV()" id="syncKVBtn" style="display: none;">üîÑ Sync to KV</button>
    <button class="btn" onclick="previewCSV()" id="previewBtn" style="display: none;">üëÅÔ∏è Preview Data</button>
    <button class="btn btn-secondary" onclick="downloadSampleCSV()">üì• Download Sample CSV</button>
    
    <div id="csvPreview" style="display: none; margin-top: 20px;">
      <h3 style="color: #58a6ff; margin-bottom: 10px;">CSV Preview (<span id="rowCount">0</span> snakes)</h3>
      <div class="preview-container">
        <table>
          <thead id="csvTableHead"></thead>
          <tbody id="csvTableBody"></tbody>
        </table>
      </div>
    </div>
    <div id="csvOutput" class="output"></div>
  </div>

  <script>
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    const STRIPE_KEY = 'sk_test_51Sg3s0BjL72pe9Xs4RFYFTBPDDUhUzNTgAUbNUxhRk4pZQGZtpEXQvIFI6o2NZIujJcyGKKGn6Ml2rnoy16yVsf700BDVZxVYI';
    const CF_ACCOUNT = 'e24c9f59eed424bd6d04e0f10fe0886f';
    const CF_TOKEN = '2BKglg-h8Vbs-n7NsjRZzHqDj_cTlwYkx2IoBVWY';
    const KV_NAMESPACE = 'ecbcb79f3df64379863872965f993991';
    
    let csvData = null;

    function log(elementId, message, type = 'info') {
      const output = document.getElementById(elementId);
      output.style.display = 'block';
      const time = new Date().toLocaleTimeString();
      output.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
      output.scrollTop = output.scrollHeight;
    }

    function clearLog(elementId) {
      const output = document.getElementById(elementId);
      output.innerHTML = '';
      output.style.display = 'none';
    }

    // Stats
    async function refreshStripeCount() {
      try {
        log('stripeOutput', 'Fetching Stripe product count...', 'info');
        // Add cache busting
        const res = await fetch(`https://api.stripe.com/v1/products?limit=100&_t=${Date.now()}`, {
          headers: { 'Authorization': `Bearer ${STRIPE_KEY}` },
          cache: 'no-cache'
        });
        const data = await res.json();
        const count = data.data ? data.data.length : 0;
        document.getElementById('stripeCount').textContent = count;
        log('stripeOutput', `‚úÖ Stripe has ${count} products`, 'success');
      } catch (err) {
        document.getElementById('stripeCount').textContent = '?';
        log('stripeOutput', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    async function refreshKVCount() {
      try {
        log('kvOutput', 'Fetching KV product count...', 'info');
        const res = await fetch(`${WORKER_URL}/products?_t=${Date.now()}`, { cache: 'no-cache' });
        const products = await res.json();
        const count = Array.isArray(products) ? products.length : 0;
        document.getElementById('kvCount').textContent = count;
        log('kvOutput', `‚úÖ KV has ${count} products`, 'success');
      } catch (err) {
        document.getElementById('kvCount').textContent = '?';
        log('kvOutput', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    async function refreshCustomerCount() {
      document.getElementById('customerCount').textContent = '-';
      log('kvOutput', 'üë• Customer count feature coming soon', 'warning');
    }

    // Stripe Inspector
    async function fetchAllStripeProducts() {
      clearLog('stripeOutput');
      log('stripeOutput', 'Fetching all Stripe products...', 'info');
      try {
        const res = await fetch('https://api.stripe.com/v1/products?limit=100', {
          headers: { 'Authorization': `Bearer ${STRIPE_KEY}` }
        });
        const data = await res.json();
        log('stripeOutput', `‚úÖ Found ${data.data.length} products:`, 'success');
        data.data.forEach(p => {
          log('stripeOutput', `  ‚Ä¢ ${p.name} (${p.id})`, 'info');
        });
      } catch (err) {
        log('stripeOutput', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    async function fetchStripePrices() {
      clearLog('stripeOutput');
      log('stripeOutput', 'Fetching Stripe prices...', 'info');
      try {
        const res = await fetch('https://api.stripe.com/v1/prices?limit=100', {
          headers: { 'Authorization': `Bearer ${STRIPE_KEY}` }
        });
        const data = await res.json();
        log('stripeOutput', `‚úÖ Found ${data.data.length} prices:`, 'success');
        data.data.forEach(p => {
          log('stripeOutput', `  ‚Ä¢ ‚Ç¨${p.unit_amount/100} - ${p.product}`, 'info');
        });
      } catch (err) {
        log('stripeOutput', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    async function clearStripeProducts() {
      if (!confirm('‚ö†Ô∏è Delete ALL Stripe products? This will remove everything!')) return;
      
      clearLog('stripeOutput');
      log('stripeOutput', 'üóëÔ∏è Clearing all Stripe products...', 'warning');
      log('stripeOutput', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'warning');
      
      try {
        const res = await fetch('https://api.stripe.com/v1/products?limit=100', {
          headers: { 'Authorization': `Bearer ${STRIPE_KEY}` }
        });
        const { data: products } = await res.json();
        
        log('stripeOutput', `Found ${products.length} products to delete`, 'info');
        log('stripeOutput', '', 'info');
        
        let deleted = 0;
        for (const product of products) {
          try {
            const delRes = await fetch(`https://api.stripe.com/v1/products/${product.id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${STRIPE_KEY}` }
            });
            
            if (delRes.ok) {
              log('stripeOutput', `  ‚úÖ Deleted ${product.name}`, 'success');
              deleted++;
            } else {
              const error = await delRes.json();
              log('stripeOutput', `  ‚ùå Failed ${product.name}: ${error.error.message}`, 'error');
            }
          } catch (err) {
            log('stripeOutput', `  ‚ùå Failed to delete ${product.name}: ${err.message}`, 'error');
          }
        }
        
        log('stripeOutput', '', 'info');
        log('stripeOutput', `‚è≥ Waiting 2 seconds for Stripe to update...`, 'info');
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Verify deletion
        const verifyRes = await fetch('https://api.stripe.com/v1/products?limit=100', {
          headers: { 'Authorization': `Bearer ${STRIPE_KEY}` }
        });
        const { data: remaining } = await verifyRes.json();
        
        log('stripeOutput', `‚úÖ Deleted: ${deleted}/${products.length}`, 'success');
        log('stripeOutput', `üìä Remaining: ${remaining.length} products`, remaining.length === 0 ? 'success' : 'warning');
        
        await refreshStripeCount();
        
      } catch (err) {
        log('stripeOutput', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    // KV Inspector
    async function listKVProducts() {
      clearLog('kvOutput');
      log('kvOutput', 'Listing KV products...', 'info');
      try {
        const res = await fetch(`${WORKER_URL}/products`);
        const products = await res.json();
        log('kvOutput', `‚úÖ Found ${products.length} products:`, 'success');
        products.forEach(p => {
          log('kvOutput', `  ‚Ä¢ ${p.name} - ${p.morph || 'No morph'}`, 'info');
        });
      } catch (err) {
        log('kvOutput', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    async function listKVCustomers() {
      clearLog('kvOutput');
      log('kvOutput', 'üë• Customer listing coming soon', 'warning');
    }

    async function listAllKVKeys() {
      clearLog('kvOutput');
      log('kvOutput', 'üìã Listing all KV keys via API...', 'info');
      try {
        const res = await fetch(
          `https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT}/storage/kv/namespaces/${KV_NAMESPACE}/keys`,
          { headers: { 'Authorization': `Bearer ${CF_TOKEN}` } }
        );
        const data = await res.json();
        log('kvOutput', `‚úÖ Found ${data.result.length} keys:`, 'success');
        data.result.forEach(k => {
          log('kvOutput', `  ‚Ä¢ ${k.name}`, 'info');
        });
      } catch (err) {
        log('kvOutput', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    function clearKVOutput() { clearLog('kvOutput'); }

    async function clearAllKV() {
      if (!confirm('‚ö†Ô∏è Delete ALL KV data? This will clear the entire KV namespace!')) return;
      
      clearLog('kvOutput');
      log('kvOutput', 'üóëÔ∏è Clearing all KV storage...', 'warning');
      log('kvOutput', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'warning');
      log('kvOutput', '', 'info');
      log('kvOutput', '‚ö†Ô∏è KV bulk delete doesn\'t support CORS from browser', 'warning');
      log('kvOutput', '', 'info');
      log('kvOutput', 'üìã Choose one of these options:', 'info');
      log('kvOutput', '', 'info');
      log('kvOutput', '1Ô∏è‚É£ Run bash script:', 'info');
      log('kvOutput', '   cd /root/catalog && bash scripts/clear-kv-data.sh', 'info');
      log('kvOutput', '', 'info');
      log('kvOutput', '2Ô∏è‚É£ Use wrangler CLI:', 'info');
      log('kvOutput', '   npx wrangler kv:key list --namespace-id=ecbcb79f3df64379863872965f993991 | \\', 'info');
      log('kvOutput', '   jq -r \'.[].name\' | xargs -I {} npx wrangler kv:key delete {} --namespace-id=...', 'info');
      log('kvOutput', '', 'info');
      log('kvOutput', '3Ô∏è‚É£ Or clear directly in Cloudflare Dashboard:', 'info');
      log('kvOutput', '   https://dash.cloudflare.com ‚Üí Workers & Pages ‚Üí KV ‚Üí PRODUCTS', 'info');
      log('kvOutput', '', 'info');
      log('kvOutput', 'üí° Reason: Browser CORS policy blocks DELETE to /bulk endpoint', 'warning');
      log('kvOutput', '   (GET works, but DELETE/POST to bulk requires backend)', 'info');
    }

    // Worker API Inspector
    async function testWorkerProducts() {
      clearLog('workerOutput');
      log('workerOutput', `GET ${WORKER_URL}/products`, 'info');
      try {
        const res = await fetch(`${WORKER_URL}/products`);
        const data = await res.json();
        log('workerOutput', `‚úÖ Response: ${data.length} products`, 'success');
        log('workerOutput', JSON.stringify(data.slice(0, 2), null, 2), 'info');
      } catch (err) {
        log('workerOutput', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    async function testWorkerHealth() {
      clearLog('workerOutput');
      log('workerOutput', `GET ${WORKER_URL}/version`, 'info');
      try {
        const res = await fetch(`${WORKER_URL}/version`);
        const data = await res.json();
        log('workerOutput', `‚úÖ Worker version: ${data.version}`, 'success');
        log('workerOutput', JSON.stringify(data, null, 2), 'info');
      } catch (err) {
        log('workerOutput', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    async function testWorkerCustomer() {
      clearLog('workerOutput');
      log('workerOutput', `GET ${WORKER_URL}/user-products?user=test`, 'info');
      try {
        const res = await fetch(`${WORKER_URL}/user-products?user=test`);
        const data = await res.json();
        log('workerOutput', `‚úÖ Response received`, 'success');
        log('workerOutput', JSON.stringify(data, null, 2), 'info');
      } catch (err) {
        log('workerOutput', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    function clearWorkerOutput() { clearLog('workerOutput'); }

    // Data Sync Verification
    async function runFullVerification() {
      clearLog('syncOutput');
      log('syncOutput', 'üîÑ Running full sync verification...', 'info');
      log('syncOutput', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
      
      // Check Stripe
      log('syncOutput', '1Ô∏è‚É£ Checking Stripe...', 'info');
      try {
        const res = await fetch('https://api.stripe.com/v1/products?limit=100', {
          headers: { 'Authorization': `Bearer ${STRIPE_KEY}` }
        });
        const data = await res.json();
        log('syncOutput', `   ‚úÖ Stripe: ${data.data.length} products`, 'success');
      } catch (err) {
        log('syncOutput', `   ‚ùå Stripe error: ${err.message}`, 'error');
      }
      
      // Check KV
      log('syncOutput', '2Ô∏è‚É£ Checking KV Storage...', 'info');
      try {
        const res = await fetch(`${WORKER_URL}/products`);
        const products = await res.json();
        log('syncOutput', `   ‚úÖ KV: ${products.length} products`, 'success');
      } catch (err) {
        log('syncOutput', `   ‚ùå KV error: ${err.message}`, 'error');
      }
      
      // Check Worker
      log('syncOutput', '3Ô∏è‚É£ Checking Worker API...', 'info');
      try {
        const res = await fetch(`${WORKER_URL}/version`);
        const data = await res.json();
        log('syncOutput', `   ‚úÖ Worker: v${data.version}`, 'success');
      } catch (err) {
        log('syncOutput', `   ‚ùå Worker error: ${err.message}`, 'error');
      }
      
      log('syncOutput', '', 'info');
      log('syncOutput', '‚úÖ Verification complete!', 'success');
    }

    async function clearAllData() {
      if (!confirm('‚ö†Ô∏è Delete ALL data from Stripe & KV?')) return;
      if (!confirm('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è THIS CANNOT BE UNDONE! Type DELETE to confirm')) return;
      
      clearLog('syncOutput');
      log('syncOutput', 'üóëÔ∏è Clearing all data...', 'warning');
      log('syncOutput', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'warning');
      
      try {
        // Clear Stripe
        log('syncOutput', '1Ô∏è‚É£ Clearing Stripe products...', 'info');
        const stripeRes = await fetch('https://api.stripe.com/v1/products?limit=100', {
          headers: { 'Authorization': `Bearer ${STRIPE_KEY}` }
        });
        const { data: products } = await stripeRes.json();
        
        let deleted = 0;
        for (const product of products) {
          await fetch(`https://api.stripe.com/v1/products/${product.id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${STRIPE_KEY}` }
          });
          log('syncOutput', `  ‚úÖ Deleted ${product.name}`, 'success');
          deleted++;
        }
        log('syncOutput', `‚úÖ Stripe: Deleted ${deleted} products`, 'success');
        
        // Clear KV
        log('syncOutput', '2Ô∏è‚É£ Clearing KV storage...', 'info');
        const kvKeysRes = await fetch(
          `https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT}/storage/kv/namespaces/${KV_NAMESPACE}/keys`,
          { headers: { 'Authorization': `Bearer ${CF_TOKEN}` } }
        );
        const { result: keys } = await kvKeysRes.json();
        
        let kvDeleted = 0;
        for (const key of keys) {
          await fetch(
            `https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT}/storage/kv/namespaces/${KV_NAMESPACE}/values/${key.name}`,
            { 
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${CF_TOKEN}` }
            }
          );
          log('syncOutput', `  ‚úÖ Deleted ${key.name}`, 'success');
          kvDeleted++;
        }
        log('syncOutput', `‚úÖ KV: Deleted ${kvDeleted} keys`, 'success');
        
        log('syncOutput', '', 'info');
        log('syncOutput', '‚úÖ All data cleared!', 'success');
        log('syncOutput', 'üéØ Stripe: 0 products | KV: 0 keys', 'info');
        
        await refreshStats();
        
      } catch (err) {
        log('syncOutput', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    // CSV Functions
    function togglePasteArea() {
      const area = document.getElementById('pasteArea');
      area.style.display = area.style.display === 'none' ? 'block' : 'none';
    }

    function handleCSVUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      document.getElementById('csvFileName').textContent = file.name;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        parseCSV(text);
      };
      reader.readAsText(file);
    }

    function parseCSVFromText() {
      const text = document.getElementById('csvTextInput').value.trim();
      if (!text) {
        alert('Please paste CSV data');
        return;
      }
      document.getElementById('csvFileName').textContent = '(from pasted text)';
      parseCSV(text);
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n').filter(l => l.trim());
      const headers = lines[0].split(',').map(h => h.trim());
      
      csvData = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const row = {};
        headers.forEach((h, idx) => row[h] = values[idx] || '');
        csvData.push(row);
      }
      
      document.getElementById('uploadStripeBtn').style.display = 'inline-block';
      document.getElementById('syncKVBtn').style.display = 'inline-block';
      document.getElementById('previewBtn').style.display = 'inline-block';
      
      clearLog('csvOutput');
      log('csvOutput', `‚úÖ Parsed ${csvData.length} rows from CSV`, 'success');
      previewCSV();
    }

    function previewCSV() {
      if (!csvData) return;
      
      const preview = document.getElementById('csvPreview');
      const thead = document.getElementById('csvTableHead');
      const tbody = document.getElementById('csvTableBody');
      
      document.getElementById('rowCount').textContent = csvData.length;
      
      const headers = Object.keys(csvData[0]);
      thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
      tbody.innerHTML = csvData.map(row => 
        '<tr>' + headers.map(h => `<td>${row[h] || '-'}</td>`).join('') + '</tr>'
      ).join('');
      
      preview.style.display = 'block';
    }

    async function uploadToStripe() {
      if (!csvData) return;
      
      clearLog('csvOutput');
      log('csvOutput', `‚¨ÜÔ∏è Uploading ${csvData.length} products to Stripe...`, 'info');
      log('csvOutput', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
      
      let success = 0, failed = 0;
      
      for (const row of csvData) {
        try {
          log('csvOutput', `Uploading ${row.Name}...`, 'info');
          
          const productData = new URLSearchParams({
            name: row.Name,
            description: `${row.Morph} | ${row.Gender} | Born ${row.YOB}`
          });
          
          const productRes = await fetch('https://api.stripe.com/v1/products', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${STRIPE_KEY}`,
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: productData
          });
          
          if (!productRes.ok) throw new Error('Product creation failed');
          const product = await productRes.json();
          
          const priceData = new URLSearchParams({
            product: product.id,
            unit_amount: '15000',
            currency: 'eur'
          });
          
          const priceRes = await fetch('https://api.stripe.com/v1/prices', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${STRIPE_KEY}`,
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: priceData
          });
          
          if (!priceRes.ok) throw new Error('Price creation failed');
          
          log('csvOutput', `  ‚úÖ ${row.Name}`, 'success');
          success++;
          
        } catch (err) {
          log('csvOutput', `  ‚ùå ${row.Name}: ${err.message}`, 'error');
          failed++;
        }
      }
      
      log('csvOutput', '', 'info');
      log('csvOutput', `‚úÖ Upload complete! ${success} succeeded, ${failed} failed`, 'success');
      log('csvOutput', 'üí° Now click "Sync to KV"', 'info');
      await refreshStripeCount();
    }

    async function syncToKV() {
      clearLog('csvOutput');
      log('csvOutput', 'üîÑ Syncing Stripe ‚Üí KV via Worker...', 'info');
      log('csvOutput', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
      
      try {
        log('csvOutput', 'üì° Sending request to Worker...', 'info');
        const res = await fetch(`${WORKER_URL}/sync-stripe-to-kv`, { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${await res.text()}`);
        }
        
        const result = await res.json();
        
        log('csvOutput', '', 'info');
        log('csvOutput', `‚úÖ Sync complete!`, 'success');
        log('csvOutput', `   üì¶ Total: ${result.total} products`, 'info');
        log('csvOutput', `   ‚úÖ Synced: ${result.synced}`, 'success');
        log('csvOutput', `   ‚ùå Failed: ${result.failed}`, result.failed > 0 ? 'error' : 'info');
        
        if (result.results && result.failed > 0) {
          log('csvOutput', '', 'info');
          log('csvOutput', 'Failed products:', 'warning');
          result.results.filter(r => !r.success).forEach(r => {
            log('csvOutput', `  ‚ùå ${r.name}: ${r.error}`, 'error');
          });
        }
        
        log('csvOutput', '', 'info');
        log('csvOutput', 'üéâ KV storage updated! Check catalog.html', 'success');
        await refreshKVCount();
        
      } catch (err) {
        log('csvOutput', '', 'info');
        log('csvOutput', `‚ùå Sync failed: ${err.message}`, 'error');
        log('csvOutput', '', 'info');
        log('csvOutput', 'üí° Make sure Worker is deployed with latest code', 'warning');
      }
    }

    function clearPasteArea() {
      document.getElementById('csvTextInput').value = '';
      document.getElementById('csvFileName').textContent = '';
      csvData = null;
      document.getElementById('uploadStripeBtn').style.display = 'none';
      document.getElementById('syncKVBtn').style.display = 'none';
      document.getElementById('previewBtn').style.display = 'none';
      document.getElementById('csvPreview').style.display = 'none';
      clearLog('csvOutput');
    }

    function downloadSampleCSV() {
      const csv = `Name,Morph,Gender,YOB,Weight
Pudding,Banana H. Clown,Male,2024,
Taohu,Super Mojave,Male,2024,
Chocolate Chip,Pastel DG,Male,2021,`;
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sample-snakes.csv';
      a.click();
      URL.revokeObjectURL(url);
      log('csvOutput', '‚úÖ Sample CSV downloaded', 'success');
    }

    // Auto-load stats on page load
    window.addEventListener('load', () => {
      refreshStripeCount();
      refreshKVCount();
      refreshCustomerCount();
    });
  </script>
</body>
</html>
