<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè• SMRI Health Check - Serpent Town</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #58a6ff; margin-bottom: 10px; font-size: 24px; }
    .subtitle { color: #8b949e; margin-bottom: 20px; font-size: 13px; }
    .btn {
      background: #238636;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 5px;
    }
    .btn:hover { background: #2ea043; }
    #output {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 13px;
    }
    .pass { color: #3fb950; }
    .fail { color: #f85149; }
  </style>
</head>
<body>
  <h1>üè• SMRI System Health Check</h1>
  <p class="subtitle" id="subtitle">Loading...</p>
  
  <button onclick="runTests()" class="btn">‚ñ∂ Run All Tests</button>
  <button onclick="showVersions()" class="btn">üìä Show Versions</button>
  
  <div id="output">Click "Run All Tests" to begin...</div>

  <script type="module">
    import { VERSION, VERSION_CONFIG, getSMRIScenario, getSMRIStats } from '../src/config/version.js';
    
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    
    // Update subtitle
    const healthScenario = getSMRIScenario('S0.1,2,3,4,5,5-1,5-2.03');
    const stats = getSMRIStats();
    document.getElementById('subtitle').innerHTML = `
      <strong>App:</strong> ${VERSION} | 
      <strong>SMRI:</strong> ${healthScenario.code} (${healthScenario.done}% done) | 
      <strong>Progress:</strong> ${stats.completed}/${stats.total} scenarios (${stats.avgProgress}% avg)
    `;
    
    window.showVersions = function() {
      document.getElementById('output').innerHTML = `
        <strong>üìä Version Information:</strong><br><br>
        App Version: ${VERSION}<br>
        SMRI Module: ${VERSION_CONFIG.MODULES.smri}<br>
        Health Scenario: ${healthScenario.code}<br>
        Completion: ${healthScenario.done}%<br><br>
        <strong>Overall Stats:</strong><br>
        Total Scenarios: ${stats.total}<br>
        Completed: ${stats.completed}<br>
        In Progress: ${stats.inProgress}<br>
        Avg Progress: ${stats.avgProgress}%
      `;
    };
    
    window.runTests = async function() {
      const output = document.getElementById('output');
      output.innerHTML = '<div>üîç Running tests...</div>';
      
      const results = [];
      
      try {
        // Test 1: Worker ping
        const start = Date.now();
        const res = await fetch(WORKER_URL + '/products');
        const latency = Date.now() - start;
        if (res.ok) {
          results.push(`<div class="pass">‚úÖ Worker online (${latency}ms)</div>`);
        } else {
          results.push(`<div class="fail">‚ùå Worker returned ${res.status}</div>`);
        }
        
        // Test 2: Products
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          results.push(`<div class="pass">‚úÖ Loaded ${data.length} products</div>`);
        } else {
          results.push(`<div class="fail">‚ùå No products found</div>`);
        }
        
        // Test 3: Product schema
        const required = ['id', 'name', 'species', 'morph', 'price'];
        const first = data[0];
        const hasAll = required.every(f => f in first);
        if (hasAll) {
          results.push(`<div class="pass">‚úÖ Product schema valid</div>`);
        } else {
          results.push(`<div class="fail">‚ùå Missing required fields</div>`);
        }
        
        // Test 4: Stripe products
        const stripe = data.filter(p => p.stripe_link);
        if (stripe.length > 0) {
          results.push(`<div class="pass">‚úÖ Found ${stripe.length} Stripe products</div>`);
        } else {
          results.push(`<div class="fail">‚ùå No Stripe products</div>`);
        }
        
        output.innerHTML = '<strong>Test Results:</strong><br><br>' + results.join('<br>');
        
      } catch (error) {
        output.innerHTML = `<div class="fail">‚ùå Test failed: ${error.message}</div>`;
      }
    };
    
    console.log('‚úÖ Health check loaded - Version:', VERSION);
  </script>
</body>
</html>
