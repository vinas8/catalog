<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß™ SMRI Test Runner - Snake Muffin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .header h1 { 
      color: white; 
      font-size: 32px; 
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .breadcrumb {
      color: rgba(255,255,255,0.7);
      font-size: 13px;
      margin-bottom: 15px;
    }
    
    .breadcrumb a { 
      color: rgba(255,255,255,0.9); 
      text-decoration: none; 
    }
    
    .status-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(255,255,255,0.2);
    }
    
    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover { 
      background: #2ea043; 
      transform: translateY(-1px); 
    }
    
    button:disabled {
      background: #21262d;
      color: #8b949e;
      cursor: not-allowed;
      transform: none;
    }
    
    button.secondary { background: #1f6feb; }
    button.secondary:hover { background: #0969da; }
    
    .panel {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }
    
    .panel h2 {
      color: #58a6ff;
      margin-bottom: 15px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .scenario-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .scenario-card {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .scenario-card:hover {
      border-color: #58a6ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(88, 166, 255, 0.2);
    }
    
    .scenario-card.running {
      border-color: #f0883e;
      animation: pulse 1.5s infinite;
    }
    
    .scenario-card.passed {
      border-color: #3fb950;
      background: rgba(63, 185, 80, 0.05);
    }
    
    .scenario-card.failed {
      border-color: #f85149;
      background: rgba(248, 81, 73, 0.05);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .scenario-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #c9d1d9;
    }
    
    .scenario-id {
      font-size: 11px;
      color: #8b949e;
      font-family: monospace;
      margin-bottom: 12px;
    }
    
    .scenario-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #30363d;
    }
    
    .scenario-status .icon {
      font-size: 18px;
    }
    
    .test-output {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      line-height: 1.6;
      min-height: 300px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .log-entry {
      margin-bottom: 4px;
      display: flex;
      gap: 8px;
    }
    
    .log-time {
      color: #8b949e;
      flex-shrink: 0;
    }
    
    .log-message {
      color: #c9d1d9;
    }
    
    .log-error { color: #f85149; }
    .log-success { color: #3fb950; }
    .log-warning { color: #f0883e; }
    .log-info { color: #58a6ff; }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-value.passed { color: #3fb950; }
    .stat-value.failed { color: #f85149; }
    .stat-value.total { color: #58a6ff; }
    
    .stat-label {
      font-size: 12px;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .iframe-container {
      background: white;
      border: 2px solid #30363d;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 20px;
      height: 700px;
      position: relative;
    }
    
    .iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }
    
    .iframe-header {
      background: #21262d;
      padding: 8px 16px;
      border-bottom: 1px solid #30363d;
      font-size: 12px;
      color: #8b949e;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .iframe-url {
      font-family: monospace;
      color: #58a6ff;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="breadcrumb">
        <a href="index.html">üêç Debug Hub</a> ‚Üí SMRI Test Runner
      </div>
      <h1>
        üß™ SMRI Test Runner
        <span class="status-badge" id="globalStatus">Ready</span>
      </h1>
      <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin-top: 8px;">
        Integrated browser testing with live HTML rendering
      </p>
    </div>

    <div class="panel">
      <h2>‚ö° Quick Actions</h2>
      <div class="controls">
        <button id="btnRunAll">
          <span>‚ñ∂Ô∏è</span>
          Run All Tests
        </button>
        <button class="secondary" id="btnRunPurchase">
          <span>üõí</span>
          Purchase Flow
        </button>
        <button class="secondary" id="btnRunHealthcheck">
          <span>üè•</span>
          Healthcheck
        </button>
        <button class="secondary" id="btnRunAPI">
          <span>üîå</span>
          Worker API
        </button>
        <button class="secondary" id="btnClear">
          <span>üóëÔ∏è</span>
          Clear Results
        </button>
      </div>
    </div>

    <div class="panel">
      <h2>üìä Test Results</h2>
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value passed" id="statPassed">0</div>
          <div class="stat-label">Passed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value failed" id="statFailed">0</div>
          <div class="stat-label">Failed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value total" id="statTotal">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statDuration" style="color: #f0883e;">0ms</div>
          <div class="stat-label">Duration</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>üß™ Test Scenarios</h2>
      <div class="scenario-grid" id="scenarioGrid"></div>
    </div>

    <div class="panel">
      <h2>üìù Console Output</h2>
      <div class="test-output" id="consoleOutput">
        <div class="log-entry">
          <span class="log-time">--:--:--</span>
          <span class="log-message log-info">Ready to run tests...</span>
        </div>
      </div>
    </div>

    <div class="panel" id="renderPanel" style="display: none;">
      <h2>üé® Live Render (Browser View)</h2>
      <p style="color: #8b949e; font-size: 13px; margin-bottom: 15px;">
        See the actual page rendering in real-time. Scroll within the frame to view products.
      </p>
      
      <!-- Pipeline Navigation -->
      <div id="pipelineNav" style="display: none; margin-bottom: 20px; background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 15px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
          <div style="font-size: 13px; font-weight: 600; color: #58a6ff;">üìç Purchase Pipeline</div>
          <div id="pipelineProgress" style="font-size: 11px; color: #8b949e;">Step 1 of 6</div>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button id="btnPrevStep" class="secondary" style="padding: 8px 16px; font-size: 12px;">‚óÄ Previous</button>
          <button id="btnNextStep" class="secondary" style="padding: 8px 16px; font-size: 12px;">Next ‚ñ∂</button>
          <button id="btnResetPipeline" style="padding: 8px 16px; font-size: 12px; background: #21262d;">üîÑ Reset</button>
          <div id="currentStep" style="flex: 1; padding: 8px 12px; background: #161b22; border-radius: 6px; font-size: 12px; color: #c9d1d9; text-align: center;"></div>
        </div>
      </div>
      
      <div class="iframe-container">
        <div class="iframe-header">
          <span>üåê</span>
          <span class="iframe-url" id="iframeUrl">about:blank</span>
          <button onclick="renderFrame.src = renderFrame.src" style="padding: 4px 8px; font-size: 11px;">üîÑ Reload</button>
          <button id="btnShowPipeline" style="padding: 4px 8px; font-size: 11px; background: #1f6feb;">üìç Show Pipeline</button>
        </div>
        <iframe id="renderFrame" src="about:blank"></iframe>
      </div>
    </div>
    
    <!-- Debug Console -->
    <div class="panel" id="debugConsolePanel" style="display: none;">
      <h2>üêõ Debug Console</h2>
      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <button onclick="clearDebugConsole()" style="padding: 6px 12px; font-size: 12px; background: #21262d;">üóëÔ∏è Clear</button>
        <button onclick="toggleDebugAutoScroll()" id="btnAutoScroll" style="padding: 6px 12px; font-size: 12px; background: #238636;">‚úÖ Auto-scroll</button>
        <span style="flex: 1; text-align: right; color: #8b949e; font-size: 12px; line-height: 30px;" id="debugLogCount">0 logs</span>
      </div>
      <div style="background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 15px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;" id="debugOutput">
        <div style="color: #8b949e;">Console ready...</div>
      </div>
    </div>
  </div>

  <script type="module">
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    const BASE_PATH = window.location.origin + window.location.pathname.replace(/\/[^/]*$/, '');
    
    // Purchase pipeline steps
    const PIPELINE_STEPS = [
      { id: 'catalog', title: '1. Browse Catalog', url: '../catalog.html', icon: 'üõí' },
      { id: 'product', title: '2. Select Product', url: '../catalog.html', icon: 'üêç' },
      { id: 'checkout', title: '3. Checkout (Stripe)', url: null, icon: 'üí≥', info: 'Opens Stripe' },
      { id: 'success', title: '4. Success Page', url: '../success.html', icon: '‚úÖ' },
      { id: 'collection', title: '5. View Collection', url: '../collection.html', icon: 'üì¶' },
      { id: 'game', title: '6. Play Game', url: '../game.html', icon: 'üéÆ' }
    ];
    
    let currentPipelineStep = 0;
    
    // Default CSV data (24 snakes from collection)
    const DEFAULT_CSV = `Name,Morph,Gender,YOB,Weight
Pudding,Banana H. Clown,Male,2024,
Taohu,Super Mojave,Male,2024,
Chocolate Chip,Pastel DG,Male,2021,
Gangsta,Spotnose Clown,Male,2024,
Mashmellow,Ivory (Super yellow belly),Male,2024,
Brownie,Black head,Male,2024,
Almond,Hurricane Butter Fire Yellow belly H.clown,Female,2024,
Caramel,Hurricane butter Spider pos H.Ghost Clown Pied,Female,2024,
Cookie,HRA Pastel Fire Paradox 50% pos het clown,Female,2024,
Hershy,Super Mystic,Female,2024,
Halibo,Spotnose Super Enchi H.Clown,Female,2023,
Biscuit,Leopard Lesser Pastel H. Clown,Female,2024,
Salabao,OD Highway,Female,2023,
Waffel,HGW Enchi Fire,Female,2023,
Toffee,Spotnose Pastel H.DG,Female,2023,
Coco,Pastel het. DG,Female,2023,
Latte,Lesser Spotnose 66% pos h.clown 50% pos h.DG hypo,Female,2023,
Mochi,Salmon Hypo Bloodred,Male,2023,
Milkshake,Salmon Tessera H.Bloored,Female,2024,
Berry,Snow poss Hypo Strawberry,Female,2024,
Honey,Opal,Female,2024,
Peachy,Opal Tessera,Male,2024,
Lavender,Lavender tessera,Female,2024,
Lolipop,Salmon H. Bloodred,Female,2024,`;
    
    // Test definitions
    const scenarios = [
      {
        id: 'csv-import',
        title: 'CSV Import & Sync',
        smri: 'S2-csv-import',
        url: null,
        icon: 'üì§',
        autoRun: true
      },
      {
        id: 'purchase-flow',
        title: 'Purchase Flow',
        smri: 'S1-purchase-flow',
        url: '../catalog.html',
        icon: 'üõí'
      },
      {
        id: 'catalog-display',
        title: 'Catalog Display',
        smri: 'S1-catalog-display',
        url: '../catalog.html',
        icon: 'üè™'
      },
      {
        id: 'success-page',
        title: 'Success Page',
        smri: 'S1-success-page',
        url: '../success.html',
        icon: '‚úÖ'
      },
      {
        id: 'collection-view',
        title: 'Collection View',
        smri: 'S2-collection-view',
        url: '../collection.html',
        icon: 'üì¶'
      },
      {
        id: 'game-tamagotchi',
        title: 'Game (Tamagotchi)',
        smri: 'S2-game-tamagotchi',
        url: '../game.html',
        icon: 'üéÆ'
      },
      {
        id: 'account-page',
        title: 'Account Page',
        smri: 'S3-account-page',
        url: '../account.html',
        icon: 'üë§'
      },
      {
        id: 'breeding-calculator',
        title: 'Breeding Calculator',
        smri: 'S2-breeding-calc',
        url: 'breeding-calculator.html',
        icon: 'üß¨'
      },
      {
        id: 'healthcheck',
        title: 'Healthcheck Page',
        smri: 'S0-healthcheck',
        url: 'healthcheck.html',
        icon: 'üè•'
      },
      {
        id: 'worker-api',
        title: 'Worker API',
        smri: 'S5-worker-api',
        url: null,
        icon: 'üîå'
      },
      {
        id: 'kv-storage',
        title: 'KV Storage',
        smri: 'S5-kv-storage',
        url: null,
        icon: 'üíæ'
      },
      {
        id: 'import-page',
        title: 'CSV Import Page',
        smri: 'S1-import-page',
        url: '../import.html',
        icon: 'üì•'
      }
    ];
    
    // State
    let results = {
      passed: 0,
      failed: 0,
      total: 0,
      duration: 0,
      scenarios: []
    };
    
    // UI elements
    const scenarioGrid = document.getElementById('scenarioGrid');
    const consoleOutput = document.getElementById('consoleOutput');
    const renderPanel = document.getElementById('renderPanel');
    const renderFrame = document.getElementById('renderFrame');
    const globalStatus = document.getElementById('globalStatus');
    const debugOutput = document.getElementById('debugOutput');
    const debugConsolePanel = document.getElementById('debugConsolePanel');
    const pipelineNav = document.getElementById('pipelineNav');
    
    let debugLogs = [];
    let debugAutoScroll = true;
    
    // Initialize UI
    function initScenarios() {
      scenarioGrid.innerHTML = scenarios.map(s => `
        <div class="scenario-card" data-id="${s.id}">
          <div class="scenario-title">${s.icon} ${s.title}</div>
          <div class="scenario-id">${s.smri}</div>
          <div class="scenario-status">
            <span class="icon">‚è∏Ô∏è</span>
            <span>Not run</span>
          </div>
        </div>
      `).join('');
      
      // Add click handlers
      document.querySelectorAll('.scenario-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = card.dataset.id;
          runScenario(id);
        });
      });
    }
    
    // Logging
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-message log-${type}">${message}</span>
      `;
      consoleOutput.appendChild(entry);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
      
      // Also add to debug console
      debugLog(message, type);
    }
    
    // Debug Console
    function debugLog(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const colors = {
        info: '#58a6ff',
        success: '#3fb950',
        error: '#f85149',
        warning: '#f0883e'
      };
      
      const icons = {
        info: '‚ÑπÔ∏è',
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è'
      };
      
      debugLogs.push({ time, message, type });
      
      const logEntry = document.createElement('div');
      logEntry.style.marginBottom = '4px';
      logEntry.style.color = colors[type] || '#c9d1d9';
      logEntry.innerHTML = `<span style="color: #8b949e;">[${time}]</span> ${icons[type] || ''} ${message}`;
      
      debugOutput.appendChild(logEntry);
      
      if (debugAutoScroll) {
        debugOutput.scrollTop = debugOutput.scrollHeight;
      }
      
      document.getElementById('debugLogCount').textContent = `${debugLogs.length} logs`;
    }
    
    function clearDebugConsole() {
      debugLogs = [];
      debugOutput.innerHTML = '<div style="color: #8b949e;">Console cleared...</div>';
      document.getElementById('debugLogCount').textContent = '0 logs';
    }
    
    function toggleDebugAutoScroll() {
      debugAutoScroll = !debugAutoScroll;
      const btn = document.getElementById('btnAutoScroll');
      btn.textContent = debugAutoScroll ? '‚úÖ Auto-scroll' : '‚è∏Ô∏è Paused';
      btn.style.background = debugAutoScroll ? '#238636' : '#21262d';
    }
    
    // Pipeline Navigation
    function updatePipelineUI() {
      const step = PIPELINE_STEPS[currentPipelineStep];
      document.getElementById('currentStep').textContent = `${step.icon} ${step.title}`;
      document.getElementById('pipelineProgress').textContent = `Step ${currentPipelineStep + 1} of ${PIPELINE_STEPS.length}`;
      
      document.getElementById('btnPrevStep').disabled = currentPipelineStep === 0;
      document.getElementById('btnNextStep').disabled = currentPipelineStep === PIPELINE_STEPS.length - 1;
    }
    
    function navigateToPipelineStep(stepIndex) {
      if (stepIndex < 0 || stepIndex >= PIPELINE_STEPS.length) return;
      
      currentPipelineStep = stepIndex;
      const step = PIPELINE_STEPS[stepIndex];
      
      debugLog(`Navigating to: ${step.title}`, 'info');
      
      if (step.url) {
        const url = BASE_PATH.replace('/debug', '') + '/' + step.url.replace('../', '');
        renderFrame.src = url;
        document.getElementById('iframeUrl').textContent = url;
      } else {
        debugLog(`${step.info || 'External action required'}`, 'warning');
      }
      
      updatePipelineUI();
    }
    
    function showPipeline() {
      pipelineNav.style.display = 'block';
      debugConsolePanel.style.display = 'block';
      updatePipelineUI();
      debugLog('Pipeline navigation enabled', 'success');
    }
    
    // Update stats
    function updateStats() {
      document.getElementById('statPassed').textContent = results.passed;
      document.getElementById('statFailed').textContent = results.failed;
      document.getElementById('statTotal').textContent = results.total;
      document.getElementById('statDuration').textContent = results.duration + 'ms';
    }
    
    // Update scenario card
    function updateScenarioCard(id, status, message) {
      const card = document.querySelector(`[data-id="${id}"]`);
      if (!card) return;
      
      card.className = `scenario-card ${status}`;
      const statusEl = card.querySelector('.scenario-status');
      
      const icons = {
        running: '‚è≥',
        passed: '‚úÖ',
        failed: '‚ùå',
        pending: '‚è∏Ô∏è'
      };
      
      statusEl.innerHTML = `
        <span class="icon">${icons[status]}</span>
        <span>${message}</span>
      `;
    }
    
    // CSV Import Manager (inline for simplicity)
    class CSVImportManager {
      constructor(config = {}) {
        this.workerUrl = config.workerUrl || WORKER_URL;
        this.onLog = config.onLog || console.log;
        this.csvData = null;
      }

      parseCSV(csvText) {
        const lines = csvText.trim().split('\n').filter(l => l.trim());
        if (lines.length < 2) throw new Error('CSV must have headers and at least one data row');
        
        const headers = lines[0].split(',').map(h => h.trim());
        const products = [];
        
        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim());
          const row = {};
          headers.forEach((h, idx) => row[h] = values[idx] || '');
          products.push(row);
        }
        
        this.csvData = products;
        this.onLog(`‚úÖ Parsed ${products.length} products from CSV`, 'success');
        return products;
      }

      formatProductsForStripe() {
        if (!this.csvData) throw new Error('No CSV data loaded');
        
        return this.csvData.map(row => {
          const morph = row.Morph || '';
          const isCornSnake = morph.includes('Corn') || morph.includes('Salmon') || 
                             morph.includes('Opal') || morph.includes('Tessera') || 
                             morph.includes('Bloodred');
          
          return {
            name: row.Name || 'Unnamed Snake',
            morph: morph,
            gender: row.Gender || 'Unknown',
            yob: row.YOB || new Date().getFullYear().toString(),
            weight: row.Weight || 'TBD',
            species: isCornSnake ? 'corn_snake' : 'ball_python',
            price: parseFloat(row.Price) || 150.00
          };
        });
      }

      async uploadToStripe() {
        if (!this.csvData) throw new Error('No CSV data loaded');
        
        this.onLog('‚¨ÜÔ∏è Uploading products to Stripe...', 'info');
        const products = this.formatProductsForStripe();
        
        const res = await fetch(`${this.workerUrl}/upload-products`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products })
        });
        
        const result = await res.json();
        
        if (res.ok) {
          this.onLog(`‚úÖ Stripe upload: ${result.uploaded}/${result.total} succeeded`, 'success');
          return result;
        } else {
          throw new Error(result.error || 'Upload failed');
        }
      }

      async syncToKV() {
        this.onLog('üîÑ Syncing Stripe ‚Üí KV...', 'info');
        
        const res = await fetch(`${this.workerUrl}/sync-stripe-to-kv`, { method: 'POST' });
        const result = await res.json();
        
        if (res.ok) {
          this.onLog(`‚úÖ KV sync: ${result.synced}/${result.total} synced`, 'success');
          return result;
        } else {
          throw new Error(result.error || 'Sync failed');
        }
      }

      async getProducts() {
        const res = await fetch(`${this.workerUrl}/products`);
        if (!res.ok) throw new Error('Failed to fetch products');
        const products = await res.json();
        this.onLog(`üì¶ Fetched ${products.length} products from KV`, 'info');
        return products;
      }

      async fullImport(csvText) {
        this.onLog('üöÄ Starting full import flow...', 'info');
        
        this.parseCSV(csvText);
        const uploadResult = await this.uploadToStripe();
        const syncResult = await this.syncToKV();
        const products = await this.getProducts();
        
        this.onLog('‚úÖ Full import complete!', 'success');
        this.onLog(`üìä Final: ${products.length} products in catalog`, 'success');
        
        return {
          success: true,
          parsed: this.csvData.length,
          uploaded: uploadResult.uploaded,
          synced: syncResult.synced,
          total: products.length
        };
      }
    }
    
    // Test: CSV Import & Sync
    async function testCSVImport() {
      log('üì§ Testing CSV Import & Sync...', 'info');
      const startTime = Date.now();
      const steps = [];
      
      try {
        // Initialize CSV manager
        const csvManager = new CSVImportManager({
          workerUrl: WORKER_URL,
          onLog: (msg, type) => log(`   ${msg}`, type)
        });
        
        log('1Ô∏è‚É£ Parsing default CSV (24 snakes)...', 'info');
        const products = csvManager.parseCSV(DEFAULT_CSV);
        steps.push({ step: 'Parse CSV', passed: true, count: products.length });
        
        log('2Ô∏è‚É£ Uploading to Stripe...', 'info');
        const uploadResult = await csvManager.uploadToStripe();
        steps.push({ 
          step: 'Upload to Stripe', 
          passed: uploadResult.uploaded > 0, 
          uploaded: uploadResult.uploaded 
        });
        
        log('3Ô∏è‚É£ Syncing to KV...', 'info');
        const syncResult = await csvManager.syncToKV();
        steps.push({ 
          step: 'Sync to KV', 
          passed: syncResult.synced > 0, 
          synced: syncResult.synced 
        });
        
        log('4Ô∏è‚É£ Verifying products in catalog...', 'info');
        const catalogProducts = await csvManager.getProducts();
        steps.push({ 
          step: 'Verify Catalog', 
          passed: catalogProducts.length > 0, 
          count: catalogProducts.length 
        });
        
        if (catalogProducts.length === 0) {
          throw new Error('No products found in catalog after import');
        }
        
        const duration = Date.now() - startTime;
        log(`‚úÖ CSV Import test complete - ${catalogProducts.length} products ready`, 'success');
        return { passed: true, steps, duration };
        
      } catch (error) {
        log(`   ‚ùå FAILED: ${error.message}`, 'error');
        const duration = Date.now() - startTime;
        return { passed: false, error: error.message, steps, duration };
      }
    }
    
    // Test: Purchase Flow
    async function testPurchaseFlow() {
      log('üõí Testing Purchase Flow (Catalog)...', 'info');
      const startTime = Date.now();
      const steps = [];
      
      try {
        // Load catalog in iframe
        const catalogUrl = BASE_PATH.replace('/debug', '') + '/catalog.html';
        log('1Ô∏è‚É£ Loading catalog.html...', 'info');
        renderPanel.style.display = 'block';
        debugConsolePanel.style.display = 'block';
        renderFrame.src = catalogUrl;
        document.getElementById('iframeUrl').textContent = catalogUrl;
        
        // Show pipeline button
        document.getElementById('btnShowPipeline').style.display = 'inline-block';
        
        // Capture iframe console logs
        try {
          renderFrame.onload = () => {
            try {
              const iframeWindow = renderFrame.contentWindow;
              if (iframeWindow) {
                const originalConsoleLog = iframeWindow.console.log;
                const originalConsoleError = iframeWindow.console.error;
                const originalConsoleWarn = iframeWindow.console.warn;
                
                iframeWindow.console.log = function(...args) {
                  debugLog(`[IFRAME] ${args.join(' ')}`, 'info');
                  originalConsoleLog.apply(iframeWindow.console, args);
                };
                
                iframeWindow.console.error = function(...args) {
                  debugLog(`[IFRAME] ${args.join(' ')}`, 'error');
                  originalConsoleError.apply(iframeWindow.console, args);
                };
                
                iframeWindow.console.warn = function(...args) {
                  debugLog(`[IFRAME] ${args.join(' ')}`, 'warning');
                  originalConsoleWarn.apply(iframeWindow.console, args);
                };
              }
            } catch (e) {
              debugLog('Cannot access iframe console (CORS)', 'warning');
            }
          };
        } catch (e) {
          debugLog('Console capture failed: ' + e.message, 'warning');
        }
        
        await new Promise(resolve => {
          setTimeout(resolve, 5000); // Fallback timeout
        });
        
        steps.push({ step: 'Load catalog', passed: true });
        log('   ‚úÖ Catalog HTML loaded', 'success');
        
        // Wait for JavaScript to execute and render products
        log('2Ô∏è‚É£ Waiting for products to render...', 'info');
        await new Promise(resolve => setTimeout(resolve, 3000)); // Wait for fetch + render
        
        // Check if iframe has products
        const iframeDoc = renderFrame.contentDocument;
        if (!iframeDoc) {
          throw new Error('Cannot access iframe document');
        }
        
        // Check for catalog-item (actual product cards)
        const catalogItems = iframeDoc.querySelectorAll('.catalog-item');
        log(`   üì¶ Found ${catalogItems.length} .catalog-item elements`, catalogItems.length > 0 ? 'success' : 'warning');
        
        // Check loading state
        const loadingElements = iframeDoc.querySelectorAll('.loading');
        const hasLoading = Array.from(loadingElements).some(el => el.offsetParent !== null);
        if (hasLoading) {
          log('   ‚ö†Ô∏è  Still showing "Loading..." - fetch may have failed', 'warning');
        }
        
        // Check empty state
        const emptyStates = iframeDoc.querySelectorAll('.empty-state');
        if (emptyStates.length > 0) {
          log(`   ‚ÑπÔ∏è  Found ${emptyStates.length} empty-state messages`, 'info');
        }
        
        // Check for actual rendered products
        const availableContainer = iframeDoc.getElementById('available-snakes');
        const virtualContainer = iframeDoc.getElementById('virtual-snakes');
        
        if (availableContainer) {
          const availableProducts = availableContainer.querySelectorAll('.catalog-item:not(.virtual)');
          log(`   üêç Real snakes rendered: ${availableProducts.length}`, 'success');
          steps.push({ step: 'Real snakes', passed: true, count: availableProducts.length });
        }
        
        if (virtualContainer) {
          const virtualProducts = virtualContainer.querySelectorAll('.catalog-item.virtual');
          log(`   üí∞ Virtual snakes rendered: ${virtualProducts.length}`, 'success');
          steps.push({ step: 'Virtual snakes', passed: true, count: virtualProducts.length });
        }
        
        // Validate product structure
        if (catalogItems.length > 0) {
          const firstProduct = catalogItems[0];
          const hasName = firstProduct.querySelector('h3');
          const hasPrice = firstProduct.querySelector('.item-price');
          const hasButton = firstProduct.querySelector('button, a.primary-btn');
          
          if (hasName && hasPrice && hasButton) {
            log('   ‚úÖ Product structure valid (name, price, button)', 'success');
            steps.push({ step: 'Product structure', passed: true });
          } else {
            log(`   ‚ö†Ô∏è  Product structure incomplete: name=${!!hasName}, price=${!!hasPrice}, button=${!!hasButton}`, 'warning');
          }
        }
        
        // Final validation
        if (catalogItems.length === 0 && !hasLoading) {
          throw new Error('No products rendered and not loading - check Worker API');
        }
        
        const duration = Date.now() - startTime;
        log(`‚úÖ Catalog test complete - ${catalogItems.length} products shown`, 'success');
        return { passed: true, steps, duration };
        
      } catch (error) {
        log(`   ‚ùå FAILED: ${error.message}`, 'error');
        const duration = Date.now() - startTime;
        return { passed: false, error: error.message, steps, duration };
      }
    }
    
    // Test: Healthcheck
    async function testHealthcheck() {
      log('üè• Testing Healthcheck...', 'info');
      const startTime = Date.now();
      
      try {
        const healthUrl = 'healthcheck.html';
        log('1Ô∏è‚É£ Loading healthcheck.html...', 'info');
        renderPanel.style.display = 'block';
        renderFrame.src = healthUrl;
        document.getElementById('iframeUrl').textContent = BASE_PATH + '/' + healthUrl;
        
        await new Promise(resolve => {
          renderFrame.onload = resolve;
          setTimeout(resolve, 3000);
        });
        
        log('   ‚úÖ Healthcheck loaded', 'success');
        
        const iframeDoc = renderFrame.contentDocument;
        if (iframeDoc) {
          const serviceGroups = iframeDoc.querySelectorAll('.service-group');
          log(`   ‚úÖ Found ${serviceGroups.length} service groups`, 'success');
        }
        
        const duration = Date.now() - startTime;
        return { passed: true, duration };
        
      } catch (error) {
        log(`   ‚ùå FAILED: ${error.message}`, 'error');
        const duration = Date.now() - startTime;
        return { passed: false, error: error.message, duration };
      }
    }
    
    // Test: Worker API
    async function testWorkerAPI() {
      log('üîå Testing Worker API...', 'info');
      const startTime = Date.now();
      
      try {
        log('1Ô∏è‚É£ Fetching /products...', 'info');
        const response = await fetch(`${WORKER_URL}/products`);
        
        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }
        
        const products = await response.json();
        log(`   ‚úÖ API returned ${products.length} products`, 'success');
        
        if (!Array.isArray(products)) {
          throw new Error('Response is not an array');
        }
        
        if (products.length > 0) {
          const hasStructure = products[0].id && products[0].name && products[0].price;
          if (!hasStructure) {
            throw new Error('Product missing required fields');
          }
          log('   ‚úÖ Product structure valid', 'success');
        }
        
        const duration = Date.now() - startTime;
        return { passed: true, duration };
        
      } catch (error) {
        log(`   ‚ùå FAILED: ${error.message}`, 'error');
        const duration = Date.now() - startTime;
        return { passed: false, error: error.message, duration };
      }
    }
    
    // Test: KV Storage
    async function testKVStorage() {
      log('üíæ Testing KV Storage...', 'info');
      const startTime = Date.now();
      
      try {
        log('1Ô∏è‚É£ Testing KV read operations...', 'info');
        
        const productsRes = await fetch(`${WORKER_URL}/products`);
        if (!productsRes.ok) throw new Error('Products fetch failed');
        const products = await productsRes.json();
        log(`   ‚úÖ KV Read: ${products.length} products`, 'success');
        
        const duration = Date.now() - startTime;
        return { passed: true, duration };
        
      } catch (error) {
        log(`   ‚ùå FAILED: ${error.message}`, 'error');
        const duration = Date.now() - startTime;
        return { passed: false, error: error.message, duration };
      }
    }
    
    // Generic HTML Page Test
    async function testHTMLPage(url, pageTitle, checks = []) {
      log(`üìÑ Testing ${pageTitle}...`, 'info');
      const startTime = Date.now();
      
      try {
        log(`1Ô∏è‚É£ Loading ${url}...`, 'info');
        renderPanel.style.display = 'block';
        
        const fullUrl = url.startsWith('http') ? url : 
                       url.startsWith('../') ? BASE_PATH.replace('/debug', '') + '/' + url.replace('../', '') :
                       BASE_PATH + '/' + url;
        
        renderFrame.src = fullUrl;
        document.getElementById('iframeUrl').textContent = fullUrl;
        
        await new Promise((resolve) => {
          renderFrame.onload = resolve;
          setTimeout(resolve, 3000);
        });
        
        log('   ‚úÖ Page loaded', 'success');
        
        const iframeDoc = renderFrame.contentDocument;
        if (iframeDoc && checks.length > 0) {
          for (const check of checks) {
            try {
              const result = check(iframeDoc);
              if (result) log(`   ‚úÖ ${result}`, 'success');
            } catch (e) {
              log(`   ‚ö†Ô∏è  Check skipped: ${e.message}`, 'warning');
            }
          }
        }
        
        const duration = Date.now() - startTime;
        return { passed: true, duration };
        
      } catch (error) {
        log(`   ‚ùå FAILED: ${error.message}`, 'error');
        const duration = Date.now() - startTime;
        return { passed: false, error: error.message, duration };
      }
    }
    
    // Specific page tests
    async function testCatalogDisplay() {
      return testHTMLPage('../catalog.html', 'Catalog Display', [
        (doc) => {
          const items = doc.querySelectorAll('.catalog-item');
          return items.length > 0 ? `${items.length} products displayed` : null;
        }
      ]);
    }
    
    async function testSuccessPage() {
      return testHTMLPage('../success.html', 'Success Page', [
        (doc) => {
          const heading = doc.querySelector('h1');
          return heading ? 'Success message displayed' : null;
        }
      ]);
    }
    
    async function testCollectionView() {
      return testHTMLPage('../collection.html', 'Collection View', [
        (doc) => {
          const container = doc.querySelector('#collection-container');
          return container ? 'Collection container present' : null;
        }
      ]);
    }
    
    async function testGameTamagotchi() {
      return testHTMLPage('../game.html', 'Game (Tamagotchi)', [
        (doc) => {
          const snakeList = doc.querySelector('#snake-list');
          return snakeList ? 'Snake list present' : null;
        }
      ]);
    }
    
    async function testAccountPage() {
      return testHTMLPage('../account.html', 'Account Page', [
        (doc) => {
          const form = doc.querySelector('form');
          return form ? 'Account form present' : null;
        }
      ]);
    }
    
    async function testBreedingCalculator() {
      return testHTMLPage('breeding-calculator.html', 'Breeding Calculator', [
        (doc) => {
          const selects = doc.querySelectorAll('select');
          return selects.length >= 2 ? `Parent selectors present` : null;
        }
      ]);
    }
    
    async function testImportPage() {
      return testHTMLPage('../import.html', 'CSV Import Page', [
        (doc) => {
          const fileInput = doc.querySelector('input[type="file"]');
          return fileInput ? 'File upload input present' : null;
        }
      ]);
    }
    
    // Run single scenario
    async function runScenario(id) {
      const scenario = scenarios.find(s => s.id === id);
      if (!scenario) return;
      
      log(`\n${'='.repeat(50)}\nüß™ Running: ${scenario.title}\n${'='.repeat(50)}`, 'info');
      updateScenarioCard(id, 'running', 'Running...');
      
      let result;
      if (id === 'csv-import') {
        result = await testCSVImport();
      } else if (id === 'purchase-flow') {
        result = await testPurchaseFlow();
      } else if (id === 'catalog-display') {
        result = await testCatalogDisplay();
      } else if (id === 'success-page') {
        result = await testSuccessPage();
      } else if (id === 'collection-view') {
        result = await testCollectionView();
      } else if (id === 'game-tamagotchi') {
        result = await testGameTamagotchi();
      } else if (id === 'account-page') {
        result = await testAccountPage();
      } else if (id === 'breeding-calculator') {
        result = await testBreedingCalculator();
      } else if (id === 'healthcheck') {
        result = await testHealthcheck();
      } else if (id === 'worker-api') {
        result = await testWorkerAPI();
      } else if (id === 'kv-storage') {
        result = await testKVStorage();
      } else if (id === 'import-page') {
        result = await testImportPage();
      }
      
      // Update results
      results.total++;
      results.duration += result.duration || 0;
      
      if (result.passed) {
        results.passed++;
        log(`‚úÖ PASSED in ${result.duration}ms\n`, 'success');
        updateScenarioCard(id, 'passed', `Passed (${result.duration}ms)`);
      } else {
        results.failed++;
        log(`‚ùå FAILED in ${result.duration}ms\n`, 'error');
        updateScenarioCard(id, 'failed', result.error);
      }
      
      updateStats();
      updateGlobalStatus();
    }
    
    // Run all scenarios
    async function runAll() {
      log('üöÄ Running all tests...', 'info');
      results = { passed: 0, failed: 0, total: 0, duration: 0 };
      
      for (const scenario of scenarios) {
        await runScenario(scenario.id);
        await new Promise(resolve => setTimeout(resolve, 500)); // Brief pause
      }
      
      log(`\n${'='.repeat(50)}\nüìä All tests complete!\n${'='.repeat(50)}`, 'info');
    }
    
    // Update global status
    function updateGlobalStatus() {
      if (results.total === 0) {
        globalStatus.textContent = 'Ready';
        globalStatus.style.background = 'rgba(255,255,255,0.2)';
      } else if (results.failed === 0) {
        globalStatus.textContent = `‚úÖ All Passed (${results.passed}/${results.total})`;
        globalStatus.style.background = '#238636';
      } else {
        globalStatus.textContent = `‚ö†Ô∏è ${results.failed} Failed`;
        globalStatus.style.background = '#da3633';
      }
    }
    
    // Clear results
    function clearResults() {
      results = { passed: 0, failed: 0, total: 0, duration: 0 };
      consoleOutput.innerHTML = '<div class="log-entry"><span class="log-time">--:--:--</span><span class="log-message log-info">Cleared.</span></div>';
      updateStats();
      updateGlobalStatus();
      renderPanel.style.display = 'none';
      
      document.querySelectorAll('.scenario-card').forEach(card => {
        card.className = 'scenario-card';
        card.querySelector('.scenario-status').innerHTML = '<span class="icon">‚è∏Ô∏è</span><span>Not run</span>';
      });
    }
    
    // Event listeners
    document.getElementById('btnRunAll').addEventListener('click', runAll);
    document.getElementById('btnRunPurchase').addEventListener('click', () => runScenario('purchase-flow'));
    document.getElementById('btnRunHealthcheck').addEventListener('click', () => runScenario('healthcheck'));
    document.getElementById('btnRunAPI').addEventListener('click', () => runScenario('worker-api'));
    document.getElementById('btnClear').addEventListener('click', clearResults);
    
    // Pipeline navigation
    document.getElementById('btnShowPipeline').addEventListener('click', showPipeline);
    document.getElementById('btnPrevStep').addEventListener('click', () => navigateToPipelineStep(currentPipelineStep - 1));
    document.getElementById('btnNextStep').addEventListener('click', () => navigateToPipelineStep(currentPipelineStep + 1));
    document.getElementById('btnResetPipeline').addEventListener('click', () => {
      currentPipelineStep = 0;
      navigateToPipelineStep(0);
      debugLog('Pipeline reset to step 1', 'info');
    });
    
    // Expose global functions
    window.clearDebugConsole = clearDebugConsole;
    window.toggleDebugAutoScroll = toggleDebugAutoScroll;
    
    // Initialize
    initScenarios();
    updateStats();
    
    // Auto-run CSV import on page load
    setTimeout(() => {
      const csvImportScenario = scenarios.find(s => s.autoRun);
      if (csvImportScenario) {
        log('üöÄ Auto-running CSV import test...', 'info');
        runScenario(csvImportScenario.id);
      }
    }, 500);
    
    console.log('üêç SMRI Test Runner initialized');
    console.log('Click scenarios or use Quick Actions to run tests');
  </script>
</body>
</html>
