<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß¨ Breeding Calculator - Snake Muffin Debug</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .header p {
      color: #718096;
      font-size: 1.1em;
    }

    .controls {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .controls button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #2d3748;
    }

    .btn-secondary:hover {
      background: #cbd5e0;
    }

    .legend {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .legend h3 {
      margin-bottom: 15px;
      color: #2d3748;
    }

    .legend-items {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .legend-box {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
    }

    .breeding-matrix {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow-x: auto;
    }

    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .matrix-table th,
    .matrix-table td {
      padding: 10px;
      text-align: center;
      border: 2px solid #e2e8f0;
      vertical-align: middle;
    }

    .matrix-table thead th {
      background: #f7fafc;
      color: #2d3748;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .matrix-table tbody th {
      background: #f7fafc;
      color: #2d3748;
      font-weight: 600;
      position: sticky;
      left: 0;
      z-index: 5;
    }

    .matrix-table thead th:first-child,
    .matrix-table tbody th {
      min-width: 100px;
      width: 100px;
    }

    .matrix-table thead th:not(:first-child) {
      min-width: 120px;
      width: 120px;
    }

    .matrix-table tbody td {
      min-width: 120px;
      width: 120px;
      background: white;
      vertical-align: top;
      padding: 12px 8px;
    }

    .header-cell {
      position: relative;
    }

    .snake-name {
      font-size: 0.95em;
      font-weight: bold;
      margin-bottom: 3px;
    }

    .snake-morph {
      font-size: 0.75em;
      color: #718096;
    }

    .snake-sex {
      font-size: 1.2em;
      margin-bottom: 3px;
    }

    /* Responsive layout */
    @media (max-width: 1200px) {
      .breeding-matrix {
        padding: 15px;
      }

      .matrix-table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .matrix-table thead th,
      .matrix-table tbody th {
        min-width: 80px;
      }

      .matrix-table tbody td {
        min-width: 90px;
      }

      .snake-name {
        font-size: 0.85em;
      }

      .snake-morph {
        font-size: 0.7em;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header h1 {
        font-size: 1.8em;
      }

      .header p {
        font-size: 0.95em;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .controls button {
        width: 100%;
      }

      .legend-items {
        flex-direction: column;
      }

      .breeding-matrix {
        padding: 15px;
        overflow-x: auto;
      }

      .matrix-table {
        min-width: 650px;
      }

      .matrix-table thead th:first-child,
      .matrix-table tbody th {
        min-width: 80px;
        width: 80px;
      }

      .matrix-table thead th:not(:first-child),
      .matrix-table tbody td {
        min-width: 90px;
        width: 90px;
      }

      .snake-name {
        font-size: 0.8em;
      }

      .snake-morph {
        font-size: 0.65em;
      }

      .score-value {
        font-size: 1.5em;
      }

      .outcome-text {
        font-size: 0.75em;
      }

      .value-estimate {
        font-size: 0.7em;
      }

      .risk-indicator {
        font-size: 0.7em;
      }
    }

    .breeding-cell {
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 3px solid transparent;
      min-height: 120px;
      padding: 10px;
    }

    .breeding-cell > div {
      display: block;
      width: 100%;
      text-align: center;
    }

    .breeding-cell:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      border-color: #4a5568;
      z-index: 20;
    }

    /* Compatibility colors */
    .score-excellent {
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
    }

    .score-good {
      background: linear-gradient(135deg, #ecc94b, #d69e2e);
      color: #2d3748;
    }

    .score-risky {
      background: linear-gradient(135deg, #ed8936, #dd6b20);
      color: white;
    }

    .score-bad {
      background: linear-gradient(135deg, #f56565, #e53e3e);
      color: white;
    }

    .score-value {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
      line-height: 1;
    }

    .outcome-text {
      font-size: 0.85em;
      margin-top: 5px;
      font-weight: 500;
      display: block;
      line-height: 1.2;
    }

    .risk-indicator {
      margin-top: 5px;
      font-size: 0.85em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: block;
      line-height: 1;
    }

    .value-estimate {
      font-size: 0.8em;
      margin-top: 3px;
      opacity: 0.9;
      display: block;
      line-height: 1;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 2em;
      cursor: pointer;
      color: #718096;
      transition: color 0.3s ease;
    }

    .modal-close:hover {
      color: #2d3748;
    }

    .modal-title {
      font-size: 2em;
      color: #2d3748;
      margin-bottom: 20px;
    }

    .pairing-info {
      display: flex;
      justify-content: space-around;
      margin-bottom: 30px;
      padding: 20px;
      background: #f7fafc;
      border-radius: 10px;
    }

    .parent-info {
      text-align: center;
    }

    .parent-info .sex {
      font-size: 2em;
      margin-bottom: 10px;
    }

    .parent-info .name {
      font-size: 1.3em;
      font-weight: bold;
      color: #2d3748;
    }

    .parent-info .morph {
      color: #718096;
      margin-top: 5px;
    }

    .punnett-square {
      margin: 30px 0;
    }

    .punnett-title {
      font-size: 1.3em;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 15px;
    }

    .punnett-grid {
      display: grid;
      grid-template-columns: 50px repeat(2, 1fr);
      grid-template-rows: 50px repeat(2, 1fr);
      gap: 5px;
      max-width: 400px;
      margin: 0 auto;
    }

    .punnett-cell {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
      font-weight: 600;
      min-height: 60px;
    }

    .punnett-header {
      background: #667eea;
      color: white;
      font-weight: bold;
    }

    .punnett-result {
      background: #f7fafc;
      color: #2d3748;
    }

    .outcomes {
      margin: 30px 0;
    }

    .outcome-item {
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      background: #f7fafc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .outcome-percentage {
      font-size: 1.2em;
      font-weight: bold;
      color: #667eea;
    }

    .outcome-morph {
      font-weight: 600;
      color: #2d3748;
    }

    .outcome-value {
      color: #48bb78;
      font-weight: 600;
    }

    .warning-box {
      background: #fff5f5;
      border-left: 4px solid #f56565;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
    }

    .warning-box h4 {
      color: #c53030;
      margin-bottom: 10px;
    }

    .warning-box p {
      color: #742a2a;
    }

    .success-box {
      background: #f0fff4;
      border-left: 4px solid #48bb78;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
    }

    .success-box h4 {
      color: #2f855a;
      margin-bottom: 10px;
    }

    .success-box p {
      color: #22543d;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat-box {
      background: #f7fafc;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-label {
      color: #718096;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #2d3748;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üß¨ Breeding Calculator</h1>
      <p>Snake Muffin - Genetics & Compatibility Matrix</p>
      <p style="margin-top: 10px; font-size: 0.9em; color: #a0aec0;">Debug Tool v0.7.2</p>
    </div>

    <div class="controls">
      <button class="btn-primary" onclick="loadMockData()">üîÑ Load Mock Data</button>
      <button class="btn-secondary" onclick="filterExcellent()">‚ú® Show Only Excellent</button>
      <button class="btn-secondary" onclick="showAll()">üëÅÔ∏è Show All</button>
      <button class="btn-secondary" onclick="sortByValue()">üí∞ Sort by Value</button>
      <button class="btn-secondary" onclick="exportPlan()">üì• Export Plan</button>
    </div>

    <div class="legend">
      <h3>üé® Compatibility Legend</h3>
      <div class="legend-items">
        <div class="legend-item">
          <div class="legend-box" style="background: linear-gradient(135deg, #48bb78, #38a169); color: white;">
            üü¢
          </div>
          <div>
            <strong>Excellent (80-100)</strong>
            <div style="color: #718096; font-size: 0.9em;">Safe genetics, high value</div>
          </div>
        </div>
        <div class="legend-item">
          <div class="legend-box" style="background: linear-gradient(135deg, #ecc94b, #d69e2e);">
            üü°
          </div>
          <div>
            <strong>Good (60-79)</strong>
            <div style="color: #718096; font-size: 0.9em;">Minor concerns</div>
          </div>
        </div>
        <div class="legend-item">
          <div class="legend-box" style="background: linear-gradient(135deg, #ed8936, #dd6b20); color: white;">
            üü†
          </div>
          <div>
            <strong>Risky (40-59)</strong>
            <div style="color: #718096; font-size: 0.9em;">Health/genetic concerns</div>
          </div>
        </div>
        <div class="legend-item">
          <div class="legend-box" style="background: linear-gradient(135deg, #f56565, #e53e3e); color: white;">
            üî¥
          </div>
          <div>
            <strong>Bad (0-39)</strong>
            <div style="color: #718096; font-size: 0.9em;">Avoid breeding</div>
          </div>
        </div>
      </div>
    </div>

    <div class="breeding-matrix">
      <h2 style="margin-bottom: 20px; color: #2d3748;">üêç Breeding Compatibility Matrix</h2>
      
      <!-- Debug Console -->
      <div style="background: #1a202c; color: #00ff00; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-family: monospace; font-size: 0.85em; max-height: 200px; overflow-y: auto;" id="debugConsole">
        <div style="color: #48bb78; font-weight: bold; margin-bottom: 10px;">üîß Debug Console</div>
        <div id="debugOutput">Initializing...</div>
      </div>
      
      <table class="matrix-table" id="breedingMatrix">
        <!-- Matrix will be populated by JavaScript -->
      </table>
    </div>
  </div>

  <!-- Modal for detailed genetics -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="modalContent">
        <!-- Content populated by JavaScript -->
      </div>
    </div>
  </div>

  <script>
    // Debug console helper
    const debugLog = (...args) => {
      const output = document.getElementById('debugOutput');
      const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ');
      output.innerHTML += `<div>${msg}</div>`;
      console.log(...args);
    };

    // Mock snake data
    const mockMales = [
      {
        id: 'male_1',
        name: 'Zeus',
        sex: 'male',
        age: 3,
        weight: 1800,
        morphs: ['mojave'],
        genetics: { 
          visual: ['mojave'], 
          hets: [],
          alleles: { mojave: 'Moj', albino: 'wt', piebald: 'wt', spider: 'wt', pastel: 'wt', lesser: 'wt' }
        },
        lineage: { 
          parent_male_id: null, 
          parent_female_id: null,
          lineage_id: 'line_alpha'
        }
      },
      {
        id: 'male_2',
        name: 'Rocky',
        sex: 'male',
        age: 4,
        weight: 2000,
        morphs: ['spider'],
        genetics: { 
          visual: ['spider'], 
          hets: [],
          alleles: { spider: 'Spd', mojave: 'wt', albino: 'wt', piebald: 'wt', pastel: 'wt', lesser: 'wt' }
        },
        lineage: { 
          parent_male_id: null, 
          parent_female_id: null,
          lineage_id: 'line_beta'
        }
      },
      {
        id: 'male_3',
        name: 'Max',
        sex: 'male',
        age: 2.5,
        weight: 1600,
        morphs: ['piebald'],
        genetics: { 
          visual: ['piebald'], 
          hets: [],
          alleles: { piebald: 'pie', mojave: 'wt', albino: 'wt', spider: 'wt', pastel: 'wt', lesser: 'wt' }
        },
        lineage: { 
          parent_male_id: null, 
          parent_female_id: null,
          lineage_id: 'line_gamma'
        }
      },
      {
        id: 'male_4',
        name: 'Apollo',
        sex: 'male',
        age: 3,
        weight: 1700,
        morphs: ['pastel'],
        genetics: { 
          visual: ['pastel'], 
          hets: ['albino'],
          alleles: { pastel: 'Pas', albino: 'alb', piebald: 'wt', spider: 'wt', mojave: 'wt', lesser: 'wt' }
        },
        lineage: { 
          parent_male_id: null, 
          parent_female_id: null,
          lineage_id: 'line_delta'
        }
      },
      {
        id: 'male_5',
        name: 'Shadow',
        sex: 'male',
        age: 2,
        weight: 1400,
        morphs: ['normal'],
        genetics: { 
          visual: [], 
          hets: ['piebald', 'albino'],
          alleles: { piebald: 'pie', albino: 'alb', spider: 'wt', mojave: 'wt', pastel: 'wt', lesser: 'wt' }
        },
        lineage: { 
          parent_male_id: 'male_3', 
          parent_female_id: 'female_3',
          lineage_id: 'line_gamma'
        }
      }
    ];

    const mockFemales = [
      {
        id: 'female_1',
        name: 'Luna',
        sex: 'female',
        age: 3,
        weight: 1500,
        morphs: ['albino'],
        genetics: { 
          visual: ['albino'], 
          hets: [],
          alleles: { albino: 'alb', mojave: 'wt', piebald: 'wt', spider: 'wt', pastel: 'wt', lesser: 'wt' }
        },
        lineage: { 
          parent_male_id: null, 
          parent_female_id: null,
          lineage_id: 'line_epsilon'
        }
      },
      {
        id: 'female_2',
        name: 'Bella',
        sex: 'female',
        age: 4,
        weight: 1600,
        morphs: ['pastel'],
        genetics: { 
          visual: ['pastel'], 
          hets: [],
          alleles: { pastel: 'Pas', mojave: 'wt', albino: 'wt', piebald: 'wt', spider: 'wt', lesser: 'wt' }
        },
        lineage: { 
          parent_male_id: null, 
          parent_female_id: null,
          lineage_id: 'line_zeta'
        }
      },
      {
        id: 'female_3',
        name: 'Nala',
        sex: 'female',
        age: 2,
        weight: 1200,
        morphs: ['normal'],
        genetics: { 
          visual: [], 
          hets: ['piebald'],
          alleles: { piebald: 'pie', mojave: 'wt', albino: 'wt', spider: 'wt', pastel: 'wt', lesser: 'wt' }
        },
        lineage: { 
          parent_male_id: null, 
          parent_female_id: null,
          lineage_id: 'line_gamma'
        }
      },
      {
        id: 'female_4',
        name: 'Cleo',
        sex: 'female',
        age: 5,
        weight: 1800,
        morphs: ['spider'],
        genetics: { 
          visual: ['spider'], 
          hets: [],
          alleles: { spider: 'Spd', mojave: 'wt', albino: 'wt', piebald: 'wt', pastel: 'wt', lesser: 'wt' }
        },
        lineage: { 
          parent_male_id: 'male_2', 
          parent_female_id: null,
          lineage_id: 'line_beta'
        }
      },
      {
        id: 'female_5',
        name: 'Ivy',
        sex: 'female',
        age: 3,
        weight: 1500,
        morphs: ['lesser'],
        genetics: { 
          visual: ['lesser'], 
          hets: [],
          alleles: { lesser: 'Les', mojave: 'wt', albino: 'wt', piebald: 'wt', spider: 'wt', pastel: 'wt' }
        },
        lineage: { 
          parent_male_id: null, 
          parent_female_id: null,
          lineage_id: 'line_eta'
        }
      }
    ];

    // Lethal combinations database
    const LETHAL_COMBOS = [
      { morphs: ['spider', 'spider'], reason: 'Super Spider is lethal (neurological defects)' },
      { morphs: ['champagne', 'champagne'], reason: 'Super Champagne has severe wobble' }
    ];

    // Morph health risk database (Phase 2)
    const MORPH_HEALTH_DATABASE = {
      'spider': {
        risk: 'MODERATE',
        issues: ['Wobble syndrome (neurological)'],
        avoidWith: ['spider', 'woma', 'hidden_gene_woma', 'champagne']
      },
      'champagne': {
        risk: 'MODERATE',
        issues: ['Wobble, duck billing'],
        avoidWith: ['champagne', 'spider']
      },
      'woma': {
        risk: 'LOW',
        issues: ['Mild head wobble in some lines'],
        avoidWith: ['spider']
      }
    };

    // Morph market values (USD)
    const MORPH_VALUES = {
      'normal': 50,
      'albino': 300,
      'spider': 150,
      'piebald': 600,
      'pastel': 150,
      'mojave': 200,
      'lesser': 200,
      'albino_pastel': 500,
      'blue_eyed_leucistic': 800,
      'piebald_pastel': 800
    };

    // Calculate compatibility score (Phase 2: Advanced)
    function calculateCompatibility(male, female) {
      let score = 100;
      let warnings = [];
      let bonuses = [];
      let outcomes = [];
      let metrics = {};

      // 1. LETHAL GENETICS (-100, instant fail)
      const isLethal = checkLethalCombo(male.morphs, female.morphs);
      if (isLethal) {
        return {
          score: 0,
          risk: 'FATAL',
          breed: false,
          warnings: [isLethal.reason],
          bonuses: [],
          outcomes: [],
          value: 0,
          metrics: {}
        };
      }

      // 2. INBREEDING COEFFICIENT (CoI)
      const CoI = calculateInbreedingCoefficient(male, female);
      metrics.CoI = CoI;
      
      if (CoI > 0.25) {
        score -= 60;
        warnings.push(`Severe inbreeding: CoI=${(CoI*100).toFixed(1)}% (>25% threshold)`);
      } else if (CoI > 0.125) {
        score -= 30;
        warnings.push(`Moderate inbreeding: CoI=${(CoI*100).toFixed(1)}% (12.5-25%)`);
      } else if (CoI > 0.0625) {
        score -= 15;
        warnings.push(`Mild inbreeding: CoI=${(CoI*100).toFixed(1)}% (6.25-12.5%)`);
      } else if (CoI === 0) {
        bonuses.push('Unrelated pair (0% CoI)');
      }

      // 3. MORPH HEALTH RISKS
      const healthRisk = assessMorphHealthRisk(male.morphs, female.morphs);
      if (healthRisk.severity === 'HIGH') {
        score -= 40;
        warnings.push(healthRisk.reason);
      } else if (healthRisk.severity === 'MODERATE') {
        score -= 20;
        warnings.push(healthRisk.reason);
      }

      // 4. AGE COMPATIBILITY (Extended)
      if (male.age < 2 || female.age < 2) {
        score -= 15;
        warnings.push('Snake(s) under 2 years old (sexual maturity risk)');
      }
      if (female.age > 10) {
        score -= 10;
        warnings.push('Female over 10 years (reduced fertility)');
      }
      if (male.age > 15 || female.age > 15) {
        score -= 5;
        warnings.push('Advanced age (breeding decline)');
      }

      // 5. SIZE COMPATIBILITY (Extended)
      const weightRatio = male.weight / female.weight;
      const sizeDiff = Math.abs(male.weight - female.weight);
      
      if (sizeDiff > 800) {
        score -= 25;
        warnings.push(`Extreme size mismatch (${sizeDiff}g difference)`);
      } else if (sizeDiff > 500) {
        score -= 15;
        warnings.push(`Large size difference (${sizeDiff}g)`);
      }
      
      if (female.weight < 1200) {
        score -= 20;
        warnings.push('Female under 1200g (egg-binding risk)');
      }
      
      if (weightRatio > 1.5) {
        score -= 10;
        warnings.push('Male significantly larger (breeding difficulty)');
      }

      // 6. GENETIC DIVERSITY BONUS
      const diversityScore = calculateGeneticDiversity(male, female);
      metrics.diversity = diversityScore;
      
      if (diversityScore > 0.8) {
        score += 15;
        bonuses.push('Excellent genetic diversity (unrelated lines)');
      } else if (diversityScore > 0.6) {
        score += 8;
        bonuses.push('Good genetic diversity');
      }

      // 7. HETEROZYGOSITY ADVANTAGE
      const heterozygosity = calculateHeterozygosity(male.genetics, female.genetics);
      metrics.heterozygosity = heterozygosity;
      
      if (heterozygosity > 0.7) {
        score += 10;
        bonuses.push('High heterozygosity (hybrid vigor potential)');
      }

      // 8. OFFSPRING VALUE ESTIMATION
      const offspringData = calculateOffspring(male, female);
      outcomes = offspringData.outcomes;
      const totalValue = offspringData.totalValue;
      const avgOffspringValue = totalValue / offspringData.clutchSize;
      metrics.avgOffspringValue = avgOffspringValue;

      if (avgOffspringValue > 400) {
        score += 20;
        bonuses.push(`High-value offspring (avg $${avgOffspringValue.toFixed(0)}/snake)`);
      } else if (avgOffspringValue > 200) {
        score += 10;
        bonuses.push(`Good value offspring (avg $${avgOffspringValue.toFixed(0)}/snake)`);
      } else if (avgOffspringValue < 100) {
        score -= 5;
        warnings.push('Low market value offspring');
      }

      // 9. RARE MORPH POTENTIAL
      const rareMorphChance = outcomes.some(o => o.value >= 600) ? 
        outcomes.find(o => o.value >= 600).percentage / 100 : 0;
      metrics.rareMorphChance = rareMorphChance;
      
      if (rareMorphChance > 0.25) {
        score += 15;
        bonuses.push(`${(rareMorphChance*100).toFixed(0)}% chance of rare morph`);
      }

      // Determine risk level
      const finalScore = Math.max(0, Math.min(100, score));
      const risk = finalScore >= 80 ? 'EXCELLENT' : 
                   finalScore >= 60 ? 'GOOD' : 
                   finalScore >= 40 ? 'RISKY' : 'BAD';

      return {
        score: finalScore,
        risk,
        breed: finalScore >= 50,
        warnings,
        bonuses,
        outcomes,
        value: totalValue,
        metrics
      };
    }

    // Check for lethal combinations
    function checkLethalCombo(morphs1, morphs2) {
      for (const combo of LETHAL_COMBOS) {
        const hasAll = combo.morphs.every(m => 
          morphs1.includes(m) && morphs2.includes(m)
        );
        if (hasAll) {
          return { reason: combo.reason };
        }
      }
      return null;
    }

    // === PHASE 2: ADVANCED GENETICS FUNCTIONS ===

    // Assess morph health risks
    function assessMorphHealthRisk(maleMorphs, femaleMorphs) {
      let severity = 'NONE';
      let reasons = [];
      
      maleMorphs.forEach(mMorph => {
        femaleMorphs.forEach(fMorph => {
          if (MORPH_HEALTH_DATABASE[mMorph]) {
            const morphData = MORPH_HEALTH_DATABASE[mMorph];
            
            if (morphData.avoidWith.includes(fMorph)) {
              severity = morphData.risk;
              reasons.push(`${mMorph} + ${fMorph}: ${morphData.issues.join(', ')}`);
            }
          }
        });
      });
      
      return { severity, reason: reasons.join('; ') };
    }

    // Calculate inbreeding coefficient (Wright's formula)
    function calculateInbreedingCoefficient(male, female) {
      let CoI = 0;
      const allSnakes = [...mockMales, ...mockFemales];
      
      // Get ancestors (5 generations)
      const maleAncestors = getAncestors(male, allSnakes, 5);
      const femaleAncestors = getAncestors(female, allSnakes, 5);
      
      // Find common ancestors
      const commonAncestors = maleAncestors.filter(a => 
        femaleAncestors.some(b => b.id === a.id)
      );
      
      if (commonAncestors.length === 0) return 0; // Unrelated
      
      commonAncestors.forEach(ancestor => {
        const pathMale = getGenerationsTo(male, ancestor, allSnakes);
        const pathFemale = getGenerationsTo(female, ancestor, allSnakes);
        const n = pathMale + pathFemale;
        
        CoI += Math.pow(0.5, n);
      });
      
      return CoI;
    }

    // Get ancestors up to N generations
    function getAncestors(snake, allSnakes, generations, visited = new Set()) {
      if (generations === 0 || !snake || visited.has(snake.id)) return [];
      
      visited.add(snake.id);
      let ancestors = [];
      
      if (snake.lineage.parent_male_id) {
        const father = allSnakes.find(s => s.id === snake.lineage.parent_male_id);
        if (father) {
          ancestors.push(father);
          ancestors.push(...getAncestors(father, allSnakes, generations - 1, visited));
        }
      }
      
      if (snake.lineage.parent_female_id) {
        const mother = allSnakes.find(s => s.id === snake.lineage.parent_female_id);
        if (mother) {
          ancestors.push(mother);
          ancestors.push(...getAncestors(mother, allSnakes, generations - 1, visited));
        }
      }
      
      return ancestors;
    }

    // Count generations to ancestor
    function getGenerationsTo(snake, ancestor, allSnakes, depth = 0) {
      if (!snake || depth > 10) return Infinity;
      if (snake.id === ancestor.id) return 0;
      
      let minPath = Infinity;
      
      if (snake.lineage.parent_male_id) {
        const father = allSnakes.find(s => s.id === snake.lineage.parent_male_id);
        if (father) {
          const path = getGenerationsTo(father, ancestor, allSnakes, depth + 1);
          minPath = Math.min(minPath, path + 1);
        }
      }
      
      if (snake.lineage.parent_female_id) {
        const mother = allSnakes.find(s => s.id === snake.lineage.parent_female_id);
        if (mother) {
          const path = getGenerationsTo(mother, ancestor, allSnakes, depth + 1);
          minPath = Math.min(minPath, path + 1);
        }
      }
      
      return minPath;
    }

    // Calculate genetic diversity score
    function calculateGeneticDiversity(male, female) {
      const uniqueMorphs = new Set([...male.morphs, ...female.morphs]).size;
      const totalMorphs = male.morphs.length + female.morphs.length;
      
      const diversity = uniqueMorphs / Math.max(totalMorphs, 1);
      
      // Lineage bonus: different bloodlines = better
      const lineageBonus = male.lineage.lineage_id !== female.lineage.lineage_id ? 1.2 : 0.8;
      
      return Math.min(1.0, diversity * lineageBonus);
    }

    // Calculate heterozygosity index
    function calculateHeterozygosity(maleGenetics, femaleGenetics) {
      let hetLoci = 0;
      let totalLoci = 0;
      
      const allGenes = ['albino', 'piebald', 'spider', 'pastel', 'mojave', 'lesser'];
      
      allGenes.forEach(gene => {
        const maleAllele = maleGenetics.alleles[gene] || 'wt';
        const femaleAllele = femaleGenetics.alleles[gene] || 'wt';
        
        if (maleAllele !== femaleAllele) hetLoci++;
        totalLoci++;
      });
      
      return hetLoci / totalLoci;
    }

    // Calculate offspring probabilities (simplified)
    function calculateOffspring(male, female) {
      const outcomes = [];
      let totalValue = 0;
      const clutchSize = 8; // Average clutch

      // Simplified genetics - just demo the concept
      const maleMorphs = male.genetics.visual.concat(male.genetics.hets);
      const femaleMorphs = female.genetics.visual.concat(female.genetics.hets);

      // Check for special combos
      if (male.genetics.visual.includes('mojave') && female.genetics.visual.includes('lesser')) {
        // BEL combo
        outcomes.push({
          morph: 'Blue Eyed Leucistic',
          percentage: 25,
          count: 2,
          value: MORPH_VALUES['blue_eyed_leucistic'] || 800
        });
        outcomes.push({
          morph: 'Mojave',
          percentage: 25,
          count: 2,
          value: MORPH_VALUES['mojave']
        });
        outcomes.push({
          morph: 'Lesser',
          percentage: 25,
          count: 2,
          value: MORPH_VALUES['lesser']
        });
        outcomes.push({
          morph: 'Normal',
          percentage: 25,
          count: 2,
          value: MORPH_VALUES['normal']
        });
      } else if (male.genetics.hets.includes('albino') && female.genetics.hets.includes('albino')) {
        // Het albino pairing
        outcomes.push({
          morph: 'Albino',
          percentage: 25,
          count: 2,
          value: MORPH_VALUES['albino']
        });
        outcomes.push({
          morph: 'Het Albino',
          percentage: 50,
          count: 4,
          value: MORPH_VALUES['normal'] * 1.5
        });
        outcomes.push({
          morph: 'Normal',
          percentage: 25,
          count: 2,
          value: MORPH_VALUES['normal']
        });
      } else {
        // Default simple outcome
        const mainMorph = male.genetics.visual[0] || female.genetics.visual[0] || 'normal';
        outcomes.push({
          morph: mainMorph.charAt(0).toUpperCase() + mainMorph.slice(1),
          percentage: 50,
          count: 4,
          value: MORPH_VALUES[mainMorph] || 100
        });
        outcomes.push({
          morph: 'Normal',
          percentage: 50,
          count: 4,
          value: MORPH_VALUES['normal']
        });
      }

      // Calculate total value
      outcomes.forEach(outcome => {
        totalValue += outcome.count * outcome.value;
      });

      return { outcomes, totalValue };
    }

    // Generate matrix
    function generateMatrix() {
      const table = document.getElementById('breedingMatrix');
      
      debugLog('üöÄ Generating matrix...');
      debugLog('Males:', mockMales.length, mockMales.map(m => m.name));
      debugLog('Females:', mockFemales.length, mockFemales.map(f => f.name));
      debugLog('Expected cells:', mockMales.length * mockFemales.length);
      
      let html = '<thead><tr><th class="header-cell">‚ôÇ Males<br>‚ôÄ Females</th>';

      // Female headers
      mockFemales.forEach(female => {
        html += `
          <th class="header-cell">
            <div class="snake-sex">‚ôÄ</div>
            <div class="snake-name">${female.name}</div>
            <div class="snake-morph">${formatMorphs(female.morphs)}</div>
          </th>
        `;
      });

      html += '</tr></thead><tbody>';

      let cellCount = 0;
      
      // Male rows
      mockMales.forEach((male, maleIndex) => {
        debugLog(`Row ${maleIndex + 1}: ${male.name}`);
        html += `<tr><th class="header-cell">
          <div class="snake-sex">‚ôÇ</div>
          <div class="snake-name">${male.name}</div>
          <div class="snake-morph">${formatMorphs(male.morphs)}</div>
        </th>`;

        mockFemales.forEach((female, femaleIndex) => {
          cellCount++;
          const compat = calculateCompatibility(male, female);
          const colorClass = compat.score >= 80 ? 'score-excellent' : 
                             compat.score >= 60 ? 'score-good' : 
                             compat.score >= 40 ? 'score-risky' : 'score-bad';
          
          const indicator = compat.score >= 80 ? 'üü¢' : 
                            compat.score >= 60 ? 'üü°' : 
                            compat.score >= 40 ? 'üü†' : 'üî¥';

          // Get the most valuable/interesting outcome (first one)
          const primaryOutcome = compat.outcomes && compat.outcomes.length > 0 
            ? compat.outcomes[0].morph 
            : 'Normal';

          html += `
            <td class="breeding-cell ${colorClass}" 
                onclick="showDetails('${male.id}', '${female.id}')"
                data-male="${male.id}"
                data-female="${female.id}"
                data-score="${compat.score}"
                title="${male.name} x ${female.name}: Click for full genetics">
              <div class="score-value">${compat.score}</div>
              <div class="outcome-text">${primaryOutcome}</div>
              <div class="value-estimate">$${compat.value}</div>
              <div class="risk-indicator">${indicator}</div>
            </td>
          `;
        });

        html += '</tr>';
      });

      html += '</tbody>';
      table.innerHTML = html;
      debugLog(`‚úÖ Matrix complete! Generated ${cellCount} cells (${mockMales.length} males x ${mockFemales.length} females)`);
    }

    // Format morphs for display
    function formatMorphs(morphs) {
      if (morphs.length === 0 || morphs[0] === 'normal') return 'Normal';
      return morphs.map(m => m.charAt(0).toUpperCase() + m.slice(1)).join(', ');
    }

    // Show detailed genetics modal
    function showDetails(maleId, femaleId) {
      const male = mockMales.find(m => m.id === maleId);
      const female = mockFemales.find(f => f.id === femaleId);
      const compat = calculateCompatibility(male, female);

      let html = `
        <h2 class="modal-title">üß¨ Breeding Genetics</h2>
        
        <div class="pairing-info">
          <div class="parent-info">
            <div class="sex">‚ôÇ</div>
            <div class="name">${male.name}</div>
            <div class="morph">${formatMorphs(male.morphs)}</div>
            <div style="font-size: 0.85em; color: #718096; margin-top: 5px;">
              ${male.age} years, ${male.weight}g
            </div>
          </div>
          <div style="font-size: 3em; color: #cbd5e0;">√ó</div>
          <div class="parent-info">
            <div class="sex">‚ôÄ</div>
            <div class="name">${female.name}</div>
            <div class="morph">${formatMorphs(female.morphs)}</div>
            <div style="font-size: 0.85em; color: #718096; margin-top: 5px;">
              ${female.age} years, ${female.weight}g
            </div>
          </div>
        </div>
      `;

      // Warnings
      if (compat.warnings.length > 0) {
        html += `
          <div class="warning-box">
            <h4>‚ö†Ô∏è Warnings</h4>
            ${compat.warnings.map(w => `<p>‚Ä¢ ${w}</p>`).join('')}
          </div>
        `;
      }

      // Success indicators
      if (compat.score >= 80) {
        html += `
          <div class="success-box">
            <h4>‚úÖ Excellent Pairing!</h4>
            <p>Safe genetics with high-value offspring potential.</p>
          </div>
        `;
      }

      // Punnett Square (simplified visualization)
      html += `
        <div class="punnett-square">
          <h3 class="punnett-title">Genetic Punnett Square</h3>
          <div class="punnett-grid">
            <div class="punnett-cell"></div>
            <div class="punnett-cell punnett-header">${male.genetics.visual[0] || 'N'}</div>
            <div class="punnett-cell punnett-header">${male.genetics.hets[0] || 'n'}</div>
            
            <div class="punnett-cell punnett-header">${female.genetics.visual[0] || 'N'}</div>
            <div class="punnett-cell punnett-result">Nn</div>
            <div class="punnett-cell punnett-result">nn</div>
            
            <div class="punnett-cell punnett-header">${female.genetics.hets[0] || 'n'}</div>
            <div class="punnett-cell punnett-result">Nn</div>
            <div class="punnett-cell punnett-result">nn</div>
          </div>
        </div>
      `;

      // Outcomes
      html += `
        <div class="outcomes">
          <h3 class="punnett-title">Expected Offspring (8 eggs)</h3>
          ${compat.outcomes.map(outcome => `
            <div class="outcome-item">
              <div>
                <span class="outcome-percentage">${outcome.percentage}%</span>
                <span class="outcome-morph"> - ${outcome.morph}</span>
                <span style="color: #718096;"> (${outcome.count} eggs)</span>
              </div>
              <div class="outcome-value">$${outcome.value} each</div>
            </div>
          `).join('')}
        </div>
      `;

      // Stats summary
      html += `
        <div class="stats">
          <div class="stat-box">
            <div class="stat-label">Compatibility Score</div>
            <div class="stat-value">${compat.score}/100</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Risk Level</div>
            <div class="stat-value">${compat.risk}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Expected Clutch Value</div>
            <div class="stat-value">$${compat.value}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Recommended</div>
            <div class="stat-value">${compat.breed ? '‚úÖ Yes' : '‚ùå No'}</div>
          </div>
        </div>
      `;

      // Phase 2 Advanced Metrics
      if (compat.metrics) {
        html += `
          <div style="margin-top: 30px; padding: 20px; background: #f7fafc; border-radius: 10px;">
            <h3 style="margin-bottom: 15px; color: #2d3748;">üî¨ Advanced Genetics</h3>
            <div class="stats">
              <div class="stat-box">
                <div class="stat-label">Inbreeding Coefficient (CoI)</div>
                <div class="stat-value">${(compat.metrics.CoI * 100).toFixed(1)}%</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Genetic Diversity</div>
                <div class="stat-value">${(compat.metrics.diversity * 100).toFixed(0)}%</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Heterozygosity</div>
                <div class="stat-value">${(compat.metrics.heterozygosity * 100).toFixed(0)}%</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Avg Offspring Value</div>
                <div class="stat-value">$${compat.metrics.avgOffspringValue.toFixed(0)}</div>
              </div>
            </div>
          </div>
        `;
      }

      // Bonuses section
      if (compat.bonuses && compat.bonuses.length > 0) {
        html += `
          <div class="success-box" style="margin-top: 20px;">
            <h4>‚úÖ Bonuses</h4>
            ${compat.bonuses.map(b => `<p>‚Ä¢ ${b}</p>`).join('')}
          </div>
        `;
      }

      document.getElementById('modalContent').innerHTML = html;
      document.getElementById('detailModal').classList.add('active');
    }

    // Close modal
    function closeModal() {
      document.getElementById('detailModal').classList.remove('active');
    }

    // Filter functions
    function filterExcellent() {
      document.querySelectorAll('.breeding-cell').forEach(cell => {
        const score = parseInt(cell.dataset.score);
        cell.style.display = score >= 80 ? 'flex' : 'none';
      });
    }

    function showAll() {
      document.querySelectorAll('.breeding-cell').forEach(cell => {
        cell.style.display = 'flex';
      });
    }

    function sortByValue() {
      alert('Sort by value feature coming soon!');
    }

    function exportPlan() {
      alert('Export breeding plan feature coming soon!');
    }

    function loadMockData() {
      generateMatrix();
      alert('‚úÖ Mock data loaded! Click any cell to see detailed genetics.');
    }

    // Initialize on page load
    window.onload = () => {
      generateMatrix();
    };

    // Close modal on outside click
    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target.id === 'detailModal') {
        closeModal();
      }
    });
  </script>
</body>
</html>
