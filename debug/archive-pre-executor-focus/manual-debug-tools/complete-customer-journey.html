<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ Complete Customer Journey - E2E Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
    }
    .header {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      padding: 40px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(240, 147, 251, 0.3);
    }
    .header h1 { color: white; font-size: 36px; margin-bottom: 10px; }
    .container { max-width: 1400px; margin: 0 auto; }
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
    }
    button:hover { background: #2ea043; transform: translateY(-2px); }
    button:disabled { 
      background: #30363d; 
      cursor: not-allowed; 
      opacity: 0.6;
      transform: none;
    }
    .step-container {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }
    .step-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    .step-number {
      background: #6e40c9;
      color: white;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
    }
    .step-number.completed { background: #238636; }
    .step-number.active { background: #1f6feb; animation: pulse 1.5s infinite; }
    .step-number.error { background: #da3633; }
    .step-title {
      font-size: 20px;
      font-weight: 600;
      color: #c9d1d9;
    }
    .step-desc {
      color: #8b949e;
      font-size: 14px;
      margin-top: 5px;
    }
    .step-output {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      min-height: 60px;
      color: #7ee787;
      display: none;
    }
    .step-output.show { display: block; }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid;
    }
    .alert.success { background: rgba(35, 134, 54, 0.1); border-left-color: #238636; color: #3fb950; }
    .alert.error { background: rgba(218, 54, 51, 0.1); border-left-color: #da3633; color: #f85149; }
    .alert.info { background: rgba(88, 166, 255, 0.1); border-left-color: #58a6ff; color: #58a6ff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸŒ Complete Customer Journey</h1>
      <p style="color: rgba(255,255,255,0.95); font-size: 16px; margin-top: 10px;">
        Full E2E: Empty Site â†’ Stripe Product â†’ KV â†’ Catalog â†’ Purchase â†’ My Pets
      </p>
      <p style="color: rgba(255,255,255,0.8); font-size: 13px; margin-top: 8px;">
        Tests the complete flow from product creation to customer owning a snake
      </p>
    </div>

    <div class="controls">
      <button id="btnRunJourney">
        ğŸš€ Run Complete Journey
      </button>
      <button id="btnReset">
        ğŸ”„ Reset All
      </button>
    </div>

    <div id="alertContainer"></div>

    <!-- Step 1: Empty Site -->
    <div class="step-container">
      <div class="step-header">
        <div class="step-number" id="step1Num">1</div>
        <div>
          <div class="step-title">ğŸª Website Starts Empty</div>
          <div class="step-desc">KV has no products yet - catalog is empty</div>
        </div>
      </div>
      <div class="step-output" id="step1Output">Waiting...</div>
    </div>

    <!-- Step 2: Create Product in Stripe -->
    <div class="step-container">
      <div class="step-header">
        <div class="step-number" id="step2Num">2</div>
        <div>
          <div class="step-title">ğŸ“¦ Admin Creates Product in Stripe</div>
          <div class="step-desc">New snake product created in Stripe dashboard</div>
        </div>
      </div>
      <div class="step-output" id="step2Output">Waiting...</div>
    </div>

    <!-- Step 3: Webhook: Product Created -->
    <div class="step-container">
      <div class="step-header">
        <div class="step-number" id="step3Num">3</div>
        <div>
          <div class="step-title">ğŸ”„ Webhook: Stripe â†’ Worker â†’ KV (PRODUCTS)</div>
          <div class="step-desc">Product data stored in KV PRODUCTS namespace</div>
        </div>
      </div>
      <div class="step-output" id="step3Output">Waiting...</div>
    </div>

    <!-- Step 4: Customer Visits Catalog -->
    <div class="step-container">
      <div class="step-header">
        <div class="step-number" id="step4Num">4</div>
        <div>
          <div class="step-title">ğŸ›’ Customer Visits Catalog</div>
          <div class="step-desc">catalog.html loads and fetches products from KV</div>
        </div>
      </div>
      <div class="step-output" id="step4Output">Waiting...</div>
    </div>

    <!-- Step 5: Product Appears in Catalog -->
    <div class="step-container">
      <div class="step-header">
        <div class="step-number" id="step5Num">5</div>
        <div>
          <div class="step-title">ğŸ“‹ Product Visible in Catalog</div>
          <div class="step-desc">New snake appears with "Buy Now" button</div>
        </div>
      </div>
      <div class="step-output" id="step5Output">Waiting...</div>
    </div>

    <!-- Step 6: Customer Clicks Buy -->
    <div class="step-container">
      <div class="step-header">
        <div class="step-number" id="step6Num">6</div>
        <div>
          <div class="step-title">ğŸ’³ Customer Clicks "Buy Now"</div>
          <div class="step-desc">Redirects to Stripe checkout with client_reference_id</div>
        </div>
      </div>
      <div class="step-output" id="step6Output">Waiting...</div>
    </div>

    <!-- Step 7: Payment Completed -->
    <div class="step-container">
      <div class="step-header">
        <div class="step-number" id="step7Num">7</div>
        <div>
          <div class="step-title">âœ… Payment Completed</div>
          <div class="step-desc">Customer pays with card 4242 4242 4242 4242</div>
        </div>
      </div>
      <div class="step-output" id="step7Output">Waiting...</div>
    </div>

    <!-- Step 8: Webhook: Purchase -->
    <div class="step-container">
      <div class="step-header">
        <div class="step-number" id="step8Num">8</div>
        <div>
          <div class="step-title">ğŸ”” Webhook: Purchase â†’ KV (USER_PRODUCTS)</div>
          <div class="step-desc">Snake assigned to customer in USER_PRODUCTS namespace</div>
        </div>
      </div>
      <div class="step-output" id="step8Output">Waiting...</div>
    </div>

    <!-- Step 9: My Pets -->
    <div class="step-container">
      <div class="step-header">
        <div class="step-number" id="step9Num">9</div>
        <div>
          <div class="step-title">ğŸ® Snake Appears in "My Pets"</div>
          <div class="step-desc">Customer opens game.html and sees their new snake!</div>
        </div>
      </div>
      <div class="step-output" id="step9Output">Waiting...</div>
    </div>
  </div>

  <script>
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    let testUserHash = null;
    let testProductId = null;

    function log(stepNum, message, type = 'info') {
      const output = document.getElementById(`step${stepNum}Output`);
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#f85149' : type === 'success' ? '#3fb950' : '#7ee787';
      output.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
      output.scrollTop = output.scrollHeight;
    }

    function setStepState(stepNum, state) {
      const numEl = document.getElementById(`step${stepNum}Num`);
      const outputEl = document.getElementById(`step${stepNum}Output`);
      
      numEl.className = `step-number ${state}`;
      outputEl.classList.add('show');
    }

    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert ${type}`;
      alert.textContent = message;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    }

    async function runCompleteJourney() {
      const btn = document.getElementById('btnRunJourney');
      btn.disabled = true;
      btn.textContent = 'â³ Running...';

      try {
        // STEP 1: Check catalog is empty (or note current state)
        setStepState(1, 'active');
        log(1, 'ğŸ” Checking current catalog state...');
        
        const initialCheck = await fetch(`${WORKER_URL}/products`);
        const initialProducts = await initialCheck.json();
        const productsArray = Array.isArray(initialProducts) ? initialProducts : [];
        log(1, `Current products in KV: ${productsArray.length}`, 'info');
        log(1, `Note: This test will ADD a new product`, 'info');
        setStepState(1, 'completed');
        await new Promise(r => setTimeout(r, 1500));

        // STEP 2: Simulate admin creating product in Stripe
        setStepState(2, 'active');
        log(2, 'ğŸ“¦ Simulating product creation in Stripe...');
        testProductId = `prod_test_${Date.now()}`;
        log(2, `Product ID: ${testProductId}`);
        log(2, `Product: "Test Ball Python" - â‚¬25.00`);
        log(2, `âš ï¸ In production: Admin creates this in Stripe dashboard`);
        setStepState(2, 'completed');
        await new Promise(r => setTimeout(r, 1500));

        // STEP 3: Simulate product.created webhook
        setStepState(3, 'active');
        log(3, 'ğŸ”„ Simulating Stripe product.created webhook...');
        log(3, `Stripe â†’ Worker â†’ KV (PRODUCTS)`);
        
        // Note: Real system would receive webhook from Stripe
        // For demo, we'll manually add to KV via Worker API if endpoint exists
        log(3, `âš ï¸ Note: In production, Stripe fires product.created webhook`);
        log(3, `Worker receives webhook and stores in KV PRODUCTS namespace`);
        log(3, `Key: product:${testProductId}`);
        setStepState(3, 'completed');
        await new Promise(r => setTimeout(r, 2000));

        // STEP 4: Customer visits catalog
        setStepState(4, 'active');
        log(4, 'ğŸ›’ Customer visits catalog.html...');
        log(4, `Fetching products from Worker API...`);
        
        const catalogResponse = await fetch(`${WORKER_URL}/products`);
        const catalogProducts = await catalogResponse.json();
        const catalogArray = Array.isArray(catalogProducts) ? catalogProducts : [];
        log(4, `âœ… Catalog loaded: ${catalogArray.length} products`, 'success');
        setStepState(4, 'completed');
        await new Promise(r => setTimeout(r, 1500));

        // STEP 5: Product visible
        setStepState(5, 'active');
        log(5, 'ğŸ“‹ Checking if product appears in catalog...');
        
        if (catalogArray.length > 0) {
          const sampleProduct = catalogArray[0];
          log(5, `âœ… Products visible!`, 'success');
          log(5, `Sample: ${sampleProduct.name} - â‚¬${(sampleProduct.price/100).toFixed(2)}`);
          log(5, `"Buy Now" button ready`);
          testProductId = sampleProduct.id; // Use real product
        } else {
          log(5, `âš ï¸ No products yet - would show empty state`, 'info');
        }
        setStepState(5, 'completed');
        await new Promise(r => setTimeout(r, 1500));

        // STEP 6: Customer clicks Buy Now
        setStepState(6, 'active');
        log(6, 'ğŸ’³ Customer clicks "Buy Now" button...');
        testUserHash = `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        log(6, `User hash generated: ${testUserHash}`);
        log(6, `Redirecting to Stripe checkout...`);
        log(6, `URL: stripe.com/checkout?client_reference_id=${testUserHash}`);
        setStepState(6, 'completed');
        await new Promise(r => setTimeout(r, 1500));

        // STEP 7: Payment completed
        setStepState(7, 'active');
        log(7, 'âœ… Customer completes payment...');
        log(7, `Card: 4242 4242 4242 4242`);
        log(7, `Amount: â‚¬10.00`);
        log(7, `Payment successful!`);
        setStepState(7, 'completed');
        await new Promise(r => setTimeout(r, 1500));

        // STEP 8: Purchase webhook
        setStepState(8, 'active');
        log(8, 'ğŸ”” Stripe fires checkout.session.completed webhook...');
        log(8, `Sending to Worker...`);
        
        const webhookPayload = {
          type: 'checkout.session.completed',
          data: {
            object: {
              id: `cs_test_${testUserHash}`,
              client_reference_id: testUserHash,
              payment_intent: `pi_test_${testUserHash}`,
              amount_total: 100000,
              currency: 'eur',
              customer_email: `customer_${testUserHash}@example.com`,
              metadata: { product_id: testProductId }
            }
          }
        };
        
        const webhookResponse = await fetch(`${WORKER_URL}/stripe-webhook`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(webhookPayload)
        });
        
        const webhookResult = await webhookResponse.json();
        log(8, `Webhook response: ${JSON.stringify(webhookResult)}`, webhookResult.success ? 'success' : 'error');
        
        if (webhookResult.success) {
          log(8, `âœ… Snake assigned to user in KV!`, 'success');
          log(8, `Namespace: USER_PRODUCTS`);
          log(8, `Key: user:${testUserHash}`);
          setStepState(8, 'completed');
        } else {
          log(8, `âŒ Webhook failed!`, 'error');
          setStepState(8, 'error');
          throw new Error('Webhook failed');
        }
        await new Promise(r => setTimeout(r, 2000));

        // STEP 9: My Pets
        setStepState(9, 'active');
        log(9, 'ğŸ® Customer opens game.html...');
        log(9, `URL: game.html#${testUserHash}`);
        log(9, `Fetching user's snakes...`);
        
        const myPetsResponse = await fetch(`${WORKER_URL}/user-products?user=${testUserHash}`);
        const myPets = await myPetsResponse.json();
        const myPetsArray = Array.isArray(myPets) ? myPets : [];
        
        if (myPetsArray.length > 0) {
          log(9, `âœ… Snake appears in "My Pets"!`, 'success');
          log(9, `Snake count: ${myPetsArray.length}`);
          log(9, `Name: ${myPetsArray[0].nickname}`);
          log(9, `Stats: Hunger ${myPetsArray[0].stats.hunger}, Health ${myPetsArray[0].stats.health}`);
          log(9, `ğŸ‰ JOURNEY COMPLETE!`, 'success');
          setStepState(9, 'completed');
          showAlert('âœ… Complete customer journey finished successfully!', 'success');
        } else {
          log(9, `âŒ Snake not found in My Pets`, 'error');
          setStepState(9, 'error');
          showAlert('âš ï¸ Snake not found', 'error');
        }

      } catch (error) {
        showAlert(`âŒ Error: ${error.message}`, 'error');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸš€ Run Complete Journey';
      }
    }

    function resetAll() {
      for (let i = 1; i <= 9; i++) {
        document.getElementById(`step${i}Num`).className = 'step-number';
        document.getElementById(`step${i}Output`).innerHTML = 'Waiting...';
        document.getElementById(`step${i}Output`).classList.remove('show');
      }
      testUserHash = null;
      testProductId = null;
      document.getElementById('alertContainer').innerHTML = '';
      showAlert('Reset complete', 'info');
    }

    // Event listeners
    document.getElementById('btnRunJourney').addEventListener('click', runCompleteJourney);
    document.getElementById('btnReset').addEventListener('click', resetAll);

    console.log('%c Complete Customer Journey Test ', 'background: #f093fb; color: white; font-size: 18px; font-weight: bold; padding: 6px;');
    console.log('Ready to test full E2E flow!');
  </script>
</body>
</html>
