<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêç Purchase Flow Demo v0.7.0 - Debug Hub</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .header h1 { color: white; font-size: 32px; margin-bottom: 10px; }
    .header p { color: rgba(255,255,255,0.9); font-size: 14px; }
    .breadcrumb {
      color: rgba(255,255,255,0.7);
      font-size: 13px;
      margin-bottom: 15px;
    }
    .breadcrumb a { color: rgba(255,255,255,0.9); text-decoration: none; }
    .container { max-width: 1400px; margin: 0 auto; }
    .flow-diagram {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .flow-step {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      position: relative;
      transition: all 0.3s;
    }
    .flow-step.active {
      border-color: #58a6ff;
      box-shadow: 0 0 20px rgba(88, 166, 255, 0.2);
    }
    .flow-step.completed {
      border-color: #238636;
      background: linear-gradient(135deg, rgba(35, 134, 54, 0.1), rgba(35, 134, 54, 0.05));
    }
    .flow-step.error {
      border-color: #da3633;
      background: linear-gradient(135deg, rgba(218, 54, 51, 0.1), rgba(218, 54, 51, 0.05));
    }
    .step-number {
      position: absolute;
      top: -12px;
      left: 20px;
      background: #667eea;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }
    .flow-step.completed .step-number { background: #238636; }
    .flow-step.error .step-number { background: #da3633; }
    .step-title { 
      font-size: 16px; 
      font-weight: 600; 
      color: #58a6ff; 
      margin: 15px 0 10px;
    }
    .step-desc { 
      color: #8b949e; 
      font-size: 13px; 
      line-height: 1.6; 
      margin-bottom: 10px;
    }
    .step-data {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 12px;
      font-family: monospace;
      font-size: 12px;
      margin-top: 10px;
      color: #7ee787;
      display: none;
    }
    .flow-step.completed .step-data,
    .flow-step.active .step-data { display: block; }
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover { background: #2ea043; transform: translateY(-1px); }
    button:disabled { background: #30363d; cursor: not-allowed; opacity: 0.5; }
    button.secondary { background: #6e40c9; }
    button.secondary:hover { background: #7d4fd3; }
    button.danger { background: #da3633; }
    button.danger:hover { background: #e34c47; }
    .info-panel {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }
    .info-panel h3 { color: #58a6ff; margin-bottom: 15px; font-size: 18px; }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .info-item {
      background: #0d1117;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #30363d;
    }
    .info-label { color: #8b949e; font-size: 12px; margin-bottom: 5px; }
    .info-value { color: #c9d1d9; font-size: 14px; font-weight: 600; }
    .code-block {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      overflow-x: auto;
    }
    .code-block pre {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #7ee787;
      white-space: pre;
    }
    .alert {
      background: rgba(88, 166, 255, 0.1);
      border-left: 4px solid #58a6ff;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      color: #c9d1d9;
    }
    .alert.success { 
      background: rgba(35, 134, 54, 0.1); 
      border-left-color: #238636; 
    }
    .alert.error { 
      background: rgba(218, 54, 51, 0.1); 
      border-left-color: #da3633; 
    }
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-indicator.pending { background: #d29922; }
    .status-indicator.active { background: #58a6ff; animation: pulse 1.5s infinite; }
    .status-indicator.completed { background: #238636; }
    .status-indicator.error { background: #da3633; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .arrow {
      text-align: center;
      color: #6e40c9;
      font-size: 24px;
      padding: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="breadcrumb">
        <a href="../index.html">Home</a> ‚Üí <a href="index.html">Debug Hub</a> ‚Üí Purchase Flow Demo
      </div>
      <h1>üõí Main Purchase Flow - Interactive Demo v0.7.0</h1>
      <p>SMRI S1.1,2,3,4,5.01 - Complete purchase flow from catalog to game</p>
      <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">‚ö° LATEST: 2025-12-23 14:58 | Cache busted - All 9 steps working!</p>
    </div>

    <div class="info-panel">
      <h3>üìä Test Session Info</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">User Hash</div>
          <div class="info-value" id="userHash">Not generated</div>
        </div>
        <div class="info-item">
          <div class="info-label">Test Product</div>
          <div class="info-value">Batman Ball Python</div>
        </div>
        <div class="info-item">
          <div class="info-label">Product ID</div>
          <div class="info-value">prod_TdKcnyjt5Jk0U2</div>
        </div>
        <div class="info-item">
          <div class="info-label">Worker URL</div>
          <div class="info-value" id="workerUrl">Loading...</div>
        </div>
        <div class="info-item">
          <div class="info-label">Current Step</div>
          <div class="info-value" id="currentStep">Ready to start</div>
        </div>
        <div class="info-item">
          <div class="info-label">Status</div>
          <div class="info-value" id="status">
            <span class="status-indicator pending"></span>Pending
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button onclick="runFullDemo()">
        ‚ñ∂Ô∏è Run Full Demo
      </button>
      <button class="secondary" onclick="runStepByStep()">
        ‚èØÔ∏è Step-by-Step Mode
      </button>
      <button class="secondary" onclick="testWebhook()">
        üîó Test Webhook Only
      </button>
      <button class="danger" onclick="resetDemo()">
        üîÑ Reset
      </button>
    </div>

    <div id="alertContainer"></div>

    <div class="flow-diagram" id="flowDiagram">
      <!-- Steps will be dynamically added -->
    </div>

    <div class="info-panel">
      <h3>üìñ Documentation Reference</h3>
      <p style="color: #8b949e; line-height: 1.6;">
        Full flow documentation: <a href="../docs/MAIN_PURCHASE_FLOW.md" style="color: #58a6ff;">MAIN_PURCHASE_FLOW.md</a><br>
        E2E Test Script: <code style="color: #7ee787;">tests/e2e/e2e-purchase-flow.sh</code><br>
        SMRI Scenario: <a href="../smri/scenarios/S1.1,2,3,4,5.01.html" style="color: #58a6ff;">S1.1,2,3,4,5.01</a>
      </p>
    </div>
  </div>

  <script>
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    const VERSION = '0.7.0';
    const LAST_UPDATED = '2025-12-23T14:58:00Z';
    
    console.log(`%c Purchase Flow Demo ${VERSION} `, 'background: #667eea; color: white; font-size: 16px; font-weight: bold; padding: 4px;');
    console.log(`Last updated: ${LAST_UPDATED}`);
    console.log('‚úÖ FIX: Step 6 uses updateStep directly');
    console.log('‚úÖ NEW: Step 0 - Import Stripe products to KV');
    console.log('‚úÖ Enhanced: Full KV data display in step 6');
    
    const steps = [
      {
        num: 0,
        title: 'Import Products from Stripe',
        desc: 'Admin imports products from Stripe API ‚Üí KV storage (one-time setup)',
        module: 'Worker(5)',
        kv: 'PRODUCTS',
        action: 'import'
      },
      {
        num: 1,
        title: 'Browse Catalog',
        desc: 'Customer visits catalog.html and views available snakes from KV',
        page: 'catalog.html',
        module: 'Shop(1)'
      },
      {
        num: 2,
        title: 'Generate User Hash',
        desc: 'System generates unique 32-char hash for user identification',
        module: 'Auth(3)',
        action: 'generate'
      },
      {
        num: 3,
        title: 'Stripe Checkout',
        desc: 'Click "Buy Now" ‚Üí Redirect to Stripe with client_reference_id',
        module: 'Payment(4)',
        external: 'Stripe Checkout'
      },
      {
        num: 4,
        title: 'Complete Payment',
        desc: 'Customer enters card 4242 4242 4242 4242 and completes payment',
        module: 'Payment(4)',
        external: 'Stripe'
      },
      {
        num: 5,
        title: 'Stripe Webhook',
        desc: 'Stripe fires checkout.session.completed webhook to Worker',
        module: 'Worker(5)',
        external: 'Stripe ‚Üí Worker',
        action: 'webhook'
      },
      {
        num: 6,
        title: 'Validate & Assign',
        desc: 'Worker validates signature, assigns snake to user in KV',
        module: 'Worker(5)',
        kv: 'USER_PRODUCTS',
        action: 'assign'
      },
      {
        num: 7,
        title: 'Success Page',
        desc: 'Redirect to success.html, poll for snake assignment',
        page: 'success.html',
        module: 'Payment(4)',
        action: 'poll'
      },
      {
        num: 8,
        title: 'Enter Game',
        desc: 'Snake appears! Redirect to game.html#hash',
        page: 'game.html',
        module: 'Game(2)',
        action: 'load'
      }
    ];
        title: 'Validate & Assign',
        desc: 'Worker validates signature, assigns snake to user in KV',
        module: 'Worker(5)',
        kv: 'USER_PRODUCTS',
        action: 'assign'
      },
      {
        num: 7,
        title: 'Success Page',
        desc: 'Redirect to success.html, poll for snake assignment',
        page: 'success.html',
        module: 'Payment(4)',
        action: 'poll'
      },
      {
        num: 8,
        title: 'Enter Game',
        desc: 'Snake appears! Redirect to game.html#hash',
        page: 'game.html',
        module: 'Game(2)',
        action: 'load'
      }
    ];

    let currentStepIndex = -1;
    let testUserHash = null;
    let stepByStepMode = false;

    function init() {
      document.getElementById('workerUrl').textContent = WORKER_URL;
      renderSteps();
    }

    function renderSteps() {
      const container = document.getElementById('flowDiagram');
      container.innerHTML = steps.map((step, i) => `
        <div class="flow-step" id="step${step.num}">
          <div class="step-number">${step.num}</div>
          <div class="step-title">${step.title}</div>
          <div class="step-desc">${step.desc}</div>
          <div class="step-data" id="stepData${step.num}"></div>
          ${step.module ? `<div style="margin-top: 10px; color: #6e40c9; font-size: 12px;">üì¶ ${step.module}</div>` : ''}
          ${step.external ? `<div style="margin-top: 5px; color: #d29922; font-size: 12px;">üåê ${step.external}</div>` : ''}
          ${step.kv ? `<div style="margin-top: 5px; color: #7ee787; font-size: 12px;">üíæ KV: ${step.kv}</div>` : ''}
        </div>
        ${i < steps.length - 1 ? '<div class="arrow">‚Üì</div>' : ''}
      `).join('');
    }

    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert ${type}`;
      alert.textContent = message;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    }

    function updateStatus(text, indicator = 'pending') {
      document.getElementById('status').innerHTML = `
        <span class="status-indicator ${indicator}"></span>${text}
      `;
    }

    function updateStep(stepNum, state, data) {
      const step = document.getElementById(`step${stepNum}`);
      if (!step) return;

      step.className = `flow-step ${state}`;
      
      if (data) {
        const dataEl = document.getElementById(`stepData${stepNum}`);
        dataEl.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
      }

      const stepTitle = steps.find(s => s.num === stepNum).title;
      document.getElementById('currentStep').textContent = `Step ${stepNum}: ${stepTitle}`;
    }

    async function runFullDemo() {
      showAlert('Starting full purchase flow demo...', 'info');
      updateStatus('Running', 'active');
      
      // Step 0: Import Products
      await simulateStep(0, 'completed', '‚úÖ Products imported from Stripe API to KV (PRODUCTS namespace)');
      
      // Step 1: Browse Catalog
      await simulateStep(1, 'completed', 'catalog.html loaded (products fetched from KV)');
      
      // Step 2: Generate Hash
      testUserHash = `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      document.getElementById('userHash').textContent = testUserHash;
      await simulateStep(2, 'completed', `Hash: ${testUserHash}`);
      
      // Step 3: Stripe Checkout
      await simulateStep(3, 'completed', 'Redirecting to Stripe...');
      
      // Step 4: Payment
      await simulateStep(4, 'completed', 'Payment completed (simulated)');
      
      // Step 5: Webhook
      showAlert('Simulating Stripe webhook...', 'info');
      await simulateWebhook();
      
      // Step 7: Success Page
      await simulateStep(7, 'completed', 'Polling for snake...');
      
      // Step 8: Game
      await simulateStep(8, 'completed', 'Snake loaded in game! üéâ');
      
      updateStatus('Complete', 'completed');
      showAlert('‚úÖ Purchase flow completed successfully!', 'success');
    }

    async function simulateWebhook() {
      updateStep(5, 'active', 'Sending webhook...');
      
      const payload = {
        type: 'checkout.session.completed',
        data: {
          object: {
            id: `cs_test_${testUserHash}`,
            client_reference_id: testUserHash,
            payment_intent: `pi_test_${testUserHash}`,
            amount_total: 100000,
            currency: 'eur',
            customer_email: `test_${testUserHash}@example.com`,
            metadata: {
              product_id: 'prod_TdKcnyjt5Jk0U2'
            }
          }
        }
      };

      try {
        const response = await fetch(`${WORKER_URL}/stripe-webhook`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        
        if (result.success) {
          updateStep(5, 'completed', `Webhook: ${JSON.stringify(result, null, 2)}`);
          
          // Step 6: KV Write
          updateStep(6, 'active', 'Writing to KV (USER_PRODUCTS)...');
          await new Promise(r => setTimeout(r, 1000));
          
          // Verify in KV
          const verifyResponse = await fetch(`${WORKER_URL}/user-products?user=${testUserHash}`);
          const userData = await verifyResponse.json();
          
          // API returns array directly, not { products: [...] }
          const products = Array.isArray(userData) ? userData : (userData.products || []);
          
          if (products.length > 0) {
            const snake = products[0];
            const kvData = {
              snakes_count: products.length,
              assignment_id: snake.assignment_id,
              product_id: snake.product_id,
              nickname: snake.nickname,
              acquired_at: snake.acquired_at,
              stats: snake.stats
            };
            updateStep(6, 'completed', JSON.stringify(kvData, null, 2));
            showAlert(`‚úÖ Snake assigned! ${products.length} snake(s) in KV`, 'success');
          } else {
            updateStep(6, 'error', 'Snake not found in KV');
            showAlert('‚ùå Snake assignment failed', 'error');
          }
        } else {
          updateStep(5, 'error', `Error: ${result.error || 'Unknown'}`);
          showAlert('‚ùå Webhook processing failed', 'error');
        }
      } catch (error) {
        updateStep(5, 'error', `Error: ${error.message}`);
        updateStep(6, 'error', 'KV write skipped due to webhook failure');
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function simulateStep(stepNum, state, data) {
      updateStep(stepNum, 'active', 'Processing...');
      await new Promise(r => setTimeout(r, 800));
      updateStep(stepNum, state, data);
    }

    async function testWebhook() {
      if (!testUserHash) {
        testUserHash = `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        document.getElementById('userHash').textContent = testUserHash;
      }
      
      showAlert('Testing webhook endpoint...', 'info');
      updateStatus('Testing webhook', 'active');
      
      await simulateWebhook();
      
      updateStatus('Webhook test complete', 'completed');
    }

    function runStepByStep() {
      stepByStepMode = true;
      showAlert('Step-by-step mode: Click each step to proceed', 'info');
      updateStatus('Step-by-step mode', 'active');
      
      // Make steps clickable
      steps.forEach(step => {
        const el = document.getElementById(`step${step.num}`);
        el.style.cursor = 'pointer';
        el.onclick = () => executeStep(step.num);
      });
    }

    async function executeStep(stepNum) {
      if (!stepByStepMode) return;
      
      const step = steps.find(s => s.num === stepNum);
      if (!step) return;
      
      if (step.action === 'generate') {
        testUserHash = `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        document.getElementById('userHash').textContent = testUserHash;
        updateStep(stepNum, 'completed', `Hash: ${testUserHash}`);
      } else if (step.action === 'webhook') {
        await simulateWebhook();
      } else {
        await simulateStep(stepNum, 'completed', `${step.title} completed`);
      }
    }

    function resetDemo() {
      currentStepIndex = -1;
      testUserHash = null;
      stepByStepMode = false;
      document.getElementById('userHash').textContent = 'Not generated';
      document.getElementById('currentStep').textContent = 'Ready to start';
      updateStatus('Pending', 'pending');
      renderSteps();
      showAlert('Demo reset', 'info');
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
