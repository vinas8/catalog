<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêç Purchase Flow Demo v0.8.1 - Debug Hub</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .header h1 { color: white; font-size: 32px; margin-bottom: 10px; }
    .breadcrumb {
      color: rgba(255,255,255,0.7);
      font-size: 13px;
      margin-bottom: 15px;
    }
    .breadcrumb a { color: rgba(255,255,255,0.9); text-decoration: none; }
    .container { max-width: 1400px; margin: 0 auto; }
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    button:hover { background: #2ea043; transform: translateY(-1px); }
    button.secondary { background: #1f6feb; }
    button.secondary:hover { background: #0969da; }
    button.danger { background: #da3633; }
    button.danger:hover { background: #e34c47; }
    .info-panel {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }
    .info-panel h3 { color: #58a6ff; margin-bottom: 15px; font-size: 18px; }
    #output {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 13px;
      min-height: 200px;
    }
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid;
    }
    .alert.info {
      background: rgba(88, 166, 255, 0.1);
      border-left-color: #58a6ff;
      color: #58a6ff;
    }
    .alert.success {
      background: rgba(35, 134, 54, 0.1);
      border-left-color: #238636;
      color: #3fb950;
    }
    .alert.error {
      background: rgba(218, 54, 51, 0.1);
      border-left-color: #da3633;
      color: #f85149;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="breadcrumb">
        <a href="index.html">Debug Hub</a> ‚Üí Purchase Flow Demo
      </div>
      <h1>üõí Main Purchase Flow - Interactive Demo v0.8.1</h1>
      <p style="color: rgba(255,255,255,0.9); font-size: 14px;">SMRI S1.1,2,3,4,5.01 - Complete purchase flow from catalog to game</p>
      <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">‚úÖ Step-by-step mode working! | 2025-12-23 16:10</p>
    </div>

    <div class="info-panel">
      <h3>üìä Test Controls</h3>
      <p style="color: #8b949e; margin-bottom: 15px;">Click buttons to test the purchase flow</p>
      
      <div class="controls">
        <button id="btnFullDemo">
          ‚ñ∂Ô∏è Run Full Demo
        </button>
        <button class="secondary" id="btnStepByStep">
          ‚èØÔ∏è Step-by-Step Mode
        </button>
        <button class="secondary" id="btnWebhook">
          üîó Test Webhook Only
        </button>
        <button class="danger" id="btnReset">
          üîÑ Reset
        </button>
      </div>
    </div>

    <div id="alertContainer"></div>

    <div class="info-panel">
      <h3>üìù Output</h3>
      <div id="output">Ready to test...</div>
    </div>
  </div>

  <script>
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    const VERSION = '0.8.1';
    
    console.log(`%c Purchase Flow Demo ${VERSION} `, 'background: #667eea; color: white; font-size: 16px; font-weight: bold; padding: 4px;');
    console.log('‚úÖ Step-by-step mode implemented!');
    
    let testUserHash = null;
    const output = document.getElementById('output');
    const alertContainer = document.getElementById('alertContainer');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      output.innerHTML += `<div style="color: ${type === 'error' ? '#f85149' : type === 'success' ? '#3fb950' : '#8b949e'}">[${timestamp}] ${message}</div>`;
      output.scrollTop = output.scrollHeight;
    }

    function showAlert(message, type = 'info') {
      const alert = document.createElement('div');
      alert.className = `alert ${type}`;
      alert.textContent = message;
      alertContainer.appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    }

    async function runFullDemo() {
      log('üöÄ Starting full purchase flow demo...', 'info');
      showAlert('Starting full purchase flow demo...', 'info');
      
      try {
        // Generate test user
        testUserHash = `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        log(`User hash generated: ${testUserHash}`);
        
        // Step 1: Simulate webhook
        log('Step 1: Sending webhook to Worker...');
        const webhookPayload = {
          type: 'checkout.session.completed',
          data: {
            object: {
              id: `cs_test_${testUserHash}`,
              client_reference_id: testUserHash,
              payment_intent: `pi_test_${testUserHash}`,
              amount_total: 100000,
              currency: 'eur',
              customer_email: `test_${testUserHash}@example.com`,
              metadata: { product_id: 'prod_TdKcnyjt5Jk0U2' }
            }
          }
        };
        
        const webhookResponse = await fetch(`${WORKER_URL}/stripe-webhook`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(webhookPayload)
        });
        
        const webhookResult = await webhookResponse.json();
        log(`Webhook response: ${JSON.stringify(webhookResult)}`, webhookResult.success ? 'success' : 'error');
        
        if (!webhookResult.success) {
          showAlert('‚ùå Webhook failed', 'error');
          return;
        }
        
        // Step 2: Wait and verify
        log('Step 2: Waiting 2 seconds for KV sync...');
        await new Promise(r => setTimeout(r, 2000));
        
        log('Step 3: Checking user products in KV...');
        const checkResponse = await fetch(`${WORKER_URL}/user-products?user=${testUserHash}`);
        const products = await checkResponse.json();
        
        const productArray = Array.isArray(products) ? products : (products.products || []);
        log(`Products found: ${productArray.length}`, productArray.length > 0 ? 'success' : 'error');
        
        if (productArray.length > 0) {
          log(`‚úÖ SUCCESS! Snake assigned!`, 'success');
          log(`Snake details: ${JSON.stringify(productArray[0], null, 2)}`);
          showAlert(`‚úÖ Demo completed! ${productArray.length} snake(s) assigned`, 'success');
        } else {
          log('‚ö†Ô∏è No products found after webhook', 'error');
          showAlert('‚ö†Ô∏è No products found', 'error');
        }
        
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function runStepByStep() {
      log('‚èØÔ∏è Starting step-by-step mode...', 'info');
      showAlert('Step-by-step mode started - click button again to advance', 'info');
      
      if (!testUserHash) {
        // Step 0: Generate hash
        testUserHash = `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        log(`Step 0: User hash generated: ${testUserHash}`);
        return;
      }
      
      // Check if webhook already sent
      const checkResponse = await fetch(`${WORKER_URL}/user-products?user=${testUserHash}`);
      const products = await checkResponse.json();
      const productArray = Array.isArray(products) ? products : (products.products || []);
      
      if (productArray.length === 0) {
        // Step 1: Send webhook
        log('Step 1: Sending webhook to Worker...');
        
        const webhookPayload = {
          type: 'checkout.session.completed',
          data: {
            object: {
              id: `cs_test_${testUserHash}`,
              client_reference_id: testUserHash,
              payment_intent: `pi_test_${testUserHash}`,
              amount_total: 100000,
              currency: 'eur',
              customer_email: `test_${testUserHash}@example.com`,
              metadata: { product_id: 'prod_TdKcnyjt5Jk0U2' }
            }
          }
        };
        
        const webhookResponse = await fetch(`${WORKER_URL}/stripe-webhook`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(webhookPayload)
        });
        
        const webhookResult = await webhookResponse.json();
        log(`Webhook result: ${JSON.stringify(webhookResult)}`, webhookResult.success ? 'success' : 'error');
        showAlert('Step 1 complete! Click again to verify...', 'success');
        return;
      }
      
      // Step 2: Verify
      log('Step 2: Verifying snake assignment in KV...');
      log(`Products found: ${productArray.length}`, 'success');
      log(`Snake details: ${JSON.stringify(productArray[0], null, 2)}`);
      showAlert(`‚úÖ Step-by-step complete! ${productArray.length} snake(s)`, 'success');
      testUserHash = null; // Reset for next run
    }

    async function testWebhook() {
      log('üîó Testing webhook only...', 'info');
      showAlert('Testing webhook...', 'info');
      
      try {
        testUserHash = `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        log(`User hash: ${testUserHash}`);
        
        const webhookPayload = {
          type: 'checkout.session.completed',
          data: {
            object: {
              id: `cs_test_${testUserHash}`,
              client_reference_id: testUserHash,
              payment_intent: `pi_test_${testUserHash}`,
              amount_total: 100000,
              currency: 'eur',
              metadata: { product_id: 'prod_TdKcnyjt5Jk0U2' }
            }
          }
        };
        
        const response = await fetch(`${WORKER_URL}/stripe-webhook`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(webhookPayload)
        });
        
        const result = await response.json();
        log(`Webhook result: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');
        showAlert(result.success ? '‚úÖ Webhook succeeded' : '‚ùå Webhook failed', result.success ? 'success' : 'error');
        
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    function resetDemo() {
      output.innerHTML = 'Reset! Ready to test...<br>';
      testUserHash = null;
      log('Demo reset', 'info');
      showAlert('Demo reset', 'info');
    }

    // Event listeners (NOT onclick attributes!)
    document.getElementById('btnFullDemo').addEventListener('click', runFullDemo);
    document.getElementById('btnStepByStep').addEventListener('click', runStepByStep);
    document.getElementById('btnWebhook').addEventListener('click', testWebhook);
    document.getElementById('btnReset').addEventListener('click', resetDemo);

    console.log('‚úÖ Event listeners attached');
    console.log('‚úÖ Demo ready!');
  </script>
</body>
</html>
