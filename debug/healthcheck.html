<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè• SMRI Health Check - Serpent Town</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e14;
      color: #c9d1d9;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 { color: #58a6ff; margin-bottom: 10px; font-size: 24px; }
    
    .subtitle {
      color: #8b949e;
      margin-bottom: 20px;
      font-size: 13px;
    }
    
    .btn {
      background: #238636;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    
    .btn:hover { background: #2ea043; }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .service-group {
      margin-bottom: 30px;
    }
    
    .service-header {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .service-header h2 {
      flex: 1;
      font-size: 18px;
      color: #c9d1d9;
    }
    
    .service-badge {
      background: #21262d;
      color: #8b949e;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .test-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      margin-bottom: 10px;
      overflow: hidden;
      margin-left: 20px;
    }
    
    .test-header {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      user-select: none;
    }
    
    .test-header:hover { background: #1c2128; }
    
    .test-number {
      background: #21262d;
      color: #8b949e;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      min-width: 35px;
      text-align: center;
    }
    
    .test-method {
      background: #238636;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      min-width: 45px;
      text-align: center;
    }
    
    .test-title { flex: 1; font-weight: 500; }
    
    .test-status {
      font-size: 18px;
    }
    
    .test-body {
      display: none;
      padding: 16px;
      border-top: 1px solid #30363d;
      background: #0d1117;
    }
    
    .test-body.show { display: block; }
    
    .test-section {
      margin-bottom: 16px;
    }
    
    .test-section h4 {
      color: #8b949e;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .code-block {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      line-height: 1.5;
    }
    
    .progress-bar {
      background: #161b22;
      border-radius: 10px;
      height: 24px;
      overflow: hidden;
      margin: 15px 0;
      border: 2px solid #30363d;
      display: none;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #238636, #2ea043);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease-out;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    
    .progress-text {
      color: #58a6ff;
      font-size: 12px;
      font-weight: bold;
      margin-top: 10px;
      display: none;
    }
    
    .status-ok { color: #3fb950; }
    .status-warn { color: #d29922; }
    .status-error { color: #f85149; }
    
    .run-btn-container {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>üè• SMRI System Health Check</h1>
  <p class="subtitle">
    <strong>SMRI:</strong> S6.0.03 | <strong>Module:</strong> v1.5 | <strong>App:</strong> 0.5.0 | <strong>Tests:</strong> 9 grouped by service<br>
    <a href="#smri-table" style="color: #58a6ff; text-decoration: none; font-size: 12px;">üìã View SMRI Code Reference</a>
  </p>
  
  <div class="run-btn-container">
    <button onclick="runAllTests()" class="btn">‚ñ∂ Run All Tests</button>
    <button onclick="collapseAll()" class="btn btn-small">Collapse All</button>
    <button onclick="expandAll()" class="btn btn-small">Expand All</button>
  </div>
  
  <div class="progress-bar" id="progress-container">
    <div class="progress-fill" id="progress-bar">0%</div>
  </div>
  <div class="progress-text" id="progress-text">Ready</div>
  
  <div id="test-list"></div>
  
  <div id="smri-table" style="margin-top: 40px; padding: 20px; background: #161b22; border: 1px solid #30363d; border-radius: 8px;">
    <h2 style="color: #c9d1d9; margin-bottom: 15px; font-size: 18px;">üìã SMRI Code Reference</h2>
    <p style="color: #8b949e; font-size: 13px; margin-bottom: 20px;">
      SMRI (Scenario-Module-Relation-Instance) codes map to external services and internal modules.
    </p>
    
    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
      <thead>
        <tr style="border-bottom: 2px solid #30363d;">
          <th style="text-align: left; padding: 10px; color: #8b949e; font-weight: 600;">SMRI Code</th>
          <th style="text-align: left; padding: 10px; color: #8b949e; font-weight: 600;">Service</th>
          <th style="text-align: left; padding: 10px; color: #8b949e; font-weight: 600;">Description</th>
          <th style="text-align: right; padding: 10px; color: #8b949e; font-weight: 600;">Tests</th>
        </tr>
      </thead>
      <tbody>
        <tr style="border-bottom: 1px solid #30363d;">
          <td style="padding: 10px; color: #58a6ff; font-family: monospace;">S5.x</td>
          <td style="padding: 10px;">‚òÅÔ∏è Cloudflare Worker</td>
          <td style="padding: 10px; color: #8b949e;">Worker API, routing, endpoints</td>
          <td style="padding: 10px; text-align: right; color: #3fb950; font-weight: bold;">3</td>
        </tr>
        <tr style="border-bottom: 1px solid #30363d;">
          <td style="padding: 10px; color: #58a6ff; font-family: monospace;">S11.1.x</td>
          <td style="padding: 10px;">üóÑÔ∏è Cloudflare KV</td>
          <td style="padding: 10px; color: #8b949e;">Key-value storage, products, user data</td>
          <td style="padding: 10px; text-align: right; color: #3fb950; font-weight: bold;">3</td>
        </tr>
        <tr style="border-bottom: 1px solid #30363d;">
          <td style="padding: 10px; color: #58a6ff; font-family: monospace;">S12.x</td>
          <td style="padding: 10px;">üí≥ Stripe</td>
          <td style="padding: 10px; color: #8b949e;">Payment integration, checkout links</td>
          <td style="padding: 10px; text-align: right; color: #3fb950; font-weight: bold;">2</td>
        </tr>
        <tr style="border-bottom: 1px solid #30363d;">
          <td style="padding: 10px; color: #58a6ff; font-family: monospace;">S6.x</td>
          <td style="padding: 10px;">üß™ Common Utils</td>
          <td style="padding: 10px; color: #8b949e;">Data validation, format checks</td>
          <td style="padding: 10px; text-align: right; color: #3fb950; font-weight: bold;">1</td>
        </tr>
      </tbody>
    </table>
    
    <div style="margin-top: 20px; padding: 15px; background: #0d1117; border-radius: 6px; border-left: 3px solid #58a6ff;">
      <h3 style="color: #c9d1d9; font-size: 14px; margin-bottom: 10px;">Internal Modules (not tested here)</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; color: #8b949e; font-size: 12px;">
        <div><strong style="color: #58a6ff;">S1.x</strong> - Shop (Catalog)</div>
        <div><strong style="color: #58a6ff;">S2.x</strong> - Game (Tamagotchi)</div>
        <div><strong style="color: #58a6ff;">S3.x</strong> - Auth (Hash Identity)</div>
        <div><strong style="color: #58a6ff;">S4.x</strong> - Payment (Webhooks)</div>
      </div>
    </div>
    
    <div style="margin-top: 15px; padding: 15px; background: #0d1117; border-radius: 6px; border-left: 3px solid #d29922;">
      <h3 style="color: #c9d1d9; font-size: 14px; margin-bottom: 10px;">Other External Services</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; color: #8b949e; font-size: 12px;">
        <div><strong style="color: #58a6ff;">S11.2.x</strong> - Cloudflare Workers Runtime</div>
        <div><strong style="color: #58a6ff;">S11.3.x</strong> - Cloudflare CDN</div>
        <div><strong style="color: #58a6ff;">S12.1.x</strong> - Stripe Checkout</div>
        <div><strong style="color: #58a6ff;">S12.2.x</strong> - Stripe Webhooks</div>
        <div><strong style="color: #58a6ff;">S13.1.x</strong> - GitHub Pages</div>
        <div><strong style="color: #58a6ff;">S13.2.x</strong> - GitHub Actions</div>
      </div>
    </div>
    
    <p style="margin-top: 15px; color: #8b949e; font-size: 12px;">
      <strong>Format:</strong> S = Scenario, M = Module (1-13), R = Relations, II = Instance<br>
      <strong>Full documentation:</strong> <a href="../docs/test/E2E_TEST_SCENARIOS.md" style="color: #58a6ff;">E2E Test Scenarios</a>
    </p>
  </div>

  <script>
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    
    const testGroups = [
      {
        service: '‚òÅÔ∏è Cloudflare Worker',
        badge: 'S5.x',
        description: 'Worker API health and connectivity',
        tests: [
          {
            id: 1,
            name: 'Worker URL Validation',
            method: 'GET',
            endpoint: '/products',
            description: 'Verify Worker URL is valid HTTPS endpoint',
            run: async () => {
              if (!WORKER_URL.startsWith('http')) throw new Error('Invalid URL');
              return { valid: true, url: WORKER_URL };
            }
          },
          {
            id: 2,
            name: 'Worker Online Check',
            method: 'GET',
            endpoint: '/products',
            description: 'Ping Worker to verify it responds',
            run: async () => {
              const start = Date.now();
              const res = await fetch(WORKER_URL + '/products');
              const time = Date.now() - start;
              if (!res.ok) throw new Error(`Status ${res.status}`);
              return { online: true, responseTime: time + 'ms', status: res.status };
            }
          },
          {
            id: 3,
            name: 'Response Time',
            method: 'GET',
            endpoint: '/products',
            description: 'Measure API response latency',
            run: async () => {
              const start = Date.now();
              await fetch(WORKER_URL + '/products');
              const time = Date.now() - start;
              if (time > 5000) throw new Error(`Too slow: ${time}ms`);
              return { responseTime: time + 'ms', threshold: '5000ms' };
            }
          }
        ]
      },
      {
        service: 'üóÑÔ∏è Cloudflare KV',
        badge: 'S11.1.x',
        description: 'KV storage and product data',
        tests: [
          {
            id: 4,
            name: 'Get Products',
            method: 'GET',
            endpoint: '/products',
            description: 'Load products from KV storage',
            run: async () => {
              const res = await fetch(WORKER_URL + '/products');
              const data = await res.json();
              if (!Array.isArray(data)) throw new Error('Not an array');
              if (data.length === 0) throw new Error('No products');
              return { count: data.length, sample: data.slice(0, 1) };
            }
          },
          {
            id: 5,
            name: 'Product Schema',
            method: 'GET',
            endpoint: '/products',
            description: 'Validate required product fields',
            run: async () => {
              const res = await fetch(WORKER_URL + '/products');
              const products = await res.json();
              const required = ['id', 'name', 'species', 'morph', 'price'];
              const first = products[0];
              const missing = required.filter(f => !(f in first));
              if (missing.length > 0) throw new Error(`Missing: ${missing.join(', ')}`);
              return { valid: true, fields: required };
            }
          },
          {
            id: 6,
            name: 'Get User Products',
            method: 'GET',
            endpoint: '/user-products?user=test',
            description: 'Test user-specific product retrieval',
            run: async () => {
              const res = await fetch(WORKER_URL + '/user-products?user=test_hash');
              if (res.status !== 200 && res.status !== 404) throw new Error(`Unexpected status ${res.status}`);
              return { status: res.status, message: res.status === 404 ? 'No products (expected for test user)' : 'Has products' };
            }
          }
        ]
      },
      {
        service: 'üí≥ Stripe Integration',
        badge: 'S12.x',
        description: 'Stripe products and payment links',
        tests: [
          {
            id: 7,
            name: 'Stripe Products',
            method: 'GET',
            endpoint: '/products',
            description: 'Find products with Stripe payment integration',
            run: async () => {
              const res = await fetch(WORKER_URL + '/products');
              const products = await res.json();
              const stripe = products.filter(p => p.source === 'stripe' && p.stripe_link);
              if (stripe.length === 0) throw new Error('No Stripe products');
              return { count: stripe.length, sample: stripe[0].name };
            }
          },
          {
            id: 8,
            name: 'Checkout Links',
            method: 'GET',
            endpoint: '/products',
            description: 'Validate payment link URLs',
            run: async () => {
              const res = await fetch(WORKER_URL + '/products');
              const products = await res.json();
              const valid = products.filter(p => p.stripe_link && p.stripe_link.startsWith('https://buy.stripe.com/'));
              if (valid.length === 0) throw new Error('No valid links');
              return { count: valid.length, sample: valid[0].stripe_link.substring(0, 50) + '...' };
            }
          }
        ]
      },
      {
        service: 'üß™ Data Validation',
        badge: 'S6.x',
        description: 'Format and structure checks',
        tests: [
          {
            id: 9,
            name: 'JSON Format',
            method: 'GET',
            endpoint: '/products',
            description: 'Verify response is valid JSON',
            run: async () => {
              const res = await fetch(WORKER_URL + '/products');
              const text = await res.text();
              JSON.parse(text);
              return { valid: true, size: text.length + ' bytes' };
            }
          }
        ]
      }
    ];
    
    let testResults = {};
    
    function renderTests() {
      const listDiv = document.getElementById('test-list');
      listDiv.innerHTML = testGroups.map(group => `
        <div class="service-group">
          <div class="service-header">
            <h2>${group.service}</h2>
            <span class="service-badge">${group.badge}</span>
            <span class="service-badge">${group.tests.length} tests</span>
          </div>
          ${group.tests.map(test => `
            <div class="test-card" id="test-${test.id}">
              <div class="test-header" onclick="toggleTest(${test.id})">
                <span class="test-number">#${test.id}</span>
                <span class="test-method">${test.method}</span>
                <span class="test-title">${test.name}</span>
                <span class="test-status" id="status-${test.id}">‚ö™</span>
              </div>
              <div class="test-body" id="body-${test.id}">
                <div class="test-section">
                  <h4>Description</h4>
                  <p style="color: #8b949e; font-size: 13px;">${test.description}</p>
                </div>
                <div class="test-section">
                  <h4>Request</h4>
                  <div class="code-block">
                    <div><strong>${test.method}</strong> ${WORKER_URL}${test.endpoint}</div>
                  </div>
                </div>
                <div class="test-section">
                  <h4>Response</h4>
                  <div class="code-block" id="response-${test.id}">
                    <div style="color: #8b949e;">Not run yet. Click "Run Test" or "Run All Tests"</div>
                  </div>
                </div>
                <button onclick="runSingleTest(${test.id})" class="btn btn-small">‚ñ∂ Run Test</button>
              </div>
            </div>
          `).join('')}
        </div>
      `).join('');
    }
    
    function getAllTests() {
      return testGroups.flatMap(g => g.tests);
    }
    
    function toggleTest(id) {
      const body = document.getElementById(`body-${id}`);
      body.classList.toggle('show');
    }
    
    function collapseAll() {
      document.querySelectorAll('.test-body').forEach(b => b.classList.remove('show'));
    }
    
    function expandAll() {
      document.querySelectorAll('.test-body').forEach(b => b.classList.add('show'));
    }
    
    async function runSingleTest(id) {
      const test = getAllTests().find(t => t.id === id);
      const statusEl = document.getElementById(`status-${id}`);
      const responseEl = document.getElementById(`response-${id}`);
      
      statusEl.textContent = '‚è≥';
      responseEl.innerHTML = '<div style="color: #58a6ff;">Running...</div>';
      
      try {
        const result = await test.run();
        statusEl.textContent = '‚úÖ';
        statusEl.className = 'test-status status-ok';
        responseEl.innerHTML = `<pre style="margin: 0; color: #3fb950;">${JSON.stringify(result, null, 2)}</pre>`;
        testResults[id] = { status: 'ok', result };
      } catch (error) {
        statusEl.textContent = '‚ùå';
        statusEl.className = 'test-status status-error';
        responseEl.innerHTML = `<pre style="margin: 0; color: #f85149;">Error: ${error.message}</pre>`;
        testResults[id] = { status: 'error', error: error.message };
      }
    }
    
    async function runAllTests() {
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      const progressContainer = document.getElementById('progress-container');
      
      progressContainer.style.display = 'block';
      progressText.style.display = 'block';
      testResults = {};
      
      const allTests = getAllTests();
      
      for (let i = 0; i < allTests.length; i++) {
        const percent = Math.round(((i + 1) / allTests.length) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
        progressText.innerHTML = `üîç Test ${i + 1}/${allTests.length} - <strong>${allTests[i].name}</strong>`;
        
        await runSingleTest(allTests[i].id);
        await new Promise(r => setTimeout(r, 200));
      }
      
      progressText.innerHTML = '‚úÖ All tests complete!';
      progressText.style.color = '#3fb950';
      
      const passed = Object.values(testResults).filter(r => r.status === 'ok').length;
      const failed = allTests.length - passed;
      
      console.log(`Tests: ${passed}/${allTests.length} passed`);
    }
    
    // Initialize
    renderTests();
    
    // Auto-run on load
    window.addEventListener('load', () => {
      setTimeout(() => runAllTests(), 500);
    });
  </script>
</body>
</html>
