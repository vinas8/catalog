<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîç Serpent Town - Unified Debug Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Monaco', 'Courier New', monospace;
      background: #0d1117;
      color: #c9d1d9;
      padding: 20px;
      font-size: 14px;
    }
    .container { max-width: 1600px; margin: 0 auto; }
    
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    h1 { color: white; margin-bottom: 5px; }
    .subtitle { color: rgba(255,255,255,0.8); font-size: 12px; }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 1200px) {
      .grid { grid-template-columns: 1fr; }
    }
    
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      padding: 20px;
      border-radius: 8px;
    }
    .card h2 {
      color: #58a6ff;
      margin-bottom: 15px;
      font-size: 16px;
      border-bottom: 1px solid #30363d;
      padding-bottom: 10px;
    }
    
    .btn {
      background: #238636;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-right: 10px;
      margin-top: 10px;
      font-family: inherit;
      transition: all 0.2s;
    }
    .btn:hover { background: #2ea043; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.danger { background: #da3633; }
    .btn.danger:hover { background: #f85149; }
    .btn.warning { background: #d29922; }
    .btn.warning:hover { background: #f0ad4e; }
    .btn:disabled { background: #484f58; cursor: not-allowed; opacity: 0.5; }
    
    .status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .status.ok { background: #238636; color: white; }
    .status.error { background: #da3633; color: white; }
    .status.warning { background: #d29922; color: white; }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #21262d;
      font-size: 13px;
    }
    .info-row:last-child { border-bottom: none; }
    .label { color: #8b949e; }
    .value { color: #c9d1d9; font-weight: 600; }
    
    .log {
      background: #0d1117;
      border: 1px solid #30363d;
      padding: 15px;
      border-radius: 6px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Monaco', monospace;
      font-size: 12px;
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid #21262d;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-entry.error { color: #f85149; }
    .log-entry.success { color: #3fb950; }
    .log-entry.warning { color: #d29922; }
    
    .api-endpoint {
      background: #0d1117;
      border: 1px solid #30363d;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    .api-endpoint .method {
      background: #1f6feb;
      color: white;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      display: inline-block;
      margin-bottom: 10px;
    }
    .api-endpoint .method.post { background: #238636; }
    .api-endpoint .method.delete { background: #da3633; }
    .api-endpoint .path {
      color: #58a6ff;
      font-size: 13px;
      margin-bottom: 10px;
    }
    .api-endpoint .description {
      color: #8b949e;
      font-size: 12px;
      margin-bottom: 10px;
    }
    .api-endpoint input, .api-endpoint textarea {
      background: #0d1117;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 8px 12px;
      border-radius: 6px;
      width: 100%;
      font-family: 'Monaco', monospace;
      font-size: 12px;
      margin-bottom: 10px;
    }
    .api-endpoint textarea {
      min-height: 80px;
      resize: vertical;
    }
    .api-endpoint .response {
      background: #010409;
      border: 1px solid #30363d;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 11px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .api-endpoint .response.success { border-color: #238636; }
    .api-endpoint .response.error { border-color: #da3633; }
    
    input[type="text"] {
      background: #0d1117;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 8px 12px;
      border-radius: 6px;
      width: 100%;
      font-family: 'Monaco', monospace;
      font-size: 13px;
      margin-bottom: 10px;
    }
    
    .spinner {
      border: 3px solid #21262d;
      border-top: 3px solid #58a6ff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid #30363d;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      color: #8b949e;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover { color: #c9d1d9; }
    .tab.active {
      color: #58a6ff;
      border-bottom-color: #58a6ff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîç Serpent Town - Unified Debug Dashboard</h1>
      <div class="subtitle">Complete diagnostics: API testing, KV management, Worker monitoring, and real-time logs</div>
      <div style="margin-top: 10px; font-size: 11px; color: rgba(255,255,255,0.7);">
        <a href="game.html" style="color: rgba(255,255,255,0.9);">‚Üê Back to Game</a> | 
        <a href="catalog.html" style="color: rgba(255,255,255,0.9);">Shop</a> | 
        <a href="index.html" style="color: rgba(255,255,255,0.9);">Home</a>
      </div>
    </header>

    <!-- Quick User Input -->
    <div class="card" style="margin-bottom: 20px;">
      <h2>üîë User Context</h2>
      <input type="text" id="user-hash-input" placeholder="Enter user hash (or load from URL)" value="">
      <button class="btn" onclick="setUser()">üíæ Set User</button>
      <button class="btn" onclick="generateTestUser()">üé≤ Generate Test User</button>
      <div id="current-user" style="margin-top: 10px; padding: 10px; background: #0d1117; border-radius: 6px; border: 1px solid #30363d;">
        <span style="color: #d29922;">‚ö†Ô∏è No user set</span>
        <span style="color: #8b949e; font-size: 11px; display: block; margin-top: 5px;">Click "Generate Test User" or enter a hash above</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('api')">üõ£Ô∏è API Testing</div>
      <div class="tab" onclick="switchTab('kv')">üì¶ KV Data</div>
      <div class="tab" onclick="switchTab('monitor')">üìä Monitoring</div>
      <div class="tab" onclick="switchTab('logs')">üìù Logs</div>
    </div>

    <!-- API Testing Tab -->
    <div id="tab-api" class="tab-content active">
      <h2 style="color: #58a6ff; margin-bottom: 20px;">API Endpoints</h2>
      
      <!-- CATALOG ENDPOINTS -->
      <div style="margin-bottom: 30px;">
        <h3 style="color: #f0883e; font-size: 16px; margin-bottom: 15px; border-bottom: 2px solid #f0883e; padding-bottom: 8px;">üì¶ Catalog & Products</h3>
        
        <!-- GET /products -->
        <div class="api-endpoint">
          <span class="method">GET</span>
          <div class="path">/products</div>
          <div class="description">Get all products from catalog (no auth required)</div>
          <button class="btn" onclick="callAPI('getProducts')">‚ñ∂ Execute</button>
          <div id="res-getProducts" class="response" style="display:none;"></div>
        </div>

        <!-- GET /product-status -->
        <div class="api-endpoint">
          <span class="method">GET</span>
          <div class="path">/product-status?id={product_id}</div>
          <div class="description">Check if a product is sold/available (no auth required)</div>
          <label style="color: #8b949e; font-size: 12px; display: block; margin-bottom: 5px;">Product ID:</label>
          <input type="text" id="param-productStatus-id" placeholder="prod_TdKcnyjt5Jk0U2">
          <button class="btn" onclick="callAPI('productStatus')">‚ñ∂ Execute</button>
          <div id="res-productStatus" class="response" style="display:none;"></div>
        </div>
      </div>

      <!-- USER-SPECIFIC ENDPOINTS -->
      <div style="margin-bottom: 30px;">
        <h3 style="color: #3fb950; font-size: 16px; margin-bottom: 15px; border-bottom: 2px solid #3fb950; padding-bottom: 8px;">üë§ User Management (requires user)</h3>
        
        <!-- GET /user-products -->
        <div class="api-endpoint">
          <span class="method">GET</span>
          <div class="path">/user-products?user={hash}</div>
          <div class="description">Get all products owned by a specific user</div>
          <button class="btn" onclick="callAPI('getUserProducts')">‚ñ∂ Execute</button>
          <div id="res-getUserProducts" class="response" style="display:none;"></div>
        </div>

        <!-- GET /user-data -->
        <div class="api-endpoint">
          <span class="method">GET</span>
          <div class="path">/user-data?user={hash}</div>
          <div class="description">Get user profile information</div>
          <button class="btn" onclick="callAPI('getUserData')">‚ñ∂ Execute</button>
          <div id="res-getUserData" class="response" style="display:none;"></div>
        </div>

        <!-- POST /register-user -->
        <div class="api-endpoint">
          <span class="method post">POST</span>
          <div class="path">/register-user</div>
          <div class="description">Register a new user profile</div>
          <label style="color: #8b949e; font-size: 12px; display: block; margin-bottom: 5px;">Username:</label>
          <input type="text" id="param-registerUser-username" placeholder="TestUser123">
          <label style="color: #8b949e; font-size: 12px; display: block; margin-bottom: 5px;">Email:</label>
          <input type="text" id="param-registerUser-email" placeholder="test@example.com">
          <button class="btn" onclick="callAPI('registerUser')">‚ñ∂ Execute</button>
          <div id="res-registerUser" class="response" style="display:none;"></div>
        </div>

        <!-- POST /assign-product -->
        <div class="api-endpoint">
          <span class="method post">POST</span>
          <div class="path">/assign-product</div>
          <div class="description">Manually assign a product to a user (testing only)</div>
          <label style="color: #8b949e; font-size: 12px; display: block; margin-bottom: 5px;">Product ID:</label>
          <input type="text" id="param-assignProduct-productId" placeholder="prod_TdKcnyjt5Jk0U2">
          <button class="btn" onclick="callAPI('assignProduct')">‚ñ∂ Execute</button>
          <div id="res-assignProduct" class="response" style="display:none;"></div>
        </div>
      </div>

      <!-- ADMIN ENDPOINTS -->
      <div style="margin-bottom: 30px;">
        <h3 style="color: #58a6ff; font-size: 16px; margin-bottom: 15px; border-bottom: 2px solid #58a6ff; padding-bottom: 8px;">üîê Admin & Reports (no auth required)</h3>
        
        <!-- GET /all-users -->
        <div class="api-endpoint">
          <span class="method">GET</span>
          <div class="path">/all-users</div>
          <div class="description">Get all registered users (sorted by registration date, newest first)</div>
          <button class="btn" onclick="callAPI('getAllUsers')">‚ñ∂ Execute</button>
          <div id="res-getAllUsers" class="response" style="display:none;"></div>
        </div>

        <!-- GET /all-purchases -->
        <div class="api-endpoint">
          <span class="method">GET</span>
          <div class="path">/all-purchases</div>
          <div class="description">Get all purchase records (sorted by date, newest first)</div>
          <button class="btn" onclick="callAPI('getAllPurchases')">‚ñ∂ Execute</button>
          <div id="res-getAllPurchases" class="response" style="display:none;"></div>
        </div>
      </div>

      <!-- STRIPE WEBHOOK -->
      <div style="margin-bottom: 30px;">
        <h3 style="color: #d29922; font-size: 16px; margin-bottom: 15px; border-bottom: 2px solid #d29922; padding-bottom: 8px;">üí≥ Stripe Integration</h3>
        
        <!-- POST /stripe-webhook (info only) -->
        <div class="api-endpoint">
          <span class="method post">POST</span>
          <div class="path">/stripe-webhook</div>
          <div class="description">‚ö†Ô∏è Stripe webhook endpoint (called by Stripe, not for manual testing)</div>
          <button class="btn" disabled>‚ñ∂ Execute</button>
          <div style="color: #8b949e; font-size: 11px; margin-top: 10px;">
            This endpoint is automatically called by Stripe when a purchase is completed.
          </div>
        </div>
      </div>
    </div>

    <!-- KV Data Tab -->
    <div id="tab-kv" class="tab-content">
      <div class="grid">
        <div class="card">
          <h2>üì¶ KV Operations</h2>
          <button class="btn" onclick="loadKV('products')">üìä Load User Products</button>
          <button class="btn" onclick="loadKV('profile')">üë§ Load User Profile</button>
          <button class="btn warning" onclick="showClearKVDialog()">üóëÔ∏è Clear User Data</button>
          <button class="btn" onclick="exportKV()">üíæ Export as JSON</button>
        </div>
        
        <div class="card">
          <h2>‚ö†Ô∏è Danger Zone</h2>
          <p style="color: #8b949e; font-size: 12px; margin-bottom: 10px;">
            These actions affect the entire KV database.
          </p>
          <button class="btn danger" onclick="showClearAllDialog()">üóëÔ∏è Clear All KV Data</button>
          <div style="margin-top: 10px; color: #8b949e; font-size: 11px;">
            Note: Clearing requires manual action in Cloudflare dashboard.<br>
            Go to: Workers & Pages ‚Üí KV ‚Üí Select namespace ‚Üí Delete keys
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üîç KV Data Viewer</h2>
        <div id="kv-viewer" style="background: #0d1117; border: 1px solid #30363d; padding: 15px; border-radius: 6px; max-height: 500px; overflow-y: auto; font-size: 11px; white-space: pre-wrap; word-wrap: break-word;">
          Click a button above to load KV data
        </div>
      </div>
    </div>

    <!-- Monitoring Tab -->
    <div id="tab-monitor" class="tab-content">
      <div class="grid">
        <div class="card">
          <h2>üîå Worker Status</h2>
          <div id="worker-status">
            <div class="spinner"></div>
          </div>
          <button class="btn" onclick="checkWorker()">üîÑ Refresh Status</button>
        </div>

        <div class="card">
          <h2>üìä Metrics</h2>
          <div id="metrics">
            <div class="info-row"><span class="label">API Calls:</span><span class="value" id="metric-calls">0</span></div>
            <div class="info-row"><span class="label">Successful:</span><span class="value" id="metric-success">0</span></div>
            <div class="info-row"><span class="label">Failed:</span><span class="value" id="metric-errors">0</span></div>
            <div class="info-row"><span class="label">Avg Latency:</span><span class="value" id="metric-latency">0ms</span></div>
          </div>
          <button class="btn warning" onclick="resetMetrics()">üîÑ Reset Metrics</button>
        </div>
      </div>
    </div>

    <!-- Logs Tab -->
    <div id="tab-logs" class="tab-content">
      <div class="card">
        <h2>üìù Debug Log</h2>
        <div id="debug-log" class="log">
          <div class="log-entry success">ÔøΩÔøΩ Dev Dashboard initialized</div>
        </div>
        <button class="btn" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        <button class="btn" onclick="downloadLog()">üíæ Download Log</button>
        <button class="btn" onclick="autoScroll = !autoScroll; log('Auto-scroll ' + (autoScroll ? 'enabled' : 'disabled'))">
          üîÑ Toggle Auto-scroll
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { WORKER_CONFIG } from './src/config/worker-config.js';

    window.WORKER_URL = WORKER_CONFIG.WORKER_URL;
    window.currentUser = null;
    window.autoScroll = true;
    
    // Metrics tracking
    window.metrics = {
      calls: 0,
      success: 0,
      errors: 0,
      latencies: []
    };

    // Initialize
    (async function() {
      log('üîÑ Initializing dashboard...', 'success');
      
      // Try to load user from URL
      const urlParams = new URLSearchParams(window.location.search);
      const hashFromQuery = urlParams.get('user');
      const hashFromHash = window.location.hash.slice(1);
      const userHash = hashFromQuery || hashFromHash;
      
      if (userHash) {
        document.getElementById('user-hash-input').value = userHash;
        setUser();
        log(`‚úÖ Loaded user from URL: ${userHash}`, 'success');
      } else {
        log('‚ö†Ô∏è No user hash in URL. Enter one above or generate a test user.', 'warning');
        log('üí° TIP: Click "Generate Test User" button to create one', 'warning');
      }
      
      // Check worker status once on load (no loop)
      await checkWorker();
    })();

    window.switchTab = function(tab) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      
      // Show selected tab
      document.getElementById('tab-' + tab).classList.add('active');
      event.target.classList.add('active');
      
      log(`üìë Switched to ${tab} tab`, 'success');
    };

    window.setUser = function() {
      const hash = document.getElementById('user-hash-input').value.trim();
      if (!hash) {
        log('‚ùå Please enter a user hash', 'error');
        alert('‚ùå Please enter a user hash in the input field');
        return;
      }
      
      window.currentUser = hash;
      document.getElementById('current-user').innerHTML = `
        <span style="color: #3fb950;">‚úÖ Current user: <strong style="color: #58a6ff;">${hash}</strong></span>
        <span style="color: #8b949e; font-size: 11px; display: block; margin-top: 5px;">User set! You can now execute API calls.</span>
      `;
      log(`üë§ User set: ${hash}`, 'success');
    };

    window.generateTestUser = function() {
      const hash = 'test_' + Date.now();
      document.getElementById('user-hash-input').value = hash;
      setUser();
      log(`üé≤ Generated test user: ${hash}`, 'success');
    };

    window.callAPI = async function(endpoint) {
      // Endpoints that don't require user
      const noUserRequired = ['productStatus', 'getProducts', 'getAllUsers', 'getAllPurchases'];
      
      if (!window.currentUser && !noUserRequired.includes(endpoint)) {
        log('‚ùå Please set a user first!', 'error');
        log('üí° Click "Generate Test User" button at the top', 'warning');
        alert('‚ö†Ô∏è Please set a user first!\n\nClick the "Generate Test User" button at the top of the page.');
        return;
      }

      log(`üöÄ Executing ${endpoint}...`, 'info');
      
      const resDiv = document.getElementById('res-' + endpoint);
      resDiv.style.display = 'block';
      resDiv.className = 'response';
      resDiv.textContent = '‚è≥ Loading...';

      const startTime = Date.now();
      
      try {
        let response, url, options;
        
        switch(endpoint) {
          case 'getProducts':
            url = `${window.WORKER_URL}/products`;
            log(`üì° GET ${url}`, 'success');
            response = await fetch(url);
            break;
            
          case 'getUserProducts':
            url = `${window.WORKER_URL}/user-products?user=${window.currentUser}`;
            log(`üì° GET ${url}`, 'success');
            response = await fetch(url);
            break;
            
          case 'getUserData':
            url = `${window.WORKER_URL}/user-data?user=${window.currentUser}`;
            log(`üì° GET ${url}`, 'success');
            response = await fetch(url);
            break;
            
          case 'getAllUsers':
            url = `${window.WORKER_URL}/all-users`;
            log(`üì° GET ${url}`, 'success');
            response = await fetch(url);
            break;
            
          case 'getAllPurchases':
            url = `${window.WORKER_URL}/all-purchases`;
            log(`üì° GET ${url}`, 'success');
            response = await fetch(url);
            break;
            
          case 'productStatus':
            const prodId = document.getElementById('param-productStatus-id').value || 'prod_TdKcnyjt5Jk0U2';
            url = `${window.WORKER_URL}/product-status?id=${prodId}`;
            log(`üì° GET ${url}`, 'success');
            response = await fetch(url);
            break;
            
          case 'assignProduct':
            const productId = document.getElementById('param-assignProduct-productId').value || 'prod_TdKcnyjt5Jk0U2';
            url = `${window.WORKER_URL}/assign-product`;
            options = {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ user_id: window.currentUser, product_id: productId })
            };
            log(`üì° POST ${url}`, 'success');
            response = await fetch(url, options);
            break;
            
          case 'registerUser':
            const username = document.getElementById('param-registerUser-username').value || 'TestUser' + Date.now();
            const email = document.getElementById('param-registerUser-email').value || 'test@example.com';
            url = `${window.WORKER_URL}/register-user`;
            options = {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ user_id: window.currentUser, username, email })
            };
            log(`üì° POST ${url}`, 'success');
            response = await fetch(url, options);
            break;
        }

        const latency = Date.now() - startTime;
        const data = await response.json();
        
        // Update metrics
        updateMetrics(response.ok, latency);
        
        // Display response
        resDiv.className = 'response ' + (response.ok ? 'success' : 'error');
        resDiv.textContent = `Status: ${response.status} ${response.statusText}\nLatency: ${latency}ms\n\n${JSON.stringify(data, null, 2)}`;
        
        log(`${response.ok ? '‚úÖ' : '‚ùå'} ${response.status} (${latency}ms)`, response.ok ? 'success' : 'error');
        
      } catch (error) {
        const latency = Date.now() - startTime;
        updateMetrics(false, latency);
        resDiv.className = 'response error';
        resDiv.textContent = `Error: ${error.message}`;
        log(`‚ùå Request failed: ${error.message}`, 'error');
      }
    };

    window.loadKV = async function(type) {
      if (!window.currentUser) {
        log('‚ùå Please set a user first', 'error');
        return;
      }

      const viewer = document.getElementById('kv-viewer');
      viewer.textContent = '‚è≥ Loading...';

      try {
        let url;
        if (type === 'products') {
          url = `${window.WORKER_URL}/user-products?user=${window.currentUser}`;
          log(`üì¶ Loading user products from KV...`, 'success');
        } else if (type === 'profile') {
          url = `${window.WORKER_URL}/user-data?user=${window.currentUser}`;
          log(`üë§ Loading user profile from KV...`, 'success');
        }

        const response = await fetch(url);
        const data = await response.json();
        
        viewer.textContent = JSON.stringify(data, null, 2);
        log(`‚úÖ Loaded ${type} from KV`, 'success');
        
      } catch (error) {
        viewer.textContent = `Error: ${error.message}`;
        log(`‚ùå Failed to load KV data: ${error.message}`, 'error');
      }
    };

    window.exportKV = async function() {
      if (!window.currentUser) {
        log('‚ùå Please set a user first', 'error');
        return;
      }

      try {
        log('üíæ Exporting KV data...', 'success');
        
        const [products, profile] = await Promise.all([
          fetch(`${window.WORKER_URL}/user-products?user=${window.currentUser}`).then(r => r.json()).catch(() => null),
          fetch(`${window.WORKER_URL}/user-data?user=${window.currentUser}`).then(r => r.json()).catch(() => null)
        ]);

        const exportData = {
          exported_at: new Date().toISOString(),
          user: window.currentUser,
          profile,
          products
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `serpent-town-${window.currentUser}-${Date.now()}.json`;
        a.click();
        
        log('‚úÖ KV data exported successfully', 'success');
      } catch (error) {
        log(`‚ùå Export failed: ${error.message}`, 'error');
      }
    };

    window.showClearKVDialog = function() {
      if (!window.currentUser) {
        log('‚ùå Please set a user first', 'error');
        return;
      }

      if (confirm(`‚ö†Ô∏è Delete ALL data for user ${window.currentUser}?\n\n- Products\n- Profile\n\nThis CANNOT be undone!`)) {
        log('‚ö†Ô∏è Clear user data triggered', 'warning');
        log('‚ö†Ô∏è KV delete endpoint not implemented yet', 'warning');
        log('‚ÑπÔ∏è To delete manually: Cloudflare Dashboard ‚Üí KV ‚Üí Delete keys starting with user:' + window.currentUser, 'warning');
      }
    };

    window.showClearAllDialog = function() {
      if (!confirm('‚ö†Ô∏è DELETE ALL DATA?\n\nThis will delete EVERYTHING from KV!\n\nAre you ABSOLUTELY sure?')) {
        return;
      }

      const confirmation = prompt('Type "DELETE ALL" to confirm:');
      if (confirmation !== 'DELETE ALL') {
        log('‚ùå Clear all cancelled', 'error');
        return;
      }

      log('üóëÔ∏è Clear all KV data request confirmed', 'warning');
      log('‚ö†Ô∏è Manual action required:', 'warning');
      log('1. Go to Cloudflare Dashboard', 'warning');
      log('2. Workers & Pages ‚Üí KV', 'warning');
      log('3. Select each namespace (USER_PRODUCTS, PRODUCT_STATUS, PRODUCTS)', 'warning');
      log('4. Delete all keys', 'warning');
    };

    window.checkWorker = async function() {
      // Prevent multiple simultaneous checks
      if (window.checkingWorker) {
        log('‚è≥ Worker check already in progress...', 'warning');
        return;
      }
      
      window.checkingWorker = true;
      const container = document.getElementById('worker-status');
      container.innerHTML = '<div class="spinner"></div>';
      log('üîå Checking worker status...', 'success');

      try {
        const startTime = Date.now();
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${window.WORKER_URL}/user-products?user=test`, {
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        const latency = Date.now() - startTime;
        
        container.innerHTML = `
          <div class="info-row"><span class="label">URL:</span><span class="value">${window.WORKER_URL}</span></div>
          <div class="info-row"><span class="label">Status:</span><span class="value"><span class="status ok">ONLINE</span></span></div>
          <div class="info-row"><span class="label">Latency:</span><span class="value">${latency}ms</span></div>
          <div class="info-row"><span class="label">Region:</span><span class="value">Cloudflare Edge</span></div>
        `;
        log('‚úÖ Worker is online and responding', 'success');
      } catch (error) {
        container.innerHTML = `
          <div class="info-row"><span class="label">Status:</span><span class="value"><span class="status error">OFFLINE</span></span></div>
          <div class="info-row"><span class="value" style="color: #f85149;">Error: ${error.message}</span></div>
        `;
        log(`‚ùå Worker is offline: ${error.message}`, 'error');
      } finally {
        window.checkingWorker = false;
      }
    };

    function updateMetrics(success, latency) {
      window.metrics.calls++;
      if (success) window.metrics.success++;
      else window.metrics.errors++;
      window.metrics.latencies.push(latency);
      
      const avgLatency = Math.round(window.metrics.latencies.reduce((a,b) => a+b, 0) / window.metrics.latencies.length);
      
      document.getElementById('metric-calls').textContent = window.metrics.calls;
      document.getElementById('metric-success').textContent = window.metrics.success;
      document.getElementById('metric-errors').textContent = window.metrics.errors;
      document.getElementById('metric-latency').textContent = avgLatency + 'ms';
    }

    window.resetMetrics = function() {
      window.metrics = { calls: 0, success: 0, errors: 0, latencies: [] };
      document.getElementById('metric-calls').textContent = '0';
      document.getElementById('metric-success').textContent = '0';
      document.getElementById('metric-errors').textContent = '0';
      document.getElementById('metric-latency').textContent = '0ms';
      log('üîÑ Metrics reset', 'success');
    };

    window.clearLog = function() {
      document.getElementById('debug-log').innerHTML = '<div class="log-entry success">üóëÔ∏è Log cleared</div>';
    };

    window.downloadLog = function() {
      const logContent = document.getElementById('debug-log').innerText;
      const blob = new Blob([logContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `debug-log-${Date.now()}.txt`;
      a.click();
      log('üíæ Log downloaded', 'success');
    };

    function log(message, type = 'info') {
      const logContainer = document.getElementById('debug-log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      if (window.autoScroll) {
        logContainer.scrollTop = logContainer.scrollHeight;
      }
    }

    window.log = log;
  </script>
</body>
</html>
