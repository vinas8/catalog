<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß¨ Integrated Breeding Calculator - Serpent Town</title>
  <link rel="stylesheet" href="styles.css">
  
  <!-- Debug console (localhost or ?debug=1) -->
  <script src="../src/utils/debug-loader.js"></script>
  
  <style>
    /* Reset & Mobile-First Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .calculator-container {
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }

    .header {
      background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
      color: white;
      padding: 20px 15px;
      text-align: center;
      border-radius: 10px 10px 0 0;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .header h1 {
      font-size: 1.4em;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 0.9em;
      opacity: 0.95;
    }

    .calculator-section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      overflow: hidden;
      margin-bottom: 20px;
    }

    .section-header {
      background: #f7fafc;
      padding: 15px;
      border-bottom: 2px solid #e2e8f0;
    }

    .section-header h2 {
      margin: 0;
      font-size: 1.2em;
      color: #2d3748;
    }

    .section-header p {
      margin: 5px 0 0 0;
      color: #718096;
      font-size: 0.85em;
    }

    .section-body {
      padding: 15px;
    }

    /* Calculator UI - Mobile First */
    .morph-selector {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .parent-section {
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 15px;
    }

    .parent-section h3 {
      margin-top: 0;
      color: #2d3748;
      font-size: 1.1em;
      margin-bottom: 12px;
    }

    .morph-input-group {
      margin-bottom: 15px;
    }

    .morph-input-group label {
      display: block;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 5px;
      font-size: 0.9em;
    }

    .morph-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 40px;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: #f7fafc;
    }

    .morph-tag {
      background: #9333ea;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .morph-tag .remove {
      cursor: pointer;
      font-weight: bold;
      opacity: 0.8;
    }

    .morph-tag .remove:hover {
      opacity: 1;
    }

    .morph-autocomplete {
      position: relative;
    }

    .morph-autocomplete input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.95em;
    }

    .morph-autocomplete input:focus {
      outline: none;
      border-color: #9333ea;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #9333ea;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .autocomplete-dropdown.show {
      display: block;
    }

    .autocomplete-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #e2e8f0;
    }

    .autocomplete-item:hover {
      background: #f7fafc;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .morph-info {
      font-size: 0.8em;
      color: #718096;
      margin-left: 5px;
    }

    .calculate-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .calculate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(147, 51, 234, 0.4);
    }

    .calculate-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Results display */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .result-card {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 20px;
    }

    .result-card h4 {
      margin-top: 0;
      color: #2d3748;
      font-size: 1.1em;
      margin-bottom: 10px;
    }

    .outcome-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .outcome-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .outcome-item:last-child {
      border-bottom: none;
    }

    .outcome-morph {
      font-weight: 600;
      color: #2d3748;
    }

    .outcome-probability {
      color: #9333ea;
      font-weight: 600;
    }

    .outcome-value {
      color: #10b981;
      font-size: 0.9em;
    }

    .sync-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .sync-indicator.synced {
      background: #10b981;
    }

    .sync-indicator.unsynced {
      background: #ef4444;
    }

    .sync-indicator.partial {
      background: #f59e0b;
    }

    .db-match-info {
      font-size: 0.85em;
      color: #718096;
      margin-top: 15px;
      padding: 10px;
      background: #fff;
      border-left: 3px solid #9333ea;
      border-radius: 4px;
    }

    .compatibility-score {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, #9333ea20 0%, #7e22ce20 100%);
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .score-value {
      font-size: 3em;
      font-weight: bold;
      color: #9333ea;
      margin: 10px 0;
    }

    .score-grade {
      font-size: 1.5em;
      color: #2d3748;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .alert-danger {
      background: #fee;
      border-left: 4px solid #dc2626;
      color: #991b1b;
    }

    .alert-warning {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      color: #92400e;
    }

    .alert-info {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      color: #1e40af;
    }

    /* ========================================
       DESKTOP RESPONSIVE (min-width)
       ======================================== */
    
    /* Tablet and up */
    @media (min-width: 768px) {
      body {
        padding: 20px;
      }

      .header {
        padding: 30px;
        border-radius: 15px 15px 0 0;
      }

      .header h1 {
        font-size: 2em;
      }

      .header p {
        font-size: 1em;
      }

      .section-header {
        padding: 20px 30px;
      }

      .section-header h2 {
        font-size: 1.5em;
      }

      .section-body {
        padding: 30px;
      }

      /* Two columns on desktop */
      .morph-selector {
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .parent-section {
        padding: 20px;
      }

      .parent-section h3 {
        font-size: 1.2em;
        margin-bottom: 15px;
      }

      .calculator-section {
        border-radius: 15px;
        margin-bottom: 30px;
      }
    }

    /* Large desktop */
    @media (min-width: 1200px) {
      .header h1 {
        font-size: 2.5em;
      }

      .score-value {
        font-size: 3.5em;
      }
    }

    /* Button container */
    .button-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    /* Mobile overrides - only necessary adjustments */
    @media (max-width: 767px) {
      /* Input fields - prevent iOS zoom */
      input[type="text"] {
        font-size: 16px !important;
      }

      /* Stack buttons vertically on mobile */
      .button-group {
        flex-direction: column;
        gap: 10px;
      }

      /* Full width buttons */
      .calculate-btn,
      .demo-btn {
        width: 100% !important;
        flex: 1 1 auto !important;
      }

      /* Single column results */
      .results-grid {
        grid-template-columns: 1fr;
      }

      /* Compact autocomplete */
      .autocomplete-dropdown {
        max-height: 200px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 5px;
      }

      .header {
        padding: 15px 10px;
      }

      .header h1 {
        font-size: 1.3em;
      }

      .section-body {
        padding: 10px;
      }

      .parent-section {
        padding: 12px;
      }

      .score-value {
        font-size: 1.8em;
      }

      .score-grade {
        font-size: 1em;
      }

      .result-card h4 {
        font-size: 1em;
      }

      .outcome-item {
        flex-direction: column;
        gap: 5px;
        padding: 10px 0;
      }

      .outcome-morph,
      .outcome-probability,
      .outcome-value {
        text-align: left;
      }
    }
  </style>
  <script>
    // Cache buster for Navigation component
    const urlParams = new URLSearchParams(window.location.search);
    const cacheBuster = urlParams.get('v') || urlParams.get('cb') || '0.8.0';
    const basePath = window.location.hostname.includes('github.io') ? '/catalog' : '';
    
    // Load Navigation with cache buster
    import(`${basePath}/src/components/Navigation.js?v=${cacheBuster}`).then(module => {
      console.log('‚úÖ Navigation loaded v' + cacheBuster);
    }).catch(err => {
      console.warn('Navigation load failed:', err);
    });
  </script>
</head>
<body>

  <div class="calculator-container">
    <div class="header">
      <h1>üß¨ Ball Python Breeding Calculator</h1>
      <p>Advanced genetics analysis with market values, health risks, and breeding compatibility</p>
    </div>

    <!-- Info Banner -->
    <div class="calculator-section">
      <div class="section-body">
        <div class="alert alert-info">
          <strong>üìö Genetics Database:</strong> 70+ morphs with lethal combo detection, health risk assessment, and market analysis.
          <br><strong>üîó Reference:</strong> Data verified against <a href="https://www.morphmarket.com/c/reptiles/pythons/ball-pythons/genetic-calculator/" target="_blank" style="color: #667eea; text-decoration: underline;">MorphMarket</a> and <a href="https://www.worldofballpythons.com/" target="_blank" style="color: #667eea; text-decoration: underline;">World of Ball Pythons</a>
        </div>
      </div>
    </div>

    <!-- Serpent Town Calculator Section -->
    <div class="calculator-section">
      <div class="section-header">
        <h2>üêç Serpent Town Advanced Genetics</h2>
        <p style="margin: 5px 0 0 0; color: #718096; font-size: 0.9em;">
          Enhanced analysis with market values, health risks, and breeding compatibility
        </p>
        <div style="font-size: 0.85em; color: #718096; margin-top: 8px;">
          <span id="data-status">Loading genetics database...</span>
        </div>
      </div>
      <div class="section-body">
        <!-- Morph Selection -->
        <div class="morph-selector">
          <!-- Male Parent -->
          <div class="parent-section">
            <h3>‚ôÇ Male Parent</h3>
            <div class="morph-input-group">
              <label>Select Morphs:</label>
              <div id="male-morphs" class="morph-tags"></div>
              <div class="morph-autocomplete">
                <input 
                  type="text" 
                  id="male-morph-input" 
                  placeholder="Type morph name..."
                  autocomplete="off"
                >
                <div id="male-autocomplete" class="autocomplete-dropdown"></div>
              </div>
            </div>
          </div>

          <!-- Female Parent -->
          <div class="parent-section">
            <h3>‚ôÄ Female Parent</h3>
            <div class="morph-input-group">
              <label>Select Morphs:</label>
              <div id="female-morphs" class="morph-tags"></div>
              <div class="morph-autocomplete">
                <input 
                  type="text" 
                  id="female-morph-input" 
                  placeholder="Type morph name..."
                  autocomplete="off"
                >
                <div id="female-autocomplete" class="autocomplete-dropdown"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button id="calculate-btn" class="calculate-btn" style="flex: 1;">
            üß¨ Calculate Breeding
          </button>
          <button id="demo-btn" class="calculate-btn" style="flex: 0 0 auto; min-width: 140px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            üé¨ Demo
          </button>
        </div>

        <!-- Results Section -->
        <div id="results-container" style="display: none; margin-top: 30px;">
          <!-- Compatibility Score -->
          <div class="compatibility-score">
            <div style="font-size: 1.1em; color: #718096;">Breeding Compatibility</div>
            <div id="score-value" class="score-value">--</div>
            <div id="score-grade" class="score-grade">--</div>
          </div>

          <!-- Alerts -->
          <div id="alerts-container"></div>

          <!-- Results Grid -->
          <div class="results-grid">
            <!-- Offspring Outcomes -->
            <div class="result-card">
              <h4>ü•ö Expected Offspring</h4>
              <ul id="offspring-list" class="outcome-list"></ul>
            </div>

            <!-- Genetic Metrics -->
            <div class="result-card">
              <h4>üß¨ Genetic Analysis</h4>
              <ul id="genetics-list" class="outcome-list"></ul>
            </div>

            <!-- Market Analysis -->
            <div class="result-card">
              <h4>üí∞ Market Value</h4>
              <ul id="market-list" class="outcome-list"></ul>
            </div>

            <!-- Health Assessment -->
            <div class="result-card">
              <h4>‚öïÔ∏è Health Assessment</h4>
              <ul id="health-list" class="outcome-list"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Cache buster - use URL param if provided, otherwise use version
    const urlParams = new URLSearchParams(window.location.search);
    const cacheBuster = urlParams.get('v') || urlParams.get('cb') || '0.8.0';
    
    // Fix path for GitHub Pages
    const basePath = window.location.hostname.includes('github.io') ? '/catalog' : '';
    
    // Set global base path for genetics-core to use
    window.APP_BASE_PATH = basePath;
    
    // Load state management
    const { markProgress } = await import(`${basePath}/src/core/state.js?v=${cacheBuster}`);
    
    const {
      loadGeneticsDatabase,
      calculateCompatibility,
      calculateOffspring,
      getMorphValue,
      checkLethalCombo,
      assessHealthRisk,
      calculateInbreedingCoefficient,
      calculateGeneticDiversity,
      calculateHeterozygosity
    } = await import(`${basePath}/src/modules/breeding/genetics-core.js?v=${cacheBuster}`);

    let morphDatabase = [];
    let selectedMaleMorphs = [];
    let selectedFemaleMorphs = [];

    async function init() {
      console.log('üß¨ Initializing breeding calculator v' + cacheBuster + '...');
      console.log('üìÇ Base path:', basePath || '(root)');
      
      const statusEl = document.getElementById('data-status');
      
      try {
        // Load comprehensive genetics database (66+ morphs)
        console.log('üìö Loading comprehensive morph database...');
        const result = await loadGeneticsDatabase(true); // Load comprehensive v3.0
        
        if (result && result.morphs) {
          morphDatabase = result.morphs;
          console.log(`‚úÖ Genetics database loaded: ${morphDatabase.length} morphs (v${result.version})`);
          console.log(`   First morph: ${morphDatabase[0]?.name}`);
          console.log(`   Sample IDs: ${morphDatabase.slice(0, 3).map(m => m.id).join(', ')}`);
          statusEl.innerHTML = `‚úÖ <strong>${morphDatabase.length} morphs</strong> loaded ‚Ä¢ <a href="${basePath}/data/genetics/" style="color: #667eea; text-decoration: underline;">v${result.version || '3.0.0'}</a>`;
          
          // Setup autocomplete ONLY after database loads
          console.log('üîß Setting up autocomplete...');
          setupAutocomplete('male');
          setupAutocomplete('female');
          console.log('‚úÖ Autocomplete ready');
        } else {
          console.error('‚ùå Failed to load genetics database - result:', result);
          statusEl.innerHTML = `‚ùå Failed to load genetics database. Check console for details.`;
          return; // Don't setup autocomplete if database failed
        }
      } catch (err) {
        console.error('‚ùå Error loading genetics:', err);
        statusEl.innerHTML = `‚ùå Error: ${err.message}`;
        return; // Don't setup autocomplete on error
      }

      // Setup calculate button
      document.getElementById('calculate-btn').addEventListener('click', calculateResults);
      
      // Setup demo button
      document.getElementById('demo-btn').addEventListener('click', loadDemo);

      // Try to listen for iframe changes (limited by CORS)
      setupIframeSyncListener();
      
      // Check for URL params and auto-load
      await loadFromURLParams();
    }

    function setupAutocomplete(parent) {
      const input = document.getElementById(`${parent}-morph-input`);
      const dropdown = document.getElementById(`${parent}-autocomplete`);
      const tagsContainer = document.getElementById(`${parent}-morphs`);

      console.log(`üîß setupAutocomplete(${parent}): morphDatabase has ${morphDatabase.length} morphs`);

      input.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        
        console.log(`üîç ${parent} search: "${query}" (database: ${morphDatabase.length} morphs)`);
        
        if (query.length < 2) {
          dropdown.classList.remove('show');
          return;
        }

        const matches = morphDatabase.filter(m => 
          m.name.toLowerCase().includes(query) ||
          m.aliases?.some(a => a.toLowerCase().includes(query))
        );

        console.log(`   Found ${matches.length} matches`);

        if (matches.length === 0) {
          dropdown.innerHTML = '<div class="autocomplete-item">No morphs found</div>';
          dropdown.classList.add('show');
          return;
        }

        dropdown.innerHTML = matches.map(m => `
          <div class="autocomplete-item" data-morph-id="${m.id}">
            <strong>${m.name}</strong>
            <span class="morph-info">
              ${m.gene_type} | $${m.market_value_usd || 'N/A'}
              ${m.health_risk !== 'none' ? ` | ‚ö†Ô∏è ${m.health_risk}` : ''}
            </span>
          </div>
        `).join('');

        dropdown.classList.add('show');

        // Add click handlers
        dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
          item.addEventListener('click', () => {
            const morphId = item.dataset.morphId;
            if (morphId) {
              console.log(`‚úÖ Selected ${parent}: ${morphId}`);
              addMorph(parent, morphId);
              input.value = '';
              dropdown.classList.remove('show');
            }
          });
        });
      });

      // Close dropdown on outside click
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove('show');
        }
      });
    }

    function addMorph(parent, morphId) {
      const morphArray = parent === 'male' ? selectedMaleMorphs : selectedFemaleMorphs;
      
      if (morphArray.includes(morphId)) {
        return; // Already added
      }

      morphArray.push(morphId);
      renderMorphTags(parent);
      updateSyncStatus();
    }

    function removeMorph(parent, morphId) {
      const morphArray = parent === 'male' ? selectedMaleMorphs : selectedFemaleMorphs;
      const index = morphArray.indexOf(morphId);
      
      if (index > -1) {
        morphArray.splice(index, 1);
        renderMorphTags(parent);
        updateSyncStatus();
      }
    }

    function renderMorphTags(parent) {
      const morphArray = parent === 'male' ? selectedMaleMorphs : selectedFemaleMorphs;
      const container = document.getElementById(`${parent}-morphs`);

      if (morphArray.length === 0) {
        container.innerHTML = '<span style="color: #a0aec0; font-size: 0.9em;">No morphs selected</span>';
        return;
      }

      container.innerHTML = morphArray.map(id => {
        const morph = morphDatabase.find(m => m.id === id);
        if (!morph) return '';

        return `
          <div class="morph-tag">
            ${morph.name}
            <span class="remove" onclick="window.removeMorph('${parent}', '${id}')">√ó</span>
          </div>
        `;
      }).join('');
    }

    function updateSyncStatus() {
      const statusDiv = document.getElementById('sync-status');
      const maleCount = selectedMaleMorphs.length;
      const femaleCount = selectedFemaleMorphs.length;

      const maleMatched = selectedMaleMorphs.filter(id => 
        morphDatabase.find(m => m.id === id)
      ).length;

      const femaleMatched = selectedFemaleMorphs.filter(id => 
        morphDatabase.find(m => m.id === id)
      ).length;

      statusDiv.innerHTML = `
        <div>
          ‚ôÇ Male: ${maleCount} morphs selected (${maleMatched}/${maleCount} in database)
        </div>
        <div style="margin-top: 5px;">
          ‚ôÄ Female: ${femaleCount} morphs selected (${femaleMatched}/${femaleCount} in database)
        </div>
      `;
    }

    function setupIframeSyncListener() {
      // Note: Due to CORS, we can't directly access iframe content
      // This would require MorphMarket to implement postMessage API
      
      window.addEventListener('message', (event) => {
        // Check if message is from MorphMarket iframe
        if (event.origin !== 'https://www.morphmarket.com') return;

        try {
          const data = JSON.parse(event.data);
          
          if (data.type === 'morph_selected') {
            syncMorphFromIframe(data.parent, data.morphName);
          }
        } catch (err) {
          console.log('Message parsing failed:', err);
        }
      });
    }

    function syncMorphFromIframe(parent, morphName) {
      // Try to match morph name to our database
      const morph = morphDatabase.find(m => 
        m.name.toLowerCase() === morphName.toLowerCase() ||
        m.aliases?.some(a => a.toLowerCase() === morphName.toLowerCase())
      );

      if (morph) {
        addMorph(parent, morph.id);
        console.log(`‚úÖ Synced ${morphName} to ${parent}`);
      } else {
        console.warn(`‚ö†Ô∏è Morph not found in database: ${morphName}`);
      }
    }

    async function calculateResults() {
      if (selectedMaleMorphs.length === 0 || selectedFemaleMorphs.length === 0) {
        alert('‚ö†Ô∏è Please select morphs for both male and female parents');
        return;
      }

      console.log('üß¨ Calculating breeding results...');

      // Create snake objects for calculation
      const male = {
        name: 'Male',
        morphs: selectedMaleMorphs.map(id => morphDatabase.find(m => m.id === id)?.name).filter(Boolean),
        age: 3, // Default values
        weight: 1800,
        sex: 'male'
      };

      const female = {
        name: 'Female',
        morphs: selectedFemaleMorphs.map(id => morphDatabase.find(m => m.id === id)?.name).filter(Boolean),
        age: 3,
        weight: 1700,
        sex: 'female'
      };

      console.log('üìä Parents:', { male: male.morphs.join(' + '), female: female.morphs.join(' + ') });

      // Calculate compatibility
      const compatibility = calculateCompatibility(male, female);
      const offspring = calculateOffspring(male, female);
      const healthRisk = assessHealthRisk(male, female);
      const lethalCheck = checkLethalCombo(male.morphs, female.morphs);

      console.log('‚úÖ Calculation complete:', {
        score: compatibility.score,
        offspring: offspring.outcomes?.length || 0,
        lethal: lethalCheck?.lethal || false
      });

      // Display results
      displayResults(compatibility, offspring, healthRisk, lethalCheck, male, female);
    }

    function displayResults(compatibility, offspring, healthRisk, lethalCheck, male, female) {
      const resultsContainer = document.getElementById('results-container');
      const scoreValue = document.getElementById('score-value');
      const scoreGrade = document.getElementById('score-grade');
      const alertsContainer = document.getElementById('alerts-container');

      // Show results
      resultsContainer.style.display = 'block';

      // Compatibility score
      scoreValue.textContent = compatibility.score;
      const grade = compatibility.score >= 90 ? 'A+ Excellent' :
                    compatibility.score >= 70 ? 'B Good' :
                    compatibility.score >= 50 ? 'C Acceptable' :
                    compatibility.score >= 30 ? 'D Poor' : 'F Not Recommended';
      scoreGrade.textContent = grade;

      // Alerts
      alertsContainer.innerHTML = '';
      
      if (lethalCheck && lethalCheck.lethal) {
        alertsContainer.innerHTML += `
          <div class="alert alert-danger">
            <strong>‚ö†Ô∏è LETHAL COMBINATION:</strong> ${lethalCheck.reason}
          </div>
        `;
      }

      if (healthRisk && healthRisk.risk !== 'none') {
        alertsContainer.innerHTML += `
          <div class="alert alert-warning">
            <strong>‚öïÔ∏è Health Risk:</strong> ${healthRisk.risk.toUpperCase()} - ${healthRisk.issues?.join(', ')}
          </div>
        `;
      }

      // Offspring outcomes
      const offspringList = document.getElementById('offspring-list');
      if (offspring && offspring.length > 0) {
        offspringList.innerHTML = offspring.map(o => `
          <li class="outcome-item" style="flex-direction: column; align-items: flex-start; padding: 12px;">
            <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 6px;">
              <span class="outcome-morph" style="font-weight: 600; ${o.warning ? 'color: #dc2626;' : ''}">${o.morph}</span>
              <span>
                <span class="outcome-probability" style="font-weight: 600;">${o.percentage}%</span>
                ${o.value > 0 ? `<span class="outcome-value" style="margin-left: 8px;">$${o.value}</span>` : ''}
              </span>
            </div>
            ${o.description ? `<div style="font-size: 0.85em; color: #64748b; margin-top: 4px;">${o.description}</div>` : ''}
            ${o.geneType ? `<div style="font-size: 0.75em; color: #94a3b8; margin-top: 2px;"><em>${o.geneType}</em>${o.rarity ? ` ‚Ä¢ ${o.rarity}` : ''}</div>` : ''}
          </li>
        `).join('');
      } else {
        offspringList.innerHTML = '<li class="outcome-item">No data available</li>';
      }

      // Genetic metrics
      const geneticsList = document.getElementById('genetics-list');
      const diversity = calculateGeneticDiversity(male, female);
      const heterozygosity = calculateHeterozygosity(male, female);
      const coi = calculateInbreedingCoefficient(male, female);

      geneticsList.innerHTML = `
        <li class="outcome-item">
          <span>Genetic Diversity</span>
          <span class="outcome-probability">${diversity}%</span>
        </li>
        <li class="outcome-item">
          <span>Heterozygosity</span>
          <span class="outcome-probability">${heterozygosity}%</span>
        </li>
        <li class="outcome-item">
          <span>Inbreeding (CoI)</span>
          <span class="outcome-probability">${coi}%</span>
        </li>
      `;

      // Market analysis
      const marketList = document.getElementById('market-list');
      const avgValue = offspring?.reduce((sum, o) => sum + (o.value * o.percentage / 100), 0) || 0;
      const maxValue = Math.max(...(offspring?.map(o => o.value) || [0]));
      const minValue = Math.min(...(offspring?.filter(o => o.value > 0).map(o => o.value) || [50]));
      const totalPotential = offspring?.reduce((sum, o) => sum + o.value, 0) || 0;
      const clutchSize = 4; // Average ball python clutch
      
      marketList.innerHTML = `
        <li class="outcome-item">
          <span>Avg. Offspring Value</span>
          <span class="outcome-value">$${Math.round(avgValue)}</span>
        </li>
        <li class="outcome-item">
          <span>Expected Clutch Value</span>
          <span class="outcome-value" style="font-weight: 600; color: #9333ea;">$${Math.round(avgValue * clutchSize)}</span>
        </li>
        <li class="outcome-item">
          <span>Value Range</span>
          <span class="outcome-value">$${minValue} - $${maxValue}</span>
        </li>
        <li class="outcome-item">
          <span>Profitability</span>
          <span class="outcome-probability" style="color: ${avgValue > 300 ? '#10b981' : avgValue > 150 ? '#f59e0b' : '#dc2626'}; font-weight: 600;">
            ${avgValue > 300 ? 'üî• High' : avgValue > 150 ? 'üìà Medium' : 'üìâ Low'}
          </span>
        </li>
        <li class="outcome-item" style="border-top: 1px solid #e2e8f0; margin-top: 8px; padding-top: 8px;">
          <span style="font-size: 0.85em; color: #64748b;">Best Outcome</span>
          <span style="font-size: 0.85em; color: #9333ea; font-weight: 600;">
            ${offspring?.find(o => o.value === maxValue)?.morph || 'N/A'}
          </span>
        </li>
      `;

      // Health assessment
      const healthList = document.getElementById('health-list');
      const riskColor = healthRisk?.risk === 'high' ? '#dc2626' : 
                       healthRisk?.risk === 'moderate' ? '#f59e0b' : 
                       healthRisk?.risk === 'low' ? '#fbbf24' : '#10b981';
      
      healthList.innerHTML = `
        <li class="outcome-item" style="flex-direction: column; align-items: flex-start;">
          <div style="display: flex; justify-content: space-between; width: 100%;">
            <span>Risk Level</span>
            <span style="color: ${riskColor}; font-weight: 600;">
              ${healthRisk?.risk?.toUpperCase() || 'NONE'}
            </span>
          </div>
        </li>
        <li class="outcome-item">
          <span>Compatibility</span>
          <span class="outcome-probability">${grade}</span>
        </li>
        <li class="outcome-item">
          <span>Recommendation</span>
          <span style="color: ${compatibility.score >= 70 ? '#10b981' : '#dc2626'}; font-weight: 600;">
            ${compatibility.score >= 70 ? '‚úÖ Breed' : '‚ùå Avoid'}
          </span>
        </li>
        ${healthRisk?.issues && healthRisk.issues.length > 0 && healthRisk.issues[0] !== 'No known health issues' ? `
          <li class="outcome-item" style="flex-direction: column; align-items: flex-start; border-top: 1px solid #e2e8f0; margin-top: 8px; padding-top: 8px;">
            <span style="font-weight: 600; margin-bottom: 6px;">‚öïÔ∏è Health Issues:</span>
            ${healthRisk.issues.map(issue => `
              <div style="font-size: 0.85em; color: #64748b; margin-left: 8px; margin-bottom: 4px;">‚Ä¢ ${issue}</div>
            `).join('')}
          </li>
        ` : ''}
      `;
          </span>
        </li>
      `;

      // Scroll to results
      resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Load morphs from URL parameters
    async function loadFromURLParams() {
      const male = urlParams.get('male');
      const female = urlParams.get('female');
      
      if (!male && !female) {
        console.log('‚ÑπÔ∏è No URL params found');
        return;
      }
      
      console.log('üîó Loading from URL params:', { male, female });
      
      // Clear existing
      selectedMaleMorphs = [];
      selectedFemaleMorphs = [];
      
      // Parse male morphs (comma-separated)
      if (male) {
        const maleIds = male.split(',').map(id => id.trim().toLowerCase());
        maleIds.forEach(id => {
          const morph = morphDatabase.find(m => m.id === id || m.name.toLowerCase() === id);
          if (morph) {
            selectedMaleMorphs.push(morph.id);
          }
        });
      }
      
      // Parse female morphs (comma-separated)
      if (female) {
        const femaleIds = female.split(',').map(id => id.trim().toLowerCase());
        femaleIds.forEach(id => {
          const morph = morphDatabase.find(m => m.id === id || m.name.toLowerCase() === id);
          if (morph) {
            selectedFemaleMorphs.push(morph.id);
          }
        });
      }
      
      // Render tags
      renderMorphTags('male');
      renderMorphTags('female');
      updateSyncStatus();
      
      // Auto-calculate if we have at least one morph selected
      if (selectedMaleMorphs.length > 0 || selectedFemaleMorphs.length > 0) {
        console.log('üé¨ Auto-calculating from URL params...');
        setTimeout(() => {
          calculateResults();
          
          // Mark calculator progress
          markProgress('calculator');
        }, 500);
      }
    }
    
    // Demo mode
    function loadDemo() {
      console.log('üé¨ Loading demo breeding pair...');
      
      // Clear existing
      selectedMaleMorphs = [];
      selectedFemaleMorphs = [];
      
      // Find popular morphs for demo
      const banana = morphDatabase.find(m => m.name.toLowerCase().includes('banana'));
      const pastel = morphDatabase.find(m => m.name.toLowerCase().includes('pastel'));
      const piebald = morphDatabase.find(m => m.name.toLowerCase().includes('piebald'));
      const fire = morphDatabase.find(m => m.name.toLowerCase().includes('fire'));
      
      // Male: Banana Pastel (if available, otherwise just Banana)
      if (banana) selectedMaleMorphs.push(banana.id);
      if (pastel) selectedMaleMorphs.push(pastel.id);
      
      // Female: Piebald (or Fire if not available)
      if (piebald) {
        selectedFemaleMorphs.push(piebald.id);
      } else if (fire) {
        selectedFemaleMorphs.push(fire.id);
      }
      
      // Fallback to first available morphs if nothing found
      if (selectedMaleMorphs.length === 0 && morphDatabase.length > 0) {
        selectedMaleMorphs.push(morphDatabase[0].id);
      }
      if (selectedFemaleMorphs.length === 0 && morphDatabase.length > 1) {
        selectedFemaleMorphs.push(morphDatabase[1].id);
      }
      
      renderMorphTags('male');
      renderMorphTags('female');
      updateSyncStatus();
      
      // Auto-calculate and scroll to results
      setTimeout(() => {
        calculateResults();
        
        // Scroll to results smoothly
        setTimeout(() => {
          const resultsContainer = document.getElementById('results-container');
          if (resultsContainer) {
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 300);
      }, 500);
    }

    // Expose functions to global scope for inline handlers
    window.removeMorph = removeMorph;

    // Initialize
    init();
  </script>
</body>
</html>
