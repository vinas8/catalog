#!/bin/bash
# Test first purchase flow after data cleaning

echo "üß™ Testing First Purchase Flow After Data Cleaning"
echo "=================================================="
echo ""

echo "1Ô∏è‚É£ Simulating data cleanup..."
# This simulates what happens when user clears browser data
echo "   - Clearing localStorage"
echo "   - Clearing sessionStorage"
echo ""

echo "2Ô∏è‚É£ User visits catalog.html..."
echo "   ‚úÖ getUserHash() creates new hash"
echo "   ‚úÖ Hash stored in localStorage"
echo "   Hash format: [timestamp_base36][random_base36]"
echo "   Example: m2x9k7p4q8n3r5t1"
echo ""

echo "3Ô∏è‚É£ User clicks 'Buy Now'..."
echo "   ‚úÖ Hash saved to multiple locations:"
echo "      - localStorage.serpent_user_hash"
echo "      - localStorage.serpent_pending_purchase_hash"
echo "      - localStorage.serpent_last_purchase_hash"
echo "      - sessionStorage.serpent_purchase_hash"
echo "   ‚úÖ client_reference_id added to Stripe URL"
echo ""

echo "4Ô∏è‚É£ Stripe checkout & payment..."
echo "   ‚Üí User enters payment info"
echo "   ‚Üí Stripe processes payment"
echo "   ‚Üí client_reference_id = user_hash (preserved)"
echo ""

echo "5Ô∏è‚É£ Stripe webhook to worker..."
echo "   ‚Üí POST /stripe-webhook"
echo "   ‚Üí Extracts client_reference_id from session"
echo "   ‚Üí Saves to KV: user:{hash} ‚Üí [product]"
echo "   ‚ö†Ô∏è  CRITICAL: Hash MUST match"
echo ""

echo "6Ô∏è‚É£ User returns to success.html..."
echo "   ‚úÖ Checks localStorage for hash"
echo "   ‚úÖ Checks sessionStorage for hash (NEW!)"
echo "   ‚úÖ Polls worker for snake (20 attempts)"
echo ""

echo "7Ô∏è‚É£ If snake found..."
echo "   ‚úÖ Redirect to register.html"
echo "   ‚úÖ User creates account"
echo "   ‚úÖ Snake appears in game"
echo ""

echo "8Ô∏è‚É£ If snake NOT found (timeout)..."
echo "   ‚ö†Ô∏è  Fallback activated (NEW FIX!):"
echo "   ‚úÖ Generate/use existing hash"
echo "   ‚úÖ Redirect to register.html?timeout=true"
echo "   ‚úÖ Show warning message"
echo "   ‚úÖ Snake will appear once webhook processes"
echo ""

echo "=================================================="
echo "üîç FIXES APPLIED:"
echo "=================================================="
echo ""
echo "‚úÖ catalog.html:"
echo "   - Added sessionStorage.serpent_purchase_hash"
echo "   - Added console logging for debugging"
echo "   - Save hash to 4 different locations"
echo ""
echo "‚úÖ success.html:"
echo "   - Check sessionStorage as fallback"
echo "   - Better error messages"
echo "   - Timeout fallback ‚Üí redirect to register anyway"
echo "   - Pass timeout=true flag"
echo ""
echo "‚úÖ register.html:"
echo "   - Detect timeout=true flag"
echo "   - Show warning banner"
echo "   - Explain snake will appear soon"
echo ""

echo "=================================================="
echo "üß™ TEST SCENARIOS:"
echo "=================================================="
echo ""
echo "Scenario A: Normal flow (webhook fast)"
echo "   1. User buys snake"
echo "   2. Webhook processes in 2 seconds"
echo "   3. success.html finds snake"
echo "   4. Redirect to register.html"
echo "   5. ‚úÖ SUCCESS"
echo ""
echo "Scenario B: Slow webhook (10-20 seconds)"
echo "   1. User buys snake"
echo "   2. Webhook delayed"
echo "   3. success.html polls 20 times (20 seconds)"
echo "   4. Eventually finds snake"
echo "   5. ‚úÖ SUCCESS"
echo ""
echo "Scenario C: Very slow webhook (>20 seconds) [NEW FIX]"
echo "   1. User buys snake"
echo "   2. Webhook very delayed"
echo "   3. success.html times out after 20 seconds"
echo "   4. Fallback: redirect to register.html?timeout=true"
echo "   5. User registers account"
echo "   6. Snake appears later when webhook completes"
echo "   7. ‚úÖ SUCCESS (with delay)"
echo ""
echo "Scenario D: Hash mismatch [FIXED BY MULTIPLE STORAGE]"
echo "   1. User buys snake"
echo "   2. localStorage cleared during redirect"
echo "   3. success.html checks sessionStorage"
echo "   4. Hash recovered!"
echo "   5. ‚úÖ SUCCESS"
echo ""

echo "=================================================="
echo "üí° DEBUGGING TIPS:"
echo "=================================================="
echo ""
echo "If 'customer not found' error occurs:"
echo ""
echo "1. Check browser console in success.html:"
echo "   - Look for 'üîç Full hash check' log"
echo "   - Verify hash exists in storage"
echo ""
echo "2. Check Cloudflare Worker logs:"
echo "   - Did webhook receive client_reference_id?"
echo "   - Was data saved to correct KV key?"
echo ""
echo "3. Check Stripe dashboard:"
echo "   - View session details"
echo "   - Verify client_reference_id was passed"
echo ""
echo "4. Manual fix:"
echo "   - Note the hash from console"
echo "   - Open register.html?user_hash=YOUR_HASH"
echo "   - Register account manually"
echo ""

echo "=================================================="
echo "‚úÖ FIX COMPLETE - READY TO TEST"
echo "=================================================="
