<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêç Snake Dex - Serpent Town</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    /* SPDX-FileCopyrightText: 2024-2026 vinas8 (Serpent Town) */
    /* SPDX-License-Identifier: MIT */
    /* UI patterns inspired by PokeRogue (AGPL-3.0) - see /CREDITS.md */
    
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Monaco', 'Courier New', monospace;
      color: #fff;
      min-height: 100vh;
    }
    .dex-container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
    
    /* Header - PokeRogue style */
    .dex-header { 
      text-align: center; 
      margin-bottom: 2rem; 
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .dex-header h1 { 
      font-size: 3rem; 
      margin-bottom: 0.5rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
    .dex-stats { 
      display: flex; 
      gap: 3rem; 
      justify-content: center; 
      margin-top: 1.5rem; 
    }
    .dex-stat { text-align: center; }
    .dex-stat-value { 
      font-size: 2.5rem; 
      font-weight: bold; 
      color: #ffd700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
    .dex-stat-label { 
      color: rgba(255, 255, 255, 0.8); 
      font-size: 0.9rem; 
    }
    
    /* Search Bar - PokeRogue style */
    .dex-search {
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
    }
    .search-input {
      flex: 1;
      padding: 0.8rem 1.2rem;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      color: #fff;
      font-size: 1rem;
      backdrop-filter: blur(10px);
    }
    .search-input::placeholder { color: rgba(255, 255, 255, 0.5); }
    .search-input:focus { 
      outline: none; 
      border-color: #ffd700; 
      background: rgba(255, 255, 255, 0.15);
    }
    
    /* Filters - PokeRogue style */
    .dex-filters { 
      display: flex; 
      gap: 0.8rem; 
      margin-bottom: 2rem; 
      flex-wrap: wrap; 
    }
    .filter-btn { 
      padding: 0.7rem 1.4rem; 
      border: 2px solid rgba(255, 255, 255, 0.3); 
      background: rgba(255, 255, 255, 0.1); 
      border-radius: 8px; 
      cursor: pointer; 
      transition: all 0.2s;
      color: #fff;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }
    .filter-btn:hover { 
      border-color: #ffd700; 
      background: rgba(255, 215, 0, 0.2);
    }
    .filter-btn.active { 
      background: #ffd700; 
      border-color: #ffd700; 
      color: #000;
    }
    
    /* Grid - PokeRogue 9-column pattern */
    .dex-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
      gap: 1rem; 
      margin-bottom: 3rem; 
    }
    
    /* Card - Compact Pokedex style */
    .dex-card { 
      background: rgba(255, 255, 255, 0.1); 
      border: 2px solid rgba(255, 255, 255, 0.2); 
      border-radius: 10px; 
      padding: 1rem; 
      transition: all 0.3s; 
      cursor: pointer; 
      position: relative;
      backdrop-filter: blur(10px);
      text-align: center;
    }
    .dex-card:hover { 
      transform: translateY(-4px); 
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); 
      border-color: #ffd700; 
      background: rgba(255, 255, 255, 0.15);
    }
    .dex-card.owned { 
      border-color: #ffd700; 
      background: rgba(255, 215, 0, 0.15);
    }
    .dex-card.owned::before { 
      content: "‚úì"; 
      position: absolute; 
      top: 4px; 
      right: 4px; 
      background: #ffd700; 
      color: #000; 
      width: 20px;
      height: 20px;
      border-radius: 50%; 
      font-size: 0.7rem; 
      font-weight: bold; 
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .dex-number {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 0.3rem;
    }
    .snake-emoji { 
      font-size: 3rem; 
      margin-bottom: 0.5rem; 
    }
    .snake-name { 
      font-size: 0.9rem; 
      font-weight: bold; 
      margin-bottom: 0.3rem; 
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }
    .snake-species { 
      color: rgba(255, 255, 255, 0.7); 
      font-size: 0.75rem; 
      margin-bottom: 0.5rem;
      font-style: italic;
    }
    .snake-price {
      font-size: 0.85rem;
      color: #ffd700;
      font-weight: bold;
    }
    .rarity-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
      margin-top: 0.3rem;
    }
    .rarity-common { background: #6c757d; }
    .rarity-uncommon { background: #28a745; }
    .rarity-rare { background: #007bff; }
    .rarity-legendary { background: #ffd700; color: #000; }
  </style>
</head>
<body>
  <div class="dex-container">
    <div class="dex-header">
      <h1>üêç Snake Dex</h1>
      <p style="color: rgba(255,255,255,0.8); font-size: 1.1rem;">Gotta Catch 'Em All!</p>
      
      <div class="dex-stats">
        <div class="dex-stat">
          <div class="dex-stat-value" id="owned-count">0</div>
          <div class="dex-stat-label">Owned</div>
        </div>
        <div class="dex-stat">
          <div class="dex-stat-value" id="total-count">0</div>
          <div class="dex-stat-label">Discovered</div>
        </div>
        <div class="dex-stat">
          <div class="dex-stat-value" id="completion-rate">0%</div>
          <div class="dex-stat-label">Completion</div>
        </div>
      </div>
    </div>

    <!-- Search Bar (PokeRogue pattern) -->
    <div class="dex-search">
      <input 
        type="text" 
        id="search-input" 
        class="search-input" 
        placeholder="üîç Search snakes by name or morph..."
      >
    </div>

    <!-- Filters (PokeRogue pattern) -->
    <div class="dex-filters">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="owned">Owned</button>
      <button class="filter-btn" data-filter="common">Common</button>
      <button class="filter-btn" data-filter="uncommon">Uncommon</button>
      <button class="filter-btn" data-filter="rare">Rare</button>
      <button class="filter-btn" data-filter="ball_python">Ball Pythons</button>
      <button class="filter-btn" data-filter="corn_snake">Corn Snakes</button>
    </div>

    <div id="dex-grid" class="dex-grid">
      <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
        <p style="color: rgba(255,255,255,0.7);">Loading snake dex...</p>
      </div>
    </div>
  </div>

  <script type="module">
    // SPDX-FileCopyrightText: 2024-2026 vinas8 (Serpent Town)
    // SPDX-License-Identifier: MIT
    // UI patterns inspired by PokeRogue (AGPL-3.0) - see /CREDITS.md
    
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    let allProducts = [];
    let userProducts = [];
    let currentFilter = 'all';
    let searchQuery = '';

    const getUserHash = () => {
      const hash = window.location.hash.substring(1);
      if (hash) return hash;
      return localStorage.getItem('serpent_user_hash') || localStorage.getItem('serpent_last_purchase_hash') || null;
    };

    async function loadAllProducts() {
      try {
        const response = await fetch(`${WORKER_URL}/products`);
        const data = await response.json();
        allProducts = data.products || [];
        console.log('üì¶ Loaded products from worker:', allProducts.length);
      } catch (error) {
        console.error('Error loading products:', error);
        allProducts = [];
      }
    }

    async function loadUserProducts() {
      const userHash = getUserHash();
      if (!userHash) return;
      try {
        const response = await fetch(`${WORKER_URL}/user-products?user=${userHash}`);
        const data = await response.json();
        userProducts = Array.isArray(data) ? data : (data.products || []);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function isOwned(productId) {
      return userProducts.some(p => p.product_id === productId);
    }

    function getRarity(product) {
      if (product.price >= 300) return 'rare';
      if (product.price >= 150) return 'uncommon';
      return 'common';
    }

    function filterProducts() {
      let filtered = allProducts;

      // Search filter
      if (searchQuery) {
        filtered = filtered.filter(p => 
          p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
          p.morph.toLowerCase().includes(searchQuery.toLowerCase()) ||
          p.species.toLowerCase().includes(searchQuery.toLowerCase())
        );
      }

      // Category filter
      if (currentFilter === 'owned') {
        filtered = filtered.filter(p => isOwned(p.id));
      } else if (currentFilter === 'common' || currentFilter === 'uncommon' || currentFilter === 'rare') {
        filtered = filtered.filter(p => getRarity(p) === currentFilter);
      } else if (currentFilter === 'ball_python' || currentFilter === 'corn_snake') {
        filtered = filtered.filter(p => p.species === currentFilter);
      }

      return filtered;
    }

    function renderDex() {
      const grid = document.getElementById('dex-grid');
      const filtered = filterProducts();

      if (filtered.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
            <p style="color: rgba(255,255,255,0.7); font-size: 1.2rem;">No snakes found üò¢</p>
            <p style="color: rgba(255,255,255,0.5); margin-top: 0.5rem;">Try a different filter or search term</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = filtered.map((product, index) => {
        const owned = isOwned(product.id);
        const rarity = getRarity(product);
        return `
          <div class="dex-card ${owned ? 'owned' : ''}" data-product-id="${product.id}">
            <div class="dex-number">#${String(index + 1).padStart(3, '0')}</div>
            <div class="snake-emoji">üêç</div>
            <div class="snake-name">${product.morph}</div>
            <div class="snake-species">${product.species.replace('_', ' ')}</div>
            <div class="rarity-badge rarity-${rarity}">${rarity.toUpperCase()}</div>
            <div class="snake-price">‚Ç¨${product.price}</div>
          </div>
        `;
      }).join('');

      // Update stats
      const ownedCount = allProducts.filter(p => isOwned(p.id)).length;
      const totalCount = allProducts.length;
      const completionRate = totalCount > 0 ? Math.round((ownedCount / totalCount) * 100) : 0;

      document.getElementById('owned-count').textContent = ownedCount;
      document.getElementById('total-count').textContent = filtered.length;
      document.getElementById('completion-rate').textContent = `${completionRate}%`;

      // Add click handlers
      document.querySelectorAll('.dex-card').forEach(card => {
        card.addEventListener('click', () => {
          const productId = card.dataset.productId;
          window.location.href = `/catalog.html#${productId}`;
        });
      });
    }

    // Search functionality
    document.getElementById('search-input').addEventListener('input', (e) => {
      searchQuery = e.target.value;
      renderDex();
    });

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderDex();
      });
    });

    async function init() {
      await loadAllProducts();
      await loadUserProducts();
      renderDex();
    }

    init();
  </script>
</body>
</html>
