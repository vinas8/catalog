<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy Snakes Online - Serpent Town</title>
  <meta name="description" content="Buy ball pythons and corn snakes online. Safe shipping, captive bred, quality guaranteed.">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="game-header">
    <div class="header-left">
      <h1>üêç Serpent Town</h1>
      <p class="tagline">Buy Snakes Online</p>
    </div>
    <nav class="main-nav">
      <a href="index.html">Home</a>
      <a href="catalog.html" class="active">Shop Snakes</a>
      <a href="game.html">Care Game</a>
    </nav>
  </header>

  <main style="padding: 2rem;">
    <div class="view-header">
      <h2>Buy Ball Pythons & Corn Snakes Online</h2>
      <p class="muted">All snakes are captive bred and shipped safely via certified carriers</p>
    </div>

    <div class="catalog-filters">
      <select id="species-filter">
        <option value="all">All Species</option>
        <option value="ball_python">Ball Python</option>
        <option value="corn_snake">Corn Snake</option>
      </select>
    </div>

    <div id="catalog-items" class="catalog-grid">
      <div class="loading">Loading snakes...</div>
    </div>
  </main>

  <script type="module">
    import { getProductsBySpecies } from './src/data/catalog.js';
    import { SPECIES_PROFILES } from './src/data/species-profiles.js';

    // Generate or get user hash for purchase tracking
    function getUserHash() {
      // Try to get existing hash from any of the possible keys
      let hash = localStorage.getItem('serpent_user_hash') || 
                 localStorage.getItem('serpent_last_purchase_hash') ||
                 localStorage.getItem('serpent_pending_purchase_hash');
      
      if (!hash) {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).substring(2, 15);
        hash = timestamp + random;
        // Store in multiple keys for compatibility
        localStorage.setItem('serpent_pending_purchase_hash', hash);
        localStorage.setItem('serpent_last_purchase_hash', hash);
      }
      return hash;
    }

    // Check if returning from successful payment
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      const notification = document.createElement('div');
      notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:1.5rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:9999;animation:slideIn 0.3s;';
      notification.innerHTML = '‚úÖ Payment successful! Thank you for your purchase!';
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
        // Clean URL
        window.history.replaceState({}, '', 'catalog.html');
      }, 5000);
    }

    async function renderCatalog() {
      const container = document.getElementById('catalog-items');
      const filter = document.getElementById('species-filter');
      const species = filter.value;

      container.innerHTML = '<div class="loading">Loading...</div>';

      try {
        const products = await getProductsBySpecies(species);

        if (products.length === 0) {
          container.innerHTML = '<div class="empty-state">No snakes available</div>';
          return;
        }

        const userHash = getUserHash();

        container.innerHTML = products.map(item => {
          // Append user hash to Stripe link as client_reference_id
          let checkoutUrl = item.stripe_link;
          if (checkoutUrl && checkoutUrl.includes('stripe.com')) {
            // Add client_reference_id parameter (Stripe will pass this back in webhook)
            checkoutUrl += `?client_reference_id=${userHash}&prefilled_email={CHECKOUT_SESSION_EMAIL}`;
          }

          return `
          <div class="catalog-item" itemscope itemtype="http://schema.org/Product">
            <div class="item-image">${item.image || 'üêç'}</div>
            <h3 itemprop="name">${item.name}</h3>
            <p class="species-info">${SPECIES_PROFILES[item.species]?.common_name || item.species} - ${item.morph}</p>
            <p itemprop="description">${item.description}</p>
            <p class="item-info">${item.info}</p>
            <div class="item-price" itemprop="offers" itemscope itemtype="http://schema.org/Offer">
              <span itemprop="price">$${item.price.toFixed(2)}</span>
              <meta itemprop="priceCurrency" content="USD">
            </div>
            <a href="${checkoutUrl}" target="_blank" class="primary-btn" rel="noopener" 
               onclick="localStorage.setItem('serpent_last_purchase_hash', '${userHash}'); localStorage.setItem('serpent_user_hash', '${userHash}'); console.log('Saved hash:', '${userHash}');">
              üí≥ Buy Now
            </a>
          </div>
        `;
        }).join('');
      } catch (error) {
        console.error('Error:', error);
        container.innerHTML = '<div class="error-state">Failed to load. Please refresh.</div>';
      }
    }

    // Initial load
    renderCatalog();

    // Filter change
    document.getElementById('species-filter').addEventListener('change', renderCatalog);
  </script>
</body>
</html>
