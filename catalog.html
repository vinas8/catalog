<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy Snakes Online - Serpent Town</title>
  <meta name="description" content="Buy ball pythons and corn snakes online. Safe shipping, captive bred, quality guaranteed.">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="game-header">
    <div class="header-left">
      <h1>üêç Serpent Town</h1>
      <p class="tagline">Buy Snakes Online</p>
    </div>
    <nav class="main-nav">
      <a href="index.html">Home</a>
      <a href="catalog.html" class="active">Shop Snakes</a>
      <a href="game.html">Care Game</a>
    </nav>
  </header>

  <main style="padding: 2rem;">
    <div class="view-header">
      <h2>Buy Ball Pythons & Corn Snakes Online</h2>
      <p class="muted">All snakes are captive bred and shipped safely via certified carriers</p>
    </div>

    <div class="catalog-filters">
      <select id="species-filter">
        <option value="all">All Species</option>
        <option value="ball_python">Ball Python</option>
        <option value="corn_snake">Corn Snake</option>
      </select>
    </div>

    <!-- Available Real Snakes -->
    <section class="catalog-section">
      <h3>üêç Available Snakes (Real Money)</h3>
      <div id="available-snakes" class="catalog-grid">
        <div class="loading">Loading...</div>
        <!-- Buy Now buttons rendered dynamically by catalog-renderer.js -->
      </div>
    </section>

    <!-- Virtual Snakes -->
    <section class="catalog-section">
      <h3>üí∞ Virtual Snakes (Gold Coins - In-Game)</h3>
      <p class="muted">Unlimited stock ‚Ä¢ Buy in game with gold</p>
      <div id="virtual-snakes" class="catalog-grid">
        <div class="loading">Loading...</div>
      </div>
    </section>

    <!-- Sold Snakes (Collapsed) -->
    <section class="catalog-section sold-section">
      <h3 id="sold-header" style="cursor: pointer; user-select: none;">
        üì¶ Sold Snakes <span id="sold-count">(0)</span> 
        <span id="sold-toggle" style="float: right;">‚ñº</span>
      </h3>
      <div id="sold-snakes" class="catalog-grid" style="display: none;">
        <div class="empty-state">No snakes sold yet</div>
      </div>
    </section>
  </main>

  <script type="module">
    import { renderStandaloneCatalog } from './src/modules/shop/ui/catalog-renderer.js';
    import { PAGE_URLS } from './src/config/worker-config.js';

    // Generate or get user hash for purchase tracking
    function getUserHash() {
      // Try to get existing hash from any of the possible keys
      let hash = localStorage.getItem('serpent_user_hash') || 
                 localStorage.getItem('serpent_last_purchase_hash') ||
                 localStorage.getItem('serpent_pending_purchase_hash');
      
      if (!hash) {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).substring(2, 15);
        hash = timestamp + random;
        // Store in multiple keys for compatibility
        localStorage.setItem('serpent_pending_purchase_hash', hash);
        localStorage.setItem('serpent_last_purchase_hash', hash);
      }
      return hash;
    }

    // Check if returning from successful payment
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      const notification = document.createElement('div');
      notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:1.5rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:9999;animation:slideIn 0.3s;';
      notification.innerHTML = '‚úÖ Payment successful! Thank you for your purchase!';
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
        // Clean URL
        window.history.replaceState({}, '', 'catalog.html');
      }, 5000);
    }

    async function renderCatalog() {
      const filter = document.getElementById('species-filter');
      const species = filter.value;
      
      // Use reusable catalog renderer
      await renderStandaloneCatalog(species, getUserHash);
    }

    // Toggle sold section
    document.getElementById('sold-header').addEventListener('click', () => {
      const soldSection = document.getElementById('sold-snakes');
      const toggle = document.getElementById('sold-toggle');
      if (soldSection.style.display === 'none') {
        soldSection.style.display = 'grid';
        toggle.textContent = '‚ñ≤';
      } else {
        soldSection.style.display = 'none';
        toggle.textContent = '‚ñº';
      }
    });

    // Initial load
    renderCatalog();

    // Filter change
    document.getElementById('species-filter').addEventListener('change', renderCatalog);
  </script>
</body>
</html>
