/**
 * Version Configuration - Single Source of Truth
 * s0.x.0 = "special one" versioning scheme
 * 
 * Format: s{major}.{module}.{patch}
 * - s = "special"
 * - major = 0 (current major version)
 * - module = feature/module version (any number)
 * - patch = bug fixes/minor updates
 */

export const VERSION_CONFIG = {
  // Current Version
  CURRENT: 's0.5.0',
  MAJOR: 0,
  MODULE: 5,
  PATCH: 0,
  
  // Version History
  HISTORY: [
    { version: 's0.1.0', date: '2024-01', description: 'Initial MVP - Basic shop and game' },
    { version: 's0.3.0', date: '2024-06', description: 'SMRI system, E2E tests' },
    { version: 's0.5.0', date: '2024-12', description: 'Production ready, full Cloudflare integration' }
  ],
  
  // Module Versions (s0.x.0 - track individual module versions)
  MODULES: {
    shop: 's0.5.0',           // Shop/catalog system
    game: 's0.5.0',           // Tamagotchi game mechanics
    payment: 's0.5.0',        // Stripe integration
    worker: 's0.5.0',         // Cloudflare Worker API
    auth: 's0.3.0',           // User authentication
    smri: 's0.3.0'            // SMRI test system
  },
  
  // SMRI Scenario Versions (S0 notation - uppercase S for SMRI)
  SMRI_SCENARIOS: {
    // === HEALTH CHECKS (S0.x.x format) ===
    debug_generic_health: 'S0.0.01',                   // Generic debug hub health check
    shop_health: 'S0-1.1.01',                          // Shop health (product rendering)
    game_health: 'S0-2.2.01',                          // Game health (mechanics)
    auth_health: 'S0-3.3.01',                          // Auth health (user validation)
    payment_health: 'S0-4.4.01',                       // Payment health (Stripe integration)
    worker_health: 'S0-5.5,5-1.01',                    // Worker health (API + KV)
    kv_health: 'S0-11.5-1.01',                         // KV storage health
    stripe_health: 'S0-12.5-2.01',                     // Stripe webhooks health
    system_health_check: 'S0.1,2,3,4,5,5-1,5-2.03',    // Full system (all modules) ✅ IMPLEMENTED
    
    // === P0 CRITICAL (13 scenarios) ===
    happy_path_purchase: 'S1.1,2,3,4,5.01',            // P0.0 - Shop → Game,Auth,Payment,Worker
    returning_user_purchase: 'S1.1,2,3,4.01',          // P0.1 - Returning user flow
    product_status_check: 'S1.1.01',                   // P0.2 - Product availability
    webhook_signature_verify: 'S5.5,5-1,5-2.01',       // P0.3 - Webhook security
    user_hash_validation: 'S3.3,5.01',                 // P0.4 - Auth validation
    product_schema_validation: 'S4.4,5.01',            // P0.5 - Payment schema
    load_game_from_kv: 'S5.2,5,5-1.01',                // P0.6 - Game cold start
    webhook_delayed: 'S4.4,5,5-2.02',                  // P0.8 - Timeout handling
    webhook_idempotency: 'S4.4,5,5-2.03',              // P0.9 - Duplicate prevention
    product_already_sold: 'S4.1,4,5.04',               // P0.10 - Race condition
    invalid_hash_rejection: 'S3.3,5.02',               // P0.11 - Security
    corrupted_kv_data: 'S5.5,5-1.01',                  // P0.12 - Data integrity
    
    // === P1 GAMEPLAY (9 scenarios) ===
    view_snake_stats: 'S2.2.01',                      // P1.0 - Stats display
    stats_decay_time: 'S2.2.02',                      // P1.1 - Hunger/thirst decay
    feed_action: 'S2.2.03',                           // P1.2 - Feed snake
    water_action: 'S2.2.04',                          // P1.3 - Water snake
    clean_enclosure: 'S2.2.05',                       // P1.4 - Clean habitat
    health_degradation: 'S2.2.06',                    // P1.5 - Health decrease
    auto_save_game_state: 'S2.5,5-1.01',              // P1.6 - Auto-save to KV
    buy_equipment_gold: 'S2.4.01',                    // P1.7 - Equipment shop
    cannot_buy_no_gold: 'S2.4.02',                    // P1.8 - Insufficient funds
    
    // === P2 IDENTITY (5 scenarios) ===
    register_after_purchase: 'S3.3,4.01',             // P2.0 - Username registration
    skip_registration: 'S3.3.01',                     // P2.1 - Anonymous play
    loyalty_points_earning: 'S3.3,4.02',              // P2.2 - Points system
    loyalty_tier_progression: 'S3.3.02',              // P2.3 - Tier upgrades
    loyalty_tier_items: 'S2.2,3.01',                  // P2.4 - Tier-locked equipment
    
    // === P3+ FEATURES (15 scenarios) ===
    demo_mode: 'S0.0.02',                              // P3.0 - Virtual snakes (disabled)
    data_cleanup: 'S0.0.03',                           // P3.1 - Storage cleanup
    network_failure_load: 'S5.2,5-1.02',              // P3.2 - Offline handling
    localstorage_deleted: 'S5.2.03',                  // P3.3 - State recovery
    xss_attempt_username: 'S3.3,5.03',                // P3.4 - XSS prevention
    csrf_webhook_attack: 'S4.4,5,5-2.05',             // P3.5 - CSRF protection
    product_sync_crud: 'S5.1,4,5-3.01',               // P3.6 - Stripe sync
    kv_consistency_check: 'S5.5,5-1.02',              // P3.7 - Data consistency
    load_100_products: 'S5.1,5-1.01',                 // P3.8 - Load testing
    game_20_snakes: 'S5.2,5-1.04',                    // P3.9 - Multi-snake game
    concurrent_webhooks: 'S5.4,5,5-2.02',             // P3.10 - Concurrency
    buy_5_different_snakes: 'S1.1,2.02',              // P3.11 - Multiple purchases
    buy_same_morph_twice: 'S1.1,2.03',                // P3.12 - Duplicate morphs
    payment_confirmation_email: 'S1.1,4.01',          // P3.13 - Email receipt
    sql_injection_attempt: 'S4.4,5.02',               // P3.14 - SQL injection block
    
    // === SPECIALIZED HEALTH CHECKS ===
    shop_health: 'S0-1.1.01',                         // Shop product rendering
    payment_health: 'S0-2.1.01',                      // Payment integration
    game_health: 'S0-4.1.01',                         // Game mechanics
    
    // === ALIASES (backwards compatibility) ===
    health_check: 'S0.1,2,3,4,5,5-1,5-2.03',          // Same as system_health_check
    shop_purchase: 'S1.1,2,3,4,5.01',                 // Same as happy_path_purchase
    
    // === METADATA ===
    TOTAL: 42,
    IMPLEMENTED: 1,
    COVERAGE: '88%',
    TESTS_PASSING: '69/71',
    
    // Module breakdown (by PRIMARY module number S{X}.x.x)
    BY_MODULE: {
      health: 7,    // S0.x - Health checks, diagnostics
      shop: 7,      // S1.x - Product catalog, purchases
      game: 10,     // S2.x - Tamagotchi mechanics
      auth: 7,      // S3.x - User authentication, loyalty
      payment: 6,   // S4.x - Stripe integration, webhooks
      worker: 10    // S5.x - Cloudflare Worker API, KV
    },
    
    // Priority breakdown
    BY_PRIORITY: {
      P0_critical: 13,
      P1_gameplay: 9,
      P2_identity: 5,
      P3_features: 15
    }
  },
  
  // API Versions
  API: {
    worker: 's0.5.0',         // Worker API version
    stripe: '2024-12-18',     // Stripe API version
    cloudflare: 'v4'          // Cloudflare API version
  },
  
  // Documentation Versions
  DOCS: {
    main: 'docs/s0.5.0.md',
    release: 'docs/RELEASE-s0.5.0.md',
    index: 'docs/INDEX.md',
    smri: '.smri'
  },
  
  // Build Info
  BUILD: {
    name: 'Serpent Town',
    codename: 'Special One',
    status: 'development',
    target: 'production'
  },
  
  // Compatibility
  COMPATIBILITY: {
    node: '>=18.0.0',
    browser: ['chrome', 'firefox', 'safari', 'edge'],
    cloudflare_workers: 'latest'
  }
};

// Helper functions
export function getVersion() {
  return VERSION_CONFIG.CURRENT;
}

export function getFullVersion() {
  return `${VERSION_CONFIG.BUILD.name} ${VERSION_CONFIG.CURRENT} (${VERSION_CONFIG.BUILD.codename})`;
}

export function getModuleVersion(moduleName) {
  return VERSION_CONFIG.MODULES[moduleName] || VERSION_CONFIG.CURRENT;
}

export function getSMRIScenario(scenarioName) {
  return VERSION_CONFIG.SMRI_SCENARIOS[scenarioName] || null;
}

export function isCompatibleVersion(requiredVersion) {
  // Simple semver-style comparison for s0.x.0 format
  const [, reqModule] = requiredVersion.match(/s0\.(\d+)\.(\d+)/) || [];
  const currentModule = VERSION_CONFIG.MODULE;
  return parseInt(reqModule) <= currentModule;
}

// Export individual values for convenience
export const VERSION = VERSION_CONFIG.CURRENT;
export const MODULE_VERSION = `s0.${VERSION_CONFIG.MODULE}.0`;
export const SMRI_TOTAL_SCENARIOS = VERSION_CONFIG.SMRI_SCENARIOS.TOTAL;

export default VERSION_CONFIG;
