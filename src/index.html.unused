<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Serpent Town — MVP</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; max-width:900px; margin:2rem auto; padding:0 1rem; color:#111;}
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;}
    .card { border:1px solid #e6e6e6; border-radius:8px; padding:12px; margin:8px 0; display:flex; gap:12px; align-items:center;}
    .thumb { width:64px; height:64px; background:#f3f3f3; display:flex; align-items:center; justify-content:center; border-radius:6px; }
    button { background:#0b6efd; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .muted { color:#666; font-size:0.9rem }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .stat { font-size:0.9rem; }
  </style>
</head>
<body>
  <header>
    <h1>Serpent Town</h1>
    <nav class="muted">Calm digital keeper — MVP</nav>
  </header>

  <main>
    <section id="hero">
      <h2>Care. Learn. Collect.</h2>
      <p class="muted">A calm digital keeper experience. Buy a snake, care for it through simple actions, and collect.</p>
    </section>

    <section>
      <h3>Catalog</h3>
      <div id="catalog"></div>
    </section>

    <section>
      <h3>Your Collection</h3>
      <div id="collection"></div>
    </section>

    <section>
      <h3>Inspect Pet</h3>
      <div id="inspector" class="muted">Select a pet from your collection.</div>
    </section>
  </main>

  <script type="module">
    import { ENTITY_TYPES, CARE_STATS } from './constants.js';
    import * as Core from './core.js';
    import snakesPlugin from './plugins/snakes.js';
    import tamagotchiPlugin from './plugins/tamagotchi.js';
    import dexPlugin from './plugins/dex.js';
    import shopPlugin from './plugins/shop.js';

    const PLUGINS = [snakesPlugin, tamagotchiPlugin, dexPlugin, shopPlugin];
    Core.loadPlugins(PLUGINS);

    // Minimal in-memory demo "user"
    const USER_EMAIL = 'demo@serpent.town';

    async function init() {
      const catalogEl = document.getElementById('catalog');
      const collectionEl = document.getElementById('collection');
      const inspectorEl = document.getElementById('inspector');

      // Build catalog from shop plugin data
      const shop = Core.getPluginById('shop');
      const snakes = Core.getPluginById('snakes');

      catalogEl.innerHTML = '';
      for (const item of shop.catalog) {
        const snakeDef = snakes.entities.find(s => s.id === item.product_id);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="thumb">${snakeDef.image ? '<img src="' + snakeDef.image + '" width="56" height="56" alt="" />' : ''}</div>
          <div style="flex:1">
            <div><strong>${snakeDef.name}</strong></div>
            <div class="muted">${snakeDef.description || ''}</div>
            <div class="muted">Price: ${item.price_text || '—'}</div>
          </div>
          <div>
            <a target="_blank" rel="noopener" href="${item.payment_link}"><button>Buy</button></a>
          </div>
        `;
        catalogEl.appendChild(card);
      }

      // Fetch collection from backend (Cloudflare Worker). For MVP demo: call /collection?user=<email>
      async function refreshCollection() {
        collectionEl.innerHTML = '';
        let owned = [];
        try {
          const resp = await fetch(`/collection?user=${encodeURIComponent(USER_EMAIL)}`);
          if (resp.ok) {
            owned = await resp.json();
          } else {
            // Worker not deployed — show demo fallback
            owned = Core.getDemoCollection(USER_EMAIL);
          }
        } catch (err) {
          owned = Core.getDemoCollection(USER_EMAIL);
        }

        if (owned.length === 0) {
          collectionEl.innerHTML = '<div class="muted">No pets yet. Buy one from the catalog.</div>';
        } else {
          for (const id of owned) {
            const def = snakes.entities.find(s => s.id === id) || { name: id };
            const pet = Core.createPetInstance(def, Core.getCareProfileForEntity(def));
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              <div class="thumb">${def.image ? '<img src="' + def.image + '" width="56" height="56" alt="" />' : ''}</div>
              <div style="flex:1">
                <div><strong>${def.name}</strong></div>
                <div class="stat">Hunger: <span data-stat="hunger">${pet.care.hunger}</span></div>
                <div class="stat">Clean: <span data-stat="clean">${pet.care.clean}</span></div>
              </div>
              <div>
                <button data-id="${def.id}" class="inspect-btn">Open</button>
              </div>
            `;
            collectionEl.appendChild(card);
          }
        }
      }

      catalogEl.addEventListener('click', e => { /* no-op */ });

      collectionEl.addEventListener('click', async (e) => {
        const btn = e.target.closest('button.inspect-btn');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        // For demo create a fresh instance
        const def = snakes.entities.find(s => s.id === id);
        const pet = Core.createPetInstance(def, Core.getCareProfileForEntity(def));
        inspectorEl.innerHTML = '';
        const node = document.createElement('div');
        node.className = 'card';
        node.innerHTML = `
          <div style="flex:1">
            <div><strong>${def.name}</strong></div>
            <div class="muted">${def.description || ''}</div>
            <div class="stat">Hunger: <span id="stat-hunger">${pet.care.hunger}</span></div>
            <div class="stat">Clean: <span id="stat-clean">${pet.care.clean}</span></div>
          </div>
          <div>
            <button id="feed">Feed</button>
            <button id="clean">Clean</button>
          </div>
        `;
        inspectorEl.appendChild(node);

        inspectorEl.querySelector('#feed').addEventListener('click', () => {
          Core.applyAction('feed', pet, Core.getCareProfileForEntity(def));
          inspectorEl.querySelector('#stat-hunger').textContent = pet.care.hunger;
        });
        inspectorEl.querySelector('#clean').addEventListener('click', () => {
          Core.applyAction('clean', pet, Core.getCareProfileForEntity(def));
          inspectorEl.querySelector('#stat-clean').textContent = pet.care.clean;
        });
      });

      // initial load
      await refreshCollection();
    }

    init();
  </script>
</body>
</html>
