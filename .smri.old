# SMRI System Manifest v2.1
# Single source of truth for SMRI notation and scenarios

---
version: 2.2
date: 2025-12-27
project: Serpent Town
app_version: 0.5.0
total_scenarios: 42
implemented: 2
test_coverage: 4.8%
tests_passing: 71/71 (unit)
debug_hub: /debug/test-scenarios.html
---

## NOTATION STANDARD v2.1

Format: S{M}.{RRR}.{II}

Components:
  S   = Scenario prefix
  M   = Primary module (1-6, lower = more important)
  RRR = Relations (comma-separated, includes ALL dependencies)
  II  = Instance number (01-99, zero-padded)

Module Priority (Lower = More Critical):
  1 = Shop      ‚Üí HIGHEST (revenue)
  2 = Game      ‚Üí HIGH (engagement)
  3 = Auth      ‚Üí MEDIUM (security)
  4 = Payment   ‚Üí HIGH (Stripe)
  5 = Worker    ‚Üí MEDIUM (infrastructure)
  6 = Common    ‚Üí LOW (utilities)

External Services (using 5-x notation):
  5-1 = Cloudflare KV
  5-2 = Stripe Webhooks
  5-3 = Stripe API
  5-4 = GitHub Pages

Notation Rules:
  - Commas (,) separate ALL dependencies (internal + external)
  - External services use hyphen notation (5-1, 5-2, etc.)
  - Primary module ALWAYS included in relations
  - List ALL touched systems in RRR

CORRECT Examples:
  S6.1,2,3,4,5,6,5-1,5-2.03   ‚Üí Health Check tests ALL (6 modules + KV + Stripe)
  S5.5,5-1,5-2.01             ‚Üí Worker + KV + Stripe Webhooks
  S1.1,5-1.01                 ‚Üí Shop + KV

WRONG Examples:
  S6.5-11.1-12.03   ‚ùå Missing internal modules
  S5.11.2-12.2.01   ‚ùå Old notation (11, 12 deprecated)

---

## üéØ BUSINESS RULES (Extracted from docs)

### Revenue Model
- Real snakes sold via Stripe (‚Ç¨80-‚Ç¨1000+)
- Virtual snakes = free (demo mode, currently disabled)
- Equipment shop uses in-game gold (earned through care)

### Purchase Flow
1. User visits catalog.html
2. System generates 32+ char user hash ‚Üí localStorage
3. Click "Buy Now" ‚Üí Stripe Checkout (client_reference_id={hash})
4. Payment complete ‚Üí Webhook fires
5. Worker validates signature ‚Üí writes to KV
6. User redirected ‚Üí success.html ‚Üí register ‚Üí game.html

### Ownership
- Snake assigned to user via Stripe webhook
- Stored in KV: USER_PRODUCTS namespace (user:{hash})
- Product marked sold in PRODUCT_STATUS (product:{id})
- Owner verification via Worker API: /user-products?user={hash}

### Product Status
- available = can buy
- sold = owned by someone, hidden from catalog
- KV is single source of truth (no local JSON in production)

### Data Sources
- Production: Cloudflare Worker API (/products)
- Development: Worker API + JSON fallback (offline only)
- DEPRECATED: data/products.json (not used)

---

## P0 CRITICAL SCENARIOS (13 total)

S1.1,2,3,4,5.01    | Happy Path Purchase           | P0.0 | Shop ‚Üí Game,Auth,Payment,Worker
S1.1,2,3,4.01      | Returning User Purchase        | P0.1 | Shop ‚Üí Game,Auth,Payment
S1.1.01            | Product Status Check           | P0.2 | Shop standalone
S5.5,5-1,5-2.01    | Webhook Signature Verify       | P0.3 | Worker + KV + Stripe
S3.3,5.01          | User Hash Validation           | P0.4 | Auth + Worker
S4.4,5.01          | Product Schema Validation      | P0.5 | Payment + Worker
S5.2,5,5-1.01      | Load Game from KV              | P0.6 | Worker + Game + KV
S6.1,2,3,4,5,6,5-1,5-2.03 | System Health Check     | P0.7 | ALL ‚úÖ
S4.4,5,5-2.02      | Webhook Delayed                | P0.8 | Payment + Worker + Stripe
S4.4,5,5-2.03      | Webhook Idempotency            | P0.9 | Payment + Worker + Stripe
S4.1,4,5.04        | Product Already Sold           | P0.10| Payment multi
S3.3,5.02          | Invalid Hash Rejection         | P0.11| Auth + Worker
S5.5,5-1.01        | Corrupted KV Data              | P0.12| Worker + KV

---

## P1 GAMEPLAY SCENARIOS (9 total)

S2.2.01            | View Snake Stats               | P1.0 | Game standalone
S2.2.02            | Stats Decay Over Time          | P1.1 | Game standalone
S2.2.03            | Feed Action                    | P1.2 | Game standalone
S2.2.04            | Water Action                   | P1.3 | Game standalone
S2.2.05            | Clean Enclosure                | P1.4 | Game standalone
S2.2.06            | Health Degradation             | P1.5 | Game standalone
S2.5,5-1.01        | Auto-Save Game State           | P1.6 | Game + Worker + KV
S2.4.01            | Buy Equipment with Gold        | P1.7 | Game + Payment
S2.4.02            | Cannot Buy Without Gold        | P1.8 | Game + Payment

---

## P2 IDENTITY SCENARIOS (5 total)

S3.3,4.01          | Register After Purchase        | P2.0 | Auth + Payment
S3.3.01            | Skip Registration              | P2.1 | Auth standalone
S3.3,4.02          | Loyalty Points Earning         | P2.2 | Auth + Payment
S3.3.02            | Loyalty Tier Progression       | P2.3 | Auth standalone
S2.2,3.01          | Loyalty Tier Required Items    | P2.4 | Game + Auth

---

## P3+ FEATURE SCENARIOS (15 total)

S6.6.01            | Demo Mode                      | P3.0 | Common standalone
S6.6.02            | Data Cleanup                   | P3.1 | Common standalone
S5.2,5-1.02        | Network Failure During Load    | P3.2 | Worker + Game + KV
S5.2.03            | localStorage Deleted           | P3.3 | Worker + Game
S3.3,5.03          | XSS Attempt via Username       | P3.4 | Auth + Worker
S4.4,5,5-2.05      | CSRF Attack on Webhook         | P3.5 | Payment + Worker + Stripe
S5.1,4,5-3.01      | Product Sync (CRUD)            | P3.6 | Worker + Payment + Stripe API
S5.5,5-1.02        | KV Consistency Check           | P3.7 | Worker + KV
S5.1,5-1.01        | Load 100 Products              | P3.8 | Worker + KV
S5.2,5-1.04        | Game with 20 Snakes            | P3.9 | Worker + Game + KV
S5.4,5,5-2.02      | Concurrent Webhook Processing  | P3.10| Payment + Worker + Stripe
S1.1,2.02          | Buy 5 Different Snakes         | P3.11| Shop + Game
S1.1,2.03          | Buy Same Morph Twice           | P3.12| Shop + Game
S1.1,4.01          | Payment Confirmation Email     | P3.13| Shop + Payment
S4.4,5.02          | SQL Injection Attempt          | P3.14| Payment + Worker

---

## DETAILED SCENARIO SPECS

### S6.1,2,3,4,5,6,5-1,5-2.03: System Health Check
Priority: P0.7 (CRITICAL)
Status: ‚úÖ IMPLEMENTED
Location: /debug/healthcheck.html
Test URL: https://vinas8.github.io/catalog/debug/healthcheck.html

Tests ALL systems:
  1 = Shop (product catalog display)
  2 = Game (game state, stats)
  3 = Auth (user hash)
  4 = Payment (Stripe links)
  5 = Worker (API connectivity)
  6 = Common (utilities)
  5-1 = Cloudflare KV (product count)
  5-2 = Stripe (webhook endpoints)

Flow:
  1. Auto-runs after 1s on /debug/healthcheck.html
  2. Pings Worker ‚Üí tests latency
  3. Calls /products ‚Üí counts items from KV (5-1)
  4. Verifies UI components (8 tabs/divs)
  5. Checks switchModule() function
  6. Tests LocalStorage
  7. Displays color-coded results

Business Value:
  - Reduces debug time from 10+ min to < 30 sec
  - Works in Termux/proot (no DevTools needed)
  - Catches issues immediately

Assertions:
  - Worker responds within 2s
  - /products returns valid JSON
  - KV contains > 0 products
  - UI has all required elements
  - localStorage read/write works

---

### S1.1,2,3,4,5.01: Happy Path Purchase
Priority: P0.0 (HIGHEST)
Status: üöß IN PROGRESS
Location: /smri/scenarios/S1.1,2,3,4,5.01.html
Test URL: https://vinas8.github.io/catalog/smri/scenarios/S1.1,2,3,4,5.01.html

Tests purchase flow across 5 modules:
  1 = Shop (catalog display, Stripe links)
  2 = Game (snake appears with stats)
  3 = Auth (hash generation, validation)
  4 = Payment (Stripe checkout, webhook)
  5 = Worker (webhook processing, KV writes)

External services used (implicit):
  5-1 = KV (stores user products, product status)
  5-2 = Stripe Webhooks (checkout.session.completed)

Flow (15 steps):
  1. Visit catalog.html
  2. Generate user hash (32+ chars) ‚Üí localStorage
  3. Click "Buy Now" Ball Python (‚Ç¨450)
  4. Stripe checkout opens (client_reference_id={hash})
  5. Complete payment
  6. Webhook fires ‚Üí POST /stripe-webhook
  7. Worker validates signature (5-2)
  8. Worker writes USER_PRODUCTS KV (5-1)
  9. Worker marks product sold in PRODUCT_STATUS (5-1)
  10. Redirect to success.html?session_id={ID}
  11. Success page polls /user-products (max 20 tries)
  12. Snake found ‚Üí show "Register Now"
  13. Click Register ‚Üí register.html
  14. Submit username ‚Üí Worker saves USERS KV
  15. Redirect to game.html ‚Üí snake appears!

Business Rules:
  - Hash persists across pages
  - Product disappears from catalog when sold
  - Snake has initial stats (hunger=100, health=100)
  - Webhook must complete within 20s

Assertions:
  assert(localStorage.getItem('serpent_last_purchase_hash') === userHash)
  assert(KV['user:' + userHash].length === 1)
  assert(KV['product:prod_xxx'].status === 'sold')
  assert(gameSnakes.length === 1)

---

### S1.1.01: Product Status Check
Priority: P0.2 (CRITICAL)
Status: ‚è≥ NOT IMPLEMENTED
Location: TBD /debug/scenarios/product-status.html

Tests:
  - Sold products hidden from catalog
  - Available products shown
  - KV status sync accuracy

Flow:
  1. Worker loads products from KV
  2. Filter by status: 'available'
  3. Hide products with status: 'sold'
  4. Verify UI shows only available items
  5. Attempt to access sold product URL ‚Üí show error

Business Rules:
  - Only 'available' products appear in catalog
  - Sold products return 404 or redirect
  - Status checked on every page load

Assertions:
  assert(catalog.filter(p => p.status === 'available').length === displayedProducts.length)
  assert(soldProduct.visible === false)
  assert(fetch('/products?status=sold').length === 0)

---

### S5.5,5-1,5-2.01: Webhook Signature Verify
Priority: P0.3 (CRITICAL)
Status: ‚è≥ NOT IMPLEMENTED
Location: TBD /debug/scenarios/webhook-signature.html

Tests:
  - Valid Stripe signature accepted
  - Invalid signature rejected
  - Missing signature rejected
  - Replay attack prevention

Flow:
  1. Simulate webhook POST to /stripe-webhook
  2. Include Stripe-Signature header
  3. Worker validates using STRIPE_WEBHOOK_SECRET
  4. Valid ‚Üí process event
  5. Invalid ‚Üí return 400 error

Business Rules:
  - All webhooks MUST have valid signature
  - Signature validation happens before processing
  - Failed validation logged but not processed

Assertions:
  assert(validWebhook.status === 200)
  assert(invalidWebhook.status === 400)
  assert(noSignatureWebhook.status === 400)
  assert(replayedWebhook.status === 400)

Test Vectors:
  - Valid signature: calculated using crypto.subtle.sign
  - Invalid signature: random string
  - Expired timestamp: > 5 minutes old
  - Replayed: same event_id twice

---

### S3.3,5.01: User Hash Validation
Priority: P0.4 (CRITICAL)
Status: ‚è≥ NOT IMPLEMENTED
Location: TBD /debug/scenarios/user-hash.html

Tests:
  - Hash generation (32+ chars)
  - Hash persistence (localStorage)
  - Hash validation format
  - Hash uniqueness

Flow:
  1. User visits catalog.html (no hash)
  2. Generate hash: crypto.randomUUID() or similar
  3. Store in localStorage: 'serpent_user_hash'
  4. Verify hash exists on page reload
  5. Use hash in Stripe checkout metadata

Business Rules:
  - Hash = 32-64 alphanumeric characters
  - Hash persists across sessions
  - Hash attached to all purchases
  - Invalid hash ‚Üí generate new one

Assertions:
  assert(userHash.length >= 32)
  assert(userHash.match(/^[a-zA-Z0-9-]+$/))
  assert(localStorage.getItem('serpent_user_hash') === userHash)
  assert(stripeMetadata.client_reference_id === userHash)

Edge Cases:
  - localStorage disabled ‚Üí use sessionStorage
  - Hash corrupted ‚Üí regenerate
  - Multiple tabs ‚Üí same hash

---

### S2.2.02: Stats Decay Over Time
Priority: P1.1 (HIGH)
Status: ‚è≥ NOT IMPLEMENTED
Location: TBD /debug/scenarios/stats-decay.html

Tests:
  - Hunger decreases by 2.0-2.5 per hour
  - Water decreases by 3.0 per hour
  - Cleanliness decreases by 1.0-1.5 per hour
  - Stats don't go below 0

Flow:
  1. Load snake with full stats (all = 100)
  2. Calculate time since last update
  3. Apply decay rates
  4. Update stats: stat = max(0, stat - (rate * hours))
  5. Save updated stats

Business Rules:
  - Decay only applies when game not open
  - 1x speed = real-time decay
  - 2x speed = double decay
  - Minimum stat value = 0

Decay Rates (per hour at 1x):
  - Hunger: -2.0 to -2.5 (species dependent)
  - Water: -3.0
  - Temperature: ¬±0.5 (toward ambient)
  - Humidity: -1.0
  - Cleanliness: -1.0 to -1.5
  - Health: -0 (doesn't decay directly)
  - Stress: +0.5 (increases when needs unmet)
  - Happiness: -1.0

Assertions:
  assert(afterOneHour.hunger === initial.hunger - 2.5)
  assert(afterTwoHours.water === initial.water - 6.0)
  assert(stats.all >= 0)

Test Vectors:
  - 0 hours passed ‚Üí no change
  - 1 hour passed ‚Üí apply decay
  - 24 hours passed ‚Üí multiple decay cycles
  - 1000 hours passed ‚Üí stats = 0 (capped)

---

### S2.4.01: Buy Equipment with Gold
Priority: P1.7 (HIGH)
Status: ‚è≥ NOT IMPLEMENTED
Location: TBD /debug/scenarios/equipment-purchase.html

Tests:
  - Purchase equipment with sufficient gold
  - Equipment added to inventory
  - Gold deducted correctly
  - Equipment persists after save/load

Flow:
  1. Player has 500 gold
  2. Open equipment shop
  3. Select "Auto-Feeder" (cost: 300 gold)
  4. Click "Buy"
  5. Gold reduced to 200
  6. Equipment added to inventory
  7. Save game state

Business Rules:
  - Equipment costs range: 50-2000 gold
  - Gold earned through snake care (10-50 per action)
  - Equipment effects apply immediately after install
  - Can own multiple equipment items

Equipment Examples:
  - Auto-Feeder (300g): Auto-feed every 6h
  - Water Dish (50g): Doubles water retention
  - Heat Lamp (150g): Maintains temperature
  - Misting System (400g): Auto-humidity control
  - UV Light (200g): Increases happiness

Assertions:
  assert(initialGold - equipmentCost === finalGold)
  assert(inventory.includes(equipment))
  assert(equipment.owned === true)
  assert(equipment.installed === false) // Not auto-installed

---

### S4.4,5,5-2.02: Webhook Delayed
Priority: P0.8 (CRITICAL)
Status: ‚è≥ NOT IMPLEMENTED
Location: TBD /debug/scenarios/webhook-delayed.html

Tests:
  - success.html polls /user-products
  - Polling interval: 2s
  - Max attempts: 20 (40s total)
  - Shows "Processing..." message
  - Eventually receives product

Flow:
  1. User completes payment
  2. Redirected to success.html?session_id=xxx
  3. Page immediately polls /user-products?user=hash
  4. Webhook not processed yet ‚Üí returns empty []
  5. Poll again after 2s ‚Üí repeat
  6. After 12s, webhook processes
  7. Next poll returns product
  8. Display success message + snake info

Business Rules:
  - Webhook should arrive within 5-10s normally
  - Polling handles delays up to 40s
  - After 40s ‚Üí show "Contact support" message
  - User can manually refresh to retry

Polling Logic:
  - Attempt 1-10: Show "Processing your purchase..."
  - Attempt 11-15: Show "Almost there..."
  - Attempt 16-20: Show "This is taking longer than expected..."
  - Attempt 20+: Show "Please contact support with session ID: {id}"

Assertions:
  assert(pollAttempts <= 20)
  assert(pollInterval === 2000ms)
  assert(eventuallyReceivesProduct === true)
  assert(userSeesFeedback === true)

---

### S4.4,5,5-2.03: Webhook Idempotency
Priority: P0.9 (CRITICAL)
Status: ‚è≥ NOT IMPLEMENTED
Location: TBD /debug/scenarios/webhook-idempotency.html

Tests:
  - Same webhook fires twice
  - Second webhook ignored
  - No duplicate products created
  - Idempotency key checked

Flow:
  1. Webhook arrives: event_id = 'evt_123'
  2. Worker checks KV for 'webhook:evt_123'
  3. Not found ‚Üí process webhook
  4. Save 'webhook:evt_123' = {processed: true, timestamp}
  5. Second webhook arrives: same event_id
  6. Found in KV ‚Üí return 200 (already processed)
  7. Do NOT create duplicate product

Business Rules:
  - Idempotency tracked by Stripe event_id
  - Processed events stored in KV for 7 days
  - Duplicate events return 200 (success) but don't process
  - Log duplicate attempts

Assertions:
  assert(firstWebhook.processed === true)
  assert(secondWebhook.processed === false) // Skipped
  assert(userProducts.length === 1) // Only one product
  assert(KV['webhook:evt_123'].exists === true)

Edge Cases:
  - Webhook arrives during processing ‚Üí queue
  - Different event_id, same session ‚Üí process both
  - Event_id cleanup after 7 days

---

## EXTERNAL SERVICE USAGE

### Cloudflare KV (5-1) - Used in 10+ scenarios
Primary storage for:
  - Products catalog (PRODUCTS namespace)
  - User purchases (USER_PRODUCTS namespace)
  - Product status (PRODUCT_STATUS namespace)
  - User profiles (USERS namespace)

Scenarios:
  S6.x.03 (Health Check) - product count
  S1.x.01 (Happy Path) - store purchase
  S5.x.01-12 (Worker tests) - KV operations
  S2.x.01 (Game) - load snakes from KV

### Stripe Webhooks (5-2) - Used in 5 scenarios
Events:
  - checkout.session.completed (primary)
  - payment_intent.succeeded (backup)

Scenarios:
  S5.5,5-1,5-2.01 (Webhook Sig) - signature validation
  S4.x.02-05 (Payment) - webhook processing
  S1.x.01 (Happy Path) - purchase completion

### Stripe API (5-3) - Used in 1 scenario
Operations:
  - Product sync (CRUD)
  - Price updates
  - Metadata management

Scenarios:
  S5.1,4,5-3.01 (Product Sync) - sync Stripe ‚Üí KV

---

## IMPLEMENTATION STATUS

Completed:
  ‚úÖ S6.1,2,3,4,5,6,5-1,5-2.03 - Health Check

In Progress:
  üöß S1.1,2,3,4,5.01 - Happy Path (page created)

Next Priority:
  1. Complete S1.1,2,3,4,5.01 automated test
  2. Implement S5.5,5-1,5-2.01 (Webhook Signature)
  3. Implement S1.1.01 (Product Status Check)

Test Coverage:
  - Unit: 71/71 (100%) ‚úÖ
  - E2E: 1/42 (2.4%)
  - Business logic: 88%

---

## RELATED FILES

Primary Docs (Keep):
  - /.smri                    ‚Üí This file (master)
  - /README.md                ‚Üí Project overview
  - /package.json             ‚Üí Version, dependencies

Implementation:
  - /smri/                    ‚Üí Web test suite
  - /debug.html               ‚Üí Health check
  - /src/                     ‚Üí Source code

Tests:
  - /tests/                   ‚Üí 71 passing tests

Archived (Reference Only):
  - docs/test/E2E_TEST_SCENARIOS.md.archive ‚Üí Migrated to .smri
  - docs/business/*.md        ‚Üí Business rules ‚Üí Consolidated here
  - docs/BUSINESS_FACTS*.md   ‚Üí Old business docs ‚Üí Consolidated here

To Remove:
  - docs/business/            ‚Üí Redundant (now in .smri)
  - docs/BUSINESS_FACTS*.md   ‚Üí Redundant (now in .smri)
  - docs/test/E2E_SCENARIOS_README.md ‚Üí Minimal redirect only

---

## CHANGE LOG

v2.1 (2025-12-23 10:55):
  - FIXED: External services now listed with commas
  - S6.1,2,3,4,5,6,5-1,5-2.03 (not S6.5-11.1-12.03)
  - Consolidated business rules from docs/business/*.md
  - Added business rules section
  - Updated all scenarios to include external services explicitly

v2.1 (2025-12-23 10:43):
  - Changed external notation from S11/S12 to S5-1/S5-2
  - External services as Worker sub-systems

v2.0 (2025-12-23):
  - Expanded notation (S1.1,2,3 not S1.234)
  - Lower number = higher priority

---

Last updated: 2025-12-23 10:55 UTC
Project: Serpent Town v0.5.0
All business rules and E2E scenarios consolidated here.
