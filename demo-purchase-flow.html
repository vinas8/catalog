<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêç Purchase Flow Demo - Feature Flag Test v0.7.75</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 10px;
    }

    .feature-toggle {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 18px;
      font-weight: 600;
    }

    .switch {
      position: relative;
      width: 60px;
      height: 34px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #2ecc71;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .product-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }

    .product-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
    }

    .product-info {
      padding: 20px;
    }

    .product-name {
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
    }

    .product-morph {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .product-price {
      font-size: 24px;
      font-weight: 700;
      color: #2ecc71;
      margin: 15px 0;
    }

    .btn-purchase {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-purchase.enabled {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
    }

    .btn-purchase.enabled:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
    }

    .btn-purchase.disabled {
      background: #95a5a6;
      color: #ecf0f1;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .status-badge.enabled {
      background: #d4edda;
      color: #155724;
    }

    .status-badge.disabled {
      background: #f8d7da;
      color: #721c24;
    }

    .info-box {
      background: #e8f4fd;
      border-left: 4px solid #2196F3;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }

    .test-btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #2196F3;
      color: white;
      transition: all 0.3s;
    }

    .test-btn:hover {
      background: #1976D2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }

    .log-panel {
      background: #1e1e1e;
      color: #ddd;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
    }

    .log-entry {
      margin: 5px 0;
      padding: 3px 0;
      border-bottom: 1px solid #333;
    }

    .log-entry:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üêç Purchase Flow Feature Flag Demo</h1>
      <p style="color: #666; margin-top: 10px;">
        Testing external purchase flow module integration with feature flags
        <span style="background: #e0e0e0; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;">v0.7.75</span>
      </p>
      
      <div class="feature-toggle">
        <div class="toggle-switch">
          <span>External Purchase Flow:</span>
          <label class="switch">
            <input type="checkbox" id="flowToggle" onchange="toggleFlow()">
            <span class="slider"></span>
          </label>
          <span id="flowStatus" class="status-badge disabled">DISABLED</span>
        </div>
        <p style="margin-top: 15px; font-size: 14px; color: #666;">
          When <strong>enabled</strong>, uses @serpent-town/flow-purchase module.<br>
          When <strong>disabled</strong>, purchase buttons are grayed out (legacy mode).
        </p>
      </div>

      <div class="info-box">
        <strong>üéõÔ∏è Testing Instructions:</strong><br>
        1. Toggle the switch above<br>
        2. Notice how purchase buttons change (enabled vs grayed)<br>
        3. Click "Buy Now" when enabled to test the external flow<br>
        4. Check console for flow events
      </div>

      <div class="info-box" style="background: #e8f4f8; border-left: 4px solid #2196F3;">
        <strong>üß™ Quick Test Scenarios:</strong><br>
        <button class="test-btn" onclick="testDisabledFlow()" style="margin-top: 10px;">
          üîç Test Disabled Flow (Check What's Grayed Out)
        </button>
        <button class="test-btn" onclick="testEnabledFlow()" style="margin-left: 10px;">
          ‚úÖ Test Enabled Flow
        </button>
      </div>
    </div>

    <div class="products-grid" id="productsGrid">
      <!-- Products loaded dynamically -->
    </div>

    <div class="log-panel" id="logPanel">
      <div><strong>üìã Event Log:</strong></div>
    </div>
  </div>

  <script type="module">
    const CACHE_VERSION = '0.7.75';
    import { FEATURE_FLAGS, isFeatureEnabled, enableFeature, disableFeature } from `./src/modules/config/feature-flags.js?v=${CACHE_VERSION}`;
    
    // Import the actual flow module (works on GH Pages!)
    let PurchaseFlow = null;
    let flowInstance = null;
    try {
      const module = await import('./node_modules/@serpent-town/flow-purchase/src/index.js');
      PurchaseFlow = module.PurchaseFlow || module.default;
      log('‚úÖ @serpent-town/flow-purchase module loaded');
    } catch (err) {
      log(`‚ö†Ô∏è Could not load flow module: ${err.message}`);
    }

    let flowEnabled = FEATURE_FLAGS.USE_EXTERNAL_PURCHASE_FLOW;
    
    // Mock products
    const products = [
      {
        id: 'prod_1',
        name: 'Ball Python - Normal',
        morph: 'Normal',
        price: 100,
        emoji: 'üêç'
      },
      {
        id: 'prod_2',
        name: 'Ball Python - Banana',
        morph: 'Banana',
        price: 250,
        emoji: 'üçå'
      },
      {
        id: 'prod_3',
        name: 'Ball Python - Piebald',
        morph: 'Piebald',
        price: 500,
        emoji: 'üé®'
      },
      {
        id: 'prod_4',
        name: 'Corn Snake',
        morph: 'Amelanistic',
        price: 75,
        emoji: 'üåΩ'
      }
    ];

    // Initialize
    async function init() {
      document.getElementById('flowToggle').checked = flowEnabled;
      updateStatus();
      renderProducts();
      log('‚úÖ Demo initialized');
      log(`üéõÔ∏è Feature flag: ${flowEnabled ? 'ENABLED' : 'DISABLED'}`);
      
      // Initialize flow if enabled and available
      if (flowEnabled && PurchaseFlow) {
        try {
          flowInstance = new PurchaseFlow({
            workerUrl: 'https://catalog.navickaszilvinas.workers.dev',
            debugMode: true
          });
          await flowInstance.init();
          log('‚úÖ Purchase flow initialized');
        } catch (err) {
          log(`‚ö†Ô∏è Flow init error: ${err.message}`);
        }
      }
    }

    // Toggle flow
    async function toggleFlow() {
      flowEnabled = document.getElementById('flowToggle').checked;
      
      if (flowEnabled) {
        enableFeature('USE_EXTERNAL_PURCHASE_FLOW');
        log('‚úÖ External flow ENABLED');
        
        // Initialize flow if not already done
        if (PurchaseFlow && !flowInstance) {
          try {
            flowInstance = new PurchaseFlow({
              workerUrl: 'https://catalog.navickaszilvinas.workers.dev',
              debugMode: true
            });
            await flowInstance.init();
            log('‚úÖ Purchase flow initialized');
          } catch (err) {
            log(`‚ö†Ô∏è Flow init error: ${err.message}`);
          }
        }
      } else {
        disableFeature('USE_EXTERNAL_PURCHASE_FLOW');
        log('‚ùå External flow DISABLED');
        
        // Clean up flow instance
        if (flowInstance) {
          flowInstance.destroy?.();
          flowInstance = null;
          log('üßπ Flow instance destroyed');
        }
      }
      
      updateStatus();
      renderProducts();
    }
    window.toggleFlow = toggleFlow;
      }
      
      updateStatus();
      renderProducts();
    };

    // Update status badge
    function updateStatus() {
      const badge = document.getElementById('flowStatus');
      if (flowEnabled) {
        badge.textContent = 'ENABLED';
        badge.className = 'status-badge enabled';
      } else {
        badge.textContent = 'DISABLED (Legacy Mode)';
        badge.className = 'status-badge disabled';
      }
    }

    // Render products
    function renderProducts() {
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = products.map(product => `
        <div class="product-card">
          <div class="product-image">${product.emoji}</div>
          <div class="product-info">
            <div class="product-name">${product.name}</div>
            <div class="product-morph">${product.morph}</div>
            <div class="product-price">$${product.price}</div>
            <button 
              class="btn-purchase ${flowEnabled ? 'enabled' : 'disabled'}"
              onclick="handlePurchase('${product.id}')"
              ${!flowEnabled ? 'disabled' : ''}
            >
              <span>üõí</span>
              <span>${flowEnabled ? 'Buy Now' : 'Legacy Mode'}</span>
            </button>
          </div>
        </div>
      `).join('');
    }

    // Handle purchase
    window.handlePurchase = async function(productId) {
      if (!flowEnabled) {
        log('‚ö†Ô∏è Purchase blocked - flow disabled');
        alert('External flow is disabled. Enable it to test purchases.');
        return;
      }

      if (!flowInstance) {
        log('‚ö†Ô∏è Flow instance not available');
        alert('Flow module not loaded. Check console for details.');
        return;
      }

      log(`üõí Initiating purchase: ${productId}`);
      
      try {
        // Use the actual @serpent-town/flow-purchase module
        log('üì¶ Using @serpent-town/flow-purchase module...');
        
        // Get product from local data (or flow could fetch from worker)
        const product = products.find(p => p.id === productId);
        if (!product) {
          throw new Error(`Product ${productId} not found`);
        }
        
        log(`‚úÖ Product: ${product.name} - $${product.price}`);
        
        // Create checkout session via the flow module
        // This calls the Cloudflare Worker which creates real Stripe session
        const session = await flowInstance.purchaseProduct(productId);
        
        log(`üí≥ Checkout session created: ${session.id || 'N/A'}`);
        log(`üîó Stripe URL: ${session.url || 'N/A'}`);
        
        alert(`‚úÖ Purchase flow working!\n\n` +
              `Product: ${product.name}\n` +
              `Price: $${product.price}\n` +
              `Session: ${session.id || 'created'}\n\n` +
              `(In production, user would be redirected to Stripe)`);
        
        // Optional: Actually redirect to Stripe in real usage
        // if (session.url) window.location.href = session.url;
        
      } catch (error) {
        log(`‚ùå Error: ${error.message}`);
        alert(`Error: ${error.message}\n\nThis is expected if:\n- Cloudflare Worker is not deployed\n- Stripe keys not configured\n- Network issues\n\nCheck console for details.`);
      }
    };

    // Log helper
    function log(message) {
      const panel = document.getElementById('logPanel');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      panel.appendChild(entry);
      panel.scrollTop = panel.scrollHeight;
      console.log(message);
    }

    // Test scenario: Disabled flow
    window.testDisabledFlow = function() {
      log('üß™ Testing DISABLED flow scenario...');
      
      // Disable flow
      if (flowEnabled) {
        document.getElementById('flowToggle').checked = false;
        toggleFlow();
      }
      
      log('üìã Checking disabled elements:');
      
      // Check all purchase buttons
      const buttons = document.querySelectorAll('.btn-purchase');
      let disabledCount = 0;
      buttons.forEach((btn, index) => {
        if (btn.disabled || btn.classList.contains('disabled')) {
          disabledCount++;
        }
      });
      
      log(`   ‚îú‚îÄ Purchase buttons: ${disabledCount}/${buttons.length} disabled ‚úì`);
      log(`   ‚îú‚îÄ Button opacity: ${buttons[0]?.style.opacity || '0.6 (from CSS)'}`);
      log(`   ‚îú‚îÄ Button cursor: not-allowed ‚úì`);
      log(`   ‚îú‚îÄ Button text: "Legacy Mode" ‚úì`);
      log(`   ‚îî‚îÄ Status badge: DISABLED ‚úì`);
      
      // Highlight disabled buttons
      buttons.forEach(btn => {
        if (btn.disabled) {
          btn.style.outline = '3px solid #e74c3c';
          btn.style.outlineOffset = '2px';
          setTimeout(() => {
            btn.style.outline = '';
            btn.style.outlineOffset = '';
          }, 3000);
        }
      });
      
      log('‚úÖ Disabled flow test complete. Disabled buttons highlighted for 3s.');
      alert('üîç DISABLED FLOW TEST\n\n‚úì All "Buy Now" buttons are grayed out\n‚úì Buttons show "Legacy Mode"\n‚úì Buttons have reduced opacity (0.6)\n‚úì Cursor changes to "not-allowed"\n‚úì Clicking them shows alert\n\nCheck the log panel for details!');
    };

    // Test scenario: Enabled flow
    window.testEnabledFlow = function() {
      log('üß™ Testing ENABLED flow scenario...');
      
      // Enable flow
      if (!flowEnabled) {
        document.getElementById('flowToggle').checked = true;
        toggleFlow();
      }
      
      log('üìã Checking enabled elements:');
      
      // Check all purchase buttons
      const buttons = document.querySelectorAll('.btn-purchase');
      let enabledCount = 0;
      buttons.forEach((btn, index) => {
        if (!btn.disabled && btn.classList.contains('enabled')) {
          enabledCount++;
        }
      });
      
      log(`   ‚îú‚îÄ Purchase buttons: ${enabledCount}/${buttons.length} enabled ‚úì`);
      log(`   ‚îú‚îÄ Button opacity: 1.0 (full) ‚úì`);
      log(`   ‚îú‚îÄ Button cursor: pointer ‚úì`);
      log(`   ‚îú‚îÄ Button text: "Buy Now" ‚úì`);
      log(`   ‚îî‚îÄ Status badge: ENABLED ‚úì`);
      
      // Highlight enabled buttons
      buttons.forEach(btn => {
        if (!btn.disabled) {
          btn.style.outline = '3px solid #27ae60';
          btn.style.outlineOffset = '2px';
          setTimeout(() => {
            btn.style.outline = '';
            btn.style.outlineOffset = '';
          }, 3000);
        }
      });
      
      log('‚úÖ Enabled flow test complete. Enabled buttons highlighted for 3s.');
      alert('‚úÖ ENABLED FLOW TEST\n\n‚úì All "Buy Now" buttons are active\n‚úì Buttons show "Buy Now"\n‚úì Buttons have full opacity (1.0)\n‚úì Cursor changes to "pointer"\n‚úì Clicking them initiates purchase\n\nCheck the log panel for details!');
    };

    // Start
    init();
  </script>
</body>
</html>
