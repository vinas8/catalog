# ğŸ“– Snake Muffin v0.5.0 - Technical Documentation

**Version:** 0.5.0  
**Status:** Minimal Viable Product (MVP)  
**Release Date:** 2025-12-26

---

## ğŸ¯ Overview

Snake Muffin v0.5.0 is the first production-ready version featuring:
- Complete purchase flow (Stripe â†’ Worker â†’ KV â†’ Frontend)
- Collection management
- Dynamic environment configuration
- Debug mode toggle
- KV-based product storage

---

## ğŸ—ï¸ Architecture

### System Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SNAKE MUFFIN v0.5.0                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend   â”‚â”€â”€â”€â–¶â”‚  Worker API     â”‚â”€â”€â”€â–¶â”‚  Cloudflare  â”‚
â”‚ GitHub Pages â”‚â—€â”€â”€â”€â”‚  (Backend)      â”‚â—€â”€â”€â”€â”‚     KV       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚                     
       â”‚                     â–¼                     
       â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    Stripe    â”‚               
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               
```

### Data Flow

1. **Purchase Flow:**
   ```
   User â†’ Catalog â†’ Stripe Checkout â†’ Payment â†’ Webhook â†’ Worker â†’ KV â†’ Collection
   ```

2. **Product Retrieval:**
   ```
   Frontend â†’ Worker API â†’ KV â†’ Product Data â†’ Display
   ```

---

## ğŸ“ File Structure

```
catalog/
â”œâ”€â”€ README.md                    # Project overview
â”œâ”€â”€ index.html                   # Landing page
â”œâ”€â”€ catalog.html                 # Product shop
â”œâ”€â”€ collection.html              # User collection
â”œâ”€â”€ game.html                    # Care game
â”œâ”€â”€ success.html                 # Post-purchase page
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ app-config.js       # ğŸ”§ Main config (DEBUG mode)
â”‚   â”‚   â”œâ”€â”€ worker-config.js    # Worker endpoints
â”‚   â”‚   â””â”€â”€ stripe-config.js    # Stripe settings
â”‚   â”‚
â”‚   â”œâ”€â”€ modules/                 # Game logic modules
â”‚   â”‚   â”œâ”€â”€ game/               # Care mechanics
â”‚   â”‚   â”œâ”€â”€ shop/               # Shopping logic
â”‚   â”‚   â””â”€â”€ auth/               # User authentication
â”‚   â”‚
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ logger.js           # ğŸ†• Debug-aware logging
â”‚
â”œâ”€â”€ worker/
â”‚   â”œâ”€â”€ worker.js               # Cloudflare Worker (backend)
â”‚   â””â”€â”€ wrangler.toml           # Worker configuration
â”‚
â””â”€â”€ docs/                        # Documentation
    â”œâ”€â”€ v0.5.0.md               # This file
    â”œâ”€â”€ CLOUDFLARE-DEPLOYMENT.md
    â”œâ”€â”€ STRIPE-SECRET-SETUP.md
    â””â”€â”€ WORKER-LOGS.md
```

---

## ğŸ”§ Configuration

### Debug Mode

**Location:** `src/config/app-config.js`

```javascript
export const APP_CONFIG = {
  // Debug mode - controls console logs and debug UI
  DEBUG: isLocalhost, // true in localhost, false in production
  
  // Environment
  ENVIRONMENT: isLocalhost ? 'local' : 'production',
  IS_LOCAL: isLocalhost,
  IS_GITHUB_PAGES: isGitHubPages,
  
  // Dynamic URLs
  BASE_URL: isLocalhost 
    ? `http://localhost:${port}`
    : 'https://vinas8.github.io/catalog'
};
```

**Usage:**

```javascript
import { logger } from './src/utils/logger.js';

// These only log when DEBUG is true
logger.log('Debug info');
logger.debug('Detailed debug');
logger.info('Information');

// These ALWAYS log
logger.warn('Warning message');
logger.error('Error message');
```

**Benefits:**
- Clean production console
- Easy debugging in development
- Performance optimization
- Better user experience

---

## ğŸ”Œ API Endpoints

### Worker API

**Base URL:** `https://catalog.navickaszilvinas.workers.dev`

#### 1. Get User Products
```
GET /user-products?user=<hash>
```

**Response:**
```json
[
  {
    "assignment_id": "assign_123456789",
    "user_id": "mjmo4b8nj57ieuxvnn",
    "product_id": "prod_TdKcnyjt5Jk0U2",
    "name": "Batman Ball",
    "species": "ball_python",
    "morph": "banana",
    "price_paid": 1000,
    "currency": "eur",
    "stats": {
      "hunger": 100,
      "water": 100,
      "health": 100
    }
  }
]
```

#### 2. Get Products Catalog
```
GET /products
```

**Response:**
```json
[
  {
    "id": "prod_TdKcnyjt5Jk0U2",
    "name": "Batman Ball",
    "species": "ball_python",
    "morph": "banana",
    "price": 1000,
    "stripe_link": "https://buy.stripe.com/..."
  }
]
```

#### 3. Stripe Webhook
```
POST /stripe-webhook
```

**Handles:** `checkout.session.completed` events

**Process:**
1. Verify webhook signature
2. Extract session data
3. Fetch product from KV
4. Create user assignment
5. Store in KV

#### 4. Session Info
```
GET /session-info?session_id=<id>
```

**Response:**
```json
{
  "client_reference_id": "user_hash",
  "amount_total": 1000,
  "currency": "eur",
  "customer_email": "user@example.com"
}
```

---

## ğŸ’¾ Data Storage (KV)

### KV Namespaces

1. **USER_PRODUCTS** (`3b88d32c0a0540a8b557c5fb698ff61a`)
   - Key: `user:<user_hash>`
   - Value: Array of product assignments

2. **PRODUCT_STATUS** (`57da5a83146147c8939e4070d4b4d4c1`)
   - Key: `product:<product_id>`
   - Value: Status object

3. **PRODUCTS** (`ecbcb79f3df64379863872965f993991`)
   - Key: `product:<product_id>`
   - Value: Product details

### Data Schema

**User Assignment:**
```json
{
  "assignment_id": "assign_1766741861024",
  "user_id": "mjmo4b8nj57ieuxvnn",
  "product_id": "prod_TdKcnyjt5Jk0U2",
  "name": "Batman Ball",
  "species": "ball_python",
  "morph": "banana",
  "acquired_at": "2025-12-26T08:27:46Z",
  "acquisition_type": "stripe_purchase",
  "payment_id": "cs_test_...",
  "price_paid": 1000,
  "currency": "eur",
  "stats": {
    "hunger": 100,
    "water": 100,
    "temperature": 80,
    "humidity": 50,
    "health": 100,
    "stress": 10,
    "cleanliness": 100,
    "happiness": 100
  }
}
```

---

## ğŸ” Security

### Secrets

Stored in Cloudflare (encrypted):
- `STRIPE_SECRET_KEY` - Stripe API key
- `CLOUDFLARE_API_TOKEN` - KV access
- `CLOUDFLARE_ACCOUNT_ID` - Account ID

### Best Practices

âœ… **Do:**
- Store secrets in Cloudflare
- Use environment variables
- Validate webhook signatures
- Sanitize user input

âŒ **Don't:**
- Commit secrets to git
- Hardcode API keys
- Expose internal IDs
- Trust client data

---

## ğŸš€ Deployment

### Automated (GitHub Actions)

**Trigger:** Push to `main` branch

**Workflow:**
```yaml
name: Deploy Cloudflare Worker
on:
  push:
    branches: [main]
    paths: ['worker/**']
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: cloudflare/wrangler-action@v3
        with:
          workingDirectory: 'worker'
```

### Manual Deployment

```bash
# Deploy worker
cd worker
wrangler publish

# Commit frontend changes
git add .
git commit -m "Update frontend"
git push origin main
# GitHub Pages auto-deploys
```

---

## ğŸ§ª Testing

### Manual Testing

1. **Purchase Flow:**
   ```
   1. Visit catalog
   2. Click "Buy Batman Ball"
   3. Complete Stripe checkout (test mode)
   4. Verify redirect to success page
   5. Check collection page
   ```

2. **API Testing:**
   ```bash
   # Test worker
   curl https://catalog.navickaszilvinas.workers.dev/version
   
   # Test user products
   curl "https://catalog.navickaszilvinas.workers.dev/user-products?user=<hash>"
   ```

### Debug Mode Testing

```javascript
// In browser console (localhost):
APP_CONFIG.DEBUG  // true

// In browser console (production):
APP_CONFIG.DEBUG  // false
```

---

## ğŸ“Š Current Limitations

### Known Issues

1. **Webhook Configuration**
   - Requires manual setup in Stripe Dashboard
   - Not automated yet

2. **Product Variety**
   - Only 1 snake available (Batman Ball)
   - Need to add more species/morphs

3. **UI Polish**
   - Functional but minimal design
   - Could use visual improvements

4. **Error Handling**
   - Basic error messages
   - Could be more user-friendly

### Not Implemented Yet

- Breeding mechanics
- Multiple snake species
- Advanced care features
- Mobile optimization
- User accounts/login
- Social features

---

## ğŸ›£ï¸ Next Steps (v0.6.0+)

### Planned Features

1. **More Products**
   - Add 5-10 more snake morphs
   - Different species (corn snakes, boas)

2. **Enhanced UI**
   - Better visual design
   - Animations
   - Mobile-responsive

3. **User Accounts**
   - Persistent login
   - Password auth
   - Profile management

4. **Advanced Care**
   - Breeding mechanics
   - Genetics calculator
   - Health system

5. **Webhook Automation**
   - Auto-configure on deployment
   - Better error handling

---

## ğŸ“ Version History

### v0.5.0 (2025-12-26) - MVP Release
- âœ… Complete purchase flow
- âœ… KV-based storage
- âœ… Collection management
- âœ… Debug mode toggle
- âœ… Dynamic environment config
- âœ… Comprehensive documentation

### Previous Versions
- v0.4.x - Development iterations
- v0.3.x - Worker integration
- v0.2.x - Stripe integration
- v0.1.x - Initial prototype

---

## ğŸ¤ Contributing

This is currently a personal project, but feedback is welcome!

**Contact:** [@vinas8](https://github.com/vinas8)

---

## ğŸ“š Additional Documentation

- [Setup Guide](guides/SETUP.md)
- [Cloudflare Deployment](CLOUDFLARE-DEPLOYMENT.md)
- [Stripe Configuration](STRIPE-SECRET-SETUP.md)
- [Worker Logs](WORKER-LOGS.md)
- [Architecture](architecture/ARCHITECTURE.md)

---

**Built with â¤ï¸ and ğŸ**
