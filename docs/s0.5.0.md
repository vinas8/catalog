# Serpent Town s0.5.0 - Complete System Documentation

**Version:** 0.5.0  
**Release Date:** 2025-12-22  
**Status:** SMRI-Driven Development Complete

---

## ğŸ¯ What is Serpent Town s0.5.0?

Serpent Town is a **snake breeding e-commerce game** with real Stripe payments and Tamagotchi-style care mechanics, built using **SMRI (Scenarioâ€“Moduleâ€“Relationâ€“Instance)** as the universal system design language.

**Key Innovation:** Documentation drives development. Every feature is a scenario. Every scenario has an SMRI code. Debug and tests execute the same workflows.

---

## ğŸ“š Table of Contents

1. [System Overview](#system-overview)
2. [SMRI System](#smri-system)
3. [Architecture](#architecture)
4. [Module Reference](#module-reference)
5. [Development Workflow](#development-workflow)
6. [Debug Hub](#debug-hub)
7. [Testing](#testing)
9. [Deployment](#deployment)
10. [Upgrade Guide](#upgrade-guide)

---

## System Overview

### Tech Stack

**Frontend:**
- Plain JavaScript ES6 modules (zero dependencies)
- HTML5 + CSS3 (responsive, mobile-first)
- GitHub Pages hosting

**Backend:**
- Cloudflare Workers (serverless API)
- Cloudflare KV (key-value storage)
- Stripe Checkout + Webhooks (payments)

**Development:**
- SMRI methodology (scenario-driven)
- TDD with shared scenario executors
- AI prompts for automation
- Debug-first development hub

### Key Features

âœ… **E-Commerce:**
- Real snake products (Ball Python, Corn Snake)
- 10+ morphs (Banana, Piebald, Pastel, etc.)
- Stripe integration with secure webhooks

âœ… **Game Mechanics:**
- Tamagotchi-style snake care
- 8 stats (hunger, water, temperature, humidity, health, stress, cleanliness, happiness)
- Decay system with realistic timers
- Equipment shop (15+ items: thermostats, auto-feeders, etc.)

âœ… **SMRI System:**
- 45 documented E2E scenarios
- 6 real modules + 3 external services
- Scenario runner for manual & automated testing
- Debug hub with scenario execution

---

## SMRI System

### What is SMRI?

**S.M.RRR.II** - A universal notation for system scenarios:

- **S** = Scenario prefix
- **M** = Module owner (1-6 internal, 11+ external)
- **RRR** = Relations (modules this scenario touches)
- **II** = Instance number (01-99)

**Example:** `S5.11.2-12.2.01`
- Worker (5) owns this scenario
- Relates to Cloudflare.KV (11.2) + Stripe.Webhooks (12.2)
- First instance

### Module Numbers

**Internal Modules (1-6):**
1. **Shop** - `src/modules/shop/` - Product catalog, Stripe links
2. **Game** - `src/modules/game/` - Tamagotchi mechanics, stats
3. **Auth** - `src/modules/auth/` - User authentication, hashes
4. **Payment** - `src/modules/payment/` - Payment processing logic
5. **Worker** - `worker/worker.js` - Cloudflare Worker API layer
6. **Common** - `src/modules/common/` - Shared utilities

**External Services (11-13):**
11. **Cloudflare** (11.1=KV, 11.2=Workers, 11.3=CDN)
12. **Stripe** (12.1=Checkout, 12.2=Webhooks, 12.3=API)
13. **GitHub** (13.1=Pages, 13.2=Actions)

### Why SMRI?

âœ… **Traceable:** Every feature has a code  
âœ… **Testable:** Scenarios map directly to tests  
âœ… **Documentable:** User stories generate from scenarios  
âœ… **Debuggable:** Debug hub runs scenarios by code  
âœ… **Scalable:** Add scenarios without breaking existing ones

---

## Architecture

### System Flow

```
User â†’ GitHub Pages (catalog.html)
  â†“
Stripe Checkout
  â†“
Stripe Webhook â†’ Cloudflare Worker
  â†“
Worker validates + writes to KV
  â†“
User opens game.html#hash
  â†“
Game fetches snakes from Worker API
  â†“
LocalStorage stores game state
```

### Data Flow

**Purchase Flow (S1.2345.01):**
```
Shop(1) â†’ Stripe(12.1) â†’ Webhook(12.2) â†’ Worker(5) â†’ KV(11.2) â†’ Game(2)
```

**Game State Flow (S2.5.01):**
```
Game(2) â†’ LocalStorage â†’ Worker(5) â†’ KV(11.2)
```

### File Structure

```
serpent-town/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ modules/
â”‚       â”œâ”€â”€ shop/          # Module 1
â”‚       â”œâ”€â”€ game/          # Module 2
â”‚       â”œâ”€â”€ auth/          # Module 3
â”‚       â”œâ”€â”€ payment/       # Module 4
â”‚       â”œâ”€â”€ common/        # Module 6
â”‚       â”‚   â”œâ”€â”€ scenario-runner.js
â”‚       â”‚   â””â”€â”€ security-scenarios.js
â”‚       â””â”€â”€ debug/         # Dev tools
â”‚           â”œâ”€â”€ index.html
â”‚           â””â”€â”€ components/
â”œâ”€â”€ worker/
â”‚   â””â”€â”€ worker.js          # Module 5
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ e2e/
â”‚       â””â”€â”€ security-scenarios.test.js
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ test/
â”‚   â”‚   â””â”€â”€ E2E_TEST_SCENARIOS.md  # SOURCE OF TRUTH
â”‚   â””â”€â”€ guides/
â”‚       â””â”€â”€ s0.5.0.md      # This file
â”œâ”€â”€ prompts/               # SMRI AI prompts
â”‚   â”œâ”€â”€ README.md
â”‚   â””â”€â”€ [smri_*.md files]
â”œâ”€â”€ catalog.html           # Main shop page
â”œâ”€â”€ game.html             # Tamagotchi game
â”œâ”€â”€ success.html          # Post-purchase
â””â”€â”€ debug.html            # Redirects to debug hub
```

---

## Module Reference

### Module 1: Shop

**Location:** `src/modules/shop/`  
**Pages:** `catalog.html`, `index.html`  
**Endpoints:** `/products`, `/product-status`

**Responsibilities:**
- Load product catalog
- Display snake species and morphs
- Generate Stripe checkout links
- Track product availability

**Key Files:**
- `shop.js` - Main shop logic
- `data/species.js` - Species definitions
- `data/morphs.js` - Morph definitions

**SMRI Scenarios:**
- S1.0.01 - Product Status Check
- S1.2.01 - Happy Path Purchase
- S1.2.02 - Buy 5 Different Snakes
- S1.234.01 - Returning User Purchase
- S1.4.01 - Payment Confirmation Email

---

### Module 2: Game

**Location:** `src/modules/game/`  
**Pages:** `game.html`  
**Endpoints:** None (frontend-only with localStorage)

**Responsibilities:**
- Render snake stats UI
- Handle care actions (feed, water, clean)
- Decay system simulation
- Equipment shop
- Auto-save to localStorage

**Key Files:**
- `game.js` - Main game loop
- `tamagotchi.js` - Care mechanics
- `snakes.js` - Snake data structures

**SMRI Scenarios:**
- S2.0.01 - View Snake Stats
- S2.0.02 - Stats Decay Over Time
- S2.0.03 - Feed Action
- S2.0.04 - Water Action
- S2.0.05 - Clean Enclosure Action
- S2.0.06 - Health Degradation
- S2.4.01 - Buy Equipment with Gold
- S2.4.02 - Cannot Buy Without Gold
- S2.5.01 - Auto-Save Game State

---

### Module 3: Auth

**Location:** `src/modules/auth/`  
**Pages:** `register.html`, all pages with user context  
**Endpoints:** `/user-products` (uses hash)

**Responsibilities:**
- Generate user hashes
- Validate hash formats
- Manage loyalty tiers
- Handle returning users

**Key Files:**
- `auth.js` - Authentication logic
- `hash.js` - Hash generation/validation

**SMRI Scenarios:**
- S3.0.01 - Skip Registration (Returning User)
- S3.0.02 - Loyalty Tier Progression
- S3.4.01 - Register After Purchase
- S3.4.02 - Loyalty Points Earning
- S3.5.01 - User Hash Validation (Security)
- S3.5.02 - Invalid Hash in URL (Security)
- S3.5.03 - XSS Attempt via Username (Security)

---

### Module 4: Payment

**Location:** `src/modules/payment/`  
**Pages:** `catalog.html` (Stripe buttons), `success.html`  
**Endpoints:** `/stripe-webhook`

**Responsibilities:**
- Process Stripe checkout events
- Validate webhook signatures
- Handle payment failures
- Assign products to users

**Key Files:**
- `payment.js` - Payment logic
- `stripe-config.js` - Stripe credentials

**SMRI Scenarios:**
- S4.4.01 - Webhook Signature Verification (Security)
- S4.4.02 - Webhook Delayed
- S4.4.03 - Webhook Idempotency
- S4.4.04 - Product Already Sold (Race Condition)
- S4.4.05 - CSRF Attack on Webhook (Security)
- S4.5.01 - Product Schema Validation (Security)
- S4.5.02 - SQL Injection Attempt (Security)

---

### Module 5: Worker

**Location:** `worker/worker.js`  
**Pages:** All pages (API backend)  
**Endpoints:** All API routes

**Responsibilities:**
- Route all API requests
- Read/write Cloudflare KV
- Validate inputs
- CORS handling
- Webhook processing

**Key Files:**
- `worker.js` - Main Worker entry point
- `wrangler.toml` - Worker configuration

**SMRI Scenarios:**
- S5.0.01 - KV Consistency Check
- S5.1.01 - Load 100 Products in Catalog (Performance)
- S5.2.01 - Load Game from KV (Cold Start)
- S5.2.02 - Network Failure During Game Load
- S5.2.03 - User Deletes localStorage Mid-Session
- S5.2.04 - Game with 20 Snakes (Performance)
- S5.4.01 - Product Sync (Create/Update/Delete)
- S5.4.02 - Concurrent Webhook Processing
- S5.5.01 - Corrupted KV Data
- S5.11.2-12.2.01 - Webhook Signature Verification

---

### Module 6: Common

**Location:** `src/modules/common/`  
**Pages:** Used by all pages  
**Endpoints:** None (shared utilities)

**Responsibilities:**
- Scenario runner infrastructure
- Security scenario executors
- Shared validation helpers
- Shared UI components

**Key Files:**
- `scenario-runner.js` - SMRI scenario execution framework
- `security-scenarios.js` - P0 security test executors
- `core.js` - Core utilities

**SMRI Scenarios:**
- S6.0.01 - Demo Mode (Browse Without Purchase)
- S6.0.02 - Data Cleanup (Remove Old Sessions)

---

## Development Workflow

### 1. Documentation-First

**Every feature starts in documentation:**

```bash
# 1. Add scenario to E2E_TEST_SCENARIOS.md
vim docs/test/E2E_TEST_SCENARIOS.md

# 2. Use AI prompt to generate code structure (optional)
cat new_scenario.md | [paste to AI with smri_test_generator prompt]

# 3. Write failing test
vim tests/e2e/new_feature.test.js

# 4. Implement feature
vim src/modules/{module}/

# 5. Test passes
npm run test:e2e:security

# 6. Update debug.html if needed
# 7. Commit with SMRI code in message
```

### 2. SMRI Code Usage

**In Git Commits:**
```bash
git commit -m "feat: S4.5.02 - Add SQL injection validation"
```

**In Test Files:**
```javascript
/**
 * SMRI E2E Test: SQL Injection Attempt
 * Code: S4.5.02
 * Module: Payment (4) â†’ Worker (5)
 */
```

**In Debug Logs:**
```
[2025-12-22T20:00:00Z] â–¶ Running scenario: S4.5.02
[2025-12-22T20:00:01Z] âœ… S4.5.02 PASSED (1234ms)
```

### 3. Testing Strategy

**Levels:**
1. **Unit Tests** - `npm test` - Module-specific logic
2. **Integration Tests** - `npm run test:slow` - Frontend â†” Backend
3. **E2E Tests** - `npm run test:e2e:security` - Full workflows
4. **Manual Tests** - Debug hub - Visual verification

**Test Pyramid:**
```
         â•±â•²
        â•±  â•²     Manual (Debug Hub)
       â•±â”€â”€â”€â”€â•²
      â•±      â•²   E2E (Scenario Runner)
     â•±â”€â”€â”€â”€â”€â”€â”€â”€â•²
    â•±          â•² Integration (Slow Tests)
   â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²
  â•±              â•² Unit (Fast Tests)
```

### 4. Debug-Driven Development

**Workflow:**
1. Open debug hub: `/debug.html`
2. Switch to "ğŸ¯ SMRI Scenarios" tab
3. Enter scenario code: `S4.5.02`
4. Click "Run Scenario"
5. View pass/fail with timing
6. Check execution log
7. Fix issues
8. Re-run until pass
9. Write automated test

**Benefits:**
- Instant feedback
- Visual verification
- Same code as tests
- Easy to reproduce bugs

---

## Debug Hub

### Location

**URL:** `http://localhost:8000/debug.html`  
**Redirects to:** `src/modules/debug/index.html`

### Features

#### ğŸ¯ SMRI Scenarios Tab (Primary)

**What it does:**
- Execute E2E scenarios by code
- View scenario metadata (module, relations, priority)
- See execution results (PASS/FAIL with timing)
- Browse all registered scenarios
- Quick access buttons for P0 security tests

**Usage:**
```
1. Enter code: S4.5.02
2. Click "â–¶ Run Scenario"
3. View result with detailed logs
```

**Quick Access Buttons:**
- S3.5.01 - Hash Validation
- S4.5.02 - SQL Injection
- S3.5.03 - XSS Attempt
- S4.4.05 - CSRF Attack

#### ğŸ“¦ Catalog Tab

Test product API endpoints:
- GET /products
- GET /product-status?id={id}

#### ğŸ‘¤ Users Tab

Test user management:
- GET /user-products?user={hash}
- POST /register-user

#### ğŸ” Admin Tab

Dev tools:
- Manual product assignment
- System operations

#### ğŸ’³ Stripe Tab

Test Stripe integration:
- View webhook events
- Test payment flows

#### ğŸ“Š Monitor Tab

System health:
- Worker status
- API latency
- Metrics

#### ğŸ“ Logs Tab

View execution logs:
- Filter by type
- Clear logs
- Export

### Components

**File:** `src/modules/debug/components/scenario-ui.js`

**Class:** `ScenarioRunnerUI`

**Methods:**
- `init()` - Initialize scenario runner
- `run(code)` - Execute scenario by SMRI code
- `showList()` - Display all scenarios
- `clearLog()` - Clear execution log

---

## Testing

### Test Files

**Security Scenarios (P0):**
```bash
npm run test:e2e:security
# Runs: tests/e2e/security-scenarios.test.js
# Tests: S3.5.01, S4.5.02, S3.5.03, S4.4.05, S5.11.2-12.2.01, S4.5.01
```

**All E2E:**
```bash
npm run test:e2e
# Runs: tests/e2e/e2e-purchase-flow.sh
# Tests: Full purchase journey
```

**Full Suite:**
```bash
npm run test:full
# Runs: Unit + Integration + E2E + Security
```

### Writing Tests

**Template:**
```javascript
#!/usr/bin/env node
/**
 * SMRI E2E Test: {Scenario Name}
 * Code: {SMRI Code}
 * Module: {Owner} â†’ {Relations}
 * Priority: {P0-P6}
 */

import { ScenarioRunner } from '../../src/modules/common/scenario-runner.js';
import { {ExecutorClass} } from '../../src/modules/common/{file}.js';

const runner = new ScenarioRunner();
const registry = runner.registry;

// Register scenario
registry.register('{code}', new {ExecutorClass}({
  workerUrl: 'https://...'
}), {
  name: '{Name}',
  description: '{Description}',
  priority: 'P0',
  module: {M},
  relations: [{R}]
});

// Run test
const result = await runner.run('{code}');

// Assert
if (result.status === 'pass') {
  console.log('âœ… PASS');
  process.exit(0);
} else {
  console.log('âŒ FAIL:', result.errors);
  process.exit(1);
}
```

### Test Coverage

**Status:** 6/45 scenarios automated (13%)

**P0 Security (6/6):** âœ… Complete
- S3.5.01 - Hash Validation
- S4.5.02 - SQL Injection
- S3.5.03 - XSS Attempt
- S4.4.05 - CSRF Attack
- S5.11.2-12.2.01 - Webhook Signature
- S4.5.01 - Schema Validation

**Remaining (39 scenarios):** ğŸš§ In Progress

---


## Deployment

### Frontend (GitHub Pages)

```bash
# Deploy is automatic on push to main
git push origin main

# Manual deploy
git checkout gh-pages
git merge main
git push origin gh-pages
```

**URL:** `https://vinas8.github.io/catalog/`

### Backend (Cloudflare Worker)

```bash
cd worker
wrangler publish

# Or use helper script
bash .github/skills/worker-deploy.sh
```

**URL:** `https://catalog.navickaszilvinas.workers.dev`

### Environment Variables

**Required:**
- `STRIPE_SECRET_KEY` - Stripe API key
- `STRIPE_WEBHOOK_SECRET` - Webhook signing secret
- `CLOUDFLARE_API_TOKEN` - Cloudflare API access
- `CLOUDFLARE_ACCOUNT_ID` - Account ID

**Setup:**
```bash
cp .env.example .env
# Edit .env with your values
```

---

## Upgrade Guide

### From v0.3.0 to s0.5.0

**Breaking Changes:**
- âš ï¸ Debug moved to `src/modules/debug/index.html`
- âš ï¸ SMRI codes changed format (S121 â†’ S1.2.01)
- âš ï¸ External services added (11-13)

**Migration Steps:**

1. **Update bookmarks:**
   - Old: `/debug.html`
   - New: `/debug.html` (redirects automatically) or `/src/modules/debug/index.html`

2. **Update test references:**
   ```bash
   # Old
   S121 - Happy Path
   
   # New
   S1.2.01 - Happy Path
   ```

3. **Update E2E docs:**
   ```bash
   # Re-read E2E_TEST_SCENARIOS.md
   cat docs/test/E2E_TEST_SCENARIOS.md
   ```

   ```

5. **Run tests:**
   ```bash
   npm run test:full
   ```

**New Features:**
- âœ… SMRI scenario runner
- âœ… Debug hub with scenario execution

- âœ… Security scenario executors
- âœ… Enhanced E2E documentation

---

## Quick Reference

### Commands

```bash
# Start dev server
npm start

# Run tests
npm test                    # Fast tests
npm run test:e2e:security   # Security scenarios
npm run test:full           # All tests

# Deploy
bash .github/skills/worker-deploy.sh  # Deploy Worker
git push origin main                   # Deploy frontend

```

### SMRI Examples

```
S1.2.01      Shop â†’ Game, instance 1
S5.11.2-12.2.01  Worker â†’ KV + Webhooks
S3.5.01      Auth â†’ Worker (security)
S2.0.03      Game standalone, instance 3
```

### Module Map

```
1=Shop  2=Game  3=Auth  4=Payment  5=Worker  6=Common
11=Cloudflare  12=Stripe  13=GitHub
```

### Files

```
Source of Truth: docs/test/E2E_TEST_SCENARIOS.md
Debug Hub: src/modules/debug/index.html
Tests: tests/e2e/security-scenarios.test.js
Scenario Runner: src/modules/common/scenario-runner.js
```

---

## Support

**Documentation:**
- Full E2E scenarios: `docs/test/E2E_TEST_SCENARIOS.md`
- Debug README: `src/modules/debug/README.md`

**Repository:** https://github.com/vinas8/catalog  
**Issues:** Use SMRI codes in issue titles (e.g., "Bug: S4.5.02 fails on invalid input")

---

**Version:** 0.5.0  
**Status:** âœ… Production Ready with SMRI Infrastructure  
**Last Updated:** 2025-12-22

---

*Documentation drives development. SMRI connects everything.*
