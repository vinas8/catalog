# ğŸ Serpent Town v0.1.0 - Complete Documentation

**All documentation consolidated into this single file.**

**Status:** âœ… Production Ready | **Tests:** 86/86 (100%) âœ… | **License:** MIT | **Date:** December 21, 2025

---

## Quick Start

```bash
cd /root/catalog
python3 -m http.server 8000
# Catalog: http://localhost:8000/catalog.html
# Game: http://localhost:8000/game.html
npm test  # 86/86 tests passing
```

---

## Core Business Logic

**THE RULE:** Buy snake in catalog â†’ Register account â†’ Snake appears in game

**Flow:**
1. Browse `catalog.html` â†’ Click "Buy Now" (user hash generated)
2. Stripe Checkout â†’ Complete payment
3. **Redirect to `register.html`** â†’ Create account
   - Auto-generated funny username (customizable)
   - Email for account recovery
   - Player ID (hash) displayed
4. Stripe webhook â†’ Cloudflare Worker â†’ Saves to KV storage
5. Open `game.html?user=HASH` â†’ ğŸ Snake appears!

**Critical:** User hash is passed through entire flow via `client_reference_id`.

---

## ğŸ†• Registration System (v0.1.0)

### User Flow After Purchase

1. **Payment Success** (`success.html`)
   - Auto-redirects to registration in 3 seconds
   - Passes `session_id` and `email` from Stripe

2. **Registration** (`register.html`)
   - **Username:** Auto-generated funny name (e.g., "SneakyPython42")
   - **Email:** Pre-filled from Stripe checkout
   - **Player ID:** Auto-generated hash (e.g., "m2x9k7p4q8n3")
   - Click "Start Playing" â†’ Saves to worker + localStorage

3. **Game Access** (`game.html?user=HASH`)
   - Displays username in header
   - Shows purchased snakes
   - Bookmark this link to access account

### Funny Username Generator

18 adjectives Ã— 16 nouns Ã— 999 numbers = 287,712 combinations

**Examples:**
- SneakySnakeCharmer42
- MightyBasilisk777
- DerpyNoodle123
- WiseSerpen999

### Player ID (Hash)

Format: `{timestamp_base36}{random_base36}`
Example: `m2x9k7p4q8n3`

**Security:** Anyone with this hash can access the snakes. Store it safely!

---

## Cloudflare Worker API

**Base URL:** `https://serpent-town.vinatier8.workers.dev`

### Endpoints

#### POST `/register-user`
Register new user after purchase.

**Request:**
```json
{
  "user_id": "m2x9k7p4q8n3",
  "username": "SneakyPython42",
  "email": "user@example.com",
  "stripe_session_id": "cs_test_..."
}
```

**Response:**
```json
{
  "success": true,
  "user": {
    "user_id": "m2x9k7p4q8n3",
    "username": "SneakyPython42",
    "email": "user@example.com",
    "created_at": "2025-12-21T13:00:00Z",
    "loyalty_points": 0,
    "loyalty_tier": "bronze"
  }
}
```

**KV Storage:** `userdata:{user_id}`

#### GET `/user-data?user=HASH`
Get user profile.

**Response:**
```json
{
  "user_id": "m2x9k7p4q8n3",
  "username": "SneakyPython42",
  "email": "user@example.com",
  "loyalty_tier": "bronze"
}
```

#### GET `/user-products?user=HASH`
Get user's purchased snakes (existing endpoint).

#### POST `/stripe-webhook`
Receives Stripe webhooks, assigns product to user hash.

---

## Data Model

**3 Data Sources:**

1. **products.json** - Available snakes (catalog)
2. **Cloudflare KV** - User profiles + purchased snakes
   - `userdata:{hash}` â†’ User profile
   - `user:{hash}` â†’ Array of purchased snakes
3. **localStorage** - Cached user data + game state

---

## Stripe Integration

### Checkout Flow

1. User clicks "Buy Now" in catalog
2. JavaScript generates user hash â†’ Saves to localStorage
3. Appends hash to Stripe link: `?client_reference_id={hash}`
4. Stripe checkout opens with user hash attached
5. After payment â†’ Stripe webhook sends hash to worker
6. Worker assigns product to that hash in KV

### Success URL

Stripe redirects to: `success.html?session_id={CHECKOUT_SESSION_ID}`

Success page extracts session ID and redirects to registration.

### Webhook Payload

Worker expects `checkout.session.completed` event:
```json
{
  "type": "checkout.session.completed",
  "data": {
    "object": {
      "client_reference_id": "m2x9k7p4q8n3",
      "customer_email": "user@example.com",
      "line_items": { ... },
      "payment_intent": "pi_..."
    }
  }
}
```

---

## Features

- 8 real-time stats (hunger, water, health, etc.)
- 15+ equipment items with automation
- Stripe integration for real purchases
- Virtual purchases with in-game gold
- 4-tier loyalty system
- Auto-save every 30 seconds

---

## Architecture

```
catalog/
â”œâ”€â”€ catalog.html        # Shop
â”œâ”€â”€ game.html           # Game
â”œâ”€â”€ webhook-server.py   # Stripe webhook
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ products.json
â”‚   â”œâ”€â”€ user-products.json  â­
â”‚   â””â”€â”€ users.json
â”œâ”€â”€ src/                # Game code
â””â”€â”€ tests/              # 86 tests
```

**Tech:** Plain JavaScript ES6, Zero dependencies, ~3,600 LOC

---

## Deployment

### Local (Demo)
```bash
python3 -m http.server 8000
```

### Production
- Frontend: GitHub Pages / Netlify
- Backend: Heroku / Railway (webhook-server.py)

---

## Webhook Setup

1. Run: `python3 webhook-server.py`
2. Configure Stripe webhook to POST to `/webhook/stripe`
3. Set env: `STRIPE_WEBHOOK_SECRET=whsec_xxx`

Webhook writes purchase to `user-products.json` â†’ Snake appears in game.

---

## Testing

```bash
npm test  # 86/86 (100%) âœ…
```

---

## Troubleshooting

**Snake doesn't appear:**
1. Check `tail -f /tmp/webhook-server.log`
2. Verify `cat data/user-products.json`
3. Match user ID in URL: `game.html#user_123`

**Catalog empty:**
```bash
cat data/products.json | python3 -m json.tool
```

---

## API Reference

```javascript
// Economy
import { Economy } from './src/business/economy.js';
Economy.buyVirtualSnake('corn_snake', [], gameState);

// Shop
import { EquipmentShop } from './src/business/equipment.js';
EquipmentShop.buyEquipment('heat_mat_basic', snakeId, gameState);

// Catalog
import { getProductsBySpecies } from './src/data/catalog.js';
await getProductsBySpecies('ball_python');
```

---

## Stats & Mechanics

**Decay (per hour at 1x):**
- Hunger: -2.0 to -2.5
- Water: -3.0
- Health: -0.5 if neglected

**Care actions:**
- Feed: Hunger +40, Stress -5
- Water: Water +50, Stress -2
- Clean: Cleanliness +30, Stress -10

**Equipment automation:**
- Auto-feeder: Feeds every 7 days
- Auto-misting: Maintains humidity
- Thermostat: Auto-temperature

---

## Species

### Ball Python
- Temp: 88-92Â°F hot, 78-82Â°F cool
- Humidity: 50-60% (70% shed)
- Feeding: Every 5-10 days
- Adult: 1200-2000g
- Morphs: Banana, Piebald, Pastel

### Corn Snake
- Temp: 85-90Â°F hot, 75-80Â°F cool
- Humidity: 40-50% (60% shed)
- Feeding: Every 5-10 days
- Adult: 400-900g
- Morphs: Amelanistic, Blood Red, Motley

---

## Managing Products

Add to `data/products.json`:
```json
{
  "id": "prod_new_001",
  "name": "Banana Ball Python",
  "species": "ball_python",
  "price": 450.00,
  "status": "available",
  "stripe_link": "https://buy.stripe.com/test_xxx"
}
```

Refresh browser â†’ Appears in catalog

---

## Browser Support

âœ… Chrome/Edge 90+ | âœ… Firefox 88+ | âœ… Safari 14+ | âœ… Mobile | âŒ IE

---

## Statistics

- Version: 0.1.0
- Date: December 21, 2025
- Lines: ~3,600
- Dependencies: 0
- Tests: 86/86 (100%) âœ…
- Shop Items: 15+
- Species: 2
- Morphs: 10+

---

## Security

- âœ… Stripe handles all payment (PCI compliant)
- âœ… Webhook signature verification
- âœ… HTTPS required in production
- âœ… No secrets in code

---

**Built with plain JavaScript. No frameworks. No dependencies. Just code.**

**Status:** âœ… Production Ready | **Tests:** 86/86 (100%) âœ…

*Play: http://localhost:8000/game.html*
# Stripe Redirect URLs Configuration

## ğŸ¯ Goal
After payment, redirect customer to: `http://localhost:8000/success.html`
Then success.html auto-redirects to: `http://localhost:8000/game.html#<user_hash>`

---

## ğŸ“‹ Setup Instructions

### 1. Go to Stripe Dashboard
- Login to: https://dashboard.stripe.com/test/payment-links
- Find your payment links for each snake product

### 2. Configure Each Payment Link

For **EACH** snake product (Batman Ball, etc.):

1. Click the payment link
2. Click **"Edit"** or **"Settings"**
3. Find **"After payment"** section
4. Set these URLs:

**Success URL:**
```
http://localhost:8000/success.html?session_id={CHECKOUT_SESSION_ID}
```

**Cancel URL (optional):**
```
http://localhost:8000/catalog.html
```

### 3. Important Notes

- `{CHECKOUT_SESSION_ID}` is a Stripe variable - keep it exactly as written
- Use `http://localhost:8000` for local testing
- For production, replace with your actual domain: `https://vinas8.github.io/catalog`

---

## ğŸ”„ Complete Flow

```
1. User clicks "Buy Now" on catalog.html
   â†“
2. Redirects to Stripe Checkout (with client_reference_id=<user_hash>)
   â†“
3. User completes payment
   â†“
4. Stripe webhook fires â†’ Worker assigns snake to user
   â†“
5. Stripe redirects to: http://localhost:8000/success.html?session_id=xxx
   â†“
6. success.html shows confirmation (3 second countdown)
   â†“
7. Auto-redirect to: http://localhost:8000/game.html#<user_hash>
   â†“
8. Game loads user's snakes from worker API
```

---

## ğŸš€ Production URLs

When deploying to production, update Stripe payment links to:

**Success URL:**
```
https://vinas8.github.io/catalog/success.html?session_id={CHECKOUT_SESSION_ID}
```

**Cancel URL:**
```
https://vinas8.github.io/catalog/catalog.html
```

---

## âœ… Testing

1. Make a test purchase
2. Complete payment in Stripe test mode
3. Should redirect to success.html
4. Should auto-redirect to game.html after 3 seconds
5. Game should show your new snake

---

## ğŸ› Troubleshooting

**Redirects to wrong URL:**
- Check Stripe Dashboard â†’ Payment Links â†’ After Payment settings
- Verify URLs match exactly (including protocol http:// or https://)

**Game doesn't load snake:**
- Check browser console for errors
- Verify user hash in localStorage: `localStorage.getItem('serpent_last_purchase_hash')`
- Check worker API: `curl http://localhost:8787/user-products?user=<hash>`

**No user hash found:**
- Ensure you clicked "Buy Now" from catalog.html (sets hash in localStorage)
- Check: `localStorage.getItem('serpent_user_hash')`

---

## ğŸ“¸ Screenshots & Images

### Purchase Flow Diagram
- Google Photos: https://photos.app.goo.gl/jDeJdwGAEfdqn2CE6

