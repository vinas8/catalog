# Serpent Town v0.2.0 - Technical Documentation

**Release Date:** 2025-12-21  
**Status:** Production Ready âœ…

## ğŸ¯ What's New in v0.2.0

### Major Features
1. **Sold Status Tracking** - Real snakes marked as sold for all users
2. **3-Section Catalog** - Available / Virtual / Sold (collapsible)
3. **Developer Dashboard** - All-in-one dev tools hub
4. **Data Cleanup Tools** - Fresh start capabilities
5. **Product Conversion System** - User products â†’ Game snakes

### Bug Fixes
- Fixed JavaScript import paths (./config instead of ../config)
- Added missing `createSnakeFromProduct()` method
- Fixed unclosed try/catch blocks
- Removed duplicate snake display from test data

### Architecture Improvements
- Single source of truth: Cloudflare KV (PRODUCT_STATUS)
- Removed obsolete `data/user-products.json`
- Clean separation: ownership (KV) vs. game state (localStorage)

---

## ğŸ“¦ Architecture Overview

### Data Sources (Hierarchy)

```
1. Cloudflare KV: PRODUCT_STATUS
   â”œâ”€ Key: product:prod_xxx
   â””â”€ Value: { status: "sold", owner_id: "user_abc", sold_at: "..." }
   Purpose: Track which real snakes are sold

2. Cloudflare KV: USER_PRODUCTS  
   â”œâ”€ Key: user:abc123
   â””â”€ Value: [array of user's purchased snakes]
   Purpose: Store user's snake collection

3. data/products.json
   â””â”€ Catalog of available snakes for shop
   Purpose: Display in catalog.html

4. Browser localStorage
   â”œâ”€ serpent_town_save (game state: stats, equipment)
   â”œâ”€ serpent_user_hash (user identification)
   â””â”€ serpent_user (cached user profile)
   Purpose: Temporary game state, NOT ownership
```

### Purchase Flow

```
User clicks "Buy Now" (catalog.html)
  â†“
Stripe Checkout
  â†“
Payment Success â†’ Webhook â†’ Cloudflare Worker
  â†“
Worker writes to:
  1. USER_PRODUCTS KV (user's collection)
  2. PRODUCT_STATUS KV (mark as sold)
  â†“
Game loads from worker API
  â†“
Snake appears in game.html
```

### Catalog Display Logic

```javascript
// catalog.html loads products
const products = await getProductsBySpecies(species);

// Check sold status from worker
for each real product:
  status = await fetch('/product-status?id=' + product.id)
  product.status = status.status
  product.owner_id = status.owner_id

// Separate into sections
available = products.filter(p => p.type === 'real' && p.status === 'available')
virtual = products.filter(p => p.type === 'virtual')
sold = products.filter(p => p.type === 'real' && p.status === 'sold')

// Display in 3 sections
render(available) // Top: Available Snakes
render(virtual)   // Middle: Virtual Snakes (gold)
render(sold)      // Bottom: Sold Snakes (folded)
```

---

## ğŸ› ï¸ Developer Tools

### New Pages (v0.2.0)

1. **dashboard.html**
   - All-in-one developer hub
   - Links to all tools
   - Command references
   - Architecture diagrams

2. **cleanup.html**
   - Clear browser localStorage
   - Instructions for KV cleanup
   - Fresh start utility

3. **start.html**
   - Demo mode (3 free virtual snakes)
   - Manual hash entry
   - Quick onboarding

4. **debug-test.html**
   - Test game controller loading
   - Check data files
   - Worker API connectivity
   - Event listener validation

### New Scripts

```bash
# Cleanup Cloudflare KV
scripts/clean-kv.sh

# Create PRODUCT_STATUS namespace
worker/create-product-status-kv.sh

# Check server status (read-only)
.github/skills/check-server-status.sh

# Deploy worker
.github/skills/worker-deploy.sh

# Test worker endpoints
.github/skills/test-worker.sh
```

---

## ğŸ”§ Configuration

### Cloudflare KV Namespaces

**USER_PRODUCTS**
```toml
[[kv_namespaces]]
binding = "USER_PRODUCTS"
id = "3b88d32c0a0540a8b557c5fb698ff61a"
```

**PRODUCT_STATUS** (New in v0.2.0)
```toml
[[kv_namespaces]]
binding = "PRODUCT_STATUS"
id = "PLACEHOLDER_CREATE_THIS_NAMESPACE"
```

To create:
```bash
cd worker
bash create-product-status-kv.sh
# Copy ID to wrangler.toml
wrangler publish worker.js
```

### Worker Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/stripe-webhook` | POST | Stripe payment webhook |
| `/user-products?user=HASH` | GET | Get user's snakes |
| `/product-status?id=PROD_ID` | GET | Check if product sold (NEW) |
| `/user-data?user=HASH` | GET | Get user profile |
| `/register-user` | POST | Save user data |
| `/assign-product` | POST | Manual assignment (testing) |

---

## ğŸ® Game Features

### Snake Care System
- **8 Stats:** Hunger, Water, Temperature, Humidity, Health, Stress, Cleanliness, Happiness
- **Decay Rates:** Configurable per species
- **Care Actions:** Feed, Water, Clean, Adjust Temperature/Humidity
- **Equipment Shop:** 15+ items (auto-feeders, thermostats, misters)

### Tamagotchi Mechanics
- Real-time stat decay (game speed 1x-100x)
- Life stages: Baby, Juvenile, Sub-Adult, Adult
- Feeding schedules based on age
- Breeding cycles (coming in v0.3.0)

### Species & Morphs
- **Ball Python:** Banana, Piebald, Pastel, Clown, etc.
- **Corn Snake:** Albino, Amelanistic, Snow, etc.
- **Genetic Calculator:** Predict offspring (interface ready, logic in progress)

---

## ğŸ’³ E-Commerce

### Product Types

**Real Snakes** (type: "real", unique: true)
- One-of-a-kind physical snakes
- Payment via Stripe
- Once sold â†’ grayed out for all users
- Moved to "Sold Snakes" section (collapsible)

**Virtual Snakes** (type: "virtual", unique: false)
- Unlimited digital copies
- Payment with in-game gold
- Always available
- Show in separate section with gold price

### Stripe Integration

```javascript
// catalog.html appends user hash to checkout URL
const checkoutUrl = item.stripe_link + 
  `?client_reference_id=${userHash}&prefilled_email={CHECKOUT_SESSION_EMAIL}`;
```

Webhook receives `client_reference_id` and assigns snake to user.

---

## ğŸ§ª Testing

**Status:** 86/86 tests passing (100%) âœ…

```bash
npm test              # All tests
npm run test:unit     # Unit tests only
npm run test:snapshot # Snapshot tests
node test-product-conversion.js  # Test conversion logic
```

### Test Coverage
- Core game mechanics
- Species data validation
- Morph inheritance
- Economy calculations
- Shop transactions
- Catalog loading
- User authentication

---

## ğŸ“ File Structure

```
/root/catalog/
â”œâ”€â”€ index.html              Landing page
â”œâ”€â”€ catalog.html            Shop (3-section layout NEW)
â”œâ”€â”€ game.html               Tamagotchi game
â”œâ”€â”€ start.html              Quick start (NEW)
â”œâ”€â”€ dashboard.html          Dev dashboard (NEW)
â”œâ”€â”€ debug-test.html         Debug console (NEW)
â”œâ”€â”€ cleanup.html            Data cleanup (NEW)
â”œâ”€â”€ success.html            Post-purchase thank you
â”œâ”€â”€ styles.css              All styling
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ game-controller.js  Main game logic (FIXED)
â”‚   â”œâ”€â”€ business/           Economy, shop, equipment
â”‚   â”œâ”€â”€ data/               Species, morphs, catalog
â”‚   â”œâ”€â”€ auth/               User authentication
â”‚   â”œâ”€â”€ config/             API keys, worker URL
â”‚   â””â”€â”€ ui/                 Shop view, modals
â”‚
â”œâ”€â”€ worker/
â”‚   â”œâ”€â”€ worker.js           Cloudflare Worker (UPDATED)
â”‚   â”œâ”€â”€ wrangler.toml       Config (PRODUCT_STATUS added)
â”‚   â”œâ”€â”€ create-product-status-kv.sh  Setup script (NEW)
â”‚   â””â”€â”€ test-worker.js      Testing script
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ products.json       Available snakes catalog
â”‚   â””â”€â”€ users.json          User accounts
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ clean-kv.sh         KV cleanup utility (NEW)
â”‚   â””â”€â”€ verify-api-connections.sh
â”‚
â”œâ”€â”€ tests/                  Test suite (86 tests)
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ v0.2.0.md          THIS FILE
    â”œâ”€â”€ v0.1.0.md          Previous version
    â”œâ”€â”€ README.md          Documentation index
    â”œâ”€â”€ API_CREDENTIALS.md API access guide
    â””â”€â”€ archive/           Historical docs
```

---

## ğŸš€ Deployment

### Prerequisites
- Node.js 18+ (testing only)
- Cloudflare account with Workers
- Stripe account (test mode)
- GitHub account (Pages hosting)

### Deploy Worker

```bash
cd worker

# Create PRODUCT_STATUS namespace (first time)
bash create-product-status-kv.sh
# Copy namespace ID to wrangler.toml

# Deploy
wrangler publish worker.js

# Verify
curl https://catalog.navickaszilvinas.workers.dev/
```

### Deploy Frontend (GitHub Pages)

```bash
git push origin main
# GitHub Pages auto-deploys from main branch
# Live at: https://vinas8.github.io/catalog/
```

### Configure Stripe Webhook

1. Go to Stripe Dashboard â†’ Webhooks
2. Add endpoint: `https://catalog.navickaszilvinas.workers.dev/stripe-webhook`
3. Select event: `checkout.session.completed`
4. Copy webhook secret to `.env`

---

## ï¿½ï¿½ Data Migration (v0.1.0 â†’ v0.2.0)

### Breaking Changes
- Removed `data/user-products.json` (obsolete)
- Import paths changed in `game-controller.js`
- Added PRODUCT_STATUS KV namespace requirement

### Migration Steps

1. **Clean old data:**
   ```bash
   # Browser (visit this page)
   http://localhost:8000/cleanup.html
   
   # Server
   bash scripts/clean-kv.sh
   ```

2. **Update worker:**
   ```bash
   cd worker
   bash create-product-status-kv.sh
   # Update wrangler.toml with namespace ID
   wrangler publish worker.js
   ```

3. **Test:**
   ```bash
   npm test
   bash .github/skills/test-worker.sh
   ```

---

## ğŸ› Known Issues

None critical in v0.2.0.

### Minor Issues
- PRODUCT_STATUS namespace must be created manually (scripted)
- Virtual snake purchase not yet implemented (UI ready)
- Breeding mechanics still in development

---

## ğŸ“ Changelog (v0.1.0 â†’ v0.2.0)

### Added
- âœ… PRODUCT_STATUS KV namespace for sold tracking
- âœ… 3-section catalog layout (Available/Virtual/Sold)
- âœ… Developer dashboard (dashboard.html)
- âœ… Data cleanup tools (cleanup.html, scripts/clean-kv.sh)
- âœ… Quick start page (start.html)
- âœ… Debug console (debug-test.html)
- âœ… Product conversion system (createSnakeFromProduct)
- âœ… Worker endpoint: GET /product-status

### Fixed
- âœ… JavaScript import paths (./config vs ../config)
- âœ… Missing createSnakeFromProduct method
- âœ… Unclosed try/catch blocks
- âœ… Duplicate snakes from test data

### Changed
- ğŸ”„ catalog.html: 3-section layout with sold tracking
- ğŸ”„ worker.js: Writes to PRODUCT_STATUS on purchase
- ğŸ”„ game-controller.js: Fixed import paths, added conversion method
- ğŸ”„ Documentation: Complete reorganization

### Removed
- âŒ data/user-products.json (obsolete)
- âŒ Old test data causing duplicate snakes

---

## ğŸ”® Roadmap (v0.3.0 and Beyond)

### Planned Features
- Breeding mechanics (genetics calculator functional)
- More species (Boa Constrictors, King Snakes)
- Multiplayer trading system
- Achievement system
- Mobile app (React Native)
- Advanced genetics (co-dominant, incomplete dominant)
- Breeding season simulation
- Egg incubation mechanics

### Infrastructure
- WebSocket for real-time updates
- PostgreSQL for complex queries
- CDN for snake images
- Email notifications for stat warnings

---

## ğŸ“š Additional Resources

- **README.md** - Project overview and quick reference
- **SETUP.md** - Installation guide
- **CLOUDFLARE-SETUP-COMPLETE.md** - Worker configuration
- **CHANGES_SUMMARY.md** - Version history
- **docs/v0.1.0.md** - Previous version documentation
- **docs/API_CREDENTIALS.md** - API access for AI assistants

---

## ğŸ¤ Contributing

See main README.md for contribution guidelines.

**Code Style:**
- Plain JavaScript ES6 modules
- No build step, no transpiling
- No external dependencies (zero-dep philosophy)
- Modules export functions/objects
- LocalStorage for game state only

**Testing:**
- Always run `npm test` before committing
- Add tests for new features
- Maintain 100% pass rate

---

## ğŸ“„ License

MIT

---

**Version:** 0.2.0  
**Last Updated:** 2025-12-21  
**Repository:** https://github.com/vinas8/catalog  
**Live Demo:** https://vinas8.github.io/catalog/
