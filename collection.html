<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Collection - Snake Muffin</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/img/icon-192.png">
  
  <link rel="stylesheet" href="styles.css">
  <script src="src/utils/debug-loader.js"></script>
  <script type="module" src="src/components/PWAInstallButton.js"></script>
  <style>
    .collection-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 2rem;
    }
    .collection-header {
      text-align: center;
      margin-bottom: 3rem;
    }
    .collection-header h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    .user-info {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      text-align: center;
    }
    .snake-collection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 2rem;
      margin-top: 2rem;
    }
    .snake-card {
      background: white;
      border: 2px solid #ddd;
      border-radius: 12px;
      padding: 1.5rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .snake-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .snake-header {
      margin-bottom: 1rem;
      border-bottom: 2px solid #eee;
      padding-bottom: 1rem;
    }
    .snake-name {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }
    .snake-species {
      color: #666;
      font-size: 1rem;
      margin-top: 0.5rem;
    }
    .snake-info {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    .badge {
      background: #667eea;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
    }
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: #f8f9fa;
      border-radius: 12px;
    }
    .empty-icon {
      font-size: 5rem;
      margin-bottom: 1rem;
    }
    .loading {
      text-align: center;
      padding: 3rem;
      font-size: 1.2rem;
    }
    .debug-info {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 2rem;
      font-family: monospace;
      font-size: 0.9rem;
    }
    .primary-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .primary-btn:hover {
      background: #5568d3;
    }
    .secondary-btn {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .secondary-btn:hover {
      background: #f8f9fa;
    }
  </style>
</head>
<body>
  <script type="module" src="src/components/Navigation.js"></script>
  
  <div class="collection-container">
    <div class="collection-header">
      <h1>üêç Your Snake Collection</h1>
      <p class="muted">Manage and view your purchased snakes</p>
    </div>

    <div id="user-info" class="user-info" style="display: none;">
      <p><strong>User ID:</strong> <span id="display-user-id">Loading...</span></p>
    </div>

    <div id="loading" class="loading">
      ‚è≥ Loading your collection...
    </div>

    <div id="snake-collection" class="snake-collection" style="display: none;">
      <!-- Snake cards will be rendered here -->
    </div>

    <div id="empty-collection" class="empty-state" style="display: none;">
      <div class="empty-icon">üêç</div>
      <h3>No Snakes Yet!</h3>
      <p>You haven't purchased any snakes yet.</p>
      <a href="catalog.html" class="primary-btn">Browse Catalog</a>
    </div>

    <div id="debug-info" class="debug-info" style="display: none;">
      <strong>Debug Info:</strong><br>
      <div id="debug-content"></div>
    </div>
  </div>

  <script type="module">
    import { WORKER_CONFIG } from './src/config/worker-config.js';
    
    const DEBUG = true; // Set to false in production
    
    function debug(msg, data = null) {
      if (DEBUG) {
        console.log(`[Collection] ${msg}`, data || '');
      }
    }
    
    function showDebugInfo(info) {
      if (DEBUG) {
        const debugDiv = document.getElementById('debug-info');
        const debugContent = document.getElementById('debug-content');
        debugContent.innerHTML = JSON.stringify(info, null, 2);
        debugDiv.style.display = 'block';
      }
    }
    
    async function loadUserCollection() {
      try {
        // Get user hash from URL query parameters or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        let userHash = urlParams.get('user');
        
        // Fallback to localStorage if no URL parameter
        if (!userHash) {
          userHash = localStorage.getItem('serpent_user_hash') || 
                     localStorage.getItem('serpent_last_purchase_hash') || 
                     localStorage.getItem('serpent_pending_purchase_hash') ||
                     localStorage.getItem('user_hash');
          
          if (userHash) {
            debug('Using hash from localStorage:', userHash);
            // Update URL to reflect the user parameter
            window.history.replaceState({}, '', `?user=${userHash}`);
          } else {
            debug('No user hash found in URL or localStorage');
            throw new Error('No user hash found. Please complete a purchase first.');
          }
        }
        
        debug('User hash from URL:', userHash);
        
        // Display user info
        document.getElementById('display-user-id').textContent = userHash;
        document.getElementById('user-info').style.display = 'block';
        
        // Fetch user products from worker
        const workerUrl = `${WORKER_CONFIG.BASE_URL}/user-products?user=${userHash}`;
        debug('Fetching from:', workerUrl);
        
        const response = await fetch(workerUrl);
        
        if (!response.ok) {
          throw new Error(`Worker returned ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        debug('Worker response:', data);
        
        showDebugInfo({
          userHash,
          workerUrl,
          responseStatus: response.status,
          data
        });
        
        // Hide loading
        document.getElementById('loading').style.display = 'none';
        
        // Check if data is array or has products property
        const products = Array.isArray(data) ? data : (data.products || []);
        
        if (!products || products.length === 0) {
          debug('No products found for user');
          document.getElementById('empty-collection').style.display = 'block';
          return;
        }
        
        // Show collection
        renderCollection(products);
        
      } catch (error) {
        console.error('Error loading collection:', error);
        document.getElementById('loading').innerHTML = 
          `<div style="color: red;">
            ‚ùå Error loading collection: ${error.message}
            <br><br>
            <a href="catalog.html" class="primary-btn">Go to Shop</a>
          </div>`;
        
        showDebugInfo({
          error: error.message,
          stack: error.stack
        });
      }
    }
    
    function renderCollection(products) {
      const container = document.getElementById('snake-collection');
      container.style.display = 'grid';
      
      debug('Rendering products:', products);
      
      container.innerHTML = products.map((product, index) => {
        // Handle different data structures
        const name = product.name || product.nickname || 'Unnamed Snake';
        const productId = product.id || product.product_id || 'Unknown';
        const species = product.species || 'Unknown Species';
        const morph = product.morph || 'Normal';
        const price = product.price || product.price_paid || 0;
        const displayPrice = price > 100 ? `‚Ç¨${(price / 100).toFixed(2)}` : `‚Ç¨${price}`;
        const purchasedDate = product.purchased_at || product.acquired_at;
        const status = product.status || product.acquisition_type || 'Owned';
        
        return `
          <div class="snake-card" data-product-index="${index}">
            <div class="snake-header">
              <div class="snake-name">${name}</div>
              <div class="snake-species">${species}</div>
              <div class="snake-info">
                <span class="badge">${morph}</span>
                <span class="muted">Status: ${status}</span>
              </div>
            </div>
            
            <div style="margin-top: 1rem;">
              <p><strong>Product ID:</strong> ${productId}</p>
              <p><strong>Price:</strong> ${displayPrice}</p>
              ${purchasedDate ? `<p><strong>Purchased:</strong> ${new Date(purchasedDate).toLocaleDateString()}</p>` : ''}
            </div>
            
            ${product.stats ? `
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                <p><strong>Stats:</strong></p>
                <p style="font-size: 0.9rem;">
                  Health: ${product.stats.health}% | 
                  Hunger: ${product.stats.hunger}% | 
                  Happiness: ${product.stats.happiness}%
                </p>
              </div>
            ` : ''}
            
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
              <button class="secondary-btn btn-view-details" style="flex: 1;" data-product-index="${index}">
                ‚ÑπÔ∏è Details
              </button>
              <a href="game.html?user=${new URLSearchParams(window.location.search).get('user') || ''}" 
                 class="primary-btn" 
                 style="flex: 1; text-align: center; display: block; text-decoration: none;">
                üéÆ Play
              </a>
            </div>
          </div>
        `;
      }).join('');
      
      // Store products for modal access
      window.userProducts = products;
    }
    
    // Load collection on page load
    loadUserCollection();
  </script>
  
  <!-- Navigate to product page -->
  <script type="module">
    // Delegate event listener for "View Details" buttons - navigate to product page
    document.addEventListener('click', (e) => {
      if (e.target.closest('.btn-view-details')) {
        const btn = e.target.closest('.btn-view-details');
        const index = parseInt(btn.dataset.productIndex);
        const product = window.userProducts?.[index];
        
        if (product) {
          const species = (product.species || 'ball-pythons').toLowerCase().replace('_', '-');
          const morph = (product.morph || 'unknown').toLowerCase().replace(/\s+/g, '-').replace(/\./g, '');
          const name = (product.name || product.id).toLowerCase().replace(/\s+/g, '-');
          
          // Use relative path for GitHub Pages compatibility
          const productUrl = `product.html?url=/en/catalog/${species}/${morph}/${name}`;
          
          window.location.href = productUrl;
        }
      }
    });
  </script>
  
  <!-- Debug Panel (auto-loads only in DEBUG mode) -->
  <script type="module">
    import { initDebugPanel } from './src/components/DebugPanel.js';
    initDebugPanel();
  </script>
</body>
</html>
