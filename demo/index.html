<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé¨ Interactive Demo - Snake Muffin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  </style>
</head>
<body>
  <div id="demo-root"></div>

  <script type="module">
    // Fix path for GitHub Pages
    const basePath = window.location.hostname.includes('github.io') ? '/catalog' : '';
    const { Demo } = await import(`${basePath}/src/modules/demo/index.js`);

    const demo = new Demo({
      containerId: 'demo-root',
      scenarios: [
        {
          icon: 'üß™',
          title: 'Automated Test Flow',
          smri: 'S1.1,2,3.01',
          description: 'Clear data ‚Üí Import ‚Üí Verify catalog ‚Üí View snake ‚Üí Check buyable ‚Üí Purchase',
          steps: [
            {
              title: 'Step 1: Clear Demo Data',
              description: 'Remove demo localStorage only',
              url: '/catalog.html?source=demo_test',
              action: async (demo) => {
                demo.log('üßπ Clearing demo data only...', 'info');
                const iframe = document.getElementById('demo-iframe');
                if (iframe?.contentWindow) {
                  try {
                    // Clear ONLY demo-specific keys (isolate from real data)
                    iframe.contentWindow.localStorage.removeItem('demo_test_products');
                    iframe.contentWindow.localStorage.removeItem('demo_test_products_timestamp');
                    
                    demo.log('‚úÖ Demo data cleared (real data untouched)', 'success');
                    demo.log('üì¶ Storage key: demo_test_products', 'info');
                    
                    // Reload to ensure clean state
                    demo.reloadIframe();
                    await demo.wait(1000);
                  } catch (e) {
                    demo.log(`‚ö†Ô∏è Could not clear: ${e.message}`, 'warning');
                  }
                }
              }
            },
            {
              title: 'Step 2: Check Empty Catalog',
              description: 'Verify demo catalog is empty',
              url: '/catalog.html?source=demo_test',
              action: async (demo) => {
                demo.log('üîç Checking catalog in browser...', 'info');
                await demo.wait(3000); // Wait for products to load
                
                const iframe = document.getElementById('demo-iframe');
                if (iframe?.contentWindow) {
                  try {
                    const doc = iframe.contentWindow.document;
                    const products = doc.querySelectorAll('.product-card');
                    const loadingMsg = doc.querySelector('.loading-message');
                    const noProductsMsg = doc.body.textContent.includes('No products') || 
                                         doc.body.textContent.includes('empty');
                    
                    demo.log(`üìä Found ${products.length} product cards in DOM`, 'info');
                    
                    if (products.length === 0) {
                      demo.log('‚úÖ SUCCESS: Catalog is empty', 'success');
                    } else {
                      demo.log(`‚ùå ERROR: Found ${products.length} products (expected 0)`, 'error');
                      throw new Error(`Catalog not empty - found ${products.length} products`);
                    }
                  } catch (e) {
                    if (e.message.includes('Catalog not empty')) {
                      throw e; // Re-throw our error
                    }
                    demo.log('‚ö†Ô∏è Could not verify (CORS)', 'warning');
                  }
                }
              }
            },
            {
              title: 'Step 3: Import Demo Snake',
              description: 'Add test snake to demo localStorage',
              url: '/catalog.html?source=demo_test',
              action: async (demo) => {
                demo.log('üì§ Creating demo snake in localStorage...', 'info');
                
                const iframe = document.getElementById('demo-iframe');
                if (iframe?.contentWindow) {
                  try {
                    // Create test product directly in localStorage (no Stripe/KV)
                    const testProduct = {
                      id: 'demo_snake_001',
                      name: 'DemoSnake',
                      active: true,
                      metadata: {
                        nickname: 'DemoSnake',
                        morph: 'Banana Het Clown',
                        species: 'ball_python',
                        gender: 'Male',
                        yob: '2024',
                        price: '299'
                      },
                      price: 299,
                      status: 'available',
                      type: 'real'
                    };
                    
                    // Save to demo-isolated localStorage
                    const products = [testProduct];
                    iframe.contentWindow.localStorage.setItem('demo_test_products', JSON.stringify(products));
                    iframe.contentWindow.localStorage.setItem('demo_test_products_timestamp', Date.now().toString());
                    
                    demo.log('‚úÖ Demo snake created in localStorage', 'success');
                    demo.log('üêç Name: DemoSnake (Banana Het Clown)', 'info');
                    demo.log('üíæ Storage: demo_test_products (isolated)', 'info');
                  } catch (err) {
                    demo.log(`‚ùå Error: ${err.message}`, 'error');
                  }
                } else {
                  demo.log('‚ùå Could not access iframe', 'error');
                }
              }
            },
            {
              title: 'Step 4: Check Catalog',
              description: 'Verify demo snake appears',
              url: '/catalog.html?source=demo_test',
              action: async (demo) => {
                demo.log('üîÑ Reloading catalog...', 'info');
                demo.reloadIframe();
                await demo.wait(4000); // Wait longer for rendering
                
                const iframe = document.getElementById('demo-iframe');
                if (iframe?.contentWindow) {
                  try {
                    const doc = iframe.contentWindow.document;
                    const products = doc.querySelectorAll('.product-card');
                    
                    demo.log(`üìä Found ${products.length} product cards in DOM`, 'info');
                    
                    if (products.length === 0) {
                      demo.log('‚ùå ERROR: Snake NOT found in catalog!', 'error');
                      demo.log('üí° Check: localStorage has demo_test_products?', 'warning');
                      throw new Error('Snake not found in catalog after import');
                    }
                    
                    // Check for DemoSnake specifically
                    const demoSnake = Array.from(products).find(p => 
                      p.textContent.includes('DemoSnake') || p.textContent.includes('Banana')
                    );
                    
                    if (demoSnake) {
                      demo.log('‚úÖ SUCCESS: DemoSnake found in catalog', 'success');
                      demo.log('üêç Name: DemoSnake (Banana Het Clown)', 'info');
                    } else {
                      demo.log(`‚ö†Ô∏è DemoSnake not found in text, but ${products.length} product(s) rendered`, 'warning');
                    }
                    
                    // Should be exactly 1 product (our demo snake)
                    if (products.length === 1) {
                      demo.log('‚úÖ Correct: Exactly 1 product in demo catalog', 'success');
                    } else {
                      demo.log(`‚ö†Ô∏è WARNING: Expected 1 product, found ${products.length}`, 'warning');
                    }
                    
                  } catch (e) {
                    if (e.message.includes('not found')) {
                      throw e; // Re-throw our errors
                    }
                    demo.log('‚ö†Ô∏è Could not check catalog (CORS)', 'warning');
                  }
                }
              }
            },
            {
              title: 'Step 5: View Snake',
              description: 'Click View Details button',
              url: '/catalog.html?source=demo_test',
              action: async (demo) => {
                demo.log('üëâ Looking for View Details button...', 'info');
                await demo.wait(1500);
                
                const iframe = document.getElementById('demo-iframe');
                if (iframe?.contentWindow) {
                  try {
                    const doc = iframe.contentWindow.document;
                    const btn = doc.querySelector('.view-details-btn');
                    
                    if (btn) {
                      demo.log('üñ±Ô∏è Clicking View Details...', 'info');
                      btn.click();
                      await demo.wait(2000);
                      demo.log('‚úÖ Snake page opened', 'success');
                    } else {
                      demo.log('‚ùå View Details button not found', 'error');
                    }
                  } catch (e) {
                    demo.log('üí° Manually click "View Details" button', 'info');
                  }
                }
              }
            },
            {
              title: 'Step 6: Check Buyable',
              description: 'Verify purchase button exists',
              url: '/product.html',
              action: async (demo) => {
                demo.log('üîç Checking if snake is buyable...', 'info');
                await demo.wait(3000); // Wait for product page to load
                
                const iframe = document.getElementById('demo-iframe');
                if (iframe?.contentWindow) {
                  try {
                    const doc = iframe.contentWindow.document;
                    const buyBtn = doc.querySelector('.cta-button');
                    
                    if (!buyBtn) {
                      demo.log('‚ùå ERROR: No buy button found', 'error');
                      throw new Error('Buy button not found on product page');
                    }
                    
                    const btnText = buyBtn.textContent.trim();
                    demo.log(`üîé Button text: "${btnText}"`, 'info');
                    
                    if (btnText.includes('‚Ç¨') && !btnText.includes('Link Needed')) {
                      demo.log('‚úÖ SUCCESS: Snake is buyable with Stripe link', 'success');
                      demo.log(`üí∞ Price: ${btnText}`, 'info');
                    } else if (btnText.includes('Link Needed')) {
                      demo.log('‚ùå ERROR: Snake NOT buyable (no Stripe payment link)', 'error');
                      demo.log('üí° Fix: Add payment link in Stripe product metadata', 'info');
                      throw new Error('Snake not buyable - missing Stripe payment link');
                    } else {
                      demo.log(`‚ö†Ô∏è Unexpected button state: ${btnText}`, 'warning');
                    }
                  } catch (e) {
                    if (e.message.includes('not buyable') || e.message.includes('not found')) {
                      throw e; // Re-throw our errors
                    }
                    demo.log('‚ö†Ô∏è Could not check buy button (CORS)', 'warning');
                  }
                }
              }
            },
            {
              title: 'Step 7: Purchase (if buyable)',
              description: 'Attempt Stripe checkout',
              url: '/product.html',
              action: async (demo) => {
                demo.log('üõí Checking purchase option...', 'info');
                await demo.wait(1000);
                
                const iframe = document.getElementById('demo-iframe');
                if (iframe?.contentWindow) {
                  try {
                    const doc = iframe.contentWindow.document;
                    const buyBtn = doc.querySelector('.cta-button:not(.disabled)');
                    
                    if (buyBtn && !buyBtn.textContent.includes('Link Needed')) {
                      demo.log('üí≥ Stripe checkout available', 'success');
                      demo.log('üí° Click button to open Stripe payment page', 'info');
                      demo.log('‚ö†Ô∏è Test mode: Use card 4242 4242 4242 4242', 'info');
                    } else {
                      demo.log('‚ö†Ô∏è Cannot purchase: Missing Stripe payment link', 'warning');
                      demo.log('üîß Fix: Add payment link in Stripe product metadata', 'info');
                    }
                  } catch (e) {
                    demo.log('üí° Manually test purchase if available', 'info');
                  }
                }
              }
            }
          ]
        },
        {
          icon: 'üéÆ',
          title: 'Game Tutorial',
          smri: 'S2.7,5,5-1.01',
          description: 'Learn to care for your snake',
          steps: [
            {
              title: 'Check Your Snakes',
              description: 'Ensure you have snakes assigned',
              url: '/game.html',
              action: async (demo) => {
                demo.log('üîç Checking if you have snakes...', 'info');
                await demo.wait(1500);
                demo.log('‚ö†Ô∏è If no snakes appear:', 'info');
                demo.log('   1. Import CSV data (Owner Dashboard)', 'info');
                demo.log('   2. Purchase from catalog', 'info');
                demo.log('   3. Snakes must be assigned to your user', 'info');
                await demo.wait(3000);
              }
            },
            {
              title: 'Select a Snake',
              description: 'Click on snake card',
              url: '/game.html',
              action: async (demo) => {
                demo.log('üëÜ Click on any snake card to select it', 'info');
                await demo.wait(2000);
              }
            },
            {
              title: 'Feed Snake',
              description: 'Click feed button',
              url: '/game.html',
              action: async (demo) => {
                demo.log('üçñ Click the "Feed" button', 'info');
                await demo.wait(2000);
              }
            },
            {
              title: 'Give Water',
              description: 'Click water button',
              url: '/game.html',
              action: async (demo) => {
                demo.log('üíß Click the "Water" button', 'info');
                await demo.wait(2000);
              }
            },
            {
              title: 'Clean Enclosure',
              description: 'Click clean button',
              url: '/game.html',
              action: async (demo) => {
                demo.log('üßπ Click the "Clean" button', 'info');
                await demo.wait(2000);
              }
            },
            {
              title: 'Check Stats',
              description: 'View snake health metrics',
              url: '/game.html',
              action: async (demo) => {
                demo.log('üìä All stats should be 100%', 'success');
                await demo.wait(1000);
              }
            }
          ]
        },
        {
          icon: 'üëî',
          title: 'Owner Dashboard - Import & Sync',
          smri: 'S6.1,4,5.01',
          description: 'Real CSV import demo',
          steps: [
            {
              title: 'Cleanup Old Products',
              description: 'Clear Stripe before import',
              url: '/admin/import-modular.html',
              action: async (demo) => {
                demo.log('üßπ Clearing old products from Stripe...', 'info');
                
                try {
                  const { ImportManager, StripeDestination } = 
                    await import('/src/modules/import/index.js');
                  
                  const manager = new ImportManager();
                  manager.setDestination(new StripeDestination());
                  
                  const cleanupResult = await manager.cleanup();
                  if (cleanupResult.success) {
                    demo.log(`‚úÖ Deleted ${cleanupResult.deleted} old products`, 'success');
                  } else {
                    demo.log(`‚ö†Ô∏è ${cleanupResult.error}`, 'warning');
                  }
                } catch (err) {
                  demo.log(`üí• Error: ${err.message}`, 'error');
                }
              }
            },
            {
              title: 'Import Sample Data',
              description: 'Load CSV ‚Üí Stripe ‚Üí KV',
              url: '/admin/import-modular.html',
              action: async (demo) => {
                demo.log('üì§ Starting real import...', 'info');
                
                // Import the modular system
                const { ImportManager, CSVSource, StripeDestination, KVDestination } = 
                  await import(`${basePath}/src/modules/import/index.js`);
                
                const sampleCSV = `Name,Morph,Gender,YOB,Weight
Pudding,Banana H. Clown,Male,2024,
Taohu,Super Mojave,Male,2024,
Chocolate,Pastel,Female,2023,`;
                
                try {
                  const manager = new ImportManager();
                  const csvSource = new CSVSource();
                  
                  // Step 1: Validate
                  demo.log('üîç Validating CSV...', 'info');
                  manager.setSource(csvSource);
                  const validation = await manager.validate(sampleCSV);
                  
                  if (!validation.valid) {
                    validation.errors.forEach(err => demo.log(err, 'error'));
                    return;
                  }
                  demo.log(`‚úÖ Validated ${validation.data.length} snakes`, 'success');
                  await demo.wait(1000);
                  
                  // Step 2: Import to Stripe
                  demo.log('‚¨ÜÔ∏è Uploading to Stripe...', 'info');
                  manager.setDestination(new StripeDestination());
                  const importResult = await manager.import();
                  
                  if (importResult.success) {
                    demo.log(`‚úÖ Uploaded ${importResult.written} products`, 'success');
                  } else {
                    demo.log(`‚ùå Upload failed`, 'error');
                    return;
                  }
                  await demo.wait(1000);
                  
                  // Step 3: Sync to KV
                  demo.log('üîÑ Syncing Stripe ‚Üí KV...', 'info');
                  manager.setDestination(new KVDestination());
                  await manager.import();
                  demo.log('‚úÖ Synced to KV storage', 'success');
                  
                  demo.log('üéâ Import complete! Check catalog.', 'success');
                  
                } catch (err) {
                  demo.log(`üí• Error: ${err.message}`, 'error');
                }
              }
            },
            {
              title: 'View in Catalog',
              description: 'Click View Details to see product page',
              url: '/catalog.html',
              action: async (demo) => {
                demo.log('üîÑ Clearing cache...', 'info');
                const iframe = document.getElementById('demo-iframe');
                if (iframe && iframe.contentWindow) {
                  try {
                    iframe.contentWindow.localStorage.removeItem('serpent_products_cache');
                    iframe.contentWindow.localStorage.removeItem('serpent_products_cache_time');
                    demo.log('‚úÖ Cache cleared!', 'success');
                  } catch (e) {
                    demo.log('‚ö†Ô∏è Could not clear cache (CORS)', 'info');
                  }
                }
                await demo.wait(1500);
                demo.reloadIframe();
                demo.log('üì¶ Products visible! Click "‚ÑπÔ∏è View Details"', 'success');
                demo.log('‚úÖ Uses product page URLs for SEO', 'success');
                demo.log('üí° Example: /en/catalog/ball-pythons/banana-clown/pudding', 'info');
              }
            }
          ]
        }
      ]
    });

    demo.init();
    console.log('üé¨ Demo system initialized');
  </script>
</body>
</html>
