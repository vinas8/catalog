<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thank You - SnakeMuffin</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .success-container {
      max-width: 600px;
      margin: 4rem auto;
      padding: 3rem;
      text-align: center;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .success-icon { font-size: 5rem; margin-bottom: 1rem; }
    .success-container h1 { color: #28a745; margin-bottom: 1rem; }
    .next-steps { text-align: left; margin: 2rem 0; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; }
    .next-steps h3 { margin-bottom: 1rem; }
    .next-steps ul { margin-left: 1.5rem; }
    .next-steps li { margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <header class="game-header">
    <div class="header-left">
      <h1>üêç SnakeMuffin</h1>
    </div>
    <nav class="main-nav">
      <a href="/">Home</a>
      <a href="/catalog.html">Shop</a>
      <a href="/game.html">Game</a>
    </nav>
  </header>

  <div class="success-container">
    <div class="success-icon">‚úÖ</div>
    <h1>Payment Successful!</h1>
    <p style="font-size: 1.2rem; margin-bottom: 2rem;" id="redirect-message">
      Your snake is being prepared...
    </p>

    <div class="next-steps">
      <h3>üéÆ What's Next?</h3>
      <ul>
        <li>Your new snake has been assigned to your account</li>
        <li>Complete quick registration to access your snakes</li>
        <li>Get your unique Player ID</li>
        <li>Start playing immediately!</li>
      </ul>
    </div>

    <p style="color: #666; margin-top: 2rem;">
      <span id="countdown">‚è≥ Checking for snake...</span>
    </p>

    <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center;" id="action-buttons">
      <a href="#" id="register-now-btn" class="primary-btn" style="display: none;">Register Now</a>
      <a href="/catalog.html" class="secondary-btn" id="secondary-btn">Continue Shopping</a>
    </div>

    <!-- Debug: Show snake details -->
    <div id="snake-debug" style="margin-top: 2rem; padding: 1rem; background: #f0f8ff; border-radius: 8px; text-align: left; display: none;">
      <h4 style="margin-bottom: 0.5rem;">üêç Your Snake Details:</h4>
      <pre id="snake-data" style="background: white; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.85rem;"></pre>
    </div>
  </div>

  <footer style="position: fixed; bottom: 0; left: 0; right: 0; background: #f8f9fa; padding: 0.5rem; font-size: 0.8rem; color: #666; border-top: 1px solid #ddd;">
    <div style="max-width: 1200px; margin: 0 auto; text-align: center;" id="stripe-callback-data">
      üìä <span id="callback-info">Loading...</span>
    </div>
  </footer>

  <script>
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    
    console.log('üöÄ Success page started');
    
    // Get URL params
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    
    console.log('üìä Session ID:', sessionId);
    
    // Display callback info
    const callbackInfo = {
      session_id: sessionId,
      timestamp: new Date().toISOString()
    };
    document.getElementById('callback-info').textContent = `Session: ${sessionId || 'none'}`;
    
    if (!sessionId) {
      console.warn('‚ö†Ô∏è No session_id - not a valid Stripe callback');
      document.getElementById('redirect-message').textContent = 'Invalid page access';
      document.getElementById('countdown').innerHTML = '‚ö†Ô∏è <a href="/catalog.html">Go to Catalog</a>';
      return;
    }
    
    // Get user hash
    const userHash = localStorage.getItem('serpent_user_hash') || 
                     localStorage.getItem('serpent_last_purchase_hash') || 
                     localStorage.getItem('serpent_pending_purchase_hash');
    
    console.log('üîç User hash:', userHash);
    
    if (!userHash) {
      console.error('‚ùå No user hash found');
      document.getElementById('redirect-message').textContent = 'Error: No user ID';
      document.getElementById('countdown').innerHTML = '‚ùå Please contact support';
      return;
    }
    
    // Poll for snake assignment (same as purchase flow demo)
    let checkAttempts = 0;
    let pollInterval = null;
    const maxAttempts = 20;
    
    const checkForSnake = async () => {
      checkAttempts++;
      console.log(`üîÑ Check attempt ${checkAttempts}/${maxAttempts}`);
      
      try {
        const response = await fetch(`${WORKER_URL}/user-products?user=${userHash}`);
        const data = await response.json();
        
        // Handle array response (same as catalog/debug demo)
        const products = Array.isArray(data) ? data : (data.products || []);
        
        console.log('üì¶ Products:', products.length);
        
        if (products.length > 0) {
          console.log('‚úÖ Snake found!', products);
          
          // STOP POLLING IMMEDIATELY
          if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
          }
          
          // Show snake details in debug section
          const snakeDebug = document.getElementById('snake-debug');
          const snakeData = document.getElementById('snake-data');
          snakeDebug.style.display = 'block';
          snakeData.textContent = JSON.stringify(products[0], null, 2);
          
          // Success!
          document.getElementById('redirect-message').textContent = 'Your snake is ready!';
          document.getElementById('countdown').innerHTML = 'üéâ Snake assigned successfully!';
          
          // Check if first purchase
          const existingUser = localStorage.getItem('serpent_user');
          const isFirstPurchase = !existingUser;
          
          if (isFirstPurchase) {
            // Show register button
            document.getElementById('register-now-btn').style.display = 'inline-block';
            document.getElementById('register-now-btn').href = `/register.html?session_id=${sessionId}&user_hash=${userHash}`;
            document.getElementById('countdown').innerHTML = 'üéâ Click "Register Now" to claim your snake!';
          } else {
            // Returning customer - go to game
            document.getElementById('secondary-btn').textContent = 'ÔøΩÔøΩ Go to My Farm';
            document.getElementById('secondary-btn').href = `/game.html#${userHash}`;
            document.getElementById('secondary-btn').className = 'primary-btn';
            document.getElementById('countdown').innerHTML = 'üéÆ Your new snake is waiting at the farm!';
          }
          
          return true; // Stop checking
        }
        
        if (checkAttempts >= maxAttempts) {
          console.warn('‚ö†Ô∏è Timeout waiting for snake');
          document.getElementById('redirect-message').textContent = 'Processing delay';
          document.getElementById('countdown').innerHTML = '‚è∞ Taking longer than expected. <a href="/game.html#' + userHash + '">Check game</a>';
          return true; // Stop checking
        }
        
        return false; // Keep checking
        
      } catch (error) {
        console.error('‚ùå Error checking:', error);
        if (checkAttempts >= maxAttempts) {
          document.getElementById('countdown').innerHTML = '‚ùå Error occurred. <a href="/catalog.html">Try again</a>';
          return true;
        }
        return false;
      }
    };
    
    // Start polling
    document.getElementById('countdown').textContent = 'Waiting for confirmation...';
    
    pollInterval = setInterval(async () => {
      const shouldStop = await checkForSnake();
      if (shouldStop) {
        clearInterval(pollInterval);
      }
    }, 1000); // Check every 1 second
    
    // Initial check immediately
    checkForSnake();
  </script>
</body>
</html>
