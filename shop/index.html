<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy Snakes Online - Snake Muffin</title>
  <meta name="description" content="Buy ball pythons and corn snakes online. Safe shipping, captive bred, quality guaranteed. Snake Muffin snake shop.">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/img/icon-192.png">
  
  <link rel="stylesheet" href="../styles.css">
  <script src="../src/utils/debug-loader.js"></script>
  <script type="module" src="../src/components/PWAInstallButton.js"></script>
</head>
<body>
  <script type="module" src="../src/components/Navigation.js"></script>

  <main style="padding: 1rem;">
    <div class="catalog-filters">
      <select id="species-filter">
        <option value="all">All Species</option>
        <option value="ball_python">Ball Python</option>
        <option value="corn_snake">Corn Snake</option>
      </select>
      <button onclick="localStorage.removeItem('serpent_products_cache'); localStorage.removeItem('serpent_products_cache_time'); location.reload();" style="margin-left: 10px;">üîÑ Clear Cache</button>
    </div>

    <!-- Available Real Snakes -->
    <section class="catalog-section">
      <h3>üêç Available Snakes</h3>
      <div id="available-snakes" class="catalog-grid">
        <div class="loading">Loading...</div>
      </div>
    </section>

    <!-- Virtual Snakes -->
    <section class="catalog-section">
      <h3>üí∞ Virtual Snakes</h3>
      <div id="virtual-snakes" class="catalog-grid">
        <div class="loading">Loading...</div>
      </div>
    </section>

    <!-- Sold Snakes (Collapsed) -->
    <section class="catalog-section sold-section">
      <h3 id="sold-header" style="cursor: pointer; user-select: none;">
        üì¶ Sold <span id="sold-count">(0)</span> 
        <span id="sold-toggle" style="float: right;">‚ñº</span>
      </h3>
      <div id="sold-snakes" class="catalog-grid" style="display: none;">
        <div class="empty-state">No snakes sold yet</div>
      </div>
    </section>
  </main>

  <script>
    const WORKER_URL = 'https://catalog.navickaszilvinas.workers.dev';
    
    // Generate or get user hash
    function getUserHash() {
      let hash = localStorage.getItem('serpent_user_hash') || 
                 localStorage.getItem('serpent_last_purchase_hash') ||
                 localStorage.getItem('serpent_pending_purchase_hash');
      
      if (!hash) {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).substring(2, 15);
        hash = timestamp + random;
        localStorage.setItem('serpent_pending_purchase_hash', hash);
        localStorage.setItem('serpent_last_purchase_hash', hash);
        localStorage.setItem('serpent_user_hash', hash);
      }
      return hash;
    }

    // Render product card
    function renderProductCard(product, userHash, isSold) {
      // Handle both Stripe format and legacy format
      const name = product.name || product.metadata?.nickname || 'Unknown';
      const morph = product.metadata?.morph || product.morph || 'Unknown';
      const species = product.metadata?.species || product.species || 'ball_python';
      const description = product.description || `${morph} ${species.replace('_', ' ')}`;
      const info = product.metadata ? 
        `${product.metadata.gender || 'Unknown'} ‚Ä¢ ${product.metadata.yob || '2024'}` :
        (product.info || '');
      
      // Price handling - use default if not set
      const price = product.metadata?.price || product.price || 150;
      const priceFormatted = typeof price === 'number' ? price.toFixed(2) : price;
      
      // Check if in demo mode
      const urlParams = new URLSearchParams(window.location.search);
      const demoSource = urlParams.get('source');
      
      // Checkout URL - use Stripe payment link from product
      let checkoutUrl = product.stripe_link;
      
      if (checkoutUrl && checkoutUrl.includes('stripe.com')) {
        checkoutUrl += `?client_reference_id=${userHash}`;
      }
      
      const soldClass = isSold ? 'sold' : '';
      const soldBadge = isSold ? '<span class="sold-badge">SOLD</span>' : '';
      
      // Demo mode: Use demo purchase button
      const buyButton = isSold ? 
        '<button class="primary-btn" disabled style="opacity: 0.5;">Sold Out</button>' :
        demoSource ? 
          `<button class="primary-btn" onclick="
            const product = JSON.parse(this.getAttribute('data-product'));
            const storageKey = '${demoSource}_products';
            const products = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const idx = products.findIndex(p => p.id === product.id);
            if (idx >= 0) {
              products[idx].status = 'sold';
              products[idx].owner = 'demo_user_123';
              localStorage.setItem(storageKey, JSON.stringify(products));
              
              // Store purchase info for success page
              localStorage.setItem('demo_last_purchase', JSON.stringify({
                product: products[idx],
                source: '${demoSource}',
                timestamp: Date.now()
              }));
              
              // Redirect to success page (same flow as real purchase)
              window.location.href = '/success.html?demo=true&source=${demoSource}';
            }
          " data-product='${JSON.stringify(product).replace(/'/g, "&apos;")}'>üé¨ Demo Buy - ‚Ç¨${priceFormatted}</button>` :
          checkoutUrl ? 
            `<a href="${checkoutUrl}" target="_blank" class="primary-btn" onclick="
              localStorage.setItem('serpent_pending_purchase_hash', '${userHash}');
              localStorage.setItem('serpent_last_purchase_hash', '${userHash}');
              localStorage.setItem('serpent_user_hash', '${userHash}');
            ">üí≥ Buy Now - ‚Ç¨${priceFormatted}</a>` :
            `<button class="primary-btn" disabled style="opacity: 0.7;">‚Ç¨${priceFormatted} (Link Needed)</button>`;
      
      return `
        <div class="catalog-item ${soldClass}" data-product-id="${product.id}">
          ${soldBadge}
          <div class="item-image">${product.image || product.images?.[0] || 'üêç'}</div>
          <h3>${name}</h3>
          <p class="species-info">${species.replace('_', ' ')} - ${morph.replace('_', ' ')}</p>
          <p>${description}</p>
          <p class="item-info">${info}</p>
          <div class="item-price">‚Ç¨${priceFormatted}</div>
          <button class="secondary-btn btn-view-details" data-product='${JSON.stringify(product).replace(/'/g, "&apos;")}'>
            ‚ÑπÔ∏è View Details
          </button>
          ${buyButton}
        </div>
      `;
    }

    function renderVirtualCard(product) {
      const price = typeof product.price === 'number' ? product.price : 0;
      
      return `
        <div class="catalog-item virtual">
          <span class="virtual-badge">VIRTUAL</span>
          <div class="item-image">${product.image || 'üêç'}</div>
          <h3>${product.name}</h3>
          <p class="species-info">${(product.species || '').replace('_', ' ')} - ${(product.morph || 'normal').replace('_', ' ')}</p>
          <p>${product.description || ''}</p>
          <p class="item-info">${product.info || ''}</p>
          <div class="item-price">${price} Gold</div>
          <button class="primary-btn" disabled style="opacity: 0.5;">Available In-Game</button>
        </div>
      `;
    }

    async function loadAndRenderCatalog() {
      const availableContainer = document.getElementById('available-snakes');
      const virtualContainer = document.getElementById('virtual-snakes');
      const soldContainer = document.getElementById('sold-snakes');
      const soldCount = document.getElementById('sold-count');
      const speciesFilter = document.getElementById('species-filter').value;
      
      console.log('üîÑ Loading catalog, species filter:', speciesFilter);
      
      availableContainer.innerHTML = '<div class="loading">Loading...</div>';
      virtualContainer.innerHTML = '<div class="loading">Loading...</div>';
      
      try {
        // Check for demo source parameter (e.g., ?source=demo_purchase)
        const urlParams = new URLSearchParams(window.location.search);
        const demoSource = urlParams.get('source');
        
        // Determine storage key based on source
        const storageKey = demoSource ? `${demoSource}_products` : 'serpent_products_cache';
        const storageTimeKey = demoSource ? `${demoSource}_products_timestamp` : 'serpent_products_cache_time';
        
        if (demoSource) {
          console.log(`üé¨ DEMO MODE: Using source "${demoSource}"`);
          console.log(`üì¶ Storage key: ${storageKey}`);
        }
        
        // Check localStorage cache first (FAST!)
        console.log('üîç Checking cache...');
        const cached = localStorage.getItem(storageKey);
        const cacheTime = localStorage.getItem(storageTimeKey);
        const now = Date.now();
        const CACHE_TTL = demoSource ? 999999999 : 300000; // Demo cache never expires
        
        let data;
        
        // Debug cache status
        if (!cached) {
          console.log('‚ùå No cache found - will fetch fresh data');
        } else if (!cacheTime) {
          console.log('‚ö†Ô∏è Cache exists but no timestamp - will fetch fresh');
        } else {
          const age = now - parseInt(cacheTime);
          const ageSeconds = Math.floor(age / 1000);
          console.log(`üì¶ Cache found - age: ${ageSeconds}s (TTL: 300s)`);
          
          if (age >= CACHE_TTL) {
            console.log(`‚è∞ Cache EXPIRED (${ageSeconds}s > 300s) - will fetch fresh`);
          } else {
            console.log(`‚úÖ Cache FRESH (${ageSeconds}s < 300s) - using cache!`);
          }
        }
        
        if (cached && cacheTime && (now - parseInt(cacheTime)) < CACHE_TTL) {
          console.log('‚ö° Using cached products (instant)');
          data = JSON.parse(cached);
          console.log(`üìä Loaded ${data.length} products from cache`);
        } else if (demoSource) {
          // Demo mode but no data - treat as empty (not error)
          console.log(`üé¨ Demo mode: No data yet for source "${demoSource}" - showing empty state`);
          data = []; // Empty array = valid state for demo start
        } else {
          // Fetch products from Worker API
          console.log('üì° Fetching from:', WORKER_URL + '/products');
          const start = Date.now();
          const response = await fetch(WORKER_URL + '/products');
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          data = await response.json();
          const duration = Date.now() - start;
          console.log(`‚úÖ Loaded ${Array.isArray(data) ? data.length : 0} products in ${duration}ms`);
          
          // Cache it
          console.log('üíæ Caching products...');
          localStorage.setItem(storageKey, JSON.stringify(data));
          localStorage.setItem(storageTimeKey, now.toString());
          console.log('‚úÖ Products cached! Next load will be instant.');
        }
        
        console.log('‚úÖ Raw response:', data);
        
        // Handle array response
        const allProducts = Array.isArray(data) ? data : (data.products || []);
        console.log('‚úÖ Total products:', allProducts.length);
        
        // Filter by species (check metadata.species for Stripe products)
        const filteredProducts = speciesFilter === 'all' 
          ? allProducts 
          : allProducts.filter(p => {
              const species = p.metadata?.species || p.species;
              return species === speciesFilter;
            });
        
        console.log('‚úÖ After species filter:', filteredProducts.length);
        
        // Deduplicate by name (keep newest based on ID)
        const uniqueProducts = [];
        const seenNames = new Set();
        
        // Sort by ID descending (newer products have higher IDs typically)
        // Handle missing IDs gracefully
        const sorted = [...filteredProducts].sort((a, b) => {
          const idA = a.id || '';
          const idB = b.id || '';
          return idB.localeCompare(idA);
        });
        
        for (const product of sorted) {
          const name = product.name?.toLowerCase();
          if (name && !seenNames.has(name)) {
            seenNames.add(name);
            uniqueProducts.push(product);
          }
        }
        
        console.log('‚úÖ After deduplication:', uniqueProducts.length, '(removed', filteredProducts.length - uniqueProducts.length, 'duplicates)');
        
        // All Stripe products are "real" (not virtual), available (active=true)
        const realProducts = uniqueProducts.filter(p => p.active !== false);
        const virtualProducts = []; // No virtual products from Stripe
        
        console.log('‚úÖ Real:', realProducts.length, 'Virtual:', virtualProducts.length);
        
        // Separate by status (Stripe products are all available if active)
        const available = realProducts;
        const sold = []; // Track sold separately (would need KV for this)
        
        console.log('‚úÖ Available:', available.length, 'Sold:', sold.length);
        
        // Debug: Show all product names
        console.log('üì¶ Product names:', available.map(p => p.name).join(', '));
        
        const userHash = getUserHash();
        
        // Render available
        if (available.length === 0) {
          availableContainer.innerHTML = '<div class="empty-state">No snakes available</div>';
        } else {
          availableContainer.innerHTML = available.map(p => renderProductCard(p, userHash, false)).join('');
        }
        
        // Render virtual
        if (virtualProducts.length === 0) {
          virtualContainer.innerHTML = '<div class="empty-state">No virtual snakes</div>';
        } else {
          virtualContainer.innerHTML = virtualProducts.map(p => renderVirtualCard(p)).join('');
        }
        
        // Render sold
        soldCount.textContent = `(${sold.length})`;
        if (sold.length === 0) {
          soldContainer.innerHTML = '<div class="empty-state">No snakes sold yet</div>';
        } else {
          soldContainer.innerHTML = sold.map(p => renderProductCard(p, userHash, true)).join('');
        }
        
        console.log('‚úÖ Catalog rendering complete!');
        
      } catch (error) {
        console.error('‚ùå Error loading catalog:', error);
        availableContainer.innerHTML = `
          <div class="error-state">
            Failed to load catalog: ${error.message}<br>
            <a href="debug/catalog-demo.html">Try Debug Demo</a>
          </div>
        `;
        virtualContainer.innerHTML = '<div class="error-state">Error</div>';
      }
    }

    // Toggle sold section
    document.getElementById('sold-header').addEventListener('click', () => {
      const soldSection = document.getElementById('sold-snakes');
      const toggle = document.getElementById('sold-toggle');
      if (soldSection.style.display === 'none') {
        soldSection.style.display = 'grid';
        toggle.textContent = '‚ñ≤';
      } else {
        soldSection.style.display = 'none';
        toggle.textContent = '‚ñº';
      }
    });

    // Check for success parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      const notification = document.createElement('div');
      notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:1.5rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:9999;';
      notification.innerHTML = '‚úÖ Payment successful! Thank you!';
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
        window.history.replaceState({}, '', 'catalog.html');
      }, 5000);
    }

    // Initial load
    loadAndRenderCatalog();

    // Filter change
    document.getElementById('species-filter').addEventListener('change', loadAndRenderCatalog);
  </script>

  <!-- Navigate to product page -->
  <script type="module">
    // Delegate event listener for "View Details" buttons - navigate to product page
    document.addEventListener('click', (e) => {
      if (e.target.closest('.btn-view-details')) {
        const btn = e.target.closest('.btn-view-details');
        try {
          const productData = JSON.parse(btn.dataset.product);
          // Handle both Stripe format (metadata.*) and legacy format
          const species = (productData.metadata?.species || productData.species || 'ball_python').toLowerCase().replace('_', '-');
          const morph = (productData.metadata?.morph || productData.morph || 'unknown').toLowerCase().replace(/\s+/g, '-').replace(/\./g, '');
          const name = (productData.name || productData.id).toLowerCase().replace(/\s+/g, '-');
          
          // Check if we're in demo mode
          const urlParams = new URLSearchParams(window.location.search);
          const demoSource = urlParams.get('source');
          const sourceParam = demoSource ? `&source=${demoSource}` : '';
          
          // Use query param for dev, clean URL for production
          const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          const productUrl = isDev 
            ? `/product.html?url=/en/catalog/${species}/${morph}/${name}${sourceParam}`
            : `/en/catalog/${species}/${morph}/${name}`;
          
          window.location.href = productUrl;
        } catch (err) {
          console.error('Failed to parse product data:', err);
        }
      }
    });
  </script>

  <!-- Debug Panel (auto-loads only in DEBUG mode) -->
  <script type="module">
    import { initDebugPanel } from './src/components/DebugPanel.js';
    initDebugPanel();
  </script>
</body>
</html>
